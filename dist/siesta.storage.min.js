!function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};b[g][0].call(k.exports,function(a){var c=b[g][1][a];return e(c?c:a)},k,k.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b){function c(a){var b=siesta._.extend({},a.__values);b.collection=a.collectionName,b.model=a.modelName,b._id=a._id,a.removed&&(b._deleted=!0);var c=a._rev;return c&&(b._rev=c),b=n.reduce(a._relationshipNames,function(b,c){var d=a[c];return siesta.isArray(d)?b[c]=n.pluck(d,"_id"):d&&(b[c]=d._id),b},b)}function d(a,b){delete a.collection,delete a.model;var c=b._relationshipNames;return n.each(c,function(b){var c=a[b];a[b]=siesta.isArray(c)?n.map(c,function(a){return{_id:a}}):{_id:c}}),a}function e(a,b){var c=a.collectionName,e=a.modelName;if(t.trace){var f=c+"."+e;t.trace("Loading instances for "+f)}var g=k[c][e],h=function(a){"$1"==a.model&&"$2"==a.collection&&emit(a._id,a)}.toString().replace("$1",e).replace("$2",c);t.trace.isEnabled&&t.trace("Querying pouch"),v.query({map:h}).then(function(a){t.trace.isEnabled&&t.trace("Queried pouch succesffully");var c=siesta._.map(siesta._.pluck(a.rows,"value"),function(a){return d(a,g)});t.trace.isEnabled&&t.trace("Mapping data",c),g.map(c,{disableevents:!0,_ignoreInstalled:!0,callInit:!1},function(a,c){a?t.error("Error loading models",a):t.trace.isEnabled&&t.trace(c.length.toString()),b(a,c)})}).catch(function(a){b(a)})}function f(a){if(y)throw new Error("not loaded yet how can i save");var b=m.defer(a);if(siesta.ext.storageEnabled){var c=k.collectionNames,d=[];n.each(c,function(a){var b=k[a],c=Object.keys(b._models);n.each(c,function(b){d.push(function(c){e({collectionName:a,modelName:b},c)})})}),siesta.async.parallel(d,function(a,c){if(!a){var d=[];siesta._.each(c,function(a){d.concat(a)}),t.trace&&t.trace("Loaded "+d.length.toString()+" instances")}b.finish(a)})}else b.finish();return b.promise}function g(a,b,c){v.allDocs({keys:n.pluck(a,"_id")}).then(function(d){for(var e=0;e<d.rows.length;e++)a[e]._rev=d.rows[e].value.rev;h(a,b,c)}).catch(function(a){c.reject(a)})}function h(a,b,d){var e=[];v.bulkDocs(n.map(a,c)).then(function(c){for(var f=0;f<c.length;f++){var h=c[f],i=a[f];h.ok?i._rev=h.rev:409==h.status?e.push(i):t.error('Error saving object with _id="'+i._id+'"',h)}e.length?g(e,b,d):(b(),d&&d.resolve())},function(a){b(a),d&&d.reject(a)})}function i(a){var b=m.defer(a);return siesta._afterInstall(function(){a=a||function(){};var c=p;p=[],q={},r={},t.trace&&t.trace("Saving objects",n.map(c,function(a){return a._dump()})),h(c,a,b)}),b.promise}if("undefined"==typeof siesta&&"undefined"==typeof b)throw new Error("Could not find window.siesta. Make sure you include siesta.core.js first.");var j=siesta._internal,k=(j.cache,j.CollectionRegistry),l=j.log,m=j.util,n=m._,o=j.events,p=[],q={},r={},s={},t=l.loggerWithName("Storage");if("undefined"==typeof PouchDB)siesta.ext.storageEnabled=!1,t.error("Storage extension is present but could not find PouchDB. Have you included pouchdb.js in your project? It must be present at window.PouchDB!");else{var u="siesta",v=new PouchDB(u),w=function(a){var b=a.obj,c=b._id;if(!b)throw new j.error.InternalSiestaError("No obj field in notification received by storage extension");if(!(c in q)){q[c]=b,p.push(b);var d=b.collectionName;r[d]||(r[d]={});var e=b.model.name;r[d][e]||(r[d][e]={}),r[d][e][c]=b}};siesta.on("Siesta",w),n.extend(s,{_load:f,save:i,_serialise:c,_reset:function(a){siesta.removeListener("Siesta",w),p=[],q={},v.destroy(function(b){b||(v=new PouchDB(u)),siesta.on("Siesta",w),t.warn("Reset complete"),a(b)})}}),Object.defineProperties(s,{_unsavedObjects:{get:function(){return p}},_unsavedObjectsHash:{get:function(){return q}},_unsavedObjectsByCollection:{get:function(){return r}},_pouch:{get:function(){return v}}}),siesta.ext||(siesta.ext={}),siesta.ext.storage=s,Object.defineProperties(siesta.ext,{storageEnabled:{get:function(){return void 0!==siesta.ext._storageEnabled?siesta.ext._storageEnabled:!!siesta.ext.storage},set:function(a){siesta.ext._storageEnabled=a},enumerable:!0}});var x,y,z=1e3;Object.defineProperties(siesta,{autosave:{get:function(){return!!x},set:function(a){a?x||(x=setInterval(function(){y||(y=!0,siesta.save(function(a){a||o.emit("saved"),y=!1}))},siesta.autosaveInterval)):x&&(clearInterval(x),x=null)}},autosaveInterval:{get:function(){return z},set:function(a){z=a,x&&(siesta.autosave=!1,siesta.autosave=!0)}},dirty:{get:function(){var a=siesta.ext.storage._unsavedObjectsByCollection;return!!Object.keys(a).length},enumerable:!0}}),n.extend(siesta,{save:i,setPouch:function(a){if(!siesta._canChange)throw new Error("Cannot change PouchDB instance when an object graph exists.");v=a}})}b.exports=s},{}]},{},[1]);