!function e(t,n,r){function i(s,a){if(!n[s]){if(!t[s]){var l="function"==typeof require&&require;if(!a&&l)return l(s,!0);if(o)return o(s,!0);var c=new Error("Cannot find module '"+s+"'");throw c.code="MODULE_NOT_FOUND",c}var u=n[s]={exports:{}};t[s][0].call(u.exports,function(e){var n=t[s][1][e];return i(n?n:e)},u,u.exports,e,t,n,r)}return n[s].exports}for(var o="function"==typeof require&&require,s=0;s<r.length;s++)i(r[s]);return i}({1:[function(e,t){!function(){var n=e("./util"),r=e("./collectionRegistry").CollectionRegistry,i=e("./collection"),o=e("./cache"),s=e("./model"),a=e("./error"),l=e("./events"),c=e("./RelationshipType"),u=e("./ReactiveQuery"),d=e("./ManyToManyProxy"),h=e("./OneToOneProxy"),f=e("./OneToManyProxy"),p=e("./RelationshipProxy"),v=e("./modelEvents"),m=e("./Query"),y=e("./QuerySet"),b=e("./log"),g=n._;n._patchBind();var _=function(e){return _.ext||(_.ext={}),g.extend(_.ext,e||{}),_};g.extend(_,{on:l.on.bind(l),off:l.removeListener.bind(l),once:l.once.bind(l),removeAllListeners:l.removeAllListeners.bind(l)}),g.extend(_,{removeListener:_.off,addListener:_.on}),g.extend(_,{RelationshipType:c,ModelEventType:v.ModelEventType,log:b.Level,InsertionPolicy:u.InsertionPolicy,_internal:{log:b,Model:s,error:a,ModelEventType:v.ModelEventType,ModelInstance:e("./ModelInstance"),extend:e("extend"),MappingOperation:e("./mappingOperation"),events:l,ProxyEventEmitter:l.ProxyEventEmitter,cache:e("./cache"),modelEvents:v,CollectionRegistry:e("./collectionRegistry").CollectionRegistry,Collection:i,utils:n,util:n,_:n._,querySet:y,observe:e("../vendor/observe-js/src/observe"),Query:m,Store:e("./store"),ManyToManyProxy:d,OneToManyProxy:f,OneToOneProxy:h,RelationshipProxy:p},_:n._,async:n.async,isArray:n.isArray,isString:n.isString}),_.ext={};var x=!1,O=!1;g.extend(_,{reset:function(e,t){x=!1,O=!1,delete this.queuedTasks,o.reset(),r.reset(),l.removeAllListeners(),_.ext.storageEnabled?(t=void 0===t?!0:t,t?_.ext.storage._reset(e):e()):e()},collection:function(e,t){return new i(e,t)},install:function(e){return O||x?void e(a("already installing")):n.promise(e,function(e){O=!0;var t=r.collectionNames,n=g.map(t,function(e){return r[e].install.bind(r[e])}),i=_.ext.storageEnabled;i&&(n=n.concat([_.ext.storage.ensureIndexesForAll,_.ext.storage._load])),n.push(function(e){x=!0,this.queuedTasks&&this.queuedTasks.execute(),e()}.bind(this)),_.async.series(n,e)}.bind(this))},_pushTask:function(e){this.queuedTasks||(this.queuedTasks=new function(){this.tasks=[],this.execute=function(){this.tasks.forEach(function(e){e()}),this.tasks=[]}.bind(this)}),this.queuedTasks.tasks.push(e)},_afterInstall:function(e){x?e():(O||this.install(function(e){e&&console.error("Error setting up siesta",e),delete this.queuedTasks}.bind(this)),x?e():this._pushTask(e))},setLogLevel:function(e,t){var n=b.loggerWithName(e);n.setLevel(t)},graph:function(e,t,i){return"function"==typeof t&&(i=t),t=t||{},n.promise(i,function(t){var i,o=[];for(var s in e)if(e.hasOwnProperty(s)){var l=r[s];l?!function(e,t){o.push(function(n){e.graph(t,function(t,r){if(!t){var i={};i[e.name]=r}n(t,i)})})}(l,e[s]):i='No such collection "'+s+'"'}i?t(a(i,{data:e,invalidCollectionName:s})):n.async.series(o,function(e,n){n=e?null:n.reduce(function(e,t){return g.extend(e,t)},{}),t(e,n)})}.bind(this))},notify:n.next,registerComparator:m.registerComparator.bind(m),count:function(){return o.count()},get:function(e,t){return n.promise(t,function(t){this._afterInstall(function(){t(null,o._localCache()[e])})}.bind(this))},removeAll:function(e){return n.promise(e,function(e){n.Promise.all(r.collectionNames.map(function(e){return r[e].removeAll()}.bind(this))).then(function(){e(null)})["catch"](e)}.bind(this))}}),Object.defineProperties(_,{_canChange:{get:function(){return!(O||x)}},installed:{get:function(){return x}}}),"undefined"!=typeof window&&(window.siesta=_),_.log=e("debug"),t.exports=_,function(){e("../storage")}()}()},{"../storage":53,"../vendor/observe-js/src/observe":54,"./ManyToManyProxy":4,"./ModelInstance":5,"./OneToManyProxy":6,"./OneToOneProxy":7,"./Query":8,"./QuerySet":9,"./ReactiveQuery":10,"./RelationshipProxy":11,"./RelationshipType":12,"./cache":13,"./collection":14,"./collectionRegistry":15,"./error":16,"./events":17,"./log":19,"./mappingOperation":20,"./model":21,"./modelEvents":22,"./store":23,"./util":25,debug:31,extend:34}],2:[function(e,t){!function(){function n(e){r.call(this,e),this.indexAttribute="index"}var r=e("./ReactiveQuery"),i=(e("./log")("query"),e("./util")),o=e("./error"),s=e("./modelEvents"),a=o.InternalSiestaError,l=e("./QuerySet"),c=i._;n.prototype=Object.create(r.prototype),c.extend(n.prototype,{_refreshIndexes:function(){var e=this.results,t=this.indexAttribute;if(!e)throw new a("ArrangedReactiveQuery must be initialised");for(var n=0;n<e.length;n++){var r=e[n];r[t]=n}},_mergeIndexes:function(){for(var e=this.results,t=[],n=[],r=[],i=0;i<e.length;i++){var o=e[i],s=o[this.indexAttribute];void 0==s?r.push(o):s>e.length?n.push(o):t[s]?r.push(o):t[s]=o}for(n=c.sortBy(n,function(e){return e[this.indexAttribute]}.bind(this)),i=0;i<n.length;i++){o=n[i];var a=this.results.length-n.length+i;o[this.indexAttribute]=a,t[a]=o}r=this._query._sortResults(r);for(var u=0;r.length;){for(o=r.shift();t[u];)u++;t[u]=o,o[this.indexAttribute]=u}this.results=l(t,this.model)},init:function(e){return i.promise(e,function(e){r.prototype.init.call(this,function(t){t||(this.model.hasAttributeNamed(this.indexAttribute)?(this._mergeIndexes(),this._query.clearOrdering()):t=o('Model "'+this.model.name+'" does not have an attribute named "'+this.indexAttribute+'"')),e(t,t?null:this.results)}.bind(this))}.bind(this))},_handleNotif:function(e){e.field!=this.indexAttribute&&(r.prototype._handleNotif.call(this,e),this._refreshIndexes())},validateIndex:function(e){var t=this.results.length-1,n=0;if(!(e>=n&&t>=e))throw new Error("Index "+e.toString()+" is out of bounds")},swapObjectsAtIndexes:function(e,t){this.validateIndex(e),this.validateIndex(t);var n=this.results[e],r=this.results[t];if(!n)throw new Error('No model at index "'+e.toString()+'"');if(!r)throw new Error('No model at index "'+t.toString()+'"');this.results[t]=n,this.results[e]=r,n[this.indexAttribute]=t,r[this.indexAttribute]=e},swapObjects:function(e,t){var n=this.results.indexOf(e),r=this.results.indexOf(t);this.swapObjectsAtIndexes(n,r)},move:function(e,t){this.validateIndex(e),this.validateIndex(t);var n=this.results.mutableCopy();(function(e,t){if(t>=this.length)for(var n=t-this.length;n--+1;)this.push(void 0)}).call(n,e,t);var r=n.splice(e,1)[0];this.results=n.asModelQuerySet(this.model),this.emit(s.ModelEventType.Splice,{index:e,removed:[r],type:s.ModelEventType.Splice,obj:this,field:"results"}),n.splice(t,0,r),this.results=n.asModelQuerySet(this.model),this.emit(s.ModelEventType.Splice,{index:t,added:[r],type:s.ModelEventType.Splice,obj:this,field:"results"}),this._refreshIndexes()}}),t.exports=n}()},{"./QuerySet":9,"./ReactiveQuery":10,"./error":16,"./log":19,"./modelEvents":22,"./util":25}],3:[function(e,t){!function(){function n(e){this.opts=e}var r=e("argsarray");n.prototype={_handlerLink:function(e){var t;return t=function(){var n=e.type;e.fn&&this._removeListener(e.fn,n),t._parentLink&&t._parentLink()}.bind(this),Object.keys(this.opts).forEach(function(e){var n=this.opts[e];t[e]=r(function(e){var r=n.apply(n.__siesta_bound_object,e);return r._parentLink=t,r}.bind(this))}.bind(this)),t._parentLink=null,t},_link:function(e,t){var n=this;t=t||function(){};var i;return i=function(){t(),i._parentLink&&i._parentLink()}.bind(this),i.__siesta_isLink=!0,i.opts=e,i.clean=t,Object.keys(e).forEach(function(t){var o=e[t];i[t]=r(function(e){var t=o.apply(o.__siesta_bound_object,e);if(t&&t.__siesta_isLink)var r=t;else{r=n._link(i.opts);for(var s in t)t[s]instanceof Function&&(r[s]=t[s])}r._parentLink=i;for(s in i)i[s]instanceof Function&&(r[s]=i[s].bind(i));return r}.bind(this))}.bind(this)),i._parentLink=null,i}},t.exports=n}()},{argsarray:28}],4:[function(e,t){!function(){function n(e){r.call(this,e),this.related=[],this.relatedCancelListeners={}}var r=e("./RelationshipProxy"),i=(e("./store"),e("./util")),o=i._,s=(e("./error").InternalSiestaError,e("./modelEvents")),a=e("./events"),l=a.wrapArray,c=(e("./ModelInstance"),e("../vendor/observe-js/src/observe").ArrayObserver),u=e("./modelEvents").ModelEventType;n.prototype=Object.create(r.prototype),o.extend(n.prototype,{clearReverse:function(e){var t=this;o.each(e,function(e){var n=t.reverseProxyForInstance(e),r=n.related.indexOf(t.object);n.makeChangesToRelatedWithoutObservations(function(){n.splice(r,1)})})},setReverseOfAdded:function(e){var t=this;o.each(e,function(e){var n=t.reverseProxyForInstance(e);n.makeChangesToRelatedWithoutObservations(function(){n.splice(0,0,t.object)})})},wrapArray:function(e){var t=this;if(l(e,this.reverseName,this.object),!e.arrayObserver){e.arrayObserver=new c(e);var n=function(n){n.forEach(function(n){var r=n.addedCount?e.slice(n.index,n.index+n.addedCount):[],i=n.removed;t.clearReverse(i),t.setReverseOfAdded(r);var o=t.getForwardModel();s.emit({collection:o.collectionName,model:o.name,localId:t.object.localId,field:t.getForwardName(),removed:i,added:r,type:u.Splice,index:n.index,obj:t.object})})};e.arrayObserver.open(n)}},get:function(e){return i.promise(e,function(e){e(null,this.related)}.bind(this))},validate:function(e){return"[object Array]"!=Object.prototype.toString.call(e)?"Cannot assign scalar to many to many":null},set:function(e,t){this.checkInstalled();var n=this;if(e){var r;if(r=this.validate(e))return r;this.clearReverseRelated(t),n.setIdAndRelated(e,t),this.wrapArray(e),n.setIdAndRelatedReverse(e,t)}else this.clearReverseRelated(t),n.setIdAndRelated(e,t)},install:function(e){r.prototype.install.call(this,e),this.wrapArray(this.related),e["splice"+i.capitaliseFirstLetter(this.reverseName)]=o.bind(this.splice,this)},registerRemovalListener:function(e){this.relatedCancelListeners[e.localId]=e.on("*",function(){}.bind(this))}}),t.exports=n}()},{"../vendor/observe-js/src/observe":54,"./ModelInstance":5,"./RelationshipProxy":11,"./error":16,"./events":17,"./modelEvents":22,"./store":23,"./util":25}],5:[function(e,t){!function(){function n(e){var t=this;this.model=e,r.subProperties(this,this.model,["collection","collectionName","_attributeNames",{name:"idField",property:"id"},{name:"modelName",property:"name"}]),a.ProxyEventEmitter.call(this),Object.defineProperties(this,{_relationshipNames:{get:function(){var e=i.map(Object.keys(t.__proxies||{}),function(e){return t.__proxies[e]});return i.map(e,function(e){return e.isForward?e.forwardName:e.reverseName})},enumerable:!0,configurable:!0},dirty:{get:function(){return siesta.ext.storageEnabled?t.localId in siesta.ext.storage._unsavedObjectsHash:void 0},enumerable:!0},event:{get:function(){return this.localId}}}),this.removed=!1}var r=(e("./log"),e("./util")),i=r._,o=e("./error"),s=(o.InternalSiestaError,e("./modelEvents")),a=e("./events"),l=e("./cache");n.prototype=Object.create(a.ProxyEventEmitter.prototype),i.extend(n.prototype,{get:function(e){return r.promise(e,function(e){e(null,this)}.bind(this))},emit:function(e,t){"object"==typeof e?t=e:t.type=e,t=t||{},i.extend(t,{collection:this.collectionName,model:this.model.name,localId:this.localId,obj:this}),s.emit(t)},remove:function(e,t){return t=null==t?!0:t,r.promise(e,function(e){l.remove(this),this.removed=!0,t&&this.emit(s.ModelEventType.Remove,{old:this});var n=this.model.remove;if(n){var i=r.paramNames(n);if(i.length){var o=this;n.call(this,function(t){e(t,o)})}else n.call(this),e(null,this)}else e(null,this)}.bind(this))},restore:function(e){return r.promise(e,function(e){var t=function(t){t||this.emit(s.ModelEventType.New,{"new":this}),e(t,this)}.bind(this);if(this.removed){l.insert(this),this.removed=!1;var n=this.model.init;if(n){var i=r.paramNames(n),o=!0;i.length>1?n.call(this,o,t):(n.call(this,o),t())}else t()}}.bind(this))}}),i.extend(n.prototype,{getAttributes:function(){return i.extend({},this.__values)},isInstanceOf:function(e){return this.model==e},isA:function(e){return this.model==e||this.model.isDescendantOf(e)}}),i.extend(n.prototype,{_dumpString:function(e){return JSON.stringify(this._dump(e,null,4))},_dump:function(){var e=i.extend({},this.__values);return e._rev=this._rev,e.localId=this.localId,e}}),i.extend(n.prototype,{_defaultSerialise:function(e){var t={},n=void 0!==e.includeNullAttributes?e.includeNullAttributes:!0,o=void 0!==e.includeNullRelationships?e.includeNullRelationships:!0,s=this.model.serialisableFields||this._attributeNames.concat.apply(this._attributeNames,this._relationshipNames).concat(this.id);return i.each(this._attributeNames,function(e){if(s.indexOf(e)>-1){var r,i=this.model._attributeDefinitionWithName(e)||{};r=i.serialise?i.serialise.bind(this):this.model.serialiseField.bind(this,e);var o=this[e];null===o?n&&(t[e]=r(o)):void 0!==o&&(t[e]=r(o))}}.bind(this)),i.each(this._relationshipNames,function(e){if(s.indexOf(e)>-1){var n=this[e],a=this.model.relationships[e];if(r.isArray(n)?n=i.pluck(n,this.model.id):n&&(n=n[this.model.id]),a&&!a.isReverse){var l;l=a.serialise?a.serialise.bind(this):this.model.serialiseField.bind(this,e),null===n?o&&(t[e]=l(n)):r.isArray(n)?(o&&!n.length||n.length)&&(t[e]=l(n)):void 0!==n&&(t[e]=l(n))}}}.bind(this)),t},serialise:function(e){return e=e||{},this.model.serialise?this.model.serialise(this,e):this._defaultSerialise(e)}}),t.exports=n}()},{"./cache":13,"./error":16,"./events":17,"./log":19,"./modelEvents":22,"./util":25}],6:[function(e,t){!function(){function n(e){r.call(this,e),this.isReverse&&(this.related=[])}var r=e("./RelationshipProxy"),i=(e("./store"),e("./util")),o=i._,s=(e("./error").InternalSiestaError,e("./modelEvents")),a=e("./events"),l=a.wrapArray,c=e("../vendor/observe-js/src/observe").ArrayObserver,u=e("./modelEvents").ModelEventType;n.prototype=Object.create(r.prototype),o.extend(n.prototype,{clearReverse:function(e){var t=this;o.each(e,function(e){var n=t.reverseProxyForInstance(e);n.setIdAndRelated(null)})},setReverseOfAdded:function(e){var t=this;o.each(e,function(e){var n=t.reverseProxyForInstance(e);n.setIdAndRelated(t.object)})},wrapArray:function(e){var t=this;if(l(e,this.reverseName,this.object),!e.arrayObserver){e.arrayObserver=new c(e);var n=function(n){n.forEach(function(n){var r=n.addedCount?e.slice(n.index,n.index+n.addedCount):[],i=n.removed;t.clearReverse(i),t.setReverseOfAdded(r);var o=t.getForwardModel();s.emit({collection:o.collectionName,model:o.name,localId:t.object.localId,field:t.getForwardName(),removed:i,added:r,type:u.Splice,index:n.index,obj:t.object})})};e.arrayObserver.open(n)}},get:function(e){return i.promise(e,function(e){e(null,this.related)}.bind(this))},validate:function(e){var t=Object.prototype.toString.call(e);if(this.isForward){if("[object Array]"==t)return"Cannot assign array forward oneToMany ("+t+"): "+this.forwardName}else if("[object Array]"!=t)return"Cannot scalar to reverse oneToMany ("+t+"): "+this.reverseName;return null},set:function(e,t){this.checkInstalled();var n=this;if(e){var r;if(r=this.validate(e))return r;this.clearReverseRelated(t),n.setIdAndRelated(e,t),n.isReverse&&this.wrapArray(n.related),n.setIdAndRelatedReverse(e,t)}else this.clearReverseRelated(t),n.setIdAndRelated(e,t)},install:function(e){r.prototype.install.call(this,e),this.isReverse&&(e["splice"+i.capitaliseFirstLetter(this.reverseName)]=o.bind(this.splice,this),this.wrapArray(this.related))}}),t.exports=n}()},{"../vendor/observe-js/src/observe":54,"./RelationshipProxy":11,"./error":16,"./events":17,"./modelEvents":22,"./store":23,"./util":25}],7:[function(e,t){!function(){function n(e){r.call(this,e)}{var r=e("./RelationshipProxy"),i=e("./util"),o=i._;e("./ModelInstance")}n.prototype=Object.create(r.prototype),o.extend(n.prototype,{validate:function(e){return"[object Array]"==Object.prototype.toString.call(e)?"Cannot assign array to one to one relationship":null},set:function(e,t){if(this.checkInstalled(),e){var n;if(n=this.validate(e))return n;this.clearReverseRelated(t),this.setIdAndRelated(e,t),this.setIdAndRelatedReverse(e,t)}else this.clearReverseRelated(t),this.setIdAndRelated(e,t)},get:function(e){return i.promise(e,function(e){e(null,this.related)}.bind(this))}}),t.exports=n}()},{"./ModelInstance":5,"./RelationshipProxy":11,"./util":25}],8:[function(e,t){!function(){function n(e,t){var n={};for(var r in t)t.hasOwnProperty(r)&&"__"==r.slice(0,2)&&(n[r.slice(2)]=t[r],delete t[r]);h.extend(this,{model:e,query:t,opts:n}),n.order=n.order||[],l.isArray(n.order)||(n.order=[n.order])}function r(e){var t;return t=null===e?"null":void 0===e?"undefined":e instanceof u?e.localId:e.toString()}function i(e){if(!e.invalid){var t=e.object[e.field];if(l.isArray(t)||l.isString(t))return t.indexOf(e.value)>-1}return!1}function o(e){var t,n=a._localCacheByType,r=e.name,i=e.collectionName,o=n[i];return o&&(t=o[r]||{}),t}var s=e("./log")("query"),a=e("./cache"),l=e("./util"),c=e("./error"),u=e("./ModelInstance"),d=e("./QuerySet"),h=l._,f={e:function(e){var t=e.object[e.field];return s.enabled&&s(e.field+": "+r(t)+" == "+r(e.value),{opts:e}),t==e.value},lt:function(e){return e.invalid?!1:e.object[e.field]<e.value},gt:function(e){return e.invalid?!1:e.object[e.field]>e.value},lte:function(e){return e.invalid?!1:e.object[e.field]<=e.value},gte:function(e){return e.invalid?!1:e.object[e.field]>=e.value},contains:i,"in":i};h.extend(n,{comparators:f,registerComparator:function(e,t){f[e]||(f[e]=t)}}),h.extend(n.prototype,{execute:function(e){return l.promise(e,function(e){this._executeInMemory(e)}.bind(this))},_dump:function(e){return e?"{}":{}},sortFunc:function(e){for(var t=function(e,t){return function(n,r){var i,o=n[t],s=r[t];return"string"==typeof o||o instanceof String&&"string"==typeof s||s instanceof String?i=e?o.localeCompare(s):s.localeCompare(o):(o instanceof Date&&(o=o.getTime()),s instanceof Date&&(s=s.getTime()),i=e?o-s:s-o),i}},n=l,r=0;r<e.length;r++){var i=e[r];n=n.thenBy(t(i.ascending,i.field))}return n==l?null:n},_sortResults:function(e){var t=this.opts.order;if(e&&t){var n=h.map(t,function(e){var t=e.split("-"),n=!0,r=null;return t.length>1?(r=t[1],n=!1):r=t[0],{field:r,ascending:n}}.bind(this)),r=this.sortFunc(n);e.immutable&&(e=e.mutableCopy()),r&&e.sort(r)}return e},_getCacheByLocalId:function(){return h.reduce(this.model.descendants,function(e,t){return h.extend(e,o(t))},h.extend({},o(this.model)))},_executeInMemory:function(e){var t=function(){for(var t,n=this._getCacheByLocalId(),r=Object.keys(n),i=this,o=[],a=0;a<r.length;a++){var l=r[a],u=n[l],h=i.objectMatchesQuery(u);if("string"==typeof h){t=c(h);break}h&&o.push(u)}o=this._sortResults(o),t&&s("Error executing query",t),e(t,t?null:d(o,this.model))}.bind(this);this.opts.ignoreInstalled?t():siesta._afterInstall(t)},clearOrdering:function(){this.opts.order=null},objectMatchesOrQuery:function(e,t){for(var n in t)if(t.hasOwnProperty(n)){var r=t[n];if(this.objectMatchesBaseQuery(e,r))return!0}return!1},objectMatchesAndQuery:function(e,t){for(var n in t)if(t.hasOwnProperty(n)){var r=t[n];if(!this.objectMatchesBaseQuery(e,r))return!1}return!0},splitMatches:function(e,t,r){var i="e",o=t.split("."),s=o[o.length-1].split("__");if(2==s.length){var a=s[0];i=s[1]}else a=s[0];o[o.length-1]=a,h.each(o.slice(0,o.length-1),function(t){e=l.isArray(e)?h.pluck(e,t):e[t]});var c=void 0!=e;if(c){var u=e[a],d=null===u||void 0===u,f=n.comparators[i],p={object:e,field:a,value:r,invalid:d};return f?f(p):'No comparator registered for query operation "'+i+'"'}return!1},objectMatches:function(e,t,n,r){if("$or"==t){var i=r.$or;if(l.isArray(i)||(i=Object.keys(i).map(function(e){var t={};return t[e]=i[e],t})),!this.objectMatchesOrQuery(e,i))return!1}else if("$and"==t){if(!this.objectMatchesAndQuery(e,r.$and))return!1}else{var o=this.splitMatches(e,t,n);if("boolean"!=typeof o)return o;if(!o)return!1}return!0},objectMatchesBaseQuery:function(e,t){for(var n=Object.keys(t),r=0;r<n.length;r++){var i=n[r],o=t[i],s=this.objectMatches(e,i,o,t);if("boolean"!=typeof s)return s;if(!s)return!1}return!0},objectMatchesQuery:function(e){return this.objectMatchesBaseQuery(e,this.query)}}),t.exports=n}()},{"./ModelInstance":5,"./QuerySet":9,"./cache":13,"./error":16,"./log":19,"./util":25}],9:[function(e,t){function n(e){var t;return t="string"==typeof e||e instanceof String?b.concat(g):"number"==typeof e||e instanceof Number?m.concat(y):e.getOwnPropertyNames()}function r(e,t){t in e||Object.defineProperty(e,t,{get:function(){return a(p.pluck(e,t))},set:function(e){if(u.isArray(e)){if(this.length!=e.length)throw h({message:"Must be same length"});for(var n=0;n<e.length;n++)this[n][t]=e[n]}else for(n=0;n<this.length;n++)this[n][t]=e}})}function i(e){return e.then&&e["catch"]}function o(e,t){t in e||(e[t]=function(){var e=arguments,n=this.map(function(n){return n[t].apply(n,e)}),r=!1;return n.length&&(r=i(n[0])),r?d.all(n):a(n)})}function s(e,t){e=p.extend([],e);var n=t._attributeNames,i=t._relationshipNames,s=n.concat(i).concat(a);s.forEach(p.partial(r,e));var a=Object.keys(f.prototype);return a.forEach(p.partial(o,e)),c(e)}function a(e){if(e.length){var t=e[0],i=n(t);i.forEach(function(n){"function"==typeof t[n]?o(e,n,arguments):r(e,n)})}return c(e)}function l(){throw new Error("Cannot modify a query set")}function c(e){return v.forEach(function(t){e[t]=l}),e.immutable=!0,e.mutableCopy=e.asArray=function(){var e=p.map(this,function(e){return e});return e.asQuerySet=function(){return a(this)},e.asModelQuerySet=function(e){return s(this,e)},e},e}var u=e("./util"),d=u.Promise,h=e("./error"),f=e("./ModelInstance"),p=e("./util")._,v=["push","sort","reverse","splice","shift","unshift"],m=["toString","toExponential","toFixed","toPrecision","valueOf"],y=["MAX_VALUE","MIN_VALUE","NEGATIVE_INFINITY","NaN","POSITIVE_INFINITY"],b=["charAt","charCodeAt","concat","fromCharCode","indexOf","lastIndexOf","localeCompare","match","replace","search","slice","split","substr","substring","toLocaleLowerCase","toLocaleUpperCase","toLowerCase","toString","toUpperCase","trim","valueOf"],g=["length"];t.exports=s},{"./ModelInstance":5,"./error":16,"./util":25}],10:[function(e,t){!function(){function n(e){var t=this;i.call(this),s.call(this),d.extend(this,{insertionPolicy:n.InsertionPolicy.Back,initialised:!1}),Object.defineProperty(this,"query",{get:function(){return this._query},set:function(e){e?(this._query=e,this.results=c([],e.model)):(this._query=null,this.results=null)},configurable:!1,enumerable:!0}),e&&d.extend(this,{_query:e,results:c([],e.model)}),Object.defineProperties(this,{initialized:{get:function(){return this.initialised}},model:{get:function(){var e=t._query;return e?e.model:void 0}},collection:{get:function(){return t.model.collectionName}}})}var r=e("./log")("query:reactive"),i=(e("./Query"),e("events").EventEmitter),o=e("./events"),s=e("./Chain"),a=e("./modelEvents"),l=e("./error").InternalSiestaError,c=e("./QuerySet"),u=e("./util"),d=u._;n.prototype=Object.create(i.prototype),d.extend(n.prototype,s.prototype),d.extend(n,{InsertionPolicy:{Front:"Front",Back:"Back"}}),d.extend(n.prototype,{init:function(e,t){if(this._query)return r&&r("init"),u.promise(e,function(e){!this.initialised||t?this._query.execute(function(t,n){t?e(t):e(null,this._applyResults(n))}.bind(this)):e(null,this.results)}.bind(this));throw new l("No _query defined")},_applyResults:function(e){if(this.results=e,!this.handler){var t=this._constructNotificationName(),n=function(e){this._handleNotif(e)}.bind(this);this.handler=n,o.on(t,n)}return r("Listening to "+t),this.initialised=!0,this.results},insert:function(e){var t=this.results.mutableCopy();if(this.insertionPolicy==n.InsertionPolicy.Back)var r=t.push(e);else r=t.unshift(e);return this.results=t.asModelQuerySet(this.model),r},update:function(e){return this.init(e,!0)},_handleNotif:function(e){if(r("_handleNotif",e),e.type==a.ModelEventType.New){var t=e["new"];if(this._query.objectMatchesQuery(t)){r("New object matches",t);var n=this.insert(t);this.emit(a.ModelEventType.Splice,{index:n,added:[t],type:a.ModelEventType.Splice,obj:this})}else r("New object does not match",t)}else if(e.type==a.ModelEventType.Set){t=e.obj;var i=this.results.indexOf(t),o=i>-1,s=this._query.objectMatchesQuery(t);if(s&&!o)r("Updated object now matches!",t),n=this.insert(t),this.emit(a.ModelEventType.Splice,{index:n,added:[t],type:a.ModelEventType.Splice,obj:this});else if(!s&&o){r("Updated object no longer matches!",t),d=this.results.mutableCopy();var u=d.splice(i,1);this.results=d.asModelQuerySet(this.model),this.emit(a.ModelEventType.Splice,{index:i,obj:this,"new":t,type:a.ModelEventType.Splice,removed:u})}else s||o?s&&o&&(r("Matches but already contains",t),this.emit(e.type,e)):r("Does not contain, but doesnt match so not inserting",t)}else{if(e.type!=a.ModelEventType.Remove)throw new l('Unknown change type "'+e.type.toString()+'"');t=e.obj;var d=this.results.mutableCopy();i=d.indexOf(t),i>-1?(r("Removing object",t),u=d.splice(i,1),this.results=c(d,this.model),this.emit(a.ModelEventType.Splice,{index:i,obj:this,type:a.ModelEventType.Splice,removed:u})):r("No modelEvents neccessary.",t)}this.results=c(this._query._sortResults(this.results),this.model)},_constructNotificationName:function(){return this.model.collectionName+":"+this.model.name},terminate:function(){this.handler&&o.removeListener(this._constructNotificationName(),this.handler),this.results=null,this.handler=null},_registerEventHandler:function(e,t,n){var r=i.prototype.removeListener;return"*"==t.trim()?Object.keys(a.ModelEventType).forEach(function(t){e.call(this,a.ModelEventType[t],n)}.bind(this)):e.call(this,t,n),this._link({on:this.on.bind(this),once:this.once.bind(this),update:this.update.bind(this),insert:this.insert.bind(this)},function(){"*"==t.trim()?Object.keys(a.ModelEventType).forEach(function(e){r.call(this,a.ModelEventType[e],n)}.bind(this)):r.call(this,t,n)})},on:function(e,t){return this._registerEventHandler(i.prototype.on,e,t)},once:function(e,t){return this._registerEventHandler(i.prototype.once,e,t)}}),t.exports=n}()},{"./Chain":3,"./Query":8,"./QuerySet":9,"./error":16,"./events":17,"./log":19,"./modelEvents":22,"./util":25,events:30}],11:[function(e,t){!function(){function n(e){var t=this;e=e||{},o.extend(this,{object:null,related:null}),Object.defineProperties(this,{isForward:{get:function(){return!t.isReverse},set:function(e){t.isReverse=!e},enumerable:!0}}),i.extendFromOpts(this,e,{reverseModel:null,forwardModel:null,forwardName:null,reverseName:null,isReverse:null,serialise:null},!1),this.cancelListens={}}var r=e("./error").InternalSiestaError,i=(e("./store"),e("./util")),o=i._,s=(e("./Query"),e("./log"),e("./cache"),e("./events")),a=s.wrapArray,l=e("../vendor/observe-js/src/observe").ArrayObserver,c=e("./modelEvents"),u=c.ModelEventType;o.extend(n,{}),o.extend(n.prototype,{install:function(e){if(!e)throw new r("No object passed to relationship install");if(this.object)throw new r("Already installed.");this.object=e;var t=this,n=this.getForwardName();Object.defineProperty(e,n,{get:function(){return t.related},set:function(e){t.set(e)},configurable:!0,enumerable:!0}),e.__proxies||(e.__proxies={}),e.__proxies[n]=this,e._proxies||(e._proxies=[]),e._proxies.push(this)}}),o.extend(n.prototype,{set:function(){throw new r("Must subclass RelationshipProxy")},get:function(){throw new r("Must subclass RelationshipProxy")}}),o.extend(n.prototype,{proxyForInstance:function(e,t){var n,s=t?this.getReverseName():this.getForwardName(),a=t?this.reverseModel:this.forwardModel;if(i.isArray(e))n=o.map(e,function(e){return e.__proxies[s]});else{var l=e.__proxies[s];if(!l){var c='No proxy with name "'+s+'" on mapping '+a.name;throw new r(c)}n=l}return n},reverseProxyForInstance:function(e){return this.proxyForInstance(e,!0)},getReverseName:function(){return this.isForward?this.reverseName:this.forwardName},getForwardName:function(){return this.isForward?this.forwardName:this.reverseName},getForwardModel:function(){return this.isForward?this.forwardModel:this.reverseModel},clearRemovalListener:function(e){var t=e.localId,n=this.cancelListens[t];n&&(n(),this.cancelListens[t]=null)},listenForRemoval:function(e){this.cancelListens[e.localId]=e.on("*",function(t){if(t.type==u.Remove){if(i.isArray(this.related)){var n=this.related.indexOf(e);this.splice(n,1)}else this.setIdAndRelated(null);this.clearRemovalListener(e)}}.bind(this))},setIdAndRelated:function(e,t){if(t=t||{},!t.disableevents)var n=this._getOldValueForSetChangeEvent();var r=this.related;r&&this.clearRemovalListener(r),e?i.isArray(e)?(this.related=e,e.forEach(function(e){this.listenForRemoval(e)}.bind(this))):(this.related=e,this.listenForRemoval(e)):this.related=null,t.disableevents||this.registerSetChange(e,n)},checkInstalled:function(){if(!this.object)throw new r("Proxy must be installed on an object before can use it.")},splicer:function(e){return e=e||{},function(t,n){if(e=e||{},!e.disableevents)var r=this._getAddedForSpliceChangeEvent(arguments),i=this._getRemovedForSpliceChangeEvent(t,n);var s=Array.prototype.slice.call(arguments,2),a=o.partial(this.related.splice,t,n).apply(this.related,s);return e.disableevents||this.registerSpliceChange(t,r,i),a}.bind(this)},clearReverseRelated:function(e){e=e||{};var t=this;if(this.related){var n=this.reverseProxyForInstance(this.related),r=i.isArray(n)?n:[n];o.each(r,function(n){if(i.isArray(n.related)){var r=n.related.indexOf(t.object);n.makeChangesToRelatedWithoutObservations(function(){n.splicer(e)(r,1)})}else n.setIdAndRelated(null,e)})}},setIdAndRelatedReverse:function(e,t){var n=this,r=this.reverseProxyForInstance(e),s=i.isArray(r)?r:[r];o.each(s,function(e){i.isArray(e.related)?e.makeChangesToRelatedWithoutObservations(function(){e.splicer(t)(e.related.length,0,n.object)}):(e.clearReverseRelated(t),e.setIdAndRelated(n.object,t))})},makeChangesToRelatedWithoutObservations:function(e){this.related?(this.related.arrayObserver.close(),this.related.arrayObserver=null,e(),this.wrapArray(this.related)):e()},_getOldValueForSetChangeEvent:function(){var e=this.related;return i.isArray(e)&&!e.length&&(e=null),e},registerSetChange:function(e,t){var n=this.object;if(!n)throw new r("Proxy must have an object associated");var i=n.model.name,o=n.collectionName;c.emit({collection:o,model:i,localId:n.localId,field:this.getForwardName(),old:t,"new":e,type:u.Set,obj:n})},_getRemovedForSpliceChangeEvent:function(e,t){var n=this.related?this.related.slice(e,e+t):null;return n},_getAddedForSpliceChangeEvent:function(e){var t=Array.prototype.slice.call(e,2),n=t.length?t:[];return n},registerSpliceChange:function(e,t,n){var r=this.object.model.name,i=this.object.collectionName;c.emit({collection:i,model:r,localId:this.object.localId,field:this.getForwardName(),index:e,removed:n,added:t,type:u.Splice,obj:this.object})},wrapArray:function(e){var t=this;if(a(e,this.reverseName,this.object),!e.arrayObserver){e.arrayObserver=new l(e);var n=function(n){n.forEach(function(n){var r=n.addedCount?e.slice(n.index,n.index+n.addedCount):[],i=t.getForwardModel();c.emit({collection:i.collectionName,model:i.name,localId:t.object.localId,field:t.getForwardName(),removed:n.removed,added:r,type:u.Splice,obj:t.object})})};e.arrayObserver.open(n)}},splice:function(){this.splicer({}).apply(this,arguments)}}),t.exports=n}()},{"../vendor/observe-js/src/observe":54,"./Query":8,"./cache":13,"./error":16,"./events":17,"./log":19,"./modelEvents":22,"./store":23,"./util":25}],12:[function(e,t){!function(){t.exports={OneToMany:"OneToMany",OneToOne:"OneToOne",ManyToMany:"ManyToMany"}}()},{}],13:[function(e,t,n){!function(){function t(){x={},g={},_={}}function r(e){var t=g[e];return m(t?"Local cache hit: "+t._dump(!0):"Local cache miss: "+e),t}function i(e){var t=e.name,n=e.collectionName,r=_[n];if(r){var i=r[t];if(i){var o=[];for(var s in i)i.hasOwnProperty(s)&&o.push(i[s]);if(o.length>1){var a="A singleton model has more than 1 object in the cache! This is a serious error. Either a model has been modified after objects have already been created, or something has gonevery wrong. Please file a bug report if the latter.";
throw new y(a)}if(o.length)return o[0]}}return null}function o(e,t){var n=t.model.name,r=t.model.collectionName,i=x[r];if(i){var o=x[r][n];if(o){var s=o[e];return m(s?"Remote cache hit: "+s._dump(!0):"Remote cache miss: "+e),s}}return m("Remote cache miss: "+e),null}function s(e,t,n){if(!e){var r="Must pass an object when inserting to cache";throw m(r),new y(r)}var i=e.model.collectionName;if(!i)throw new y("Model has no collection",{model:e.model,obj:e});x[i]||(x[i]={});var o=e.model.name;if(!o)throw new y("Model has no type",{model:e.model,obj:e});x[i][o]||(x[i][o]={}),n&&(x[i][o][n]=null);var s=x[i][o][t];if(s){if(e!=s){var l="Object "+i.toString()+":"+o.toString()+"["+e.model.id+'="'+t+'"] already exists in the cache. This is a serious error, please file a bug report if you are experiencing this out in the wild';throw m(l,{obj:e,cachedObject:s}),new y(l)}m("Object has already been inserted: "+e._dump(!0))}else x[i][o][t]=e,m("Remote cache insert: "+e._dump(!0)),m("Remote cache now looks like: "+a(!0))}function a(e){var t={};for(var n in x)if(x.hasOwnProperty(n)){var r={};t[n]=r;var i=x[n];for(var o in i)if(i.hasOwnProperty(o)){var s={};r[o]=s;var a=i[o];for(var l in a)a.hasOwnProperty(l)&&a[l]&&(s[l]=a[l]._dump())}}return e?b.prettyPrint(4):t}function l(e){var t={};for(var n in g)g.hasOwnProperty(n)&&(t[n]=g[n]._dump());return e?b.prettyPrint(4):t}function c(e){var t={localCache:l(),remoteCache:a()};return e?b.prettyPrint(4):t}function u(){return x}function d(){return g}function h(e){m("get",e);var t,n,s,a=e.localId;if(a)return t=r(a),t?t:e.model?(n=e.model.id,s=e[n],m(n+"="+s),o(s,e)):null;if(e.model){if(n=e.model.id,s=e[n])return o(s,e);if(e.model.singleton)return i(e.model)}else m("Invalid opts to cache",{opts:e});return null}function f(e){var t=e.localId;if(t){var n=e.model.collectionName,r=e.model.name;if(m("Local cache insert: "+e._dumpString()),g[t]){if(g[t]!=e){var i='Object with localId="'+t.toString()+'" is already in the cache. This is a serious error. Please file a bug report if you are experiencing this out in the wild';throw m(i),new y(i)}}else g[t]=e,m("Local cache now looks like: "+l(!0)),_[n]||(_[n]={}),_[n][r]||(_[n][r]={}),_[n][r][t]=e}var o=e.idField,a=e[o];a?s(e,a):m('No remote id ("'+o+'") so wont be placing in the remote cache',e)}function p(e){var t={localId:e.localId},n=e.model;return n.id&&e[n.id]&&(t.model=n,t[n.id]=e[n.id]),!!h(t)}function v(e){if(p(e)){var t=e.model.collectionName,n=e.model.name,r=e.localId;if(!n)throw y("No mapping name");if(!t)throw y("No collection name");if(!r)throw y("No localId");if(delete _[t][n][r],delete g[r],e.model.id){var i=e[e.model.id];i&&delete x[t][n][i]}}}var m=e("./log")("cache"),y=e("./error").InternalSiestaError,b=e("./util"),g={},_={},x={};n._remoteCache=u,n._localCache=d,Object.defineProperty(n,"_localCacheByType",{get:function(){return _}}),n.get=h,n.insert=f,n.remoteInsert=s,n.reset=t,n._dump=c,n.contains=p,n.remove=v,n.getSingleton=i,n.count=function(){return Object.keys(g).length}}()},{"./error":16,"./log":19,"./util":25}],14:[function(e,t){!function(){function n(e,t){var n=this;if(!e)throw new Error("Collection must have a name");t=t||{},c.extendFromOpts(this,t,{baseURL:""}),u.extend(this,{name:e,_rawModels:{},_models:{},_opts:t,installed:!1}),Object.defineProperties(this,{dirty:{get:function(){if(siesta.ext.storageEnabled){var e=siesta.ext.storage._unsavedObjectsByCollection,t=e[n.name]||{};return!!Object.keys(t).length}return void 0},enumerable:!0}}),i.register(this),l.ProxyEventEmitter.call(this,this.name)}{var r=e("./log")("collection"),i=e("./collectionRegistry").CollectionRegistry,o=e("./error").InternalSiestaError,s=e("./model"),a=e("extend"),l=(e("../vendor/observe-js/src/observe").Platform,e("./events")),c=e("./util"),u=c._,d=e("./error");e("./cache")}n.prototype=Object.create(l.ProxyEventEmitter.prototype),u.extend(n.prototype,{install:function(e){return c.promise(e,function(e){var t=this;if(this.installed)throw new o('Collection "'+this.name+'" has already been installed');var n=[];for(var i in this._models)if(this._models.hasOwnProperty(i)){var s=this._models[i];n.push(s)}if(r("There are "+n.length.toString()+" mappings to install"),n.length){var a=u.map(n,function(e){return u.bind(e.install,e)});c.async.parallel(a,function(i){if(i)r("Failed to install collection",i),t._finaliseInstallation(i,e);else{t.installed=!0;var o=[];u.each(n,function(e){r('Installing relationships for mapping with name "'+e.name+'"');var t=e.installRelationships();t&&o.push(t)}),o.length||u.each(n,function(e){r('Installing reverse relationships for mapping with name "'+e.name+'"');var t=e.installReverseRelationships();t&&o.push(t)}),1==o.length?i=o[0]:o.length&&(i=o),t._finaliseInstallation(i,e)}})}else t._finaliseInstallation(null,e)}.bind(this))},_finaliseInstallation:function(t,n){if(t&&(t=d("Errors were encountered whilst setting up the collection",{errors:t})),!t){this.installed=!0;var r=e("./index");r[this.name]=this}n(t)},_model:function(e,t){if(e){this._rawModels[e]=t,t=a(!0,{},t),t.name=e,t.collection=this;var n=new s(t);return this._models[e]=n,this[e]=n,n}throw new Error("No name specified when creating mapping")},model:function(){var e=!this.installed;if(!e)throw Error("Cannot create new models once the object graph is established!");var t=this;if(arguments.length){if(1==arguments.length){if(c.isArray(arguments[0]))return u.map(arguments[0],function(e){return t._model(e.name,e)});var n,r;return c.isString(arguments[0])?(n=arguments[0],r={}):(r=arguments[0],n=r.name),this._model(n,r)}return"string"==typeof arguments[0]?this._model(arguments[0],arguments[1]):u.map(arguments,function(e){return t._model(e.name,e)})}return null},_dump:function(e){var t={};return t.installed=this.installed,t.docId=this._docId,t.name=this.name,t.baseURL=this.baseURL,e?c.prettyPrint(t):t},count:function(e){return c.promise(e,function(e){var t=u.map(this._models,function(e){return u.bind(e.count,e)});c.async.parallel(t,function(t,n){var r;t||(r=u.reduce(n,function(e,t){return e+t},0)),e(t,r)})}.bind(this))},graph:function(e,t,n){return"function"==typeof t&&(n=t),t=t||{},c.promise(n,function(t){var n,r=[];for(var i in e)if(e.hasOwnProperty(i)){var o=this._models[i];o?!function(e,t){r.push(function(n){e.graph(t,function(t,r){if(!t){var i={};i[e.name]=r}n(t,i)})})}(o,e[i]):n='No such model "'+i+'"'}n?t(d(n,{data:e,invalidModelName:i})):c.async.series(r,function(e,n){n=e?null:n.reduce(function(e,t){return u.extend(e,t)},{}),t(e,n)})}.bind(this))},removeAll:function(e){return c.promise(e,function(e){c.Promise.all(Object.keys(this._models).map(function(e){var t=this._models[e];return t.removeAll()}.bind(this))).then(function(){e(null)})["catch"](e)}.bind(this))}}),t.exports=n}()},{"../vendor/observe-js/src/observe":54,"./cache":13,"./collectionRegistry":15,"./error":16,"./events":17,"./index":void 0,"./log":19,"./model":21,"./util":25,extend:34}],15:[function(e,t,n){!function(){function t(){return this?void(this.collectionNames=[]):new t}var r=e("./util")._;r.extend(t.prototype,{register:function(e){var t=e.name;this[t]=e,this.collectionNames.push(t)},reset:function(){var e=this;r.each(this.collectionNames,function(t){delete e[t]}),this.collectionNames=[]}}),n.CollectionRegistry=new t}()},{"./util":25}],16:[function(e,t){!function(){function e(e,t,n){this.message=e,this.context=t,n&&Error.captureStackTrace&&Error.captureStackTrace(this,n)}function n(e){return"object"==typeof e?"error"in e&&"ok"in e&&"reason"in e:!1}e.prototype=Object.create(Error.prototype),e.prototype.name="InternalSiestaError",e.prototype.constructor=e,t.exports=function(e,t){if(n(e))return e;var r={reason:e,error:!0,ok:!1};for(var i in t||{})t.hasOwnProperty(i)&&(r[i]=t[i]);return r.toString=function(){return JSON.stringify(this)},r},t.exports.InternalSiestaError=e}()},{}],17:[function(e,t){!function(){function n(e,t){s.extend(this,{event:e,listeners:{}});var n={};n.on=this.on.bind(this),n.once=this.once.bind(this),l.call(this,s.extend(n,t||{}))}var r=e("events").EventEmitter,i=e("../vendor/observe-js/src/observe").ArrayObserver,o=e("./util"),s=(e("argsarray"),o._),a=e("./modelEvents"),l=e("./Chain"),c=new r;c.setMaxListeners(100),n.prototype=Object.create(l.prototype),s.extend(n.prototype,{on:function(e,t){if("function"==typeof e)t=e,e=null;else{"*"==e.trim()&&(e=null);var n=t;t=function(t){t=t||{},e?t.type==e&&n(t):n(t)};var r=this.listeners;e&&(r[e]||(r[e]=[]),r[e].push(t))}return c.on(this.event,t),this._handlerLink({fn:t,type:e,extend:this.proxyChainOpts})},once:function(e,t){var n=this.event;if("function"==typeof e)t=e,e=null;else{"*"==e.trim()&&(e=null);var r=t;t=function(i){i=i||{},e?i.type==e&&(c.removeListener(n,t),r(i)):r(i)}}return e?c.on(n,t):c.once(n,t)},_removeListener:function(e,t){if(t){var n=this.listeners[t],r=n.indexOf(e);n.splice(r,1)}return c.removeListener(this.event,e)},emit:function(e,t){"object"==typeof e?(t=e,e=null):(t=t||{},t.type=e),c.emit.call(c,this.event,t)},_removeAllListeners:function(e){(this.listeners[e]||[]).forEach(function(e){c.removeListener(this.event,e)}.bind(this)),this.listeners[e]=[]},removeAllListeners:function(e){if(e)this._removeAllListeners(e);else for(e in this.listeners)this.listeners.hasOwnProperty(e)&&this._removeAllListeners(e)}}),s.extend(c,{ProxyEventEmitter:n,wrapArray:function(e,t,n){e.observer||(e.observer=new i(e),e.observer.open(function(r){var i=n._attributeNames.indexOf(t)>-1;i&&r.forEach(function(r){a.emit({collection:n.collectionName,model:n.model.name,localId:n.localId,index:r.index,removed:r.removed,added:r.addedCount?e.slice(r.index,r.index+r.addedCount):[],type:a.ModelEventType.Splice,field:t,obj:n})})}))}}),t.exports=c}()},{"../vendor/observe-js/src/observe":54,"./Chain":3,"./modelEvents":22,"./util":25,argsarray:28,events:30}],18:[function(e,t){!function(){function n(e){this.model=e}var r=e("./log")("model"),i=e("./error").InternalSiestaError,o=e("./RelationshipType"),s=(e("./Query"),e("./ModelInstance")),a=e("./util"),l=a._,c=a.guid,u=e("./cache"),d=(e("./store"),e("extend"),e("./modelEvents")),h=e("./events").wrapArray,f=e("./OneToManyProxy"),p=e("./OneToOneProxy"),v=e("./ManyToManyProxy"),m=(e("./ReactiveQuery"),e("./ArrangedReactiveQuery"),d.ModelEventType);n.prototype={_getLocalId:function(e){var t;return t=e&&e.localId?e.localId:c()},_installAttributes:function(e,t){var n=this.model,r=n._attributeNames,i=r.indexOf(n.id);l.extend(e,{__values:l.extend(l.reduce(n.attributes,function(e,t){return void 0!==t["default"]&&(e[t.name]=t["default"]),e},{}),t||{})}),i>-1&&r.splice(i,1),l.each(r,function(t){var r=n._attributeDefinitionWithName(t);Object.defineProperty(e,t,{get:function(){var n=e.__values[t];return void 0===n?null:n},set:function(i){r.parse&&(i=r.parse.call(e,i)),n.parseAttribute&&(i=n.parseAttribute.call(e,t,i));var o=e.__values[t],s=this._propertyDependencies[t];s=l.map(s,function(e){return{prop:e,old:this[e]}}.bind(this)),e.__values[t]=i,s.forEach(function(t){var r=t.prop,i=this[r];d.emit({collection:n.collectionName,model:n.name,localId:e.localId,"new":i,old:t.old,type:m.Set,field:r,obj:e})}.bind(this));var c={collection:n.collectionName,model:n.name,localId:e.localId,"new":i,old:o,type:m.Set,field:t,obj:e};window.lastEmission=c,d.emit(c),a.isArray(i)&&h(i,t,e)},enumerable:!0,configurable:!0})})},_installMethods:function(e){var t=this.model;l.each(Object.keys(t.methods),function(n){void 0===e[n]?e[n]=t.methods[n].bind(e):r('A method with name "'+n+'" already exists. Ignoring it.')}.bind(this))},_installProperties:function(e){var t=Object.keys(this.model.properties),n={};l.each(t,function(t){var i=this.model.properties[t],o=i.dependencies||[];o.forEach(function(e){n[e]||(n[e]=[]),n[e].push(t)}),delete i.dependencies,void 0===e[t]?Object.defineProperty(e,t,i):r('A property/method with name "'+t+'" already exists. Ignoring it.')}.bind(this)),e._propertyDependencies=n},_installRemoteId:function(e){var t=this.model,n=t.id;Object.defineProperty(e,n,{get:function(){return e.__values[t.id]||null},set:function(n){var r=e[t.id];e.__values[t.id]=n,d.emit({collection:t.collectionName,model:t.name,localId:e.localId,"new":n,old:r,type:m.Set,field:t.id,obj:e}),u.remoteInsert(e,n,r)},enumerable:!0,configurable:!0})},_installRelationships:function(e){var t=this.model;for(var n in t.relationships){var r;if(t.relationships.hasOwnProperty(n)){var s=l.extend({},t.relationships[n]),a=s.type;if(delete s.type,a==o.OneToMany)r=new f(s);else if(a==o.OneToOne)r=new p(s);else{if(a!=o.ManyToMany)throw new i("No such relationship type: "+a);r=new v(s)}}r.install(e)}},_registerInstance:function(e,t){u.insert(e),t=void 0===t?!0:t,t&&d.emit({collection:this.model.collectionName,model:this.model.name,localId:e.localId,"new":e,type:m.New,obj:e})},_installLocalId:function(e,t){e.localId=this._getLocalId(t)},_instance:function(e,t){if(this.model.installed){var n=new s(this.model);return this._installLocalId(n,e),this._installAttributes(n,e),this._installMethods(n),this._installProperties(n),this._installRemoteId(n),this._installRelationships(n),this._registerInstance(n,t),n}throw new i("Model must be fully installed before creating any models")}},t.exports=function(e){var t=new n(e);return t._instance.bind(t)}}()},{"./ArrangedReactiveQuery":2,"./ManyToManyProxy":4,"./ModelInstance":5,"./OneToManyProxy":6,"./OneToOneProxy":7,"./Query":8,"./ReactiveQuery":10,"./RelationshipType":12,"./cache":13,"./error":16,"./events":17,"./log":19,"./modelEvents":22,"./store":23,"./util":25,extend:34}],19:[function(e,t){!function(){var n=e("debug"),r=e("argsarray");t.exports=function(e){var t=n("siesta:"+e),i=r(function(e){t.call(t,e)});return Object.defineProperty(i,"enabled",{get:function(){return n.enabled(e)}}),i}}()},{argsarray:28,debug:31}],20:[function(e,t){!function(){function n(e){this.opts=e}function r(e){this._opts=e,l.extendFromOpts(this,e,{model:null,data:null,objects:[],disableevents:!1,_ignoreInstalled:!1,fromStorage:!1}),c.extend(this,{errors:[],subTaskResults:{},_newObjects:[]}),this.data=this.preprocessData()}var i=e("./store"),o=e("./ModelInstance"),s=e("./log")("graph"),a=e("./cache"),l=e("./util"),c=l._,u=l.async;n.prototype.toString=function(){return JSON.stringify(this.opts,null,4)},c.extend(r.prototype,{mapAttributes:function(){for(var e=0;e<this.data.length;e++){var t=this.data[e],n=this.objects[e];if(t!=n&&n){var r=this.model._attributeNames;c.each(r,function(e){void 0!==t[e]&&(this.disableevents?n.__values[e]=t[e]:n[e]=t[e])}.bind(this)),t._rev&&(n._rev=t._rev)}}},_map:function(){var e,t=this;this.mapAttributes();var n=c.keys(t.subTaskResults);c.each(n,function(n){for(var r=t.subTaskResults[n],i=r.indexes,o=r.objects,s=t.getRelatedData(n).relatedData,a=l.unflattenArray(o,s),c=0;c<a.length;c++){var u=i[c],d=t.errors[u];if(e=d?d[n]:null,!e){var h=a[c],f=t.objects[u];f&&(e=f.__proxies[n].set(h,{disableevents:t.disableevents}),e&&(t.errors[u]||(t.errors[u]={}),t.errors[u][n]=e))}}})},_lookup:function(e){return l.promise(e,function(e){for(var t=this,n=[],r=[],u=0;u<this.data.length;u++)if(!this.objects[u]){var d,h=this.data[u],f="string"==typeof h||"number"==typeof h||h instanceof String;h?f?(d={index:u,datum:{}},d.datum[t.model.id]=h,n.push(d)):h instanceof o?this.objects[u]=h:h.localId?r.push({index:u,datum:h}):h[t.model.id]?n.push({index:u,datum:h}):this.objects[u]=t._instance():this.objects[u]=null}l.async.parallel([function(e){var n=c.pluck(c.pluck(r,"datum"),"localId");n.length?i.getMultipleLocal(n,function(i,o){if(!i)for(var s=0;s<n.length;s++){var l=o[s],c=n[s],u=r[s];l?t.objects[u.index]=l:(l=a.get({localId:c}),l||(l=t._instance({localId:c},!t.disableevents)),t.objects[u.index]=l)}e(i)}):e()},function(e){var r=c.pluck(c.pluck(n,"datum"),t.model.id);r.length?i.getMultipleRemote(r,t.model,function(i,o){if(!i){if(s.enabled){var l={};for(u=0;u<o.length;u++)l[r[u]]=o[u]?o[u].localId:null}for(u=0;u<o.length;u++){var c=o[u],d=n[u];if(c)t.objects[d.index]=c;else{var h={},f=r[u];h[t.model.id]=f;var p={model:t.model};p[t.model.id]=f;var v=a.get(p);v?t.objects[d.index]=v:(t.objects[d.index]=t._instance(),t.objects[d.index][t.model.id]=f)}}}e(i)}):e()}],e)}.bind(this))},_lookupSingleton:function(e){return l.promise(e,function(e){var t,n=this,r=c.pluck(n.data,"localId");for(o=0;o<r.length;o++)if(r[o]){t={localId:r[o]};break}for(var i=a.getSingleton(this.model)||this._instance(t),o=0;o<n.data.length;o++)n.objects[o]=i;e()}.bind(this))},_instance:function(){var e=this.model,t=e._instance.apply(e,arguments);return this._newObjects.push(t),t},preprocessData:function(){var e=c.extend([],this.data);return c.map(e,function(e){if(e&&!l.isString(e)){var t=c.keys(e);c.each(t,function(t){var n=this.model._relationshipNames.indexOf(t)>-1;if(n){var r=e[t];r instanceof o?e[t]={localId:r.localId}:l.isArray(r)&&(e[t]=c.each(r,function(e){return e instanceof o?{localId:r.localId}:r}))}}.bind(this))}return e}.bind(this))},start:function(e){var t=this.data;if(t.length){var n=this,r=[],i=this.model.singleton?this._lookupSingleton:this._lookup;r.push(c.bind(i,this)),r.push(c.bind(this._executeSubOperations,this)),l.async.parallel(r,function(){try{n._map();var t=this.fromStorage,r=c.reduce(n._newObjects,function(n,r){var i=r.model.init;if(i){var o=l.paramNames(i);o.length>1?n.push(c.bind(i,r,t,e)):i.call(r,t)}return n},[]);u.parallel(r,function(){e(n.errors.length?n.errors:null,n.objects)})}catch(i){console.error("Uncaught error when executing init funcitons on models.",i),e(i)}}.bind(this))}else e(null,[])},getRelatedData:function(e){for(var t=[],n=[],r=0;r<this.data.length;r++){var i=this.data[r];if(i){var o=i[e];o&&(t.push(r),n.push(o))}}return{indexes:t,relatedData:n}},processErrorsFromTask:function(e,t,n){if(t.length)for(var r=this.getRelatedData(e).relatedData,i=l.unflattenArray(t,r),o=0;o<i.length;o++){var s=n[o],a=i[o],u=a;l.isArray(a)&&(u=c.reduce(a,function(e,t){return e||t},!1)),u&&(this.errors[s]||(this.errors[s]={}),this.errors[s][e]=a)}},_executeSubOperations:function(e){var t=this,n=c.keys(this.model.relationships);if(n.length){var i=c.reduce(n,function(e,n){var i=t.model.relationships[n],o=i.forwardName==n?i.reverseModel:i.forwardModel;o.singleton&&!i.isReverse&&this.data.forEach(function(e){e[n]||(e[n]={})});var s=this.getRelatedData(n),a=s.indexes,c=s.relatedData;if(c.length)var u=l.flattenArray(c),d=new r({model:o,data:u,disableevents:t.disableevents,_ignoreInstalled:t._ignoreInstalled,fromStorage:this.fromStorage});if(d){var h;h=function(e){d.start(function(r,i){t.subTaskResults[n]={errors:r,objects:i,indexes:a},t.processErrorsFromTask(n,d.errors,a),e()})},e.push(h)}return e}.bind(this),[]);u.parallel(i,function(t){e(t)})}else e()}}),t.exports=r}()},{"./ModelInstance":5,"./cache":13,"./log":19,"./store":23,"./util":25}],21:[function(e,t){!function(){function n(e){var t=this;this._opts=e?b.extend({},e):{},c.extendFromOpts(this,e,{methods:{},attributes:[],collection:function(e){return c.isString(e)&&(e=i[e]),e},id:"id",relationships:[],name:null,indexes:[],singleton:!1,statics:this.installStatics.bind(this),properties:{},init:null,serialise:null,serialiseField:null,serialisableFields:null,remove:null,parseAttribute:null,store:null},!1),this.parseAttribute||(this.parseAttribute=function(e,t){return t}),this.serialiseField||(this.serialiseField=function(e,t){return t}),void 0===this.store||null===this.store?this.store=function(){return!0}:this.store===!1?this.store=function(){return!1}:this.store===!0&&(this.store=function(){return!0}),this.attributes=n._processAttributes(this.attributes),this._instance=new m(this),b.extend(this,{_installed:!1,_relationshipsInstalled:!1,_reverseRelationshipsInstalled:!1,children:[]}),Object.defineProperties(this,{_relationshipNames:{get:function(){return Object.keys(t.relationships)},enumerable:!0},_attributeNames:{get:function(){var e=[];return t.id&&e.push(t.id),b.each(t.attributes,function(t){e.push(t.name)}),e},enumerable:!0,configurable:!0},installed:{get:function(){return t._installed&&t._relationshipsInstalled&&t._reverseRelationshipsInstalled},enumerable:!0,configurable:!0},descendants:{get:function(){return b.reduce(t.children,function(e,t){return Array.prototype.concat.call(e,t.descendants)}.bind(t),b.extend([],t.children))},enumerable:!0},dirty:{get:function(){if(siesta.ext.storageEnabled){var e=siesta.ext.storage._unsavedObjectsByCollection,t=(e[this.collectionName]||{})[this.name]||{};return!!Object.keys(t).length}return void 0},enumerable:!0},collectionName:{get:function(){return this.collection.name},enumerable:!0}});var r=this.collectionName+":"+this.name,o={query:this.query.bind(this)};p.ProxyEventEmitter.call(this,r,o)}var r=e("./log")("model"),i=e("./collectionRegistry").CollectionRegistry,o=e("./error").InternalSiestaError,s=e("./RelationshipType"),a=e("./Query"),l=e("./mappingOperation"),c=(e("./ModelInstance"),e("./util")),u=e("./cache"),d=(e("./store"),e("argsarray")),h=e("./error"),f=e("extend"),p=(e("./modelEvents"),e("./events")),v=(e("./OneToOneProxy"),e("./ManyToManyProxy"),e("./ReactiveQuery")),m=e("./instanceFactory"),y=e("./ArrangedReactiveQuery"),b=c._;b.extend(n,{_processAttributes:function(e){return b.reduce(e,function(e,t){return e.push("string"==typeof t?{name:t}:t),e},[])}}),n.prototype=Object.create(p.ProxyEventEmitter.prototype),b.extend(n.prototype,{installStatics:function(e){return e&&b.each(Object.keys(e),function(t){this[t]?r('Static method with name "'+t+'" already exists. Ignoring it.'):this[t]=e[t].bind(this)}.bind(this)),e},_validateRelationshipType:function(e){return e.type||(e.type=this.singleton?s.OneToOne:s.OneToMany),this.singleton&&e.type==s.ManyToMany?"Singleton model cannot use ManyToMany relationship.":Object.keys(s).indexOf(e.type)<0?"Relationship type "+e.type+" does not exist":null},installRelationships:function(){if(this._relationshipsInstalled)throw new o('Relationships for "'+this.name+'" have already been installed');var e=this,t=null;if(e._relationships=[],e._opts.relationships)for(var s in e._opts.relationships)if(e._opts.relationships.hasOwnProperty(s)){var a=e._opts.relationships[s];if(!(a.isReverse||(r(this.name+": configuring relationship "+s,a),t=this._validateRelationshipType(a)))){var l=a.model;if(!l)return"Must pass model";delete a.model;var c;if(l instanceof n)c=l;else{if(r("reverseModelName",l),!e.collection)throw new o("Model must have collection");var u=e.collection;if(!u)throw new o("Collection "+e.collectionName+" not registered");c=u[l]}if(!c){var d=l.split(".");if(2==d.length){var h=d[0];l=d[1];var f=i[h];if(!f)return'Collection with name "'+h+'" does not exist.';c=f[l]}}if(r("reverseModel",c),!c)return'Model with name "'+l.toString()+'" does not exist';b.extend(a,{reverseModel:c,forwardModel:this,forwardName:s,reverseName:a.reverse||"reverse_"+s,isReverse:!1}),delete a.reverse}}return t||(this._relationshipsInstalled=!0),t},installReverseRelationships:function(){var e=[];if(this._reverseRelationshipsInstalled)throw new o('Reverse relationships for "'+this.name+'" have already been installed.');for(var t in this.relationships)if(this.relationships.hasOwnProperty(t)){var n=this.relationships[t];n=f(!0,{},n),n.isReverse=!0;var i=n.reverseModel,a=n.reverseName,l=n.forwardModel;if(i!=this||i==l){if(e.push(a),i.singleton){if(n.type==s.ManyToMany)return"Singleton model cannot be related via reverse ManyToMany";if(n.type==s.OneToMany)return"Singleton model cannot be related via reverse OneToMany"}if(r(this.name+": configuring  reverse relationship "+a),i.relationships[a]){var c=i.relationships[a].forwardModel.isAncestorOf(this),u=i.relationships[a].forwardModel.isDescendantOf(this);if(!c&&!u)return'Reverse relationship "'+a+'" already exists on model "'+i.name+'"'}i.relationships[a]=n}}this._reverseRelationshipsInstalled=!0},_query:function(e){return new a(this,e||{})},query:function(e,t){var n,r=c.promise(t,function(t){return this.singleton?(n=this._query({__ignoreInstalled:!0}),void n.execute(function(r,i){r?t(r):(e=b.extend({},e),e.__ignoreInstalled=!0,i.length?(n=this._query(e),n.execute(t)):this.graph({},function(r){r?t(r):(n=this._query(e),n.execute(t))}.bind(this)))}.bind(this))):(n=this._query(e),n.execute(t))}.bind(this)),i=new c.Promise(function(e,t){r.then(d(function(t){setTimeout(function(){e.apply(null,t)})}),d(function(e){setTimeout(function(){t.apply(null,e)})}))});return this._link({then:i.then.bind(i),"catch":i["catch"].bind(i),on:d(function(t){var n=new v(this._query(e));n.init(),n.on.apply(n,t)}.bind(this))})},_reactiveQuery:function(e){return new v(new a(this,e||{}))},_arrangedReactiveQuery:function(e){return new y(new a(this,e||{}))},one:function(e,t){return"function"==typeof e&&(t=e,e={}),c.promise(t,function(t){this.query(e,function(e,n){e?t(e):n.length>1?t(h("More than one instance returned when executing get query!")):(n=n.length?n[0]:null,t(null,n))})}.bind(this))},all:function(e,t){"function"==typeof e&&(t=e,e={}),e=e||{};var n={};return e.__order&&(n.__order=e.__order),this.query(e,t)},_attributeDefinitionWithName:function(e){for(var t=0;t<this.attributes.length;t++){var n=this.attributes[t];if(n.name==e)return n}},install:function(e){return r("Installing mapping "+this.name),c.promise(e,function(e){if(this._installed)throw new o('Model "'+this.name+'" has already been installed');this._installed=!0,e()}.bind(this))},graph:function(e,t,n){return"function"==typeof t&&(n=t),t=t||{},c.promise(n,function(n){var r=function(){var r=t.override;r&&(t.objects=c.isArray(r)?r:[r]),delete t.override,c.isArray(e)?this._mapBulk(e,t,n):this._mapBulk([e],t,function(t,r){var i;r&&r.length&&(i=r[0]),t=t?c.isArray(e)?t:c.isArray(t)?t[0]:t:null,n(t,i)})}.bind(this);t._ignoreInstalled?r():siesta._afterInstall(r)}.bind(this))},_mapBulk:function(e,t,n){b.extend(t,{model:this,data:e});var r=new l(t);r.start(function(e,t){e?n&&n(e):n(null,t||[])})},_countCache:function(){var e=u._localCacheByType[this.collectionName]||{},t=e[this.name]||{};return b.reduce(Object.keys(t),function(e,t){return e[t]={},e},{})},count:function(e){return c.promise(e,function(e){e(null,Object.keys(this._countCache()).length)}.bind(this))},_dump:function(e){var t={};return t.name=this.name,t.attributes=this.attributes,t.id=this.id,t.collection=this.collectionName,t.relationships=b.map(this.relationships,function(e){return e.isForward?e.forwardName:e.reverseName}),e?c.prettyPrint(t):t},toString:function(){return"Model["+this.name+"]"},removeAll:function(e){return c.promise(e,function(e){this.all().then(function(t){t.remove(),e()})["catch"](e)}.bind(this))}}),b.extend(n.prototype,{child:function(e,t){"string"==typeof e?t.name=e:t=name,b.extend(t,{attributes:Array.prototype.concat.call(t.attributes||[],this._opts.attributes),relationships:b.extend(t.relationships||{},this._opts.relationships),methods:b.extend(b.extend({},this._opts.methods)||{},t.methods),statics:b.extend(b.extend({},this._opts.statics)||{},t.statics),properties:b.extend(b.extend({},this._opts.properties)||{},t.properties),id:t.id||this._opts.id,init:t.init||this._opts.init,remove:t.remove||this._opts.remove,serialise:t.serialise||this._opts.serialise,serialiseField:t.serialiseField||this._opts.serialiseField,parseAttribute:t.parseAttribute||this._opts.parseAttribute,store:void 0==t.store?this._opts.store:t.store}),this._opts.serialisableFields&&(t.serialisableFields=Array.prototype.concat.apply(t.serialisableFields||[],this._opts.serialisableFields));var n=this.collection.model(t.name,t);return n.parent=this,this.children.push(n),n},isChildOf:function(e){return this.parent==e},isParentOf:function(e){return this.children.indexOf(e)>-1},isDescendantOf:function(e){for(var t=this.parent;t;){if(t==e)return!0;t=t.parent}return!1},isAncestorOf:function(e){return this.descendants.indexOf(e)>-1},hasAttributeNamed:function(e){return this._attributeNames.indexOf(e)>-1}}),t.exports=n}()},{"./ArrangedReactiveQuery":2,"./ManyToManyProxy":4,"./ModelInstance":5,"./OneToOneProxy":7,"./Query":8,"./ReactiveQuery":10,"./RelationshipType":12,"./cache":13,"./collectionRegistry":15,"./error":16,"./events":17,"./instanceFactory":18,"./log":19,"./mappingOperation":20,"./modelEvents":22,"./store":23,"./util":25,argsarray:28,extend:34}],22:[function(e,t,n){!function(){function t(e){this._opts=e||{},Object.keys(e).forEach(function(t){this[t]=e[t]}.bind(this))}function r(e,t,n){var r="Siesta",i=c[e],o=i[t];if(!i)throw new a('No such collection "'+e+'"');if(!o)throw new a('No such model "'+t+'"');if(s.emit(r,n),siesta.installed){var l=e+":"+t,u=n.localId;s.emit(e,n),s.emit(l,n),s.emit(u,n)}o.id&&n.obj[o.id]&&s.emit(e+":"+t+":"+n.obj[o.id],n)}function i(e){if(!e.model)throw new a("Must pass a model");if(!e.collection)throw new a("Must pass a collection");if(!e.localId)throw new a("Must pass a local identifier");if(!e.obj)throw new a("Must pass the object")}function o(e){i(e);var n=e.collection,o=e.model,s=new t(e);return r(n,o,s),s}var s=e("./events"),a=e("./error").InternalSiestaError,l=(e("./log")("events"),e("./util")._.extend),c=e("./collectionRegistry").CollectionRegistry,u={Set:"set",Splice:"splice",New:"new",Remove:"remove"};t.prototype._dump=function(e){var t={};return t.collection="string"==typeof this.collection?this.collection:this.collection._dump(),t.model="string"==typeof this.model?this.model:this.model.name,t.localId=this.localId,t.field=this.field,t.type=this.type,this.index&&(t.index=this.index),this.added&&(t.added=_.map(this.added,function(e){return e._dump()})),this.removed&&(t.removed=_.map(this.removed,function(e){return e._dump()})),this.old&&(t.old=this.old),this["new"]&&(t["new"]=this["new"]),e?util.prettyPrint(t):t},l(n,{ModelEvent:t,emit:o,validateEventOpts:i,ModelEventType:u})}()},{"./collectionRegistry":15,"./error":16,"./events":17,"./log":19,"./util":25}],23:[function(e,t){!function(){function n(e,t){a("get",e);var n;return l.promise(t,function(t){if(e.localId){if(l.isArray(e.localId))r(c.map(e.localId,function(e){return{localId:e}}),t);else if(n=u.get(e))a.enabled&&a("Had cached object",{opts:e,obj:n}),t&&t(null,n);else if(l.isArray(e.localId))r(c.map(e.localId,function(e){return{localId:e}}),t);else if(t){var i=siesta.ext.storage;if(!i)throw new Error("Storage module not installed");i.store.getFromPouch(e,t)}}else{if(!e.model){var o={opts:e},d="Invalid options given to store";throw new s(d,o)}if(l.isArray(e[e.model.id]))r(c.map(e[e.model.id],function(t){var n={};return n[e.model.id]=t,n.model=e.model,n}),t);else if(n=u.get(e))a.enabled&&a("Had cached object",{opts:e,obj:n}),t&&t(null,n);else{var h=e.model;if(h.singleton)h.one(t);else{var f=h.id,p=e[f],v={};if(v[f]=p,!p)throw new s('Invalid options given to store. Missing "'+f.toString()+'."');h.one(v,function(e,n){e?t(e):n?t(null,n):t(null,null)})}}}}.bind(this))}function r(e,t){return l.promise(t,function(t){var r=[],i=[];c.each(e,function(o){n(o,function(n,o){n?i.push(n):r.push(o),r.length+i.length==e.length&&t&&(i.length?t(i):t(null,r))})})}.bind(this))}function i(e,t){return l.promise(t,function(t){function n(n){t&&(n?t(n):t(null,c.map(e,function(e){return r.cached[e]})))}var r=c.reduce(e,function(e,t){var n=u.get({localId:t});return n?e.cached[t]=n:e.notCached.push(t),e},{cached:{},notCached:[]});n()}.bind(this))}function o(e,t,n){return l.promise(n,function(n){function r(t){n&&(t?n(t):n(null,c.map(e,function(e){return i.cached[e]})))}var i=c.reduce(e,function(e,n){var r={model:t};r[t.id]=n;var i=u.get(r);return i?e.cached[n]=i:e.notCached.push(n),e},{cached:{},notCached:[]});r()}.bind(this))}var s=e("./error").InternalSiestaError,a=e("./log")("store"),l=e("./util"),c=l._,u=e("./cache");t.exports={get:n,getMultiple:r,getMultipleLocal:i,getMultipleRemote:o}}()},{"./cache":13,"./error":16,"./log":19,"./util":25}],24:[function(e,t){!function(){function n(e){return function(){var t=Array.prototype.slice.call(arguments);return e.apply(null,[l].concat(t))}}function r(e,t){if(e.map)return e.map(t);var n=[];return l(e,function(e,r,i){n.push(t(e,r,i))}),n}function i(e,t,n,i){if(t=r(t,function(e,t){return{index:t,value:e}}),i){var o=[];
e(t,function(e,t){n(e.value,function(n,r){o[e.index]=r,t(n)})},function(e){i(e,o)})}else e(t,function(e,t){n(e.value,function(e){t(e)})})}function o(e){return function(){var t=Array.prototype.slice.call(arguments);return e.apply(null,[s].concat(t))}}function s(e,t,n){if(n=n||function(){},!e.length)return n();var r=0,i=function(){t(e[r],function(t){t?(n(t),n=function(){}):(r+=1,r>=e.length?n():i())})};i()}function a(e,t){if(e.forEach)return e.forEach(t);for(var n=0;n<e.length;n+=1)t(e[n],n,e)}function l(e,t,n){function r(t){t?(n(t),n=function(){}):(i+=1,i>=e.length&&n())}if(n=n||function(){},!e.length)return n();var i=0;a(e,function(e){t(e,u(r))})}function c(e,t){if(t=t||function(){},f.isArray(e))m(e,function(e,t){e&&e(function(e){var n=Array.prototype.slice.call(arguments,1);n.length<=1&&(n=n[0]),t.call(null,e,n)})},t);else{var n={};s(p.keys(e),function(t,r){e[t](function(e){var i=Array.prototype.slice.call(arguments,1);i.length<=1&&(i=i[0]),n[t]=i,r(e)})},function(e){t(e,n)})}}function u(e){var t=!1;return function(){if(t)throw new Error("Callback was already called.");t=!0,e.apply(h,arguments)}}function d(e,t){y({map:v,each:l},e,t)}var h,f=e("./misc"),p=e("./underscore"),v=n(i),m=o(i),y=function(e,t,n){if(n=n||function(){},f.isArray(t))e.map(t,function(e,t){e&&e(function(e){var n=Array.prototype.slice.call(arguments,1);n.length<=1&&(n=n[0]),t.call(null,e,n)})},n);else{var r={};e.each(Object.keys(t),function(e,n){t[e](function(t){var i=Array.prototype.slice.call(arguments,1);i.length<=1&&(i=i[0]),r[e]=i,n(t)})},function(e){n(e,r)})}};t.exports={series:c,parallel:d}}()},{"./misc":26,"./underscore":27}],25:[function(e,t){!function(){var n=e("./underscore"),r=e("./async"),i=e("./misc");n.extend(t.exports,{_:n,async:r}),n.extend(t.exports,i)}()},{"./async":24,"./misc":26,"./underscore":27}],26:[function(e,t){!function(){function n(e,t){return function(n){e&&e.apply(e,arguments),t&&(n?t.reject(n):t.resolve.apply(t,Array.prototype.slice.call(arguments,1)))}}var r=e("../../vendor/observe-js/src/observe").Platform,i=e("./underscore"),o=e("lie"),s=e("argsarray"),a=e("./../error").InternalSiestaError,l=/^function\s*[^\(]*\(\s*([^\)]*)\)/m,c=/,/,u=/^\s*(_?)(.+?)\1\s*$/,d=/((\/\/.*$)|(\/\*[\s\S]*?\*\/))/gm,h=function(e){return"[object Array]"===i.toString.call(e)},f=Array.isArray||h,p=function(e){return"string"==typeof e||e instanceof String};i.extend(t.exports,{argsarray:s,next:function(e){r.performMicrotaskCheckpoint(),setTimeout(e)},cb:n,guid:function(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return function(){return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}}(),assert:function(e,t,n){if(!e)throw t=t||"Assertion failed",n=n||{},new a(t,n)},thenBy:function(){function e(e){return e.thenBy=t,e}function t(t){var n=this;return e(function(e,r){return n(e,r)||t(e,r)})}return e}(),defineSubProperty:function(e,t,n){return Object.defineProperty(this,e,{get:function(){return n?t[n]:t[e]},set:function(r){n?t[n]=r:t[e]=r},enumerable:!0,configurable:!0})},defineSubPropertyNoSet:function(e,t,n){return Object.defineProperty(this,e,{get:function(){return n?t[n]:t[e]},enumerable:!0,configurable:!0})},_patchBind:function(){var e=Function.prototype.apply.bind(Function.prototype.bind);Object.defineProperty(Function.prototype,"bind",{value:function(t){var n=e(this,arguments);return Object.defineProperty(n,"__siesta_bound_object",{value:t,writable:!0,configurable:!0,enumerable:!1}),n}})},Promise:o,promise:function(e,t){return e=e||function(){},new o(function(n,r){var i=s(function(t){var i=t[0],o=t.slice(1);i?r(i):n(o[0]);var s=e.__siesta_bound_object||e;e.apply(s,t)});t(i)})},subProperties:function(e,t,n){f(n)||(n=Array.prototype.slice.call(arguments,2));for(var r=0;r<n.length;r++)!function(n){var r={set:!1,name:n,property:n};p(n)||i.extend(r,n);var o={get:function(){return t[r.property]},enumerable:!0,configurable:!0};r.set&&(o.set=function(e){t[r.property]=e}),Object.defineProperty(e,r.name,o)}(n[r])},capitaliseFirstLetter:function(e){return e.charAt(0).toUpperCase()+e.slice(1)},extendFromOpts:function(e,t,n,r){if(r=void 0==r?!0:r){var o=Object.keys(n),s=Object.keys(t),a=s.filter(function(e){return-1==o.indexOf(e)});if(a.length)throw Error("Unknown options: "+a.toString())}i.each(Object.keys(n),function(e){var r=n[e];"function"==typeof r&&(n[e]=r(t[e]),delete t[e])}),i.extend(n,t),i.extend(e,n)},isString:p,isArray:f,prettyPrint:function(e){return JSON.stringify(e,null,4)},flattenArray:function(e){return i.reduce(e,function(e,t){return f(t)?e=e.concat(t):e.push(t),e},[])},unflattenArray:function(e,t){for(var n=0,r=[],i=0;i<t.length;i++)if(f(t[i])){var o=[];r[i]=o;for(var s=0;s<t[i].length;s++)o.push(e[n]),n++}else r[i]=e[n],n++;return r},paramNames:function(e){var t,n,r=[];return t=e.toString().replace(d,""),n=t.match(l),n[1].split(c).forEach(function(e){e.replace(u,function(e,t,n){r.push(n)})}),r}})}()},{"../../vendor/observe-js/src/observe":54,"./../error":16,"./underscore":27,argsarray:28,lie:38}],27:[function(e,t){!function(){function e(e){if(Object.keys)return Object.keys(e);var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(n);return t}var n={},r=Array.prototype,i=Function.prototype,o=r.forEach,s=r.map,a=r.reduce,l=i.bind,c=r.slice,d={},h=function(){};n.keys=e,n.each=n.forEach=function(e,t,r){if(null==e)return e;if(o&&e.forEach===o)e.forEach(t,r);else if(e.length===+e.length){for(var i=0,s=e.length;s>i;i++)if(t.call(r,e[i],i,e)===d)return}else for(var a=n.keys(e),i=0,s=a.length;s>i;i++)if(t.call(r,e[a[i]],a[i],e)===d)return;return e},n.map=n.collect=function(e,t,r){var i=[];return null==e?i:s&&e.map===s?e.map(t,r):(n.each(e,function(e,n,o){i.push(t.call(r,e,n,o))}),i)};var f=function(e,t,n){if(void 0===t)return e;switch(null==n?3:n){case 1:return function(n){return e.call(t,n)};case 2:return function(n,r){return e.call(t,n,r)};case 3:return function(n,r,i){return e.call(t,n,r,i)};case 4:return function(n,r,i,o){return e.call(t,n,r,i,o)}}return function(){return e.apply(t,arguments)}};n.times=function(e,t,n){var r=new Array(Math.max(0,e));t=f(t,n,1);for(var i=0;e>i;i++)r[i]=t(i);return r},n.partial=function(e){var t=c.call(arguments,1);return function(){for(var r=0,i=t.slice(),o=0,s=i.length;s>o;o++)i[o]===n&&(i[o]=arguments[r++]);for(;r<arguments.length;)i.push(arguments[r++]);return e.apply(this,i)}},n.pluck=function(e,t){return n.map(e,n.property(t))};var p="Reduce of empty array with no initial value";n.reduce=n.foldl=n.inject=function(e,t,r,i){var o=arguments.length>2;if(null==e&&(e=[]),a&&e.reduce===a)return i&&(t=n.bind(t,i)),o?e.reduce(t,r):e.reduce(t);if(n.each(e,function(e,n,s){o?r=t.call(i,r,e,n,s):(r=e,o=!0)}),!o)throw new TypeError(p);return r},n.property=function(e){return function(t){return t[e]}},"function"!=typeof/./&&(n.isFunction=function(e){return"function"==typeof e}),n.isObject=function(e){var t=typeof e;return"function"===t||"object"===t&&!!e};var v=function(e){return null==e?n.identity:n.isFunction(e)?e:n.property(e)};n.sortBy=function(e,t,r){return t=v(t),n.pluck(n.map(e,function(e,n,i){return{value:e,index:n,criteria:t.call(r,e,n,i)}}).sort(function(e,t){var n=e.criteria,r=t.criteria;if(n!==r){if(n>r||void 0===n)return 1;if(r>n||void 0===r)return-1}return e.index-t.index}),"value")},n.bind=function(e,t){var r,i;if(l&&e.bind===l)return l.apply(e,c.call(arguments,1));if(!n.isFunction(e))throw new TypeError;return r=c.call(arguments,2),i=function(){if(!(this instanceof i))return e.apply(t,r.concat(c.call(arguments)));h.prototype=e.prototype;var n=new h;h.prototype=null,u;var o=e.apply(n,r.concat(c.call(arguments)));return Object(o)===o?o:n}},n.identity=function(e){return e},n.zip=function(e){if(null==e)return[];for(var t=n.max(arguments,"length").length,r=Array(t),i=0;t>i;i++)r[i]=n.pluck(arguments,i);return r},n.max=function(e,t,r){var i,o,s=-1/0,a=-1/0;if(null==t&&null!=e){e=e.length===+e.length?e:n.values(e);for(var l=0,c=e.length;c>l;l++)i=e[l],i>s&&(s=i)}else t=n.iteratee(t,r),n.each(e,function(e,n,r){o=t(e,n,r),(o>a||o===-1/0&&s===-1/0)&&(s=e,a=o)});return s},n.iteratee=function(e,t,r){return null==e?n.identity:n.isFunction(e)?f(e,t,r):n.isObject(e)?n.matches(e):n.property(e)},n.pairs=function(e){for(var t=n.keys(e),r=t.length,i=Array(r),o=0;r>o;o++)i[o]=[t[o],e[t[o]]];return i},n.matches=function(e){var t=n.pairs(e),r=t.length;return function(e){if(null==e)return!r;e=new Object(e);for(var n=0;r>n;n++){var i=t[n],o=i[0];if(i[1]!==e[o]||!(o in e))return!1}return!0}},n.some=function(e,t,r){if(null==e)return!1;t=n.iteratee(t,r);var i,o,s=e.length!==+e.length&&n.keys(e),a=(s||e).length;for(i=0;a>i;i++)if(o=s?s[i]:i,t(e[o],o,e))return!0;return!1},n.extend=function(e){if(!n.isObject(e))return e;for(var t,r,i=1,o=arguments.length;o>i;i++){t=arguments[i];for(r in t)hasOwnProperty.call(t,r)&&(e[r]=t[r])}return e},t.exports=n}()},{}],28:[function(e,t){"use strict";function n(e){return function(){var t=arguments.length;if(t){for(var n=[],r=-1;++r<t;)n[r]=arguments[r];return e.call(this,n)}return e.call(this,[])}}t.exports=n},{}],29:[function(){},{}],30:[function(e,t){function n(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}function r(e){return"function"==typeof e}function i(e){return"number"==typeof e}function o(e){return"object"==typeof e&&null!==e}function s(e){return void 0===e}t.exports=n,n.EventEmitter=n,n.prototype._events=void 0,n.prototype._maxListeners=void 0,n.defaultMaxListeners=10,n.prototype.setMaxListeners=function(e){if(!i(e)||0>e||isNaN(e))throw TypeError("n must be a positive number");return this._maxListeners=e,this},n.prototype.emit=function(e){var t,n,i,a,l,c;if(this._events||(this._events={}),"error"===e&&(!this._events.error||o(this._events.error)&&!this._events.error.length)){if(t=arguments[1],t instanceof Error)throw t;throw TypeError('Uncaught, unspecified "error" event.')}if(n=this._events[e],s(n))return!1;if(r(n))switch(arguments.length){case 1:n.call(this);break;case 2:n.call(this,arguments[1]);break;case 3:n.call(this,arguments[1],arguments[2]);break;default:for(i=arguments.length,a=new Array(i-1),l=1;i>l;l++)a[l-1]=arguments[l];n.apply(this,a)}else if(o(n)){for(i=arguments.length,a=new Array(i-1),l=1;i>l;l++)a[l-1]=arguments[l];for(c=n.slice(),i=c.length,l=0;i>l;l++)c[l].apply(this,a)}return!0},n.prototype.addListener=function(e,t){var i;if(!r(t))throw TypeError("listener must be a function");if(this._events||(this._events={}),this._events.newListener&&this.emit("newListener",e,r(t.listener)?t.listener:t),this._events[e]?o(this._events[e])?this._events[e].push(t):this._events[e]=[this._events[e],t]:this._events[e]=t,o(this._events[e])&&!this._events[e].warned){var i;i=s(this._maxListeners)?n.defaultMaxListeners:this._maxListeners,i&&i>0&&this._events[e].length>i&&(this._events[e].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[e].length),"function"==typeof console.trace&&console.trace())}return this},n.prototype.on=n.prototype.addListener,n.prototype.once=function(e,t){function n(){this.removeListener(e,n),i||(i=!0,t.apply(this,arguments))}if(!r(t))throw TypeError("listener must be a function");var i=!1;return n.listener=t,this.on(e,n),this},n.prototype.removeListener=function(e,t){var n,i,s,a;if(!r(t))throw TypeError("listener must be a function");if(!this._events||!this._events[e])return this;if(n=this._events[e],s=n.length,i=-1,n===t||r(n.listener)&&n.listener===t)delete this._events[e],this._events.removeListener&&this.emit("removeListener",e,t);else if(o(n)){for(a=s;a-->0;)if(n[a]===t||n[a].listener&&n[a].listener===t){i=a;break}if(0>i)return this;1===n.length?(n.length=0,delete this._events[e]):n.splice(i,1),this._events.removeListener&&this.emit("removeListener",e,t)}return this},n.prototype.removeAllListeners=function(e){var t,n;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[e]&&delete this._events[e],this;if(0===arguments.length){for(t in this._events)"removeListener"!==t&&this.removeAllListeners(t);return this.removeAllListeners("removeListener"),this._events={},this}if(n=this._events[e],r(n))this.removeListener(e,n);else for(;n.length;)this.removeListener(e,n[n.length-1]);return delete this._events[e],this},n.prototype.listeners=function(e){var t;return t=this._events&&this._events[e]?r(this._events[e])?[this._events[e]]:this._events[e].slice():[]},n.listenerCount=function(e,t){var n;return n=e._events&&e._events[t]?r(e._events[t])?1:e._events[t].length:0}},{}],31:[function(e,t,n){function r(){return"WebkitAppearance"in document.documentElement.style||window.console&&(console.firebug||console.exception&&console.table)||navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31}function i(){var e=arguments,t=this.useColors;if(e[0]=(t?"%c":"")+this.namespace+(t?" %c":" ")+e[0]+(t?"%c ":" ")+"+"+n.humanize(this.diff),!t)return e;var r="color: "+this.color;e=[e[0],r,"color: inherit"].concat(Array.prototype.slice.call(e,1));var i=0,o=0;return e[0].replace(/%[a-z%]/g,function(e){"%%"!==e&&(i++,"%c"===e&&(o=i))}),e.splice(o,0,r),e}function o(){return"object"==typeof console&&console.log&&Function.prototype.apply.call(console.log,console,arguments)}function s(e){try{null==e?l.removeItem("debug"):l.debug=e}catch(t){}}function a(){var e;try{e=l.debug}catch(t){}return e}n=t.exports=e("./debug"),n.log=o,n.formatArgs=i,n.save=s,n.load=a,n.useColors=r;var l;l="undefined"!=typeof chrome&&"undefined"!=typeof chrome.storage?chrome.storage.local:window.localStorage,n.colors=["lightseagreen","forestgreen","goldenrod","dodgerblue","darkorchid","crimson"],n.formatters.j=function(e){return JSON.stringify(e)},n.enable(a())},{"./debug":32}],32:[function(e,t,n){function r(){return n.colors[u++%n.colors.length]}function i(e){function t(){}function i(){var e=i,t=+new Date,o=t-(c||t);e.diff=o,e.prev=c,e.curr=t,c=t,null==e.useColors&&(e.useColors=n.useColors()),null==e.color&&e.useColors&&(e.color=r());var s=Array.prototype.slice.call(arguments);s[0]=n.coerce(s[0]),"string"!=typeof s[0]&&(s=["%o"].concat(s));var a=0;s[0]=s[0].replace(/%([a-z%])/g,function(t,r){if("%%"===t)return t;a++;var i=n.formatters[r];if("function"==typeof i){var o=s[a];t=i.call(e,o),s.splice(a,1),a--}return t}),"function"==typeof n.formatArgs&&(s=n.formatArgs.apply(e,s));var l=i.log||n.log||console.log.bind(console);l.apply(e,s)}t.enabled=!1,i.enabled=!0;var o=n.enabled(e)?i:t;return o.namespace=e,o}function o(e){n.save(e);for(var t=(e||"").split(/[\s,]+/),r=t.length,i=0;r>i;i++)t[i]&&(e=t[i].replace(/\*/g,".*?"),"-"===e[0]?n.skips.push(new RegExp("^"+e.substr(1)+"$")):n.names.push(new RegExp("^"+e+"$")))}function s(){n.enable("")}function a(e){var t,r;for(t=0,r=n.skips.length;r>t;t++)if(n.skips[t].test(e))return!1;for(t=0,r=n.names.length;r>t;t++)if(n.names[t].test(e))return!0;return!1}function l(e){return e instanceof Error?e.stack||e.message:e}n=t.exports=i,n.coerce=l,n.disable=s,n.enable=o,n.enabled=a,n.humanize=e("ms"),n.names=[],n.skips=[],n.formatters={};var c,u=0},{ms:33}],33:[function(e,t){function n(e){var t=/^((?:\d+)?\.?\d+) *(ms|seconds?|s|minutes?|m|hours?|h|days?|d|years?|y)?$/i.exec(e);if(t){var n=parseFloat(t[1]),r=(t[2]||"ms").toLowerCase();switch(r){case"years":case"year":case"y":return n*u;case"days":case"day":case"d":return n*c;case"hours":case"hour":case"h":return n*l;case"minutes":case"minute":case"m":return n*a;case"seconds":case"second":case"s":return n*s;case"ms":return n}}}function r(e){return e>=c?Math.round(e/c)+"d":e>=l?Math.round(e/l)+"h":e>=a?Math.round(e/a)+"m":e>=s?Math.round(e/s)+"s":e+"ms"}function i(e){return o(e,c,"day")||o(e,l,"hour")||o(e,a,"minute")||o(e,s,"second")||e+" ms"}function o(e,t,n){return t>e?void 0:1.5*t>e?Math.floor(e/t)+" "+n:Math.ceil(e/t)+" "+n+"s"}var s=1e3,a=60*s,l=60*a,c=24*l,u=365.25*c;t.exports=function(e,t){return t=t||{},"string"==typeof e?n(e):t["long"]?i(e):r(e)}},{}],34:[function(e,t){var n,r=Object.prototype.hasOwnProperty,i=Object.prototype.toString,o=function(e){"use strict";if(!e||"[object Object]"!==i.call(e)||e.nodeType||e.setInterval)return!1;var t=r.call(e,"constructor"),o=e.constructor&&e.constructor.prototype&&r.call(e.constructor.prototype,"isPrototypeOf");if(e.constructor&&!t&&!o)return!1;var s;for(s in e);return s===n||r.call(e,s)};t.exports=function s(){"use strict";var e,t,r,i,a,l,c=arguments[0],u=1,d=arguments.length,h=!1;for("boolean"==typeof c?(h=c,c=arguments[1]||{},u=2):("object"!=typeof c&&"function"!=typeof c||c==n)&&(c={});d>u;++u)if(null!=(e=arguments[u]))for(t in e)r=c[t],i=e[t],c!==i&&(h&&i&&(o(i)||(a=Array.isArray(i)))?(a?(a=!1,l=r&&Array.isArray(r)?r:[]):l=r&&o(r)?r:{},c[t]=s(h,l,i)):i!==n&&(c[t]=i));return c}},{}],35:[function(e,t){"use strict";function n(){}t.exports=n},{}],36:[function(e,t){"use strict";function n(e){function t(e,t){function r(e){c[t]=e,++u===n&!l&&(l=!0,a.resolve(h,c))}o(e).then(r,function(e){l||(l=!0,a.reject(h,e))})}if("[object Array]"!==Object.prototype.toString.call(e))return i(new TypeError("must be an array"));var n=e.length,l=!1;if(!n)return o([]);for(var c=new Array(n),u=0,d=-1,h=new r(s);++d<n;)t(e[d],d);return h}var r=e("./promise"),i=e("./reject"),o=e("./resolve"),s=e("./INTERNAL"),a=e("./handlers");t.exports=n},{"./INTERNAL":35,"./handlers":37,"./promise":39,"./reject":42,"./resolve":43}],37:[function(e,t,n){"use strict";function r(e){var t=e&&e.then;return e&&"object"==typeof e&&"function"==typeof t?function(){t.apply(e,arguments)}:void 0}var i=e("./tryCatch"),o=e("./resolveThenable"),s=e("./states");n.resolve=function(e,t){var a=i(r,t);if("error"===a.status)return n.reject(e,a.value);var l=a.value;if(l)o.safely(e,l);else{e.state=s.FULFILLED,e.outcome=t;for(var c=-1,u=e.queue.length;++c<u;)e.queue[c].callFulfilled(t)}return e},n.reject=function(e,t){e.state=s.REJECTED,e.outcome=t;for(var n=-1,r=e.queue.length;++n<r;)e.queue[n].callRejected(t);return e}},{"./resolveThenable":44,"./states":45,"./tryCatch":46}],38:[function(e,t,n){t.exports=n=e("./promise"),n.resolve=e("./resolve"),n.reject=e("./reject"),n.all=e("./all"),n.race=e("./race")},{"./all":36,"./promise":39,"./race":41,"./reject":42,"./resolve":43}],39:[function(e,t){"use strict";function n(e){if(!(this instanceof n))return new n(e);if("function"!=typeof e)throw new TypeError("resolver must be a function");this.state=s.PENDING,this.queue=[],this.outcome=void 0,e!==i&&o.safely(this,e)}var r=e("./unwrap"),i=e("./INTERNAL"),o=e("./resolveThenable"),s=e("./states"),a=e("./queueItem");t.exports=n,n.prototype["catch"]=function(e){return this.then(null,e)},n.prototype.then=function(e,t){if("function"!=typeof e&&this.state===s.FULFILLED||"function"!=typeof t&&this.state===s.REJECTED)return this;var o=new n(i);if(this.state!==s.PENDING){var l=this.state===s.FULFILLED?e:t;r(o,l,this.outcome)}else this.queue.push(new a(o,e,t));return o}},{"./INTERNAL":35,"./queueItem":40,"./resolveThenable":44,"./states":45,"./unwrap":47}],40:[function(e,t){"use strict";function n(e,t,n){this.promise=e,"function"==typeof t&&(this.onFulfilled=t,this.callFulfilled=this.otherCallFulfilled),"function"==typeof n&&(this.onRejected=n,this.callRejected=this.otherCallRejected)}var r=e("./handlers"),i=e("./unwrap");t.exports=n,n.prototype.callFulfilled=function(e){r.resolve(this.promise,e)},n.prototype.otherCallFulfilled=function(e){i(this.promise,this.onFulfilled,e)},n.prototype.callRejected=function(e){r.reject(this.promise,e)},n.prototype.otherCallRejected=function(e){i(this.promise,this.onRejected,e)}},{"./handlers":37,"./unwrap":47}],41:[function(e,t){"use strict";function n(e){function t(e){o(e).then(function(e){l||(l=!0,a.resolve(u,e))},function(e){l||(l=!0,a.reject(u,e))})}if("[object Array]"!==Object.prototype.toString.call(e))return i(new TypeError("must be an array"));var n=e.length,l=!1;if(!n)return o([]);for(var c=-1,u=new r(s);++c<n;)t(e[c]);return u}var r=e("./promise"),i=e("./reject"),o=e("./resolve"),s=e("./INTERNAL"),a=e("./handlers");t.exports=n},{"./INTERNAL":35,"./handlers":37,"./promise":39,"./reject":42,"./resolve":43}],42:[function(e,t){"use strict";function n(e){var t=new r(i);return o.reject(t,e)}var r=e("./promise"),i=e("./INTERNAL"),o=e("./handlers");t.exports=n},{"./INTERNAL":35,"./handlers":37,"./promise":39}],43:[function(e,t){"use strict";function n(e){if(e)return e instanceof r?e:o.resolve(new r(i),e);var t=typeof e;switch(t){case"boolean":return s;case"undefined":return l;case"object":return a;case"number":return c;case"string":return u}}var r=e("./promise"),i=e("./INTERNAL"),o=e("./handlers");t.exports=n;var s=o.resolve(new r(i),!1),a=o.resolve(new r(i),null),l=o.resolve(new r(i),void 0),c=o.resolve(new r(i),0),u=o.resolve(new r(i),"")},{"./INTERNAL":35,"./handlers":37,"./promise":39}],44:[function(e,t,n){"use strict";function r(e,t){function n(t){a||(a=!0,i.reject(e,t))}function r(t){a||(a=!0,i.resolve(e,t))}function s(){t(r,n)}var a=!1,l=o(s);"error"===l.status&&n(l.value)}var i=e("./handlers"),o=e("./tryCatch");n.safely=r},{"./handlers":37,"./tryCatch":46}],45:[function(e,t,n){n.REJECTED=["REJECTED"],n.FULFILLED=["FULFILLED"],n.PENDING=["PENDING"]},{}],46:[function(e,t){"use strict";function n(e,t){var n={};try{n.value=e(t),n.status="success"}catch(r){n.status="error",n.value=r}return n}t.exports=n},{}],47:[function(e,t){"use strict";function n(e,t,n){r(function(){var r;try{r=t(n)}catch(o){return i.reject(e,o)}r===e?i.reject(e,new TypeError("Cannot resolve promise with itself")):i.resolve(e,r)})}var r=e("immediate"),i=e("./handlers");t.exports=n},{"./handlers":37,immediate:48}],48:[function(e,t){"use strict";function n(){i=!0;for(var e,t,n=a.length;n;){for(t=a,a=[],e=-1;++e<n;)t[e]();n=a.length}i=!1}function r(e){1!==a.push(e)||i||o()}for(var i,o,s=[e("./nextTick"),e("./mutation.js"),e("./messageChannel"),e("./stateChange"),e("./timeout")],a=[],l=-1,c=s.length;++l<c;)if(s[l]&&s[l].test&&s[l].test()){o=s[l].install(n);break}t.exports=r},{"./messageChannel":49,"./mutation.js":50,"./nextTick":29,"./stateChange":51,"./timeout":52}],49:[function(e,t,n){(function(e){"use strict";n.test=function(){return e.setImmediate?!1:"undefined"!=typeof e.MessageChannel},n.install=function(t){var n=new e.MessageChannel;return n.port1.onmessage=t,function(){n.port2.postMessage(0)}}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],50:[function(e,t,n){(function(e){"use strict";var t=e.MutationObserver||e.WebKitMutationObserver;n.test=function(){return t},n.install=function(n){var r=0,i=new t(n),o=e.document.createTextNode("");return i.observe(o,{characterData:!0}),function(){o.data=r=++r%2}}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],51:[function(e,t,n){(function(e){"use strict";n.test=function(){return"document"in e&&"onreadystatechange"in e.document.createElement("script")},n.install=function(t){return function(){var n=e.document.createElement("script");return n.onreadystatechange=function(){t(),n.onreadystatechange=null,n.parentNode.removeChild(n),n=null},e.document.documentElement.appendChild(n),t}}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],52:[function(e,t,n){"use strict";n.test=function(){return!0},n.install=function(e){return function(){setTimeout(e,0)}}},{}],53:[function(e,t){!function(){function e(){return{dateFields:[]}}function n(e,t){return e+"."+t}function r(t){t.siesta_meta=e();for(var n in t)t.hasOwnProperty(n)&&t[n]instanceof Date&&(t.siesta_meta.dateFields.push(n),t[n]=t[n].getTime())}function i(t){var n=t.siesta_meta||e();n.dateFields.forEach(function(e){var n=t[e];n instanceof Date||(t[e]=new Date(n))}),delete t.siesta_meta}function o(e,t){var r=n(e,t),i={};return i[r]={map:function(e){"$1"==e.collection&&"$2"==e.model&&emit(e.collection+"."+e.model,e)}.toString().replace("$1",e).replace("$2",t)},{_id:"_design/"+r,views:i}}function s(){var e=[],t=siesta._internal.CollectionRegistry;return t.collectionNames.forEach(function(n){var r=t[n]._models;for(var i in r)r.hasOwnProperty(i)&&e.push(o(n,i))}),e}function a(e,t){k.bulkDocs(e).then(function(e){for(var n=[],r=0;r<e.length;r++){var i=e[r];if(!i.ok){var o=409==i.status;o||n.push(i)}}t(n.length?x("multiple errors",{errors:n}):null)})["catch"](t)}function l(e){var t=s();a(t,e)}function c(e){var t={},n=e.__values;t=siesta._.extend(t,n),Object.keys(t).forEach(function(e){t[e.replace(R,"@")]=n[e]}),r(t),t.collection=e.collectionName,t.model=e.modelName,t._id=e.localId,e.removed&&(t._deleted=!0);var i=e._rev;return i&&(t._rev=i),t=w.reduce(e._relationshipNames,function(t,n){var r=e[n];if(siesta.isArray(r))r=r.filter(function(e){return e.model.store(e)}),t[n]=w.pluck(r,"localId");else if(r){var i=r.model.store(r);i&&(t[n]=r.localId)}return t},t)}function u(e,t){i(e),delete e.collection,delete e.model,e.localId=e._id,delete e._id;var n={};Object.keys(e).forEach(function(t){n[t.replace(C,"_")]=e[t]});var r=t._relationshipNames;return w.each(r,function(e){var t=n[e];t&&(n[e]=siesta.isArray(t)?w.map(t,function(e){return{localId:e}}):{localId:t})}),n}function d(e,t){var r={},i=e.collectionName,o=e.modelName,s=n(i,o);_("Loading instances for "+s);var a=g[i][o];_("Querying pouch"),k.query(s).then(function(e){_("Queried pouch successfully");var n=e.rows,i=siesta._.map(siesta._.pluck(n,"value"),function(e){return u(e,a)});siesta._.map(i,function(e){var t=e[a.id];t&&(r[t]?console.error("Duplicates detected in storage. You have encountered a serious bug. Please report this."):r[t]=e)}),_("Mapping data",i),a.graph(i,{_ignoreInstalled:!0,fromStorage:!0},function(e,n){e?_("Error loading models",e):_.enabled&&_(n.length.toString()),t(e,n)})})["catch"](function(e){t(e)})}function h(e){if(T)throw new Error("not loaded yet how can i save");return O.promise(e,function(e){if(siesta.ext.storageEnabled){var t=g.collectionNames,n=[];w.each(t,function(e){var t=g[e],r=Object.keys(t._models);w.each(r,function(t){n.push(function(n){N._loadModel({collectionName:e,modelName:t},n)})})}),siesta.async.series(n,function(t,n){var r;if(!t){var i=[];siesta._.each(n,function(e){i=i.concat(e)}),r=i.length,_&&_("Loaded "+r.toString()+" instances. Cache size is "+b.count(),{remote:b._remoteCache(),localCache:b._localCache()}),siesta.on("Siesta",m)}e(t,r)})}else e()}.bind(this))}function f(e,t){k.allDocs({keys:w.pluck(e,"localId")}).then(function(n){for(var r=0;r<n.rows.length;r++)e[r]._rev=n.rows[r].value.rev;p(e,t)})["catch"](function(e){t(e)})}function p(e,t){var n=[],r=w.map(e,c);k.bulkDocs(r).then(function(r){for(var i=0;i<r.length;i++){var o=r[i],s=e[i];o.ok?s._rev=o.rev:409==o.status?n.push(s):_('Error saving object with localId="'+s.localId+'"',o)}n.length?f(n,t):t()},function(e){t(e)})}function v(e){return O.promise(e,function(e){siesta._afterInstall(function(){var t=E;E=[],I={},A={},t=t.filter(function(e){return e.model.store(e)}),_("Saving instances",t),p(t,e)})}.bind(this))}function m(e){var t=e.obj,n=t.localId;if(!t)throw new y.error.InternalSiestaError("No obj field in notification received by storage extension");if(!(n in I)){I[n]=t,E.push(t);var r=t.collectionName;A[r]||(A[r]={});var i=t.model.name;A[r][i]||(A[r][i]={}),A[r][i][n]=t}}if("undefined"==typeof siesta&&"undefined"==typeof t)throw new Error("Could not find window.siesta. Make sure you include siesta.core.js first.");var y=siesta._internal,b=y.cache,g=y.CollectionRegistry,_=y.log("storage"),x=y.error,O=y.util,w=O._,j=y.events,E=[],I={},A={},N={},R=/_/g,C=/@/g;if("undefined"==typeof PouchDB)siesta.ext.storageEnabled=!1,console.log("PouchDB is not present therefore storage is disabled.");else{var M="siesta",k=new PouchDB(M,{auto_compaction:!0});w.extend(N,{_load:h,_loadModel:d,save:v,_serialise:c,ensureIndexesForAll:l,_reset:function(e){siesta.removeListener("Siesta",m),E=[],I={},k.destroy(function(t){t||(k=new PouchDB(M)),_("Reset complete"),e(t)})}}),Object.defineProperties(N,{_unsavedObjects:{get:function(){return E}},_unsavedObjectsHash:{get:function(){return I}},_unsavedObjectsByCollection:{get:function(){return A}},_pouch:{get:function(){return k}}}),siesta.ext||(siesta.ext={}),siesta.ext.storage=N,Object.defineProperties(siesta.ext,{storageEnabled:{get:function(){return void 0!==siesta.ext._storageEnabled?siesta.ext._storageEnabled:!!siesta.ext.storage},set:function(e){siesta.ext._storageEnabled=e},enumerable:!0}});var S,T,P=1e3;Object.defineProperties(siesta,{autosave:{get:function(){return!!S},set:function(e){e?S||(S=setInterval(function(){T||(T=!0,siesta.save(function(e){e||j.emit("saved"),T=!1}))},siesta.autosaveInterval)):S&&(clearInterval(S),S=null)}},autosaveInterval:{get:function(){return P},set:function(e){P=e,S&&(siesta.autosave=!1,siesta.autosave=!0)}},dirty:{get:function(){var e=siesta.ext.storage._unsavedObjectsByCollection;return!!Object.keys(e).length},enumerable:!0}}),w.extend(siesta,{save:v,setPouch:function(e){if(!siesta._canChange)throw new Error("Cannot change PouchDB instance when an object graph exists.");k=e}})}t.exports=N}()},{}],54:[function(require,module,exports){(function(global){!function(global){"use strict";function detectObjectObserve(){function e(e){t=e}if("function"!=typeof Object.observe||"function"!=typeof Array.observe)return!1;var t=[],n={},r=[];return Object.observe(n,e),Array.observe(r,e),n.id=1,n.id=2,delete n.id,r.push(1,2),r.length=0,Object.deliverChangeRecords(e),5!==t.length?!1:"add"!=t[0].type||"update"!=t[1].type||"delete"!=t[2].type||"splice"!=t[3].type||"splice"!=t[4].type?!1:(Object.unobserve(n,e),Array.unobserve(r,e),!0)}function detectEval(){if("undefined"!=typeof chrome&&chrome.app&&chrome.app.runtime)return!1;if(navigator.getDeviceStorage)return!1;try{var e=new Function("","return true;");return e()}catch(t){return!1}}function isIndex(e){return+e===e>>>0&&""!==e}function toNumber(e){return+e}function dirtyCheck(e){for(var t=0;MAX_DIRTY_CHECK_CYCLES>t&&e.check_();)t++;return testingExposeCycleCount&&(global.dirtyCheckCycleCount=t),t>0}function objectIsEmpty(e){for(var t in e)return!1;return!0}function diffIsEmpty(e){return objectIsEmpty(e.added)&&objectIsEmpty(e.removed)&&objectIsEmpty(e.changed)}function diffObjectFromOldObject(e,t){var n={},r={},i={};for(var o in t){var s=e[o];(void 0===s||s!==t[o])&&(o in e?s!==t[o]&&(i[o]=s):r[o]=void 0)}for(var o in e)o in t||(n[o]=e[o]);return Array.isArray(e)&&e.length!==t.length&&(i.length=e.length),{added:n,removed:r,changed:i}}function runEOMTasks(){if(!eomTasks.length)return!1;for(var e=0;e<eomTasks.length;e++)eomTasks[e]();return eomTasks.length=0,!0}function newObservedObject(){function e(e){t&&t.state_===OPENED&&!r&&t.check_(e)}var t,n,r=!1,i=!0;return{open:function(n){if(t)throw Error("ObservedObject in use");i||Object.deliverChangeRecords(e),t=n,i=!1},observe:function(t,r){n=t,r?Array.observe(n,e):Object.observe(n,e)},deliver:function(t){r=t,Object.deliverChangeRecords(e),r=!1},close:function(){t=void 0,Object.unobserve(n,e),observedObjectCache.push(this)}}}function getObservedObject(e,t,n){var r=observedObjectCache.pop()||newObservedObject();return r.open(e),r.observe(t,n),r}function newObservedSet(){function e(t,o){t&&(t===r&&(i[o]=!0),a.indexOf(t)<0&&(a.push(t),Object.observe(t,n)),e(Object.getPrototypeOf(t),o))}function t(e){for(var t=0;t<e.length;t++){var n=e[t];if(n.object!==r||i[n.name]||"setPrototype"===n.type)return!1}return!0}function n(n){if(!t(n)){for(var r,i=0;i<s.length;i++)r=s[i],r.state_==OPENED&&r.iterateObjects_(e);for(var i=0;i<s.length;i++)r=s[i],r.state_==OPENED&&r.check_()}}var r,i,o=0,s=[],a=[],l={object:void 0,objects:a,open:function(t,n){r||(r=n,i={}),s.push(t),o++,t.iterateObjects_(e)},close:function(){if(o--,!(o>0)){for(var e=0;e<a.length;e++)Object.unobserve(a[e],n),Observer.unobservedCount++;s.length=0,a.length=0,r=void 0,i=void 0,observedSetCache.push(this)}}};return l}function Observer(){this.state_=UNOPENED,this.callback_=void 0,this.target_=void 0,this.directObserver_=void 0,this.value_=void 0,this.id_=nextObserverId++
}function addToAll(e){Observer._allObserversCount++,collectObservers&&allObservers.push(e)}function removeFromAll(){Observer._allObserversCount--}function ObjectObserver(e){Observer.call(this),this.value_=e,this.oldObject_=void 0}function ArrayObserver(e){if(!Array.isArray(e))throw Error("Provided object is not an Array");ObjectObserver.call(this,e)}function diffObjectFromChangeRecords(e,t,n){for(var r={},i={},o=0;o<t.length;o++){var s=t[o];expectedRecordTypes[s.type]?(s.name in n||(n[s.name]=s.oldValue),"update"!=s.type&&("add"!=s.type?s.name in r?(delete r[s.name],delete n[s.name]):i[s.name]=!0:s.name in i?delete i[s.name]:r[s.name]=!0)):(console.error("Unknown changeRecord type: "+s.type),console.error(s))}for(var a in r)r[a]=e[a];for(var a in i)i[a]=void 0;var l={};for(var a in n)if(!(a in r||a in i)){var c=e[a];n[a]!==c&&(l[a]=c)}return{added:r,removed:i,changed:l}}function newSplice(e,t,n){return{index:e,removed:t,addedCount:n}}function ArraySplice(){}function calcSplices(e,t,n,r,i,o){return arraySplice.calcSplices(e,t,n,r,i,o)}function intersect(e,t,n,r){return n>t||e>r?-1:t==n||r==e?0:n>e?r>t?t-n:r-n:t>r?r-e:t-e}function mergeSplice(e,t,n,r){for(var i=newSplice(t,n,r),o=!1,s=0,a=0;a<e.length;a++){var l=e[a];if(l.index+=s,!o){var c=intersect(i.index,i.index+i.removed.length,l.index,l.index+l.addedCount);if(c>=0){e.splice(a,1),a--,s-=l.addedCount-l.removed.length,i.addedCount+=l.addedCount-c;var u=i.removed.length+l.removed.length-c;if(i.addedCount||u){var n=l.removed;if(i.index<l.index){var d=i.removed.slice(0,l.index-i.index);Array.prototype.push.apply(d,n),n=d}if(i.index+i.removed.length>l.index+l.addedCount){var h=i.removed.slice(l.index+l.addedCount-i.index);Array.prototype.push.apply(n,h)}i.removed=n,l.index<i.index&&(i.index=l.index)}else o=!0}else if(i.index<l.index){o=!0,e.splice(a,0,i),a++;var f=i.addedCount-i.removed.length;l.index+=f,s+=f}}}o||e.push(i)}function createInitialSplices(e,t){for(var n=[],r=0;r<t.length;r++){var i=t[r];switch(i.type){case"splice":mergeSplice(n,i.index,i.removed.slice(),i.addedCount);break;case"add":case"update":case"delete":if(!isIndex(i.name))continue;var o=toNumber(i.name);if(0>o)continue;mergeSplice(n,o,[i.oldValue],1);break;default:console.error("Unexpected record type: "+JSON.stringify(i))}}return n}function projectArraySplices(e,t){var n=[];return createInitialSplices(e,t).forEach(function(t){return 1==t.addedCount&&1==t.removed.length?void(t.removed[0]!==e[t.index]&&n.push(t)):void(n=n.concat(calcSplices(e,t.index,t.index+t.addedCount,t.removed,0,t.removed.length)))}),n}var testingExposeCycleCount=global.testingExposeCycleCount,hasObserve=detectObjectObserve(),hasEval=detectEval(),numberIsNaN=global.Number.isNaN||function(e){return"number"==typeof e&&global.isNaN(e)},createObject="__proto__"in{}?function(e){return e}:function(e){var t=e.__proto__;if(!t)return e;var n=Object.create(t);return Object.getOwnPropertyNames(e).forEach(function(t){Object.defineProperty(n,t,Object.getOwnPropertyDescriptor(e,t))}),n},identStart="[$_a-zA-Z]",identPart="[$_a-zA-Z0-9]",MAX_DIRTY_CHECK_CYCLES=1e3,eomTasks=[],runEOM=hasObserve?function(){var e={pingPong:!0},t=!1;return Object.observe(e,function(){runEOMTasks(),t=!1}),function(n){eomTasks.push(n),t||(t=!0,e.pingPong=!e.pingPong)}}():function(){return function(e){eomTasks.push(e)}}(),observedObjectCache=[],observedSetCache=[],lastObservedSet,UNOPENED=0,OPENED=1,CLOSED=2,nextObserverId=1;Observer.prototype={open:function(e,t){if(this.state_!=UNOPENED)throw Error("Observer has already been opened.");return addToAll(this),this.callback_=e,this.target_=t,this.connect_(),this.state_=OPENED,this.value_},close:function(){this.state_==OPENED&&(removeFromAll(this),this.disconnect_(),this.value_=void 0,this.callback_=void 0,this.target_=void 0,this.state_=CLOSED)},deliver:function(){this.state_==OPENED&&dirtyCheck(this)},report_:function(e){try{this.callback_.apply(this.target_,e)}catch(t){Observer._errorThrownDuringCallback=!0,console.error("Exception caught during observer callback: "+(t.stack||t))}},discardChanges:function(){return this.check_(void 0,!0),this.value_}};var collectObservers=!hasObserve,allObservers;Observer._allObserversCount=0,collectObservers&&(allObservers=[]);var runningMicrotaskCheckpoint=!1,hasDebugForceFullDelivery=hasObserve&&hasEval&&function(){try{return eval("%RunMicrotasks()"),!0}catch(ex){return!1}}();global.Platform=global.Platform||{},global.Platform.performMicrotaskCheckpoint=function(){if(!runningMicrotaskCheckpoint){if(hasDebugForceFullDelivery)return void eval("%RunMicrotasks()");if(collectObservers){runningMicrotaskCheckpoint=!0;var cycles=0,anyChanged,toCheck;do{cycles++,toCheck=allObservers,allObservers=[],anyChanged=!1;for(var i=0;i<toCheck.length;i++){var observer=toCheck[i];observer.state_==OPENED&&(observer.check_()&&(anyChanged=!0),allObservers.push(observer))}runEOMTasks()&&(anyChanged=!0)}while(MAX_DIRTY_CHECK_CYCLES>cycles&&anyChanged);testingExposeCycleCount&&(global.dirtyCheckCycleCount=cycles),runningMicrotaskCheckpoint=!1}}},collectObservers&&(global.Platform.clearObservers=function(){allObservers=[]}),ObjectObserver.prototype=createObject({__proto__:Observer.prototype,arrayObserve:!1,connect_:function(){hasObserve?this.directObserver_=getObservedObject(this,this.value_,this.arrayObserve):this.oldObject_=this.copyObject(this.value_)},copyObject:function(e){var t=Array.isArray(e)?[]:{};for(var n in e)t[n]=e[n];return Array.isArray(e)&&(t.length=e.length),t},check_:function(e){var t,n;if(hasObserve){if(!e)return!1;n={},t=diffObjectFromChangeRecords(this.value_,e,n)}else n=this.oldObject_,t=diffObjectFromOldObject(this.value_,this.oldObject_);return diffIsEmpty(t)?!1:(hasObserve||(this.oldObject_=this.copyObject(this.value_)),this.report_([t.added||{},t.removed||{},t.changed||{},function(e){return n[e]}]),!0)},disconnect_:function(){hasObserve?(this.directObserver_.close(),this.directObserver_=void 0):this.oldObject_=void 0},deliver:function(){this.state_==OPENED&&(hasObserve?this.directObserver_.deliver(!1):dirtyCheck(this))},discardChanges:function(){return this.directObserver_?this.directObserver_.deliver(!0):this.oldObject_=this.copyObject(this.value_),this.value_}}),ArrayObserver.prototype=createObject({__proto__:ObjectObserver.prototype,arrayObserve:!0,copyObject:function(e){return e.slice()},check_:function(e){var t;if(hasObserve){if(!e)return!1;t=projectArraySplices(this.value_,e)}else t=calcSplices(this.value_,0,this.value_.length,this.oldObject_,0,this.oldObject_.length);return t&&t.length?(hasObserve||(this.oldObject_=this.copyObject(this.value_)),this.report_([t]),!0):!1}}),ArrayObserver.applySplices=function(e,t,n){n.forEach(function(n){for(var r=[n.index,n.removed.length],i=n.index;i<n.index+n.addedCount;)r.push(t[i]),i++;Array.prototype.splice.apply(e,r)})};var observerSentinel={},expectedRecordTypes={add:!0,update:!0,"delete":!0},EDIT_LEAVE=0,EDIT_UPDATE=1,EDIT_ADD=2,EDIT_DELETE=3;ArraySplice.prototype={calcEditDistances:function(e,t,n,r,i,o){for(var s=o-i+1,a=n-t+1,l=new Array(s),c=0;s>c;c++)l[c]=new Array(a),l[c][0]=c;for(var u=0;a>u;u++)l[0][u]=u;for(var c=1;s>c;c++)for(var u=1;a>u;u++)if(this.equals(e[t+u-1],r[i+c-1]))l[c][u]=l[c-1][u-1];else{var d=l[c-1][u]+1,h=l[c][u-1]+1;l[c][u]=h>d?d:h}return l},spliceOperationsFromEditDistances:function(e){for(var t=e.length-1,n=e[0].length-1,r=e[t][n],i=[];t>0||n>0;)if(0!=t)if(0!=n){var o,s=e[t-1][n-1],a=e[t-1][n],l=e[t][n-1];o=l>a?s>a?a:s:s>l?l:s,o==s?(s==r?i.push(EDIT_LEAVE):(i.push(EDIT_UPDATE),r=s),t--,n--):o==a?(i.push(EDIT_DELETE),t--,r=a):(i.push(EDIT_ADD),n--,r=l)}else i.push(EDIT_DELETE),t--;else i.push(EDIT_ADD),n--;return i.reverse(),i},calcSplices:function(e,t,n,r,i,o){var s=0,a=0,l=Math.min(n-t,o-i);if(0==t&&0==i&&(s=this.sharedPrefix(e,r,l)),n==e.length&&o==r.length&&(a=this.sharedSuffix(e,r,l-s)),t+=s,i+=s,n-=a,o-=a,n-t==0&&o-i==0)return[];if(t==n){for(var c=newSplice(t,[],0);o>i;)c.removed.push(r[i++]);return[c]}if(i==o)return[newSplice(t,[],n-t)];for(var u=this.spliceOperationsFromEditDistances(this.calcEditDistances(e,t,n,r,i,o)),c=void 0,d=[],h=t,f=i,p=0;p<u.length;p++)switch(u[p]){case EDIT_LEAVE:c&&(d.push(c),c=void 0),h++,f++;break;case EDIT_UPDATE:c||(c=newSplice(h,[],0)),c.addedCount++,h++,c.removed.push(r[f]),f++;break;case EDIT_ADD:c||(c=newSplice(h,[],0)),c.addedCount++,h++;break;case EDIT_DELETE:c||(c=newSplice(h,[],0)),c.removed.push(r[f]),f++}return c&&d.push(c),d},sharedPrefix:function(e,t,n){for(var r=0;n>r;r++)if(!this.equals(e[r],t[r]))return r;return n},sharedSuffix:function(e,t,n){for(var r=e.length,i=t.length,o=0;n>o&&this.equals(e[--r],t[--i]);)o++;return o},calculateSplices:function(e,t){return this.calcSplices(e,0,e.length,t,0,t.length)},equals:function(e,t){return e===t}};var arraySplice=new ArraySplice,expose=global;"undefined"!=typeof exports&&("undefined"!=typeof module&&module.exports&&(expose=exports=module.exports),expose=exports),expose.Observer=Observer,expose.Observer.runEOM_=runEOM,expose.Observer.observerSentinel_=observerSentinel,expose.Observer.hasObjectObserve=hasObserve,expose.ArrayObserver=ArrayObserver,expose.ArrayObserver.calculateSplices=function(e,t){return arraySplice.calculateSplices(e,t)},expose.Platform=global.Platform,expose.ArraySplice=ArraySplice,expose.ObjectObserver=ObjectObserver}("undefined"!=typeof global&&global&&"undefined"!=typeof module&&module?global:this||window)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}]},{},[1]);