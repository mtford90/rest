(function e$$0(t,r,d){function n(l,f){if(!r[l]){if(!t[l]){var m="function"==typeof require&&require;if(!f&&m)return m(l,!0);if(p)return p(l,!0);m=Error("Cannot find module '"+l+"'");throw m.code="MODULE_NOT_FOUND",m;}m=r[l]={exports:{}};t[l][0].call(m.exports,function(g){var c=t[l][1][g];return n(c?c:g)},m,m.exports,e$$0,t,r,d)}return r[l].exports}for(var p="function"==typeof require&&require,l=0;l<d.length;l++)n(d[l]);return n})({1:[function(e,t,r){function d(b){n.call(this,b);this.indexAttribute=
"index"}var n=e("./ReactiveQuery");r=e("./log");var p=e("./util"),l=e("./error"),q=e("./modelEvents"),f=l.InternalSiestaError,m=e("./QuerySet"),g=l.errorFactory(l.Components.ArrangedReactiveQuery),c=p._;r.loggerWithName("Query");d.prototype=Object.create(n.prototype);c.extend(d.prototype,{_refreshIndexes:function(){var b=this.results,a=this.indexAttribute;if(!b)throw new f("ArrangedReactiveQuery must be initialised");for(var k=0;k<b.length;k++)b[k][a]=k},_mergeIndexes:function(){for(var b=this.results,
a=[],k=[],h=[],v=0;v<b.length;v++){var z=b[v],g=z[this.indexAttribute];void 0==g?h.push(z):g>b.length?k.push(z):a[g]?h.push(z):a[g]=z}k=c.sortBy(k,function(a){return a[this.indexAttribute]}.bind(this));for(v=0;v<k.length;v++)z=k[v],b=this.results.length-k.length+v,z[this.indexAttribute]=b,a[b]=z;h=this._query._sortResults(h);for(k=0;h.length;){for(z=h.shift();a[k];)k++;a[k]=z;z[this.indexAttribute]=k}this.results=m(a,this.model)},init:function(b){var a=p.defer(b);n.prototype.init.call(this,function(k){k||
(this.model.hasAttributeNamed(this.indexAttribute)?(this._mergeIndexes(),this._query.clearOrdering()):k=g('Model "'+this.model.name+'" does not have an attribute named "'+this.indexAttribute+'"'));a.finish(k,k?null:this.results)}.bind(this));return a.promise},_handleNotif:function(b){b.field!=this.indexAttribute&&(n.prototype._handleNotif.call(this,b),this._refreshIndexes())},validateIndex:function(b){var a=this.results.length-1;if(!(0<=b&&b<=a))throw Error("Index "+b.toString()+" is out of bounds");
},swapObjectsAtIndexes:function(b,a){this.validateIndex(b);this.validateIndex(a);var k=this.results[b],h=this.results[a];if(!k)throw Error('No model at index "'+b.toString()+'"');if(!h)throw Error('No model at index "'+a.toString()+'"');this.results[a]=k;this.results[b]=h;k[this.indexAttribute]=a;h[this.indexAttribute]=b},swapObjects:function(b,a){var k=this.results.indexOf(b),h=this.results.indexOf(a);this.swapObjectsAtIndexes(k,h)},move:function(b,a){this.validateIndex(b);this.validateIndex(a);
var k=this.results.mutableCopy();(function(a,k){if(k>=this.length)for(var b=k-this.length;b--+1;)this.push(void 0)}).call(k,b,a);var h=k.splice(b,1)[0];this.results=k.asModelQuerySet(this.model);this.emit("change",{index:b,removed:[h],type:q.ModelEventType.Splice,obj:this,field:"results"});k.splice(a,0,h);this.results=k.asModelQuerySet(this.model);this.emit("change",{index:a,added:[h],type:q.ModelEventType.Splice,obj:this,field:"results"});this._refreshIndexes()}});t.exports=d},{"./QuerySet":7,"./ReactiveQuery":8,
"./error":14,"./log":17,"./modelEvents":20,"./util":23}],2:[function(e,t,r){function d(c){n.call(this,c);this.related=[];this.relatedCancelListeners={}}var n=e("./RelationshipProxy");e("./store");var p=e("./util"),l=p._;e("./error");var q=e("./modelEvents"),f=e("./events").wrapArray;e("./ModelInstance");var m=e("../vendor/observe-js/src/observe").ArrayObserver,g=e("./modelEvents").ModelEventType;d.prototype=Object.create(n.prototype);l.extend(d.prototype,{clearReverse:function(c){var b=this;l.each(c,
function(a){var k=b.reverseProxyForInstance(a),h=k.related.indexOf(b.object);k.makeChangesToRelatedWithoutObservations(function(){k.splice(h,1)})})},setReverseOfAdded:function(c){var b=this;l.each(c,function(a){var k=b.reverseProxyForInstance(a);k.makeChangesToRelatedWithoutObservations(function(){k.splice(0,0,b.object)})})},wrapArray:function(c){var b=this;f(c,this.reverseName,this.object);c.arrayObserver||(c.arrayObserver=new m(c),c.arrayObserver.open(function(a){a.forEach(function(a){var h=a.addedCount?
c.slice(a.index,a.index+a.addedCount):[],v=a.removed;b.clearReverse(v);b.setReverseOfAdded(h);var z=b.getForwardModel();q.emit({collection:z.collectionName,model:z.name,_id:b.object._id,field:b.getForwardName(),removed:v,added:h,type:g.Splice,index:a.index,obj:b.object})})}))},get:function(c){var b=p.defer(c);c=b.finish.bind(b);c(null,this.related);return b.promise},validate:function(c){return"[object Array]"!=Object.prototype.toString.call(c)?"Cannot assign scalar to many to many":null},set:function(c,
b){this.checkInstalled();if(c){var a;if(a=this.validate(c))return a;this.clearReverseRelated(b);this.setIdAndRelated(c,b);this.wrapArray(c);this.setIdAndRelatedReverse(c,b)}else this.clearReverseRelated(b),this.setIdAndRelated(c,b)},install:function(c){n.prototype.install.call(this,c);this.wrapArray(this.related);c["splice"+p.capitaliseFirstLetter(this.reverseName)]=l.bind(this.splice,this)},registerRemovalListener:function(c){this.relatedCancelListeners[c._id]=c.listen(function(b){}.bind(this))}});
t.exports=d},{"../vendor/observe-js/src/observe":39,"./ModelInstance":3,"./RelationshipProxy":9,"./error":14,"./events":15,"./modelEvents":20,"./store":21,"./util":23}],3:[function(e,t,r){function d(f){var g=this;this.model=f;n.subProperties(this,this.model,["collection","collectionName","_attributeNames",{name:"idField",property:"id"},{name:"modelName",property:"name"}]);q.ProxyEventEmitter.call(this);Object.defineProperties(this,{_relationshipNames:{get:function(){var c=p.map(Object.keys(g.__proxies||
{}),function(b){return g.__proxies[b]});return p.map(c,function(b){return b.isForward?b.forwardName:b.reverseName})},enumerable:!0,configurable:!0},dirty:{get:function(){if(siesta.ext.storageEnabled)return g._id in siesta.ext.storage._unsavedObjectsHash},enumerable:!0},event:{get:function(){return this._id}}});this.removed=!1}e("./log");var n=e("./util"),p=n._;e("./error");var l=e("./modelEvents"),q=e("./events"),f=e("./cache");d.prototype=Object.create(q.ProxyEventEmitter.prototype);p.extend(d.prototype,
{get:function(f){var g=n.defer(f);f=g.finish.bind(g);f(null,this);return g.promise},emit:function(f,g){"object"==typeof f?g=f:g.type=f;g=g||{};p.extend(g,{collection:this.collectionName,model:this.model.name,_id:this._id,obj:this});l.emit(g)},remove:function(d,g){g=null==g?!0:g;var c=n.defer(d);d=c.finish.bind(c);f.remove(this);this.removed=!0;g&&this.emit(l.ModelEventType.Remove,{old:this});var b=this.model.remove;if(b)if(n.paramNames(b).length){var a=this;b.call(this,function(k){d(k,a)})}else b.call(this),
d(null,this);else d(null,this);return c.promise},restore:function(d){var g=n.defer(d);d=g.finish.bind(g);var c=function(a){a||this.emit(l.ModelEventType.New,{"new":this});d(a,this)}.bind(this);if(this.removed){f.insert(this);this.removed=!1;var b=this.model.init;b?1<n.paramNames(b).length?b.call(this,!0,c):(b.call(this,!0),c()):c()}return g.promise}});p.extend(d.prototype,{getAttributes:function(){return p.extend({},this.__values)},isInstanceOf:function(f){return this.model==f},isA:function(f){return this.model==
f||this.model.isDescendantOf(f)}});p.extend(d.prototype,{_dumpString:function(f){return JSON.stringify(this._dump(f,null,4))},_dump:function(f){f=p.extend({},this.__values);f._rev=this._rev;f._id=this._id;return f}});t.exports=d},{"./cache":11,"./error":14,"./events":15,"./log":17,"./modelEvents":20,"./util":23}],4:[function(e,t,r){function d(c){n.call(this,c);this.isReverse&&(this.related=[])}var n=e("./RelationshipProxy");e("./store");var p=e("./util"),l=p._;e("./error");var q=e("./modelEvents");
e("./ModelInstance");var f=e("./events").wrapArray,m=e("../vendor/observe-js/src/observe").ArrayObserver,g=e("./modelEvents").ModelEventType;d.prototype=Object.create(n.prototype);l.extend(d.prototype,{clearReverse:function(c){var b=this;l.each(c,function(a){b.reverseProxyForInstance(a).setIdAndRelated(null)})},setReverseOfAdded:function(c){var b=this;l.each(c,function(a){b.reverseProxyForInstance(a).setIdAndRelated(b.object)})},wrapArray:function(c){var b=this;f(c,this.reverseName,this.object);c.arrayObserver||
(c.arrayObserver=new m(c),c.arrayObserver.open(function(a){a.forEach(function(a){var h=a.addedCount?c.slice(a.index,a.index+a.addedCount):[],v=a.removed;b.clearReverse(v);b.setReverseOfAdded(h);var z=b.getForwardModel();q.emit({collection:z.collectionName,model:z.name,_id:b.object._id,field:b.getForwardName(),removed:v,added:h,type:g.Splice,index:a.index,obj:b.object})})}))},get:function(c){var b=p.defer(c);c=b.finish.bind(b);c(null,this.related);return b.promise},validate:function(c){c=Object.prototype.toString.call(c);
if(this.isForward){if("[object Array]"==c)return"Cannot assign array forward oneToMany ("+c+"): "+this.forwardName}else if("[object Array]"!=c)return"Cannot scalar to reverse oneToMany ("+c+"): "+this.reverseName;return null},set:function(c,b){this.checkInstalled();if(c){var a;if(a=this.validate(c))return a;this.clearReverseRelated(b);this.setIdAndRelated(c,b);this.isReverse&&this.wrapArray(this.related);this.setIdAndRelatedReverse(c,b)}else this.clearReverseRelated(b),this.setIdAndRelated(c,b)},
install:function(c){n.prototype.install.call(this,c);this.isReverse&&(c["splice"+p.capitaliseFirstLetter(this.reverseName)]=l.bind(this.splice,this),this.wrapArray(this.related))}});t.exports=d},{"../vendor/observe-js/src/observe":39,"./ModelInstance":3,"./RelationshipProxy":9,"./error":14,"./events":15,"./modelEvents":20,"./store":21,"./util":23}],5:[function(e,t,r){function d(d){n.call(this,d)}var n=e("./RelationshipProxy");e("./store");var p=e("./util");r=p._;e("./error");e("./modelEvents");e("./ModelInstance");
d.prototype=Object.create(n.prototype);r.extend(d.prototype,{validate:function(d){return"[object Array]"==Object.prototype.toString.call(d)?"Cannot assign array to one to one relationship":null},set:function(d,e){this.checkInstalled();if(d){var f;if(f=this.validate(d))return f;this.clearReverseRelated(e);this.setIdAndRelated(d,e);this.setIdAndRelatedReverse(d,e)}else this.clearReverseRelated(e),this.setIdAndRelated(d,e)},get:function(d){var e=p.defer(d);d=e.finish.bind(e);d(null,this.related);return e.promise}});
t.exports=d},{"./ModelInstance":3,"./RelationshipProxy":9,"./error":14,"./modelEvents":20,"./store":21,"./util":23}],6:[function(e,t,r){function d(a,k){var b={},v;for(v in k)k.hasOwnProperty(v)&&"__"==v.slice(0,2)&&(b[v.slice(2)]=k[v],delete k[v]);g.extend(this,{model:a,query:k,opts:b});b.order=b.order||[];l.isArray(b.order)||(b.order=[b.order])}function n(a){var b=a.name;a=p._localCacheByType[a.collectionName];var h;a&&(h=a[b]||{});return h}r=e("./log");var p=e("./cache"),l=e("./util"),q=e("./error"),
f=e("./QuerySet"),m=q.errorFactory(q.Components.Query),g=l._,c=r.loggerWithName("Query"),b={e:function(a){var b=a.object[a.field];c.trace&&c.trace(a.field+": "+(null===b?"null":void 0===b?"undefined":b.toString())+" == "+a.value.toString());return b==a.value},lt:function(a){return a.invalid?!1:a.object[a.field]<a.value},gt:function(a){return a.invalid?!1:a.object[a.field]>a.value},lte:function(a){return a.invalid?!1:a.object[a.field]<=a.value},gte:function(a){return a.invalid?!1:a.object[a.field]>=
a.value},contains:function(a){return a.invalid?!1:-1<a.object[a.field].indexOf(a.value)}};g.extend(d,{comparators:b,registerComparator:function(a,k){b[a]||(b[a]=k)}});g.extend(d.prototype,{execute:function(a){var b=l.defer(a);a=b.finish.bind(b);this._executeInMemory(a);return b.promise},_dump:function(a){return a?"{}":{}},sortFunc:function(a){for(var b=function(a,b){return function(v,k){var h=v[b],c=k[b];"string"==typeof h||h instanceof String&&"string"==typeof c||c instanceof String?h=a?h.localeCompare(c):
c.localeCompare(h):(h instanceof Date&&(h=h.getTime()),c instanceof Date&&(c=c.getTime()),h=a?h-c:c-h);return h}},h=l,v=0;v<a.length;v++)var c=a[v],h=h.thenBy(b(c.ascending,c.field));return h==l?null:h},_sortResults:function(a){var b=this.opts.order;a&&b&&(b=g.map(b,function(a){a=a.split("-");var b=!0,k=null;1<a.length?(k=a[1],b=!1):k=a[0];return{field:k,ascending:b}}.bind(this)),b=this.sortFunc(b),a.immutable&&(a=a.mutableCopy()),b&&a.sort(b));return a},_getCacheByLocalId:function(){return g.reduce(this.model.descendants,
function(a,b){return g.extend(a,n(b))},g.extend({},n(this.model)))},_executeInMemory:function(a){var b=function(){for(var b=this._getCacheByLocalId(),v=Object.keys(b),k=[],g,d=0;d<v.length;d++){var e=b[v[d]],l=this.objectMatchesQuery(e);if("string"==typeof l){g=m(l);break}else l&&k.push(e)}k=this._sortResults(k);g&&c.error("Error executing query",g);a(g,g?null:f(k,this.model))}.bind(this);this.opts.ignoreInstalled?b():siesta._afterInstall(b)},clearOrdering:function(){this.opts.order=null},objectMatchesOrQuery:function(a,
b){for(var h in b)if(b.hasOwnProperty(h)&&this.objectMatchesBaseQuery(a,b[h]))return!0;return!1},objectMatchesAndQuery:function(a,b){for(var h in b)if(b.hasOwnProperty(h)&&!this.objectMatchesBaseQuery(a,b[h]))return!1;return!0},splitMatches:function(a,b,h){var v="e",c=b.split("."),f=c[c.length-1].split("__");2==f.length?(b=f[0],v=f[1]):b=f[0];c[c.length-1]=b;g.each(c.slice(0,c.length-1),function(b){a=a[b]});c=a[b];return(f=d.comparators[v])?f({object:a,field:b,value:h,invalid:null===c||void 0===c}):
'No comparator registered for query operation "'+v+'"'},objectMatches:function(a,b,h,v){if("$or"==b){if(!this.objectMatchesOrQuery(a,v.$or))return!1}else if("$and"==b){if(!this.objectMatchesAndQuery(a,v.$and))return!1}else{a=this.splitMatches(a,b,h);if("boolean"!=typeof a)return a;if(!a)return!1}return!0},objectMatchesBaseQuery:function(a,b){for(var h=Object.keys(b),v=0;v<h.length;v++){var c=h[v],c=this.objectMatches(a,c,b[c],b);if("boolean"!=typeof c)return c;if(!c)return!1}return!0},objectMatchesQuery:function(a){return this.objectMatchesBaseQuery(a,
this.query)}});t.exports=d},{"./QuerySet":7,"./cache":11,"./error":14,"./log":17,"./util":23}],7:[function(e,t,r){function d(a){return"string"==typeof a||a instanceof String?D.concat(B):"number"==typeof a||a instanceof Number?v.concat(z):a.getOwnPropertyNames()}function n(a,v){v in a||Object.defineProperty(a,v,{get:function(){return f(k.pluck(a,v))},set:function(a){if(c.isArray(a)){if(this.length!=a.length)throw new b({message:"Must be same length"});for(var h=0;h<a.length;h++)this[h][v]=a[h]}else for(h=
0;h<this.length;h++)this[h][v]=a}})}function p(a){return a.then&&a["catch"]}function l(a,b){b in a||(a[b]=function(){var a=arguments,v=this.map(function(v){return v[b].apply(v,a)}),h=!1;v.length&&(h=p(v[0]));return h?siesta.q.all(v):f(v)})}function q(b,v){b=k.extend([],b);v._attributeNames.concat(v._relationshipNames).concat(h).forEach(k.partial(n,b));var h=Object.keys(a.prototype);h.forEach(k.partial(l,b));return g(b)}function f(a){if(a.length){var b=a[0];d(b).forEach(function(v){"function"==typeof b[v]?
l(a,v,arguments):n(a,v)})}return g(a)}function m(){throw Error("Cannot modify a query set");}function g(a){h.forEach(function(b){a[b]=m});a.immutable=!0;a.mutableCopy=a.asArray=function(){var a=k.map(this,function(a){return a});a.asQuerySet=function(){return f(this)};a.asModelQuerySet=function(a){return q(this,a)};return a};return a}var c=e("./util"),b=e("./error").SiestaUserError,a=e("./ModelInstance"),k=e("./util")._,h="push sort reverse splice shift unshift".split(" "),v=["toString","toExponential",
"toFixed","toPrecision","valueOf"],z=["MAX_VALUE","MIN_VALUE","NEGATIVE_INFINITY","NaN","POSITIVE_INFINITY"],D="charAt charCodeAt concat fromCharCode indexOf lastIndexOf localeCompare match replace search slice split substr substring toLocaleLowerCase toLocaleUpperCase toLowerCase toString toUpperCase trim valueOf".split(" "),B=["length"];t.exports=q},{"./ModelInstance":3,"./error":14,"./util":23}],8:[function(e,t,r){function d(b){var a=this;n.call(this);g.extend(this,{_query:b,results:f([],b.model),
insertionPolicy:d.InsertionPolicy.Back,initialised:!1});Object.defineProperties(this,{initialized:{get:function(){return this.initialised}},model:{get:function(){return a._query.model}},collection:{get:function(){return a.model.collectionName}}})}r=e("./log");e("./Query");var n=e("events").EventEmitter,p=e("./events"),l=e("./modelEvents"),q=e("./error").InternalSiestaError,f=e("./QuerySet"),m=e("./util"),g=m._,c=r.loggerWithName("Query");d.prototype=Object.create(n.prototype);g.extend(d,{InsertionPolicy:{Front:"Front",
Back:"Back"}});g.extend(d.prototype,{init:function(b){c.trace&&c.trace("init");var a=m.defer(b);b=a.finish.bind(a);this.initialised?b(null,this.results):this._query.execute(function(a,h){if(a)b(a);else{this.results=h;if(!this.handler){var v=this._constructNotificationName(),g=function(a){this._handleNotif(a)}.bind(this);this.handler=g;p.on(v,g)}c.trace&&c.trace("Listening to "+v);this.initialised=!0;b(null,this.results)}}.bind(this));return a.promise},insert:function(b){var a=this.results.mutableCopy();
b=this.insertionPolicy==d.InsertionPolicy.Back?a.push(b):a.unshift(b);this.results=a.asModelQuerySet(this.model);return b},_handleNotif:function(b){c.trace&&c.trace("_handleNotif",b);if(b.type==l.ModelEventType.New){var a=b["new"];if(this._query.objectMatchesQuery(a)){c.trace&&c.trace("New object matches",a._dumpString());var k=this.insert(a);this.emit("change",{index:k,added:[a],type:l.ModelEventType.Splice,obj:this})}else c.trace&&c.trace("New object does not match",a._dumpString())}else if(b.type==
l.ModelEventType.Set){var a=b.obj,k=this.results.indexOf(a),h=-1<k,v=this._query.objectMatchesQuery(a);v&&!h?(c.trace&&c.trace("Updated object now matches!",a._dumpString()),k=this.insert(a),this.emit("change",{index:k,added:[a],type:l.ModelEventType.Splice,obj:this})):!v&&h?(c.trace&&c.trace("Updated object no longer matches!",a._dumpString()),h=this.results.mutableCopy(),b=h.splice(k,1),this.results=h.asModelQuerySet(this.model),this.emit("change",{index:k,obj:this,"new":a,type:l.ModelEventType.Splice,
removed:b})):v||h?v&&h&&(c.trace&&c.trace("Matches but already contains",a._dumpString()),this.emit("change",b)):c.trace&&c.trace("Does not contain, but doesnt match so not inserting",a._dumpString())}else if(b.type==l.ModelEventType.Remove)a=b.obj,h=this.results.mutableCopy(),k=h.indexOf(a),-1<k?(c.trace&&c.trace("Removing object",a._dumpString()),b=h.splice(k,1),this.results=f(h,this.model),this.emit("change",{index:k,obj:this,type:l.ModelEventType.Splice,removed:b})):c.trace&&c.trace("No modelEvents neccessary.",
a._dumpString());else throw new q('Unknown change type "'+b.type.toString()+'"');this.results=f(this._query._sortResults(this.results),this.model)},_constructNotificationName:function(){return this.model.collectionName+":"+this.model.name},terminate:function(){this.handler&&p.removeListener(this._constructNotificationName(),this.handler);this.handler=this.results=null},listen:function(b){this.on("change",b);return function(){this.removeListener("change",b)}.bind(this)},listenOnce:function(b){this.once("change",
b)}});t.exports=d},{"./Query":6,"./QuerySet":7,"./error":14,"./events":15,"./log":17,"./modelEvents":20,"./util":23,events:33}],9:[function(e,t,r){function d(c){var b=this;c=c||{};l.extend(this,{object:null,related:null});Object.defineProperties(this,{isForward:{get:function(){return!b.isReverse},set:function(a){b.isReverse=!a},enumerable:!0}});p.extendFromOpts(this,c,{reverseModel:null,forwardModel:null,forwardName:null,reverseName:null,isReverse:null});this.cancelListens={}}var n=e("./error").InternalSiestaError;
e("./store");var p=e("./util"),l=p._;e("./Query");e("./log");e("./cache");var q=e("./events").wrapArray,f=e("../vendor/observe-js/src/observe").ArrayObserver,m=e("./modelEvents"),g=m.ModelEventType;l.extend(d,{});l.extend(d.prototype,{install:function(c){if(c){if(this.object)throw new n("Already installed.");this.object=c;var b=this,a=this.getForwardName();Object.defineProperty(c,a,{get:function(){return b.related},set:function(a){b.set(a)},configurable:!0,enumerable:!0});c.__proxies||(c.__proxies=
{});c.__proxies[a]=this;c._proxies||(c._proxies=[]);c._proxies.push(this)}else throw new n("No object passed to relationship install");}});l.extend(d.prototype,{set:function(c,b){throw new n("Must subclass RelationshipProxy");},get:function(c){throw new n("Must subclass RelationshipProxy");}});l.extend(d.prototype,{proxyForInstance:function(c,b){var a=b?this.getReverseName():this.getForwardName(),k=b?this.reverseModel:this.forwardModel;if(p.isArray(c))k=l.map(c,function(b){return b.__proxies[a]});
else{var h=c.__proxies[a];if(!h)throw new n('No proxy with name "'+a+'" on mapping '+k.name);k=h}return k},reverseProxyForInstance:function(c){return this.proxyForInstance(c,!0)},getReverseName:function(){return this.isForward?this.reverseName:this.forwardName},getForwardName:function(){return this.isForward?this.forwardName:this.reverseName},getForwardModel:function(){return this.isForward?this.forwardModel:this.reverseModel},clearRemovalListener:function(c){c=c._id;var b=this.cancelListens[c];b&&
(b(),this.cancelListens[c]=null)},listenForRemoval:function(c){this.cancelListens[c._id]=c.listen(function(b){b.type==g.Remove&&(p.isArray(this.related)?(b=this.related.indexOf(c),this.splice(b,1)):this.setIdAndRelated(null),this.clearRemovalListener(c))}.bind(this))},setIdAndRelated:function(c,b){b=b||{};b.disableevents||this.registerSetChange(c);var a=this.related;a&&this.clearRemovalListener(a);c?p.isArray(c)?(this.related=c,c.forEach(function(a){this.listenForRemoval(a)}.bind(this))):(this.related=
c,this.listenForRemoval(c)):this.related=null},checkInstalled:function(){if(!this.object)throw new n("Proxy must be installed on an object before can use it.");},splicer:function(c){c=c||{};return function(b,a){c=c||{};c.disableevents||this.registerSpliceChange.apply(this,arguments);var k=Array.prototype.slice.call(arguments,2);return l.partial(this.related.splice,b,a).apply(this.related,k)}.bind(this)},clearReverseRelated:function(c){c=c||{};var b=this;if(this.related){var a=this.reverseProxyForInstance(this.related),
a=p.isArray(a)?a:[a];l.each(a,function(a){if(p.isArray(a.related)){var h=a.related.indexOf(b.object);a.makeChangesToRelatedWithoutObservations(function(){a.splicer(c)(h,1)})}else a.setIdAndRelated(null,c)})}},setIdAndRelatedReverse:function(c,b){var a=this,k=this.reverseProxyForInstance(c),k=p.isArray(k)?k:[k];l.each(k,function(h){p.isArray(h.related)?h.makeChangesToRelatedWithoutObservations(function(){h.splicer(b)(h.related.length,0,a.object)}):(h.clearReverseRelated(b),h.setIdAndRelated(a.object,
b))})},makeChangesToRelatedWithoutObservations:function(c){this.related?(this.related.arrayObserver.close(),this.related.arrayObserver=null,c(),this.wrapArray(this.related)):c()},registerSetChange:function(c){var b=this.object;if(!b)throw new n("Proxy must have an object associated");var a=b.model.name,k=b.collectionName,h=this.related;p.isArray(h)&&!h.length&&(h=null);m.emit({collection:k,model:a,_id:b._id,field:this.getForwardName(),old:h,"new":c,type:g.Set,obj:b})},registerSpliceChange:function(c,
b){var a=Array.prototype.slice.call(arguments,2);m.emit({collection:this.object.collectionName,model:this.object.model.name,_id:this.object._id,field:this.getForwardName(),index:c,removed:this.related?this.related.slice(c,c+b):null,added:a.length?a:[],type:g.Splice,obj:this.object})},wrapArray:function(c){var b=this;q(c,this.reverseName,this.object);c.arrayObserver||(c.arrayObserver=new f(c),c.arrayObserver.open(function(a){a.forEach(function(a){var h=a.addedCount?c.slice(a.index,a.index+a.addedCount):
[],v=b.getForwardModel();m.emit({collection:v.collectionName,model:v.name,_id:b.object._id,field:b.getForwardName(),removed:a.removed,added:h,type:g.Splice,obj:b.object})})}))},splice:function(){this.splicer({}).apply(this,arguments)}});t.exports=d},{"../vendor/observe-js/src/observe":39,"./Query":6,"./cache":11,"./error":14,"./events":15,"./log":17,"./modelEvents":20,"./store":21,"./util":23}],10:[function(e,t,r){t.exports={OneToMany:"OneToMany",OneToOne:"OneToOne",ManyToMany:"ManyToMany"}},{}],
11:[function(e,t,r){function d(a){var b=a.name;if(a=k[a.collectionName])if(b=a[b]){a=[];for(var h in b)b.hasOwnProperty(h)&&a.push(b[h]);if(1<a.length)throw new g("A singleton model has more than 1 object in the cache! This is a serious error. Either a model has been modified after objects have already been created, or something has gonevery wrong. Please file a bug report if the latter.");if(a.length)return a[0]}return null}function n(a,c){var k=c.model.name,g=c.model.collectionName;if(h[g]&&(k=
h[g][k]))return(k=k[a])?b.debug&&b.debug("Remote cache hit: "+k._dump(!0)):b.debug&&b.debug("Remote cache miss: "+a),k;b.debug&&b.debug("Remote cache miss: "+a);return null}function p(a,c,k){if(a){var f=a.model.collectionName;if(f){h[f]||(h[f]={});var d=a.model.name;if(d)if(h[f][d]||(h[f][d]={}),k&&(h[f][d][k]=null),k=h[f][d][c]){if(a!=k)throw c="Object "+f.toString()+":"+d.toString()+"["+a.model.id+'="'+c+'"] already exists in the cache. This is a serious error, please file a bug report if you are experiencing this out in the wild',
b.error(c,{obj:a,cachedObject:k}),new g(c);b.debug.isEnabled&&b.debug("Object has already been inserted: "+a._dump(!0))}else h[f][d][c]=a,b.debug.isEnabled&&b.debug("Remote cache insert: "+a._dump(!0)),b.trace.isEnabled&&b.trace("Remote cache now looks like: "+l(!0));else throw new g("Model has no type",{model:a.model,obj:a});}else throw new g("Model has no collection",{model:a.model,obj:a});}else throw b.error("Must pass an object when inserting to cache"),new g("Must pass an object when inserting to cache");
}function l(a){var b={},k;for(k in h)if(h.hasOwnProperty(k)){var g={};b[k]=g;var f=h[k],d;for(d in f)if(f.hasOwnProperty(d)){var l={};g[d]=l;var e=f[d],m;for(m in e)e.hasOwnProperty(m)&&e[m]&&(l[m]=e[m]._dump())}}return a?c.prettyPrint((b,null,4)):b}function q(b){var h={},k;for(k in a)a.hasOwnProperty(k)&&(h[k]=a[k]._dump());return b?c.prettyPrint((h,null,4)):h}function f(h){b.debug.isEnabled&&b.debug("get",h);var c,k;if(c=h._id){(k=a[c])?b.debug.isEnabled&&b.debug("Local cache hit: "+k._dump(!0)):
b.debug.isEnabled&&b.debug("Local cache miss: "+c);if(k)return k;if(h.model)return c=h.model.id,k=h[c],b.debug.isEnabled&&b.debug(c+"="+k),n(k,h)}else if(h.model){c=h.model.id;if(k=h[c])return n(k,h);if(h.model.singleton)return d(h.model)}else b.warn("Invalid opts to cache",{opts:h});return null}function m(a){var b={_id:a._id},h=a.model;h.id&&a[h.id]&&(b.model=h,b[h.id]=a[h.id]);return!!f(b)}t=e("./log");var g=e("./error").InternalSiestaError,c=e("./util"),b=t.loggerWithName("Cache"),a={},k={},h=
{};r._remoteCache=function(){return h};r._localCache=function(){return a};Object.defineProperty(r,"_localCacheByType",{get:function(){return k}});r.get=f;r.insert=function(h){var c=h._id;if(c){var f=h.model.collectionName,d=h.model.name;b.debug.isEnabled&&b.debug("Local cache insert: "+h._dumpString());if(!a[c])a[c]=h,b.trace.isEnabled&&b.trace("Local cache now looks like: "+q(!0)),k[f]||(k[f]={}),k[f][d]||(k[f][d]={}),k[f][d][c]=h;else if(a[c]!=h)throw h='Object with _id="'+c.toString()+'" is already in the cache. This is a serious error. Please file a bug report if you are experiencing this out in the wild',
b.error(h),new g(h);}c=h.idField;(f=h[c])?p(h,f):b.debug.isEnabled&&b.debug('No remote id ("'+c+'") so wont be placing in the remote cache',h)};r.remoteInsert=p;r.reset=function(){h={};a={};k={}};r._dump=function(a){var b={localCache:q(),remoteCache:l()};return a?c.prettyPrint((b,null,4)):b};r.contains=m;r.remove=function(b){if(m(b)){var c=b.model.collectionName,f=b.model.name,d=b._id;if(!f)throw g("No mapping name");if(!c)throw g("No collection name");if(!d)throw g("No _id");delete k[c][f][d];delete a[d];
b.model.id&&(b=b[b.model.id])&&delete h[c][f][b]}else throw new g("Object was not in cache.");};r.getSingleton=d},{"./error":14,"./log":17,"./util":23}],12:[function(e,t,r){function d(a,b){var c=this;if(!a)throw Error("Collection must have a name");b=b||{};m.extendFromOpts(this,b,{baseURL:""});g.extend(this,{name:a,_rawModels:{},_models:{},_opts:b,installed:!1});Object.defineProperties(this,{dirty:{get:function(){if(siesta.ext.storageEnabled)return!!Object.keys(siesta.ext.storage._unsavedObjectsByCollection[c.name]||
{}).length},enumerable:!0}});n.register(this);f.ProxyEventEmitter.call(this,this.name)}r=e("./log");var n=e("./collectionRegistry").CollectionRegistry,p=e("./error").InternalSiestaError,l=e("./model"),q=e("extend");e("../vendor/observe-js/src/observe");var f=e("./events"),m=e("./util"),g=m._,c=e("./error"),b=c.errorFactory(c.Components.Collection);e("./cache");var a=["PUT","PATCH","POST","DELETE"],k=r.loggerWithName("Collection");d.prototype=Object.create(f.ProxyEventEmitter.prototype);g.extend(d.prototype,
{install:function(a){var b=m.defer(a),c=this;if(this.installed)throw new p('Collection "'+this.name+'" has already been installed');var f=[],d;for(d in this._models)this._models.hasOwnProperty(d)&&f.push(this._models[d]);k.info.isEnabled&&k.info("There are "+f.length.toString()+" mappings to install");f.length?(a=g.map(f,function(a){return g.bind(a.install,a)}),m.async.parallel(a,function(a){if(a)k.error("Failed to install collection",a);else{c.installed=!0;var h=[];g.each(f,function(a){k.info.isEnabled&&
k.info('Installing relationships for mapping with name "'+a.name+'"');(a=a.installRelationships())&&h.push(a)});h.length||g.each(f,function(a){k.info.isEnabled&&k.info('Installing reverse relationships for mapping with name "'+a.name+'"');(a=a.installReverseRelationships())&&h.push(a)});1==h.length?a=h[0]:h.length&&(a=h)}c._finaliseInstallation(a,b.finish.bind(b))})):c._finaliseInstallation(null,b.finish.bind(b));return b.promise},_finaliseInstallation:function(a,c){a&&(a=b("Errors were encountered whilst setting up the collection",
{errors:a}));a||(this.installed=!0,e("./index")[this.name]=this);c(a)},_model:function(a,b){if(a){this._rawModels[a]=b;b=q(!0,{},b);b.name=a;b.collection=this;var c=new l(b);this._models[a]=c;return this[a]=c}throw Error("No name specified when creating mapping");},model:function(a){if(this.installed)throw Error("Cannot create new models once the object graph is established!");var b=this;if(arguments.length){if(1==arguments.length){if(m.isArray(arguments[0]))return g.map(arguments[0],function(a){return b._model(a.name,
a)});var c,k;m.isString(arguments[0])?(c=arguments[0],k={}):(k=arguments[0],c=k.name);return this._model(c,k)}return"string"==typeof arguments[0]?this._model(arguments[0],arguments[1]):g.map(arguments,function(a){return b._model(a.name,a)})}return null},descriptor:function(b){var c=[];if(siesta.ext.httpEnabled){b.collection=this;for(var k=siesta.ext.http._resolveMethod(b.method),f=[],g=[],d=0;d<k.length;d++){var e=k[d];-1<a.indexOf(e)?f.push(e):g.push(e)}f.length&&(k=q({},b),k.method=f,k=new siesta.ext.http.RequestDescriptor(k),
siesta.ext.http.DescriptorRegistry.registerRequestDescriptor(k),c.push(k));g.length&&(b=q({},b),b.method=g,b=new siesta.ext.http.ResponseDescriptor(b),siesta.ext.http.DescriptorRegistry.registerResponseDescriptor(b),c.push(b))}else throw Error("HTTP module not installed.");return c},_dump:function(a){var b={};b.installed=this.installed;b.docId=this._docId;b.name=this.name;b.baseURL=this.baseURL;return a?m.prettyPrint(b):b},count:function(a){var b=m.defer(a);a=g.map(this._models,function(a){return g.bind(a.count,
a)});m.async.parallel(a,function(a,c){var h;a||(h=g.reduce(c,function(a,b){return a+b},0));b.finish(a,h)});return b.promise}});t.exports=d},{"../vendor/observe-js/src/observe":39,"./cache":11,"./collectionRegistry":13,"./error":14,"./events":15,"./index":16,"./log":17,"./model":19,"./util":23,extend:37}],13:[function(e,t,r){function d(){if(!this)return new d;this.collectionNames=[]}var n=e("./util")._;n.extend(d.prototype,{register:function(d){var e=d.name;this[e]=d;this.collectionNames.push(e)},
reset:function(){var d=this;n.each(this.collectionNames,function(e){delete d[e]});this.collectionNames=[]}});r.CollectionRegistry=new d},{"./util":23}],14:[function(e,t,r){function d(d,e,f){this.message=d;this.context=e;(f=f||arguments.callee)&&Error.captureStackTrace&&Error.captureStackTrace(this,f)}function n(d,e,f){f=f||{};this.component=d;this.message=e;for(var m in f)f.hasOwnProperty(m)&&(this[m]=f[m]);this.isUserError=!0}d.prototype=Object.create(Error.prototype);d.prototype.name="InternalSiestaError";
d.prototype.constructor=d;e={Unknown:0,NoDescriptorMatched:1};var p={Mapping:"Mapping",HTTP:"HTTP",ReactiveQuery:"ReactiveQuery",ArrangedReactiveQuery:"ArrangedReactiveQuery",Collection:"Collection",Query:"Query"};r={};r[e.NoDescriptorMatched]="No descriptor matched the HTTP response/request.";t.exports={InternalSiestaError:d,SiestaUserError:n,ErrorCode:e,ErrorField:{Message:"message",Code:"code"},Message:r,Components:p,errorFactory:function(d){if(d in p)return function(e,f){return new n(d,e,f)};
throw new n('No such component "'+d+'"');}}},{}],15:[function(e,t,r){function d(f){p.extend(this,{event:f,listeners:{}})}r=e("events").EventEmitter;var n=e("../vendor/observe-js/src/observe").ArrayObserver,p=e("./util")._,l=e("./modelEvents"),q=new r;q.setMaxListeners(100);p.extend(d.prototype,{listen:function(f,d){if("function"==typeof f)d=f,f=null;else{var g=d;d=function(b){b=b||{};f?b.type==f&&g(b):g(b)};var c=this.listeners;f&&(c[f]||(c[f]=[]),c[f].push(d))}q.on(this.event,d);return function(){this._removeListener(d,
f)}.bind(this)},listenOnce:function(f,d){var g=this.event;if("function"==typeof f)d=f,f=null;else{var c=d;d=function(b){b=b||{};f?b.type==f&&(q.removeListener(g,d),c(b)):c(b)}}return f?q.on(g,d):q.once(g,d)},_removeListener:function(f,d){if(d){var g=this.listeners[d],c=g.indexOf(f);g.splice(c,1)}return q.removeListener(this.event,f)},emit:function(f,d){"object"==typeof f?d=f:(d=d||{},d.type=f);q.emit.call(q,this.event,d)},_removeAllListeners:function(d){(this.listeners[d]||[]).forEach(function(d){q.removeListener(this.event,
d)}.bind(this));this.listeners[d]=[]},removeAllListeners:function(d){if(d)this._removeAllListeners(d);else for(d in this.listeners)this.listeners.hasOwnProperty(d)&&this._removeAllListeners(d)}});p.extend(d.prototype,{on:d.prototype.listen});p.extend(q,{ProxyEventEmitter:d,wrapArray:function(d,e,g){d.observer||(d.observer=new n(d),d.observer.open(function(c){-1<g._attributeNames.indexOf(e)&&c.forEach(function(b){l.emit({collection:g.collectionName,model:g.model.name,_id:g._id,index:b.index,removed:b.removed,
added:b.addedCount?d.slice(b.index,b.index+b.addedCount):[],type:l.ModelEventType.Splice,field:e,obj:g})})}))}});t.exports=q},{"../vendor/observe-js/src/observe":39,"./modelEvents":20,"./util":23,events:33}],16:[function(e,t,r){var d=e("./util"),n=e("./collectionRegistry").CollectionRegistry,p=e("./collection"),l=e("./cache");r=e("./model");var q=e("./error"),f=e("./events"),m=e("./RelationshipType"),g=e("./ReactiveQuery"),c=e("./ManyToManyProxy"),b=e("./OneToOneProxy"),a=e("./OneToManyProxy"),k=
e("./RelationshipProxy"),h=e("./modelEvents"),v=e("./Query"),z=e("./QuerySet"),D=e("./log"),B=d._,x=function(a){x.ext||(x.ext={});B.extend(x.ext,a||{});return x};Object.defineProperty(x,"q",{get:function(){return this._q||window.q||window.Q},set:function(a){this._q=a}});B.extend(x,{on:f.on.bind(f),off:f.removeListener.bind(f),once:f.once.bind(f),removeAllListeners:f.removeAllListeners.bind(f)});B.extend(x,{removeListener:x.off,addListener:x.on});B.extend(x,{RelationshipType:m,ModelEventType:h.ModelEventType,
log:D.Level,InsertionPolicy:g.InsertionPolicy,_internal:{log:D,Model:r,error:q,ModelEventType:h.ModelEventType,ModelInstance:e("./ModelInstance"),extend:e("extend"),MappingOperation:e("./mappingOperation"),events:f,ProxyEventEmitter:f.ProxyEventEmitter,cache:e("./cache"),modelEvents:h,CollectionRegistry:e("./collectionRegistry").CollectionRegistry,Collection:p,utils:d,util:d,_:d._,querySet:z,observe:e("../vendor/observe-js/src/observe"),Query:v,Store:e("./store"),ManyToManyProxy:c,OneToManyProxy:a,
OneToOneProxy:b,RelationshipProxy:k},_:d._,async:d.async,isArray:d.isArray,isString:d.isString});x.ext={};var w=!1,A=!1;B.extend(x,{reset:function(a){A=w=!1;delete this.queuedTasks;l.reset();n.reset();f.removeAllListeners();x.ext.httpEnabled&&x.ext.http.DescriptorRegistry.reset();x.ext.storageEnabled?x.ext.storage._reset(a):a()},resetData:function(a){var b=d.defer(a);a=b.finish.bind(b);x.ext.storage._reset(function(){var b=[],c=n.collectionNames.reduce(function(a,c){var h=n[c]._models;b.push(c);Object.keys(h).forEach(function(b){var c=
h[b];a.push(function(a){c.all(function(b,c){b||c.remove();a(b)})})});return a},[]);d.async.series([B.partial(d.async.parallel,c)],a)});return b.promise},collection:function(a,b){return new p(a,b)},install:function(a){if(A||w)throw new q.InternalSiestaError("Already installing...");A=!0;var b=d.defer(a);a=b.finish.bind(b);var c=B.map(n.collectionNames,function(a){return function(b){n[a].install(b)}});x.ext.storageEnabled&&c.unshift(x.ext.storage.ensureIndexesForAll);var h=this;x.async.series(c,function(b){if(b)a(b);
else{if(x.ext.httpEnabled){b=function(a){Object.keys(a).forEach(function(b){a[b].forEach(function(a){(a=a._resolveCollectionAndModel())&&c.push(a)})})};var c=[],k=x.ext.http.DescriptorRegistry,d=k.responseDescriptors;b(k.requestDescriptors);b(d);if(c.length){a(c);return}}x.ext.storageEnabled?x.ext.storage._load(function(b){b||(w=!0,h.queuedTasks&&h.queuedTasks.execute());a(b)}):(w=!0,h.queuedTasks&&h.queuedTasks.execute(),a())}});return b.promise},_pushTask:function(a){this.queuedTasks||(this.queuedTasks=
new function(){this.tasks=[];this.execute=function(){this.tasks.forEach(function(a){a()});this.tasks=[]}.bind(this)});this.queuedTasks.tasks.push(a)},_afterInstall:function(a){w?a():(A||this.install(function(a){a&&console.error("Error setting up siesta",a);delete this.queuedTasks}.bind(this)),w?a():this._pushTask(a))},setLogLevel:function(a,b){D.loggerWithName(a).setLevel(b)},notify:d.next,registerComparator:v.registerComparator.bind(v)});Object.defineProperties(x,{_canChange:{get:function(){return!(A||
w)}}});"undefined"!=typeof window&&(window.siesta=x);t.exports=x;var C=Function.prototype.apply.bind(Function.prototype.bind);Object.defineProperty(Function.prototype,"bind",{value:function(a){var b=C(this,arguments);Object.defineProperty(b,"__siesta_bound_object",{value:a,writable:!0,configurable:!0,enumerable:!1});return b}});e("../http");e("../storage")},{"../http":28,"../storage":38,"../vendor/observe-js/src/observe":39,"./ManyToManyProxy":2,"./ModelInstance":3,"./OneToManyProxy":4,"./OneToOneProxy":5,
"./Query":6,"./QuerySet":7,"./ReactiveQuery":8,"./RelationshipProxy":9,"./RelationshipType":10,"./cache":11,"./collection":12,"./collectionRegistry":13,"./error":14,"./events":15,"./log":17,"./mappingOperation":18,"./model":19,"./modelEvents":20,"./store":21,"./util":23,extend:37}],17:[function(e,t,r){function d(e){if(!this)return new d(e);this.name=e;l[e]=d.Level.warn;this.trace=n(this,p.bind(console.debug?console.debug:console.log,console),d.Level.trace);this.debug=n(this,p.bind(console.debug?console.debug:
console.log,console),d.Level.debug);this.info=n(this,p.bind(console.info?console.info:console.log,console),d.Level.info);this.log=n(this,p.bind(console.log,console),d.Level.info);this.warn=n(this,p.bind(console.warn?console.warn:console.log,console),d.Level.warning);this.error=n(this,p.bind(console.error?console.error:console.log,console),d.Level.error);this.fatal=n(this,p.bind(console.error?console.error:console.log,console),d.Level.fatal)}function n(d,f,e){var g=function(c){d.performLog(f,e,c,arguments)};
Object.defineProperty(g,"isEnabled",{get:function(){var c=d.currentLevel();return e>=c},enumerable:!0,configurable:!0});g.f=f;g.logger=d;g.level=e;return g}var p=e("./util")._,l={};d.Level={trace:0,debug:1,info:2,warning:3,warn:3,error:4,fatal:5};d.LevelText={};d.LevelText[d.Level.trace]="TRACE";d.LevelText[d.Level.debug]="DEBUG";d.LevelText[d.Level.info]="INFO ";d.LevelText[d.Level.warning]="WARN ";d.LevelText[d.Level.error]="ERROR";d.levelAsText=function(d){return this.LevelText[d]};d.loggerWithName=
function(e){return new d(e)};d.prototype.currentLevel=function(){var e=l[this.name];return e?e:d.Level.trace};d.prototype.setLevel=function(d){l[this.name]=d};d.prototype.override=function(e,f,l){var g=this[d.levelAsText(e).trim().toLowerCase()].f,c=Array.prototype.slice.call(arguments,3,arguments.length);this.performLog(g,e,l,c,f)};d.prototype.performLog=function(e,f,l,g,c){if((void 0!==c?c:this.currentLevel())<=f){e=p.partial(e,d.levelAsText(f)+" ["+this.name+"]: "+l);f=[];for(l=0;l<g.length;l++)f[l]=
g[l];f.splice(0,1);e.apply(e,f)}};t.exports=d},{"./util":23}],18:[function(e,t,r){function d(c){this._opts=c;q.extendFromOpts(this,c,{model:null,data:null,objects:[],disableevents:!1,_ignoreInstalled:!1,fromStorage:!1});f.extend(this,{errors:[],subTaskResults:{},_newObjects:[]})}var n=e("./store"),p=e("./ModelInstance");r=e("./log");e("./error");var l=e("./cache"),q=e("./util"),f=q._,m=q.async;e("./modelEvents");var g=r.loggerWithName("Mapping");g.setLevel(r.Level.trace);f.extend(d.prototype,{mapAttributes:function(){for(var c=
0;c<this.data.length;c++){var b=this.data[c],a=this.objects[c];b!=a&&a&&(f.each(this.model._attributeNames,function(c){void 0!==b[c]&&(this.disableevents?a.__values[c]=b[c]:a[c]=b[c])}.bind(this)),b._rev&&(a._rev=b._rev))}},_map:function(){var c=this,b;this.mapAttributes();var a=f.keys(c.subTaskResults);f.each(a,function(a){for(var h=c.subTaskResults[a],d=h.indexes,h=h.objects,g=c.getRelatedData(a).relatedData,h=q.unflattenArray(h,g),g=0;g<h.length;g++){var f=d[g],e=c.errors[f];b=e?e[a]:null;if(!b){var e=
h[g],l=c.objects[f];l&&(b=l.__proxies[a].set(e,{disableevents:c.disableevents}))&&(c.errors[f]||(c.errors[f]={}),c.errors[f][a]=b)}}})},_lookup:function(c){var b=q.defer(c);c=b.finish.bind(b);for(var a=this,k=[],h=[],d=0;d<this.data.length;d++)if(!this.objects[d]){var e,m=this.data[d];e="string"==typeof m||"number"==typeof m||m instanceof String;m?e?(e={index:d,datum:{}},e.datum[a.model.id]=m,k.push(e)):m instanceof p?this.objects[d]=m:m._id?h.push({index:d,datum:m}):m[a.model.id]?k.push({index:d,
datum:m}):this.objects[d]=a._new():this.objects[d]=null}q.async.parallel([function(b){var c=f.pluck(f.pluck(h,"datum"),"_id");c.length?n.getMultipleLocal(c,function(k,d){if(!k)for(var g=0;g<c.length;g++){var f=d[g],v=c[g],e=h[g];f||(f=l.get({_id:v}))||(f=a._new({_id:v},!a.disableevents));a.objects[e.index]=f}b(k)}):b()},function(b){var c=f.pluck(f.pluck(k,"datum"),a.model.id);c.length?(g.trace.isEnabled&&g.trace("Looking up remoteIdentifiers: "+q.prettyPrint(c)),n.getMultipleRemote(c,a.model,function(h,
f){if(!h){if(g.trace.isEnabled){var e={};for(d=0;d<f.length;d++)e[c[d]]=f[d]?f[d]._id:null;g.trace("Results for remoteIdentifiers: "+q.prettyPrint(e))}for(d=0;d<f.length;d++){var z=f[d],e=k[d];if(z)a.objects[e.index]=z;else{var z=c[d],m={model:a.model};m[a.model.id]=z;(m=l.get(m))?a.objects[e.index]=m:(a.objects[e.index]=a._new(),a.objects[e.index][a.model.id]=z)}}}b(h)})):b()}],c);return b.promise},_lookupSingleton:function(c){var b=q.defer(c);c=b.finish.bind(b);for(var a=f.pluck(this.data,"_id"),
k,h=0;h<a.length;h++)if(a[h]){k={_id:a[h]};break}for(var a=l.getSingleton(this.model)||this._new(k),h=0;h<this.data.length;h++)this.objects[h]=a;c();return b.promise},_new:function(){var c=this.model,c=c._new.apply(c,arguments);this._newObjects.push(c);return c},start:function(c){if(this.data.length){var b=this,a=[];a.push(f.bind(this.model.singleton?this._lookupSingleton:this._lookup,this));a.push(f.bind(this._executeSubOperations,this));q.async.parallel(a,function(){try{b._map();var a=this.fromStorage,
h=f.reduce(b._newObjects,function(b,h){var d=h.model.init;d&&(1<q.paramNames(d).length?b.push(f.bind(d,h,a,c)):d.call(h,a));return b},[]);m.parallel(h,function(){c(b.errors.length?b.errors:null,b.objects)})}catch(d){console.error("Uncaught error when executing init funcitons on models.",d),c(d)}}.bind(this))}else c(null,[])},getRelatedData:function(c){for(var b=[],a=[],k=0;k<this.data.length;k++){var h=this.data[k];h&&h[c]&&(b.push(k),a.push(h[c]))}return{indexes:b,relatedData:a}},processErrorsFromTask:function(c,
b,a){if(b.length){var k=this.getRelatedData(c).relatedData;b=q.unflattenArray(b,k);for(k=0;k<b.length;k++){var h=a[k],d=b[k],g=d;q.isArray(d)&&(g=f.reduce(d,function(a,b){return a||b},!1));g&&(this.errors[h]||(this.errors[h]={}),this.errors[h][c]=d)}}},_executeSubOperations:function(c){var b=this,a=f.keys(this.model.relationships);a.length?(a=f.reduce(a,function(a,c){var g=b.model.relationships[c],f=g.forwardName==c?g.reverseModel:g.forwardModel;f.singleton&&!g.isReverse&&this.data.forEach(function(a){a[c]||
(a[c]={})});var g=this.getRelatedData(c),e=g.indexes,g=g.relatedData;if(g.length)var g=q.flattenArray(g),l=new d({model:f,data:g,disableevents:b.disableevents,_ignoreInstalled:b._ignoreInstalled,fromStorage:this.fromStorage});l&&a.push(function(a){l.start(function(k,d){b.subTaskResults[c]={errors:k,objects:d,indexes:e};b.processErrorsFromTask(c,l.errors,e);a()})});return a}.bind(this),[]),m.parallel(a,function(a){c(a)})):c()}});t.exports=d},{"./ModelInstance":3,"./cache":11,"./error":14,"./log":17,
"./modelEvents":20,"./store":21,"./util":23}],19:[function(e,t,r){function d(a){var b=this;this._opts=a?w.extend({},a):{};g.extendFromOpts(this,a,{methods:{},attributes:[],collection:function(a){g.isString(a)&&(a=n[a]);return a},id:"id",relationships:[],name:null,indexes:[],singleton:!1,statics:this.installStatics.bind(this),properties:{},init:null,remove:null});this.attributes=d._processAttributes(this.attributes);w.extend(this,{_installed:!1,_relationshipsInstalled:!1,_reverseRelationshipsInstalled:!1,
children:[]});Object.defineProperties(this,{_relationshipNames:{get:function(){return Object.keys(b.relationships)},enumerable:!0},_attributeNames:{get:function(){var a=[];b.id&&a.push(b.id);w.each(b.attributes,function(b){a.push(b.name)});return a},enumerable:!0,configurable:!0},installed:{get:function(){return b._installed&&b._relationshipsInstalled&&b._reverseRelationshipsInstalled},enumerable:!0,configurable:!0},descendants:{get:function(){return w.reduce(b.children,function(a,b){return Array.prototype.concat.call(a,
b.descendants)}.bind(b),w.extend([],b.children))},enumerable:!0},dirty:{get:function(){if(siesta.ext.storageEnabled)return!!Object.keys((siesta.ext.storage._unsavedObjectsByCollection[this.collectionName]||{})[this.name]||{}).length},enumerable:!0},collectionName:{get:function(){return this.collection.name},enumerable:!0}});k.ProxyEventEmitter.call(this,this.collectionName+":"+this.name)}r=e("./log");var n=e("./collectionRegistry").CollectionRegistry,p=e("./error").InternalSiestaError,l=e("./RelationshipType"),
q=e("./Query"),f=e("./mappingOperation"),m=e("./ModelInstance"),g=e("./util"),c=e("./cache");e("./store");var b=e("extend"),a=e("./modelEvents"),k=e("./events"),h=e("./events").wrapArray;e("./RelationshipProxy");var v=e("./OneToManyProxy"),z=e("./OneToOneProxy"),D=e("./ManyToManyProxy"),B=e("./ReactiveQuery"),x=e("./ArrangedReactiveQuery"),w=g._,A=g.guid,C=a.ModelEventType,y=r.loggerWithName("Model");w.extend(d,{_processAttributes:function(a){return w.reduce(a,function(a,b){"string"==typeof b?a.push({name:b}):
a.push(b);return a},[])}});d.prototype=Object.create(k.ProxyEventEmitter.prototype);w.extend(d.prototype,{installStatics:function(a){a&&w.each(Object.keys(a),function(b){this[b]?y.error('Static method with name "'+b+'" already exists. Ignoring it.'):this[b]=a[b].bind(this)}.bind(this));return a},installRelationships:function(){if(this._relationshipsInstalled)throw new p('Relationships for "'+this.name+'" have already been installed');this._relationships=[];if(this._opts.relationships)for(var a in this._opts.relationships)if(this._opts.relationships.hasOwnProperty(a)){var b=
this._opts.relationships[a];if(!b.isReverse){y.debug.isEnabled&&y.debug(this.name+": configuring relationship "+a,b);b.type||(b.type=this.singleton?l.OneToOne:l.OneToMany);if(this.singleton&&b.type==l.ManyToMany)return"Singleton model cannot use ManyToMany relationship.";if(b.type==l.OneToMany||b.type==l.OneToOne||b.type==l.ManyToMany){var c=b.model;delete b.model;var h;if(c instanceof d)h=c;else{y.debug.isEnabled&&y.debug("reverseModelName",c);if(!this.collection)throw new p("Model must have collection");
var k=this.collection;if(!k)throw new p("Collection "+this.collectionName+" not registered");h=k[c]}if(!h&&(k=c.split("."),2==k.length)){h=k[0];c=k[1];k=n[h];if(!k)return'Collection with name "'+h+'" does not exist.';h=k[c]}y.debug.isEnabled&&y.debug("reverseModel",h);if(h)b.reverseModel=h,b.forwardModel=this,b.forwardName=a,b.reverseName=b.reverse||"reverse_"+a,delete b.reverse,b.isReverse=!1;else return'Model with name "'+c.toString()+'" does not exist'}else return"Relationship type "+b.type+" does not exist"}}this._relationshipsInstalled=
!0;return null},installReverseRelationships:function(){if(this._reverseRelationshipsInstalled)throw new p('Reverse relationships for "'+this.name+'" have already been installed.');for(var a in this.relationships)if(this.relationships.hasOwnProperty(a)){var c=this.relationships[a],c=b(!0,{},c);c.isReverse=!0;var h=c.reverseModel,k=c.reverseName;if(h.singleton){if(c.type==l.ManyToMany)return"Singleton model cannot be related via reverse ManyToMany";if(c.type==l.OneToMany)return"Singleton model cannot be related via reverse OneToMany"}y.debug.isEnabled&&
y.debug(this.name+": configuring  reverse relationship "+k);h.relationships[k]=c}this._reverseRelationshipsInstalled=!0},_query:function(a){return a=new q(this,a||{})},query:function(a,b){if(this.singleton){var c=g.defer(b);b=c.finish.bind(c);this._query({__ignoreInstalled:!0}).execute(function(c,h){c?b(c):(a=w.extend({},a),a.__ignoreInstalled=!0,h.length?this._query(a).execute(b):this.graph({},function(c){c?b(c):this._query(a).execute(b)}.bind(this)))}.bind(this));return c.promise}return this._query(a).execute(b)},
reactiveQuery:function(a){return new B(new q(this,a||{}))},arrangedReactiveQuery:function(a){return new x(new q(this,a||{}))},one:function(a,b){"function"==typeof a&&(b=a,a={});var c=g.defer(b);b=c.finish.bind(c);this.query(a,function(a,c){a?b(a):1<c.length?b("More than one instance returned when executing get query!"):(c=c.length?c[0]:null,b(null,c))});return c.promise},all:function(a,b){"function"==typeof a&&(b=a,a={});a=a||{};return this.query(a,b)},install:function(a){y.info.isEnabled&&y.info("Installing mapping "+
this.name);var b=g.defer(a);a=b.finish.bind(b);if(this._installed)throw new p('Model "'+this.name+'" has already been installed');this._installed=!0;a();return b.promise},graph:function(a,b,c){"function"==typeof b&&(c=b);b=b||{};var h=g.defer(c);c=function(){var c=b.override;c&&(g.isArray(c)?b.objects=c:b.objects=[c]);delete b.override;g.isArray(a)?this._mapBulk(a,b,h.finish.bind(h)):this._mapBulk([a],b,function(a,b){var c;b&&b.length&&(c=b[0]);h.finish(a?g.isArray(a)?a[0]:a:null,c)})}.bind(this);
b._ignoreInstalled?c():siesta._afterInstall(c);return h.promise},_mapBulk:function(a,b,c){w.extend(b,{model:this,data:a});(new f(b)).start(function(a,b){a?c&&c(a):c(null,b||[])})},_countCache:function(){return w.reduce(Object.keys((c._localCacheByType[this.collectionName]||{})[this.name]||{}),function(a,b){a[b]={};return a},{})},count:function(a){var b=g.defer(a);a=b.finish.bind(b);var c=this._countCache();a(null,Object.keys(c).length);return b.promise},_new:function(b,k){k=void 0===k?!0:k;if(this.installed){var d=
this,f;f=b?b._id?b._id:A():A();var e=new m(this);y.info.isEnabled&&y.info('New object created _id="'+f.toString()+'", type='+this.name,b);e._id=f;f={};e.__values=f;var q=w.reduce(this.attributes,function(a,b){void 0!==b["default"]&&(a[b.name]=b["default"]);return a},{});w.extend(f,q);b&&w.extend(f,b);f=this._attributeNames;q=f.indexOf(this.id);-1<q&&f.splice(q,1);w.each(f,function(b){Object.defineProperty(e,b,{get:function(){var a=e.__values[b];return void 0===a?null:a},set:function(c){var k=e.__values[b],
f=this._propertyDependencies[b],f=w.map(f,function(a){return{prop:a,old:this[a]}}.bind(this));e.__values[b]=c;f.forEach(function(b){var c=b.prop;a.emit({collection:d.collectionName,model:d.name,_id:e._id,"new":this[c],old:b.old,type:C.Set,field:c,obj:e})}.bind(this));k={collection:d.collectionName,model:d.name,_id:e._id,"new":c,old:k,type:C.Set,field:b,obj:e};window.lastEmission=k;a.emit(k);g.isArray(c)&&h(c,b,e)},enumerable:!0,configurable:!0})});w.each(Object.keys(this.methods),function(a){void 0===
e[a]?e[a]=this.methods[a].bind(e):y.error('A method with name "'+a+'" already exists. Ignoring it.')}.bind(this));f=Object.keys(this.properties);var n={};w.each(f,function(a){var b=this.properties[a];(b.dependencies||[]).forEach(function(b){n[b]||(n[b]=[]);n[b].push(a)});delete b.dependencies;void 0===e[a]?Object.defineProperty(e,a,b):y.error('A property/method with name "'+a+'" already exists. Ignoring it.')}.bind(this));e._propertyDependencies=n;Object.defineProperty(e,this.id,{get:function(){return e.__values[d.id]||
null},set:function(b){var h=e[d.id];e.__values[d.id]=b;a.emit({collection:d.collectionName,model:d.name,_id:e._id,"new":b,old:h,type:C.Set,field:d.id,obj:e});c.remoteInsert(e,b,h)},enumerable:!0,configurable:!0});for(var r in this.relationships){var t;if(this.relationships.hasOwnProperty(r))if(t=w.extend({},this.relationships[r]),f=t.type,delete t.type,f==l.OneToMany)t=new v(t);else if(f==l.OneToOne)t=new z(t);else if(f==l.ManyToMany)t=new D(t);else throw new p("No such relationship type: "+f);t.install(e)}c.insert(e);
k&&a.emit({collection:this.collectionName,model:this.name,_id:e._id,"new":e,type:C.New,obj:e});return e}throw new p("Model must be fully installed before creating any models");},_dump:function(a){var b={};b.name=this.name;b.attributes=this.attributes;b.id=this.id;b.collection=this.collectionName;b.relationships=w.map(this.relationships,function(a){return a.isForward?a.forwardName:a.reverseName});return a?g.prettyPrint(b):b},toString:function(){return"Model["+this.name+"]"}});w.extend(d.prototype,
{child:function(a,b){"string"==typeof a?b.name=a:b=name;w.extend(b,{attributes:Array.prototype.concat.call(b.attributes||[],this._opts.attributes),relationships:w.extend(b.relationships||{},this._opts.relationships),methods:w.extend(w.extend({},this._opts.methods)||{},b.methods),statics:w.extend(w.extend({},this._opts.statics)||{},b.statics),properties:w.extend(w.extend({},this._opts.properties)||{},b.properties),id:b.id||this._opts.id,init:b.init||this._opts.init,remove:b.remove||this._opts.remove});
var c=this.collection.model(b.name,b);c.parent=this;this.children.push(c);return c},isChildOf:function(a){return this.parent==a},isParentOf:function(a){return-1<this.children.indexOf(a)},isDescendantOf:function(a){for(var b=this.parent;b;){if(b==a)return!0;b=b.parent}return!1},isAncestorOf:function(a){return-1<this.descendants.indexOf(a)},hasAttributeNamed:function(a){return-1<this._attributeNames.indexOf(a)}});w.extend(d.prototype,{paginator:function(a){if(siesta.ext.httpEnabled){var b=siesta.ext.http.Paginator;
a=a||{};a.model=this;return new b(a)}}});t.exports=d},{"./ArrangedReactiveQuery":1,"./ManyToManyProxy":2,"./ModelInstance":3,"./OneToManyProxy":4,"./OneToOneProxy":5,"./Query":6,"./ReactiveQuery":8,"./RelationshipProxy":9,"./RelationshipType":10,"./cache":11,"./collectionRegistry":13,"./error":14,"./events":15,"./log":17,"./mappingOperation":18,"./modelEvents":20,"./store":21,"./util":23,extend:37}],20:[function(e,t,r){function d(d){this._opts=d||{};Object.keys(d).forEach(function(c){this[c]=d[c]}.bind(this))}
function n(d){if(!d.model)throw new l("Must pass a model");if(!d.collection)throw new l("Must pass a collection");if(!d._id)throw new l("Must pass a local identifier");if(!d.obj)throw new l("Must pass the object");}var p=e("./events"),l=e("./error").InternalSiestaError;t=e("./log");var q=e("./util")._.extend,f=e("./collectionRegistry").CollectionRegistry,m=t.loggerWithName("ModelEvents");d.prototype._dump=function(d){var c={};c.collection="string"==typeof this.collection?this.collection:this.collection._dump();
c.model="string"==typeof this.model?this.model:this.model.name;c._id=this._id;c.field=this.field;c.type=this.type;this.index&&(c.index=this.index);this.added&&(c.added=_.map(this.added,function(b){return b._dump()}));this.removed&&(c.removed=_.map(this.removed,function(b){return b._dump()}));this.old&&(c.old=this.old);this["new"]&&(c["new"]=this["new"]);return d?util.prettyPrint(c):c};q(r,{ModelEvent:d,emit:function(g){n(g);var c=g.collection,b=g.model;g=new d(g);m.trace.isEnabled&&m.trace('Sending notification "'+
c+'" of type '+g.type);p.emit(c,g);var a=c+":"+b;m.trace.isEnabled&&m.trace('Sending notification "'+a+'" of type '+g.type);p.emit(a,g);m.trace.isEnabled&&m.trace('Sending notification "Siesta" of type '+g.type);p.emit("Siesta",g);a=g._id;m.trace.isEnabled&&m.trace('Sending notification "'+a+'" of type '+g.type);p.emit(a,g);a=f[c];if(!a)throw c='No such collection "'+c+'"',m.error(c,f),new l(c);a=a[b];if(!a)throw c='No such model "'+b+'"',m.error(c,f),new l(c);a.id&&g.obj[a.id]&&(c=c+":"+b+":"+g.obj[a.id],
m.trace.isEnabled&&m.trace('Sending notification "'+c+'" of type '+g.type),p.emit(c,g));return g},validateEventOpts:n,ModelEventType:{Set:"Set",Splice:"Splice",New:"New",Remove:"Remove"}})},{"./collectionRegistry":13,"./error":14,"./events":15,"./log":17,"./util":23}],21:[function(e,t,r){function d(d,c){var b=l.defer(c);c=b.finish.bind(b);m.debug.isEnabled&&m.debug("get",d);var a;if(d._id)if(l.isArray(d._id))n(q.map(d._id,function(a){return{_id:a}}),c);else if(a=f.get(d))m.debug.isEnabled&&m.debug("Had cached object",
{opts:d,obj:a}),c&&c(null,a);else if(l.isArray(d._id))n(q.map(d._id,function(a){return{_id:a}}),c);else{if(c)if(a=siesta.ext.storage)a.store.getFromPouch(d,c);else throw Error("Storage module not installed");}else if(d.model)if(l.isArray(d[d.model.id]))n(q.map(d[d.model.id],function(a){var b={};b[d.model.id]=a;b.model=d.model;return b}),c);else if(a=f.get(d))m.debug.isEnabled&&m.debug("Had cached object",{opts:d,obj:a}),c&&c(null,a);else if(a=d.model,a.singleton)a.one(c);else{var k=a.id,h=d[k],e=
{};if(e[k]=h)a.one(e,function(a,b){a?c(a):b?c(null,b):c(null,null)});else throw new p('Invalid options given to store. Missing "'+k.toString()+'."');}else throw new p("Invalid options given to store",{opts:d});return b.promise}function n(f,c){var b=l.defer(c);c=b.finish.bind(b);var a=[],k=[];q.each(f,function(b){d(b,function(b,h){b?k.push(b):a.push(h);a.length+k.length==f.length&&c&&(k.length?c(k):c(null,a))})});return b.promise}var p=e("./error").InternalSiestaError;r=e("./log");var l=e("./util"),
q=l._,f=e("./cache"),m=r.loggerWithName("Store");t.exports={get:d,getMultiple:n,getMultipleLocal:function(d,c){var b=l.defer(c);c=b.finish.bind(b);var a=q.reduce(d,function(a,b){var c=f.get({_id:b});c?a.cached[b]=c:a.notCached.push(b);return a},{cached:{},notCached:[]});(function(b){c&&(b?c(b):c(null,q.map(d,function(b){return a.cached[b]})))})();return b.promise},getMultipleRemote:function(d,c,b){var a=l.defer(b);b=a.finish.bind(a);var k=q.reduce(d,function(a,b){var d={model:c};d[c.id]=b;(d=f.get(d))?
a.cached[b]=d:a.notCached.push(b);return a},{cached:{},notCached:[]});(function(a){b&&(a?b(a):b(null,q.map(d,function(a){return k.cached[a]})))})();return a.promise}}},{"./cache":11,"./error":14,"./log":17,"./util":23}],22:[function(e,t,r){function d(a,b){if(a.map)return a.map(b);var c=[];q(a,function(a,h,d){c.push(b(a,h,d))});return c}function n(a,b,c,k){b=d(b,function(a,b){return{index:b,value:a}});if(k){var f=[];a(b,function(a,b){c(a.value,function(c,d){f[a.index]=d;b(c)})},function(a){k(a,f)})}else a(b,
function(a,b){c(a.value,function(a){b(a)})})}function p(a,b,c){c=c||function(){};if(!a.length)return c();var d=0,k=function(){b(a[d],function(b){b?(c(b),c=function(){}):(d+=1,d>=a.length?c():k())})};k()}function l(a,b){if(a.forEach)return a.forEach(b);for(var c=0;c<a.length;c+=1)b(a[c],c,a)}function q(a,b,c){function d(b){b?(c(b),c=function(){}):(k+=1,k>=a.length&&c())}c=c||function(){};if(!a.length)return c();var k=0;l(a,function(a){b(a,f(d))})}function f(a){var c=!1;return function(){if(c)throw Error("Callback was already called.");
c=!0;a.apply(b,arguments)}}var m=e("./misc"),g=e("./underscore"),c=function(a){return function(){var b=Array.prototype.slice.call(arguments);return a.apply(null,[q].concat(b))}}(n),b,a=function(a){return function(){var b=Array.prototype.slice.call(arguments);return a.apply(null,[p].concat(b))}}(n),k=function(a,b,c){c=c||function(){};if(m.isArray(b))a.map(b,function(a,b){a&&a(function(a){var c=Array.prototype.slice.call(arguments,1);1>=c.length&&(c=c[0]);b.call(null,a,c)})},c);else{var d={};a.each(Object.keys(b),
function(a,c){b[a](function(b){var k=Array.prototype.slice.call(arguments,1);1>=k.length&&(k=k[0]);d[a]=k;c(b)})},function(a){c(a,d)})}};t.exports={series:function(b,c){c=c||function(){};if(m.isArray(b))a(b,function(a,b){a&&a(function(a){var c=Array.prototype.slice.call(arguments,1);1>=c.length&&(c=c[0]);b.call(null,a,c)})},c);else{var d={};p(g.keys(b),function(a,c){b[a](function(b){var k=Array.prototype.slice.call(arguments,1);1>=k.length&&(k=k[0]);d[a]=k;c(b)})},function(a){c(a,d)})}},parallel:function(a,
b){k({map:c,each:q},a,b)}}},{"./misc":24,"./underscore":25}],23:[function(e,t,r){r=e("./underscore");var d=e("./async");e=e("./misc");r.extend(t.exports,{_:r,async:d});r.extend(t.exports,e)},{"./async":22,"./misc":24,"./underscore":25}],24:[function(e,t,r){var d=e("../../vendor/observe-js/src/observe").Platform,n=e("./underscore"),p=e("./../error").InternalSiestaError,l=/^function\s*[^\(]*\(\s*([^\)]*)\)/m,q=/,/,f=/^\s*(_?)(.+?)\1\s*$/,m=/((\/\/.*$)|(\/\*[\s\S]*?\*\/))/mg;e=function(b){return"[object Array]"===
n.toString.call(b)};var g=Array.isArray||e,c=function(b){return"string"==typeof b||b instanceof String};n.extend(t.exports,{next:function(b){d.performMicrotaskCheckpoint();setTimeout(b)},cb:function(b,a){return function(c){b&&b.apply(b,arguments);a&&(c?a.reject(c):a.resolve.apply(a,Array.prototype.slice.call(arguments,1)))}},guid:function(){function b(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return function(){return b()+b()+"-"+b()+"-"+b()+"-"+b()+"-"+b()+b()+b()}}(),
assert:function(b,a,c){if(!b)throw c=c||{},new p(a||"Assertion failed",c);},thenBy:function(){function b(b){b.thenBy=a;return b}function a(a){var c=this;return b(function(b,d){return c(b,d)||a(b,d)})}return b}(),defer:function(b){var a;b=b||function(){};if(siesta.q){a=siesta.q.defer();var c=a.reject,d=a.resolve;n.extend(a,{reject:function(a){b(a);c.call(this,a)},resolve:function(a){var c=b.__siesta_bound_object||b,k=Array.prototype.slice.call(arguments,0);k.unshift(null);b.apply(c,k);d.apply(this,
arguments)},finish:function(a,b){if(a)this.reject(a);else{var c=Array.prototype.slice.call(arguments,1);this.resolve.apply(this,c)}}})}else a={promise:void 0,reject:function(a){b.apply(b.__siesta_bound_object||b,arguments)},resolve:function(a){var c=b.__siesta_bound_object||b,d=Array.prototype.slice.call(arguments,0);d.unshift(null);b.apply(c,d)},finish:function(a,c){b.apply(b.__siesta_bound_object||b,arguments)}};return a},defineSubProperty:function(b,a,c){return Object.defineProperty(this,b,{get:function(){return c?
a[c]:a[b]},set:function(d){c?a[c]=d:a[b]=d},enumerable:!0,configurable:!0})},defineSubPropertyNoSet:function(b,a,c){return Object.defineProperty(this,b,{get:function(){return c?a[c]:a[b]},enumerable:!0,configurable:!0})},subProperties:function(b,a,d){g(d)||(d=Array.prototype.slice.call(arguments,2));for(var h=0;h<d.length;h++)(function(d){var k={set:!1,name:d,property:d};c(d)||n.extend(k,d);d={get:function(){return a[k.property]},enumerable:!0,configurable:!0};k.set&&(d.set=function(b){a[k.property]=
b});Object.defineProperty(b,k.name,d)})(d[h])},capitaliseFirstLetter:function(b){return b.charAt(0).toUpperCase()+b.slice(1)},extendFromOpts:function(b,a,c,d){if(void 0==d||d){var f=Object.keys(c);d=Object.keys(a).filter(function(a){return-1==f.indexOf(a)});if(d.length)throw Error("Unknown options: "+d.toString());}n.each(Object.keys(c),function(b){var d=c[b];"function"==typeof d&&(c[b]=d(a[b]),delete a[b])});n.extend(c,a);n.extend(b,c)},isString:c,isArray:g,prettyPrint:function(b){return JSON.stringify(b,
null,4)},flattenArray:function(b){return n.reduce(b,function(a,b){g(b)?a=a.concat(b):a.push(b);return a},[])},unflattenArray:function(b,a){for(var c=0,d=[],f=0;f<a.length;f++)if(g(a[f])){var e=[];d[f]=e;for(var l=0;l<a[f].length;l++)e.push(b[c]),c++}else d[f]=b[c],c++;return d},paramNames:function(b){var a=[];b.toString().replace(m,"").match(l)[1].split(q).forEach(function(b){b.replace(f,function(b,c,d){a.push(d)})});return a}})},{"../../vendor/observe-js/src/observe":39,"./../error":14,"./underscore":25}],
25:[function(e,t,r){var d={};e=Array.prototype;var n=e.forEach,p=e.map,l=e.reduce,q=Function.prototype.bind,f=e.slice,m={},g=function(){};d.keys=function(a){if(Object.keys)return Object.keys(a);var b=[],c;for(c in a)a.hasOwnProperty(c)&&b.push(c);return b};d.each=d.forEach=function(a,b,c){if(null==a)return a;if(n&&a.forEach===n)a.forEach(b,c);else if(a.length===+a.length)for(var f=0,e=a.length;f<e;f++){if(b.call(c,a[f],f,a)===m)return}else for(var g=d.keys(a),f=0,e=g.length;f<e;f++)if(b.call(c,a[g[f]],
g[f],a)===m)return;return a};d.map=d.collect=function(a,b,c){var f=[];if(null==a)return f;if(p&&a.map===p)return a.map(b,c);d.each(a,function(a,d,e){f.push(b.call(c,a,d,e))});return f};var c=function(a,b,c){if(void 0===b)return a;switch(null==c?3:c){case 1:return function(c){return a.call(b,c)};case 2:return function(c,d){return a.call(b,c,d)};case 3:return function(c,d,h){return a.call(b,c,d,h)};case 4:return function(c,d,h,f){return a.call(b,c,d,h,f)}}return function(){return a.apply(b,arguments)}};
d.times=function(a,b,d){var f=Array(Math.max(0,a));b=c(b,d,1);for(d=0;d<a;d++)f[d]=b(d);return f};d.partial=function(a){var b=f.call(arguments,1);return function(){for(var c=0,f=b.slice(),e=0,g=f.length;e<g;e++)f[e]===d&&(f[e]=arguments[c++]);for(;c<arguments.length;)f.push(arguments[c++]);return a.apply(this,f)}};d.pluck=function(a,b){return d.map(a,d.property(b))};d.reduce=d.foldl=d.inject=function(a,b,c,f){var e=2<arguments.length;null==a&&(a=[]);if(l&&a.reduce===l)return f&&(b=d.bind(b,f)),e?
a.reduce(b,c):a.reduce(b);d.each(a,function(a,d,g){e?c=b.call(f,c,a,d,g):(c=a,e=!0)});if(!e)throw new TypeError("Reduce of empty array with no initial value");return c};d.property=function(a){return function(b){return b[a]}};"function"!==typeof/./&&(d.isFunction=function(a){return"function"===typeof a});d.isObject=function(a){var b=typeof a;return"function"===b||"object"===b&&!!a};var b=function(a){return null==a?d.identity:d.isFunction(a)?a:d.property(a)};d.sortBy=function(a,c,f){c=b(c);return d.pluck(d.map(a,
function(a,b,d){return{value:a,index:b,criteria:c.call(f,a,b,d)}}).sort(function(a,b){var c=a.criteria,d=b.criteria;if(c!==d){if(c>d||void 0===c)return 1;if(c<d||void 0===d)return-1}return a.index-b.index}),"value")};d.bind=function(a,b){var c,e;if(q&&a.bind===q)return q.apply(a,f.call(arguments,1));if(!d.isFunction(a))throw new TypeError;c=f.call(arguments,2);return e=function(){if(!(this instanceof e))return a.apply(b,c.concat(f.call(arguments)));g.prototype=a.prototype;var d=new g;g.prototype=
null;u;var l=a.apply(d,c.concat(f.call(arguments)));return Object(l)===l?l:d}};d.identity=function(a){return a};d.zip=function(a){if(null==a)return[];for(var b=d.max(arguments,"length").length,c=Array(b),f=0;f<b;f++)c[f]=d.pluck(arguments,f);return c};d.max=function(a,b,c){var f=-Infinity,e=-Infinity,g;if(null==b&&null!=a){a=a.length===+a.length?a:d.values(a);for(var l=0,m=a.length;l<m;l++)c=a[l],c>f&&(f=c)}else b=d.iteratee(b,c),d.each(a,function(a,c,d){g=b(a,c,d);if(g>e||-Infinity===g&&-Infinity===
f)f=a,e=g});return f};d.iteratee=function(a,b,f){return null==a?d.identity:d.isFunction(a)?c(a,b,f):d.isObject(a)?d.matches(a):d.property(a)};d.pairs=function(a){for(var b=d.keys(a),c=b.length,f=Array(c),e=0;e<c;e++)f[e]=[b[e],a[b[e]]];return f};d.matches=function(a){var b=d.pairs(a),c=b.length;return function(a){if(null==a)return!c;a=Object(a);for(var d=0;d<c;d++){var f=b[d],e=f[0];if(f[1]!==a[e]||!(e in a))return!1}return!0}};d.some=function(a,b,c){if(null==a)return!1;b=d.iteratee(b,c);c=a.length!==
+a.length&&d.keys(a);var f=(c||a).length,e,g;for(e=0;e<f;e++)if(g=c?c[e]:e,b(a[g],g,a))return!0;return!1};d.extend=function(a){if(!d.isObject(a))return a;for(var b,c,f=1,e=arguments.length;f<e;f++)for(c in b=arguments[f],b)hasOwnProperty.call(b,c)&&(a[c]=b[c]);return a};t.exports=d},{}],26:[function(e,t,r){function d(b){b?"*"==b||-1<b.indexOf("*")?b=a:l.isArray(b)||(b=[b]):b=["GET"];return c.map(b,function(a){return a.toUpperCase()})}function n(a){if(!this)return new n(a);this._rawOpts=g(!0,{},a);
this._opts=a;var b=function(a){a instanceof RegExp||(a=new RegExp(a,"g"));return a}.bind(this);this._opts.path?(a=this._opts.path,l.isArray(a)||(a=[a]),this._opts.path=[],c.each(a,function(a){this._opts.path.push(b.call(this,a))}.bind(this))):this._opts.path=[""];this._opts.method=d(this._opts.method);if((a=this._opts.data)&&a.length){var e=a.split(".");if(1==e.length)a=e[0];else{var m={};a=m;for(var q=e[0],p=1;p<e.length;p++){var r=e[p];if(p==e.length-1)m[q]=r;else var t={},m=m[q]=t,q=r}}this._opts.data=
a}f.call(this,"path",this._opts);f.call(this,"method",this._opts);f.call(this,"data",this._opts);f.call(this,"transforms",this._opts)}e=siesta._internal;var p=e.error.InternalSiestaError,l=e.util,q=l.assert,f=l.defineSubProperty,m=e.CollectionRegistry,g=e.extend,c=l._,b=e.log.loggerWithName("Descriptor"),a="POST PATCH PUT HEAD GET DELETE OPTIONS TRACE CONNECT".split(" ");c.extend(n.prototype,{httpMethods:a,_resolveCollectionAndModel:function(){var a;a=this._opts.collection;var b=this._opts.model;
if(a)a="string"==typeof a?m[a]:a;else if(b&&!l.isString(b))a=b.collection;else return"Must pass collection or a model object";var c;if(b)if(l.isString(b))if(c=a._models[b])this._opts.model=c;else return"Model "+b+" does not exist in collection";else{if(b.collection!=a)return"Passed model is not part of the passed collection";c=b}else return"Descriptors must be initialised with a model";this.model=c;this.collection=a},_matchPath:function(a){var c;for(c=0;c<this._opts.path.length;c++){var d=this._opts.path[c];
b.trace.isEnabled&&b.trace("Matching path",a,d.toString());var f=d.exec(a);b.trace.isEnabled&&(f?b.trace("Matched path successfully",a,d.toString()):b.trace("Failed to match path",a,d.toString()));if(f)return!0}return!1},_matchMethod:function(a){for(var b=0;b<this.method.length;b++)if(a.toUpperCase()==this.method[b])return!0;return!1},bury:function(a,b){var c=Object.keys(b);q(1==c.length);for(var c=c[0],d=b;"string"!=typeof d[c];)d=d[c],c=Object.keys(d),q(1==c.length),c=c[0];var f=d[c],e={};d[c]=
e;e[f]=a;return b},_embedData:function(a){if(this.data){var b;"string"==typeof this.data?(b={},b[this.data]=a):b=this.bury(a,g(!0,{},this.data));return b}return a},_extractData:function(a){b.debug.isEnabled&&b.debug("_extractData",a);if(this.data){if("string"==typeof this.data)return a[this.data];var c=Object.keys(this.data);q(1==c.length);for(var d=this.data;"string"!=typeof d&&(c=Object.keys(d),q(1==c.length),c=c[0],d=d[c],a=a[c],a););return a?a[d]:null}return a},_matchConfig:function(a){var b=
a.type?this._matchMethod(a.type):{};b&&(b=a.url?this._matchPath(a.url):{});return b},_matchData:function(a){var b=null;this.data?a&&(b=this._extractData(a)):b=a;return b},match:function(a,b){var c=!1;this._matchConfig(a)&&(c=this._matchData(b));return c},_transformData:function(a){var b=this.transforms;if("function"==typeof b)a=b(a);else for(var c in b)if(b.hasOwnProperty(c)&&a[c]){var d=b[c],f=a[c];if("string"==typeof d)if(d=d.split("."),delete a[c],1==d.length)a[d[0]]=f;else{a[d[0]]={};for(var e=
a[d[0]],g=1;g<d.length-1;g++){var m=d[g];e[m]={};e=e[m]}e[d[d.length-1]]=f}else if("function"==typeof d)f=d(f),l.isArray(f)?(delete a[c],a[f[0]]=f[1]):a[c]=f;else throw new p("Invalid transformer");}return a}});r.Descriptor=n;r.resolveMethod=d},{}],27:[function(e,t,r){function d(){if(!this)return new d(opts);this.requestDescriptors={};this.responseDescriptors={}}function n(d,f){var c=f._opts.model,b=f._opts.collection,a;if(b)a=l.isString(b)?b:b.name;else if(c){if(l.isString(c))throw new q("Not enough information to register the descriptor");
a=c.collection.name}d[a]||(d[a]=[]);d[a].push(f)}function p(d,e){var c;c="string"==typeof e?d[e]||[]:d[e.name]||[];f.trace.isEnabled&&f.trace("_descriptorsForCollection",{collection:e,allDescriptors:d,descriptors:c});return c}e=siesta._internal;var l=e.util;t=l._;var q=e.error.InternalSiestaError,f=e.log.loggerWithName("Descriptor");t.extend(d.prototype,{registerRequestDescriptor:function(d){n(this.requestDescriptors,d)},registerResponseDescriptor:function(d){f.trace.isEnabled&&f.trace("registerResponseDescriptor");
n(this.responseDescriptors,d)},requestDescriptorsForCollection:function(d){return p(this.requestDescriptors,d)},responseDescriptorsForCollection:function(d){var e=p(this.responseDescriptors,d);e.length||f.debug.isEnabled&&f.debug("No response descriptors for collection ",{collection:d});return e},reset:function(){this.requestDescriptors={};this.responseDescriptors={}}});r.DescriptorRegistry=new d},{}],28:[function(e,t,r){function d(a,b,c){if(y.debug.isEnabled){var d=y.debug;a=a.type+" "+b.status+
" "+a.url;y.trace.isEnabled&&c&&(d=y.trace,a+=": "+B.prettyPrint(c));d(a)}}function n(a){if(y.debug.isEnabled){var b=y.debug;a=a.type+" "+a.url;y.trace.isEnabled&&(b=y.trace);b(a)}}function p(a,b,c,f){var e=this,g=Array.prototype.slice.call(arguments,2),h={},k=this.name;"function"==typeof g[0]?f=g[0]:"object"==typeof g[0]&&(h=g[0],f=g[1]);g=B.defer(f);f=g.finish.bind(g);siesta._afterInstall(function(){function c(a,b,g){d(h,g,a);if(h.parseResponse){b=C.responseDescriptorsForCollection(e);for(var l,
m,q=0;q<b.length;q++){var p=b[q];if(m=p.match(h,a)){l=p;break}}if(l)y.trace.isEnabled&&y.trace("Model _constructSubOperation data: "+B.prettyPrint(m)),"object"==typeof m?l.model.graph(m,{override:h.obj},function(b,c){f(b,c,a,g)}):f(null,null,null,g);else if(f)if(k)f(null,null,a,g);else throw new A("Unnamed collection");}else f(null,null,a,g)}function g(a,b,c){f&&f(c,null,null,a)}h.type=a;h.method=a;h.url||(h.url=this.baseURL+b);void 0===h.parseResponse&&(h.parseResponse=!0);n(h);var l=siesta.ext.http.ajax;
l?(l=l(h),l.success?(l.success(c),l.error(g)):l.done?(l.done(c),l.fail(g)):f("Incompatible ajax function. Could not find success/fail methods on returned promise.")):f("No ajax function. Ensure that either $.ajax is available, or call siesta.setAjax(ajax) with a compatible ajax function e.g. zepto, jquery, $http")}.bind(this));return g.promise}function l(a,b,c){this._serialise(b,function(b,d){var f=d;a.fields&&(f={},x.each(a.fields,function(a){f[a]=d[a]}));c(b,f)})}function q(a,b,c){var d=this,f=
Array.prototype.slice.call(arguments,3),e,g={};"function"==typeof f[0]?e=f[0]:"object"==typeof f[0]&&(g=f[0],e=f[1]);var h=B.defer(e);e=h.finish.bind(h);var f=Array.prototype.slice.call(f,2),k=C.requestDescriptorsForCollection(this),m;g.type=a;g.url=this.baseURL+b;for(var q=0;q<k.length;q++){var n=k[q];if(n._matchConfig(g)){m=n;break}}m?(y.trace.isEnabled&&y.trace("Matched descriptor: "+m._dump(!0)),l.call(m,c,g,function(h,k){y.trace.isEnabled&&y.trace("_serialise",{err:h,data:k});h?e&&e(h,null,null):
(g.data=k,g.obj=c,x.partial(p,a,b,g,e).apply(d,f))})):e&&(y.trace.isEnabled&&y.trace("Did not match descriptor"),e("No descriptor matched",null,null));return h.promise}function f(a,b){var c=Array.prototype.slice.call(arguments,2),d={},f;"function"==typeof c[0]?f=c[0]:"object"==typeof c[0]&&(d=c[0],f=c[1]);var e=B.defer(f),g=d.deletionMode||"restore";void 0===d.parseResponse&&(d.parseResponse=!1);p.call(this,"DELETE",a,d,function(a,c,d,h){a?"restore"==g&&b.restore():"success"==g&&b.remove();f(a,c,
d,h);e.finish(a,{x:c,y:d,z:h})});"now"!=g&&"restore"!=g||b.remove();return e.promise}function m(a,b){var c=Array.prototype.slice.call(arguments,2);return x.partial(a?q:p,b).apply(this,c)}function g(){return x.partial(m,!1,"GET").apply(this,arguments)}function c(){return x.partial(m,!1,"OPTIONS").apply(this,arguments)}function b(){return x.partial(m,!1,"TRACE").apply(this,arguments)}function a(){return x.partial(m,!1,"HEAD").apply(this,arguments)}function k(){return x.partial(m,!0,"POST").apply(this,
arguments)}function h(){return x.partial(m,!0,"PUT").apply(this,arguments)}function v(){return x.partial(m,!0,"PATCH").apply(this,arguments)}if("undefined"==typeof siesta&&"undefined"==typeof t)throw Error("Could not find window.siesta. Make sure you include siesta.core.js first.");var z=siesta._internal;r=z.Collection;var D=z.log,B=z.util,x=B._,w=e("./descriptor"),A=z.error.InternalSiestaError,C=e("./descriptorRegistry").DescriptorRegistry,y=D.loggerWithName("HTTP");e={RequestDescriptor:e("./requestDescriptor").RequestDescriptor,
ResponseDescriptor:e("./responseDescriptor").ResponseDescriptor,Descriptor:w.Descriptor,_resolveMethod:w.resolveMethod,Serialiser:e("./serialiser"),DescriptorRegistry:e("./descriptorRegistry").DescriptorRegistry,_httpResponse:p,_httpRequest:q,DELETE:f,HTTP_METHOD:m,GET:g,TRACE:b,OPTIONS:c,HEAD:a,POST:k,PUT:h,PATCH:v,_serialiseObject:l,Paginator:e("./paginator")};Object.defineProperty(e,"ajax",{get:function(){return E||($?$.ajax:null)||(jQuery?jQuery.ajax:null)},set:function(a){E=a}});x.extend(r.prototype,
{DELETE:f,GET:g,TRACE:b,OPTIONS:c,HEAD:a,POST:k,PUT:h,PATCH:v});siesta.ext||(siesta.ext={});siesta.ext.http=e;Object.defineProperties(siesta.ext,{httpEnabled:{get:function(){return void 0!==siesta.ext._httpEnabled?siesta.ext._httpEnabled:!!siesta.ext.http},set:function(a){siesta.ext._httpEnabled=a},enumerable:!0}});var E;r={};x.extend(siesta,{setAjax:function(a){E=a},getAjax:function(){return siesta.ext.http.ajax},serialisers:r,serializers:r});Object.defineProperty(siesta,"ajax",{get:function(){return E},
set:function(a){E=a}});Object.defineProperties(r,{id:{get:function(){return siesta.ext.httpEnabled?siesta.ext.http.Serialiser.idSerialiser:null}},depth:{get:function(){return siesta.ext.httpEnabled?siesta.ext.http.Serialiser.depthSerializer:null}}});"undefined"!=typeof t&&(t.exports=e)},{"./descriptor":26,"./descriptorRegistry":27,"./paginator":29,"./requestDescriptor":30,"./responseDescriptor":31,"./serialiser":32}],29:[function(e,t,r){function d(d){this.opts={};p.extendFromOpts(this.opts,d,{path:"/",
model:null,page:"page",queryParams:!0,pageSize:"pageSize",numPages:"numPages",dataPath:"data",count:"count",type:"GET",dataType:"json"},!1);l.extend(this,{numPages:null,count:null});this.validate()}r=siesta._internal;var n=r.error.InternalSiestaError,p=r.util,l=p._,q=e("querystring");l.extend(d.prototype,{_extract:function(d,e,g){if(d)if("function"==typeof d)e=d(e,g);else for(d=d.split("."),g=0;g<d.length;g++)e=e[d[g]];return e},_extractData:function(d,e){return this._extract(this.opts.dataPath,d,
e)},_extractNumPages:function(d,e){return this._extract(this.opts.numPages,d,e)},_extractCount:function(d,e){return this._extract(this.opts.count,d,e)},_parseURL:function(d){var e=document.createElement("a");e.href=d;return e},page:function(d,e){var g=this,c={};"function"==typeof d?e=d:d&&(c=d);var b=p.defer(e),a=c.page,c=c.pageSize;e=b.finish.bind(b);var k=siesta.ext.http.ajax,h=l.extend({},this.opts),n=this.opts.model.collection.baseURL+this.opts.path;if(this.opts.queryParams){var n=this._parseURL(n),
r=n.search,t=r.split("?");1<t.length&&(r=t[1]);r=q.parse(r);a&&(r[this.opts.page]=a);c&&(r[this.opts.pageSize]=c);Object.keys(r).length&&(n.search="?"+q.stringify(r));n=n.href}else r={},a&&(r[this.opts.page]=a),c&&(r[this.opts.pageSize]=c),h.data=r;l.extend(h,{url:n,success:function(a,b,c){var d=g._extractData(a,c),f=g._extractCount(a,c),h=g._extractNumPages(a,c);g.opts.model.graph(d,function(d,k){d?e(d):(g.count=f,g.numPages=h,e(null,k,{data:a,textStatus:b,jqXHR:c}))})},fail:e});k(h);return b.promise},
validate:function(){if(!this.opts.model)throw new n("Paginator must have a model");}});t.exports=d},{querystring:36}],30:[function(e,t,r){function d(f){if(!this)return new d(f);n.call(this,f);this._opts.serializer&&(this._opts.serialiser=this._opts.serializer);this._opts.serialiser||(this._opts.serialiser=p.depthSerializer(0));q.call(this,"serialiser",this._opts);q.call(this,"serializer",this._opts,"serialiser")}var n=e("./descriptor").Descriptor,p=e("./serialiser");e=siesta._internal;var l=e.util;
t=l._;var q=l.defineSubProperty,f=e.log.loggerWithName("Descriptor");d.prototype=Object.create(n.prototype);t.extend(d.prototype,{_serialise:function(d,e){var c=l.defer(e);e=c.finish.bind(c);var b=this;f.trace.isEnabled&&f.trace("_serialise");var a,k=this.serialiser(d,function(c,d){a||(d=b._transformData(d),e&&e(c,b._embedData(d)))});void 0!==k?(f.trace.isEnabled&&f.trace("serialiser doesnt use a callback"),a=!0,k=b._transformData(k),e&&e(null,b._embedData(k))):f.trace.isEnabled&&f.trace("serialiser uses a callback",
this.serialiser);return c.promise},_dump:function(d){var f={};f.methods=this.method;f.model=this.model.name;f.path=this._rawOpts.path;f.serialiser="function"==typeof this._rawOpts.serialiser?"function () { ... }":this._rawOpts.serialiser;var c={},b;for(b in this.transforms)this.transforms.hasOwnProperty(b)&&(c[b]="function"==typeof this.transforms[b]?"function () { ... }":this.transforms[b]);f.transforms=c;return d?l.prettyPrint(f):f}});r.RequestDescriptor=d},{"./descriptor":26,"./serialiser":32}],
31:[function(e,t,r){function d(e){if(!this)return new d(e);n.call(this,e)}var n=e("./descriptor").Descriptor;e=siesta._internal.util._;d.prototype=Object.create(n.prototype);e.extend(d.prototype,{_extractData:function(d){(d=n.prototype._extractData.call(this,d))&&(d=this._transformData(d));return d},_matchData:function(d){(d=n.prototype._matchData.call(this,d))&&(d=this._transformData(d));return d},_dump:function(d){var e={};e.methods=this.method;e.model=this.model.name;e.path=this._rawOpts.path;
var q={},f;for(f in this.transforms)this.transforms.hasOwnProperty(f)&&(q[f]="function"==typeof this.transforms[f]?"function () { ... }":this.transforms[f]);e.transforms=q;return d?util.prettyPrint(e):e}});r.ResponseDescriptor=d},{"./descriptor":26}],32:[function(e,t,r){function d(d){var f=d.model.id;if(f)return d[f]?d[f]:null;p.debug.isEnabled&&p.debug("No idfield")}function n(d,f,e){e=e||function(){};p.trace.isEnabled&&p.trace("depthSerialiser");var g={};l.each(f._attributeNames,function(a){p.trace.isEnabled&&
p.trace("field",a);f[a]&&(g[a]=f[a])});var c=[],b=[],a={},k=[];l.each(f._relationshipNames,function(h){p.trace.isEnabled&&p.trace("relationshipField",h);var l=f.__proxies[h];l.isForward&&(p.debug.isEnabled&&p.debug(h),c.push(h),l.get(function(l,r){p.trace.isEnabled&&p.trace("proxy.get",h);p.debug.isEnabled&&p.debug(h,r);l?(b.push(l),k.push(h),a[h]={err:l,v:r}):r?d?n(d-1,r,function(d,f,l){d?b.push(d):g[h]=f;k.push(h);a[h]={err:d,v:r,resp:l};c.length==k.length&&e&&e(b.length?b:null,g,a)}):(k.push(h),
g[h]=r[f.__proxies[h].forwardModel.id],a[h]={err:l,v:r},c.length==k.length&&e&&e(b.length?b:null,g,a)):(p.debug.isEnabled&&p.debug("no value for "+h),k.push(h),a[h]={err:l,v:r},c.length==k.length&&e&&e(b.length?b:null,g,a))}))});c.length||e(null,g,{})}e=siesta._internal;t=e.util;var p=e.log.loggerWithName("Serialisation"),l=t._;r.depthSerialiser=function(d){return l.partial(n,d)};r.depthSerializer=function(d){return l.partial(n,d)};r.idSerializer=d;r.idSerialiser=d},{}],33:[function(e,t,r){function d(){this._events=
this._events||{};this._maxListeners=this._maxListeners||void 0}function n(d){return"function"===typeof d}function p(d){return"object"===typeof d&&null!==d}t.exports=d;d.EventEmitter=d;d.prototype._events=void 0;d.prototype._maxListeners=void 0;d.defaultMaxListeners=10;d.prototype.setMaxListeners=function(d){if("number"!==typeof d||0>d||isNaN(d))throw TypeError("n must be a positive number");this._maxListeners=d;return this};d.prototype.emit=function(d){var e,f,m,g;this._events||(this._events={});
if("error"===d&&(!this._events.error||p(this._events.error)&&!this._events.error.length)){e=arguments[1];if(e instanceof Error)throw e;throw TypeError('Uncaught, unspecified "error" event.');}f=this._events[d];if(void 0===f)return!1;if(n(f))switch(arguments.length){case 1:f.call(this);break;case 2:f.call(this,arguments[1]);break;case 3:f.call(this,arguments[1],arguments[2]);break;default:e=arguments.length;m=Array(e-1);for(g=1;g<e;g++)m[g-1]=arguments[g];f.apply(this,m)}else if(p(f)){e=arguments.length;
m=Array(e-1);for(g=1;g<e;g++)m[g-1]=arguments[g];f=f.slice();e=f.length;for(g=0;g<e;g++)f[g].apply(this,m)}return!0};d.prototype.addListener=function(e,q){var f;if(!n(q))throw TypeError("listener must be a function");this._events||(this._events={});this._events.newListener&&this.emit("newListener",e,n(q.listener)?q.listener:q);this._events[e]?p(this._events[e])?this._events[e].push(q):this._events[e]=[this._events[e],q]:this._events[e]=q;p(this._events[e])&&!this._events[e].warned&&(f=void 0!==this._maxListeners?
this._maxListeners:d.defaultMaxListeners)&&0<f&&this._events[e].length>f&&(this._events[e].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[e].length),"function"===typeof console.trace&&console.trace());return this};d.prototype.on=d.prototype.addListener;d.prototype.once=function(d,e){function f(){this.removeListener(d,f);m||(m=!0,e.apply(this,arguments))}if(!n(e))throw TypeError("listener must be a function");
var m=!1;f.listener=e;this.on(d,f);return this};d.prototype.removeListener=function(d,e){var f,m,g;if(!n(e))throw TypeError("listener must be a function");if(!this._events||!this._events[d])return this;f=this._events[d];g=f.length;m=-1;if(f===e||n(f.listener)&&f.listener===e)delete this._events[d],this._events.removeListener&&this.emit("removeListener",d,e);else if(p(f)){for(;0<g--;)if(f[g]===e||f[g].listener&&f[g].listener===e){m=g;break}if(0>m)return this;1===f.length?(f.length=0,delete this._events[d]):
f.splice(m,1);this._events.removeListener&&this.emit("removeListener",d,e)}return this};d.prototype.removeAllListeners=function(d){var e;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[d]&&delete this._events[d],this;if(0===arguments.length){for(e in this._events)"removeListener"!==e&&this.removeAllListeners(e);this.removeAllListeners("removeListener");this._events={};return this}e=this._events[d];if(n(e))this.removeListener(d,
e);else for(;e.length;)this.removeListener(d,e[e.length-1]);delete this._events[d];return this};d.prototype.listeners=function(d){return this._events&&this._events[d]?n(this._events[d])?[this._events[d]]:this._events[d].slice():[]};d.listenerCount=function(d,e){return d._events&&d._events[e]?n(d._events[e])?1:d._events[e].length:0}},{}],34:[function(e,t,r){t.exports=function(e,p,l,q){l=l||"=";var f={};if("string"!==typeof e||0===e.length)return f;var m=/\+/g;e=e.split(p||"&");p=1E3;q&&"number"===
typeof q.maxKeys&&(p=q.maxKeys);q=e.length;0<p&&q>p&&(q=p);for(p=0;p<q;++p){var g=e[p].replace(m,"%20"),c=g.indexOf(l),b;0<=c?(b=g.substr(0,c),g=g.substr(c+1)):(b=g,g="");b=decodeURIComponent(b);g=decodeURIComponent(g);Object.prototype.hasOwnProperty.call(f,b)?d(f[b])?f[b].push(g):f[b]=[f[b],g]:f[b]=g}return f};var d=Array.isArray||function(d){return"[object Array]"===Object.prototype.toString.call(d)}},{}],35:[function(e,t,r){function d(d,e){if(d.map)return d.map(e);for(var l=[],g=0;g<d.length;g++)l.push(e(d[g],
g));return l}var n=function(d){switch(typeof d){case "string":return d;case "boolean":return d?"true":"false";case "number":return isFinite(d)?d:"";default:return""}};t.exports=function(e,f,m,g){f=f||"&";m=m||"=";null===e&&(e=void 0);return"object"===typeof e?d(l(e),function(c){var b=encodeURIComponent(n(c))+m;return p(e[c])?d(e[c],function(a){return b+encodeURIComponent(n(a))}).join(f):b+encodeURIComponent(n(e[c]))}).join(f):g?encodeURIComponent(n(g))+m+encodeURIComponent(n(e)):""};var p=Array.isArray||
function(d){return"[object Array]"===Object.prototype.toString.call(d)},l=Object.keys||function(d){var e=[],l;for(l in d)Object.prototype.hasOwnProperty.call(d,l)&&e.push(l);return e}},{}],36:[function(e,t,r){r.decode=r.parse=e("./decode");r.encode=r.stringify=e("./encode")},{"./decode":34,"./encode":35}],37:[function(e,t,r){var d=Object.prototype.hasOwnProperty,n=Object.prototype.toString,p=function(e){if(!e||"[object Object]"!==n.call(e)||e.nodeType||e.setInterval)return!1;var p=d.call(e,"constructor"),
f=e.constructor&&e.constructor.prototype&&d.call(e.constructor.prototype,"isPrototypeOf");if(e.constructor&&!p&&!f)return!1;for(var m in e);return void 0===m||d.call(e,m)};t.exports=function q(){var d,e,g,c,b,a=arguments[0],k=1,h=arguments.length,n=!1;if("boolean"===typeof a)n=a,a=arguments[1]||{},k=2;else if("object"!==typeof a&&"function"!==typeof a||void 0==a)a={};for(;k<h;++k)if(null!=(d=arguments[k]))for(e in d)g=a[e],c=d[e],a!==c&&(n&&c&&(p(c)||(b=Array.isArray(c)))?(b?(b=!1,g=g&&Array.isArray(g)?
g:[]):g=g&&p(g)?g:{},a[e]=q(n,g,c)):void 0!==c&&(a[e]=c));return a}},{}],38:[function(e,t,r){if("undefined"==typeof siesta&&"undefined"==typeof t)throw Error("Could not find window.siesta. Make sure you include siesta.core.js first.");var d=siesta._internal,n=d.CollectionRegistry,p=d.util,l=p._,q=d.events,f=[],m={},g={},c={},b=d.log.loggerWithName("Storage");if("undefined"==typeof PouchDB)siesta.ext.storageEnabled=!1,console.log("PouchDB is not present therefore storage is disabled.");else{e=function(c){var d=
p.defer(c);c=d.finish.bind(d);siesta._afterInstall(function(){var e=f;f=[];m={};g={};b.trace&&b.trace("Saving objects",l.map(e,function(a){return a._dump()}));a(e,c,d)});return d.promise};var a=function(a,c,d){var e=[];A.bulkDocs(l.map(a,v)).then(function(f){for(var g=0;g<f.length;g++){var h=f[g],l=a[g];h.ok?l._rev=h.rev:409==h.status?e.push(l):b.error('Error saving object with _id="'+l._id+'"',h)}e.length?k(e,c,d):(c(),d&&d.resolve())},function(a){c(a);d&&d.reject(a)})},k=function(b,c,d){A.allDocs({keys:l.pluck(b,
"_id")}).then(function(e){for(var f=0;f<e.rows.length;f++)b[f]._rev=e.rows[f].value.rev;a(b,c,d)})["catch"](function(a){d.reject(a)})},h=function(a,b){x(a);delete a.collection;delete a.model;l.each(b._relationshipNames,function(b){var c=a[b];siesta.isArray(c)?a[b]=l.map(c,function(a){return{_id:a}}):a[b]={_id:c}});return a},v=function(a){var b=siesta._.extend({},a.__values);w(b);b.collection=a.collectionName;b.model=a.modelName;b._id=a._id;a.removed&&(b._deleted=!0);var c=a._rev;c&&(b._rev=c);return b=
l.reduce(a._relationshipNames,function(b,c){var d=a[c];siesta.isArray(d)?b[c]=l.pluck(d,"_id"):d&&(b[c]=d._id);return b},b)},z=function(a,b){A.bulkDocs(a).then(function(a){for(var c=[],d=0;d<a.length;d++){var e=a[d];e.ok||409!=e.status&&c.push(e)}b(c.length?c:null)})["catch"](b)},D=function(){var a=[],b=siesta._internal.CollectionRegistry;b.collectionNames.forEach(function(c){var d=b[c]._models,e;for(e in d)d.hasOwnProperty(e)&&a.push(B(c,e))});return a},B=function(a,b){var c=a+"."+b,d={};d[c]={map:function(a){"$1"==
a.collection&&"$2"==a.model&&emit(a.collection+"."+a.model,a)}.toString().replace("$1",a).replace("$2",b)};return{_id:"_design/"+c,views:d}},x=function(a){(a.siesta_meta||{dateFields:[]}).dateFields.forEach(function(b){var c=a[b];c instanceof Date||(a[b]=new Date(Date.parse(c)))});delete a.siesta_meta},w=function(a){a.siesta_meta={dateFields:[]};for(var b in a)a.hasOwnProperty(b)&&a[b]instanceof Date&&a.siesta_meta.dateFields.push(b)},A=new PouchDB("siesta"),C=function(a){a=a.obj;var b=a._id;if(!a)throw new d.error.InternalSiestaError("No obj field in notification received by storage extension");
if(!(b in m)){m[b]=a;f.push(a);var c=a.collectionName;g[c]||(g[c]={});var e=a.model.name;g[c][e]||(g[c][e]={});g[c][e][b]=a}};siesta.on("Siesta",C);l.extend(c,{_load:function(a){if(E)throw Error("not loaded yet how can i save");var d=p.defer(a);if(siesta.ext.storageEnabled){var e=[];l.each(n.collectionNames,function(a){var b=Object.keys(n[a]._models);l.each(b,function(b){e.push(function(d){c._loadModel({collectionName:a,modelName:b},d)})})});siesta.async.series(e,function(a,c){var e;if(!a){var f=
[];siesta._.each(c,function(a){f=f.concat(a)});e=f.length;b.trace&&b.trace("Loaded "+e.toString()+" instances")}d.finish(a,e)})}else d.finish();return d.promise},_loadModel:function(a,c){var d=a.collectionName,e=a.modelName,f=d+"."+e;b.trace&&b.trace("Loading instances for "+f);var g=n[d][e];(function(a){"$1"==a.model&&"$2"==a.collection&&emit(a._id,a)}).toString().replace("$1",e).replace("$2",d);b.trace.isEnabled&&b.trace("Querying pouch");A.query(f).then(function(a){console.log("resp",a);b.trace.isEnabled&&
b.trace("Queried pouch successfully");a=siesta._.map(siesta._.pluck(a.rows,"value"),function(a){return h(a,g)});b.trace.isEnabled&&b.trace("Mapping data",a);g.graph(a,{disableevents:!0,_ignoreInstalled:!0,fromStorage:!0},function(a,d){a?b.error("Error loading models",a):b.trace.isEnabled&&b.trace("Loaded "+d?d.length.toString():"0 instances for "+f);c(a,d)})})["catch"](function(a){c(a)})},save:e,_serialise:v,ensureIndexesForAll:function(a){var b=D();console.log("ensureIndexesForAll",b);z(b,a)},_reset:function(a){siesta.removeListener("Siesta",
C);f=[];m={};A.destroy(function(c){c||(A=new PouchDB("siesta"));siesta.on("Siesta",C);b.warn("Reset complete");a(c)})}});Object.defineProperties(c,{_unsavedObjects:{get:function(){return f}},_unsavedObjectsHash:{get:function(){return m}},_unsavedObjectsByCollection:{get:function(){return g}},_pouch:{get:function(){return A}}});siesta.ext||(siesta.ext={});siesta.ext.storage=c;Object.defineProperties(siesta.ext,{storageEnabled:{get:function(){return void 0!==siesta.ext._storageEnabled?siesta.ext._storageEnabled:
!!siesta.ext.storage},set:function(a){siesta.ext._storageEnabled=a},enumerable:!0}});var y,E,H=1E3;Object.defineProperties(siesta,{autosave:{get:function(){return!!y},set:function(a){a?y||(y=setInterval(function(){E||(E=!0,siesta.save(function(a){a||q.emit("saved");E=!1}))},siesta.autosaveInterval)):y&&(clearInterval(y),y=null)}},autosaveInterval:{get:function(){return H},set:function(a){H=a;y&&(siesta.autosave=!1,siesta.autosave=!0)}},dirty:{get:function(){return!!Object.keys(siesta.ext.storage._unsavedObjectsByCollection).length},
enumerable:!0}});l.extend(siesta,{save:e,setPouch:function(a){if(siesta._canChange)A=a;else throw Error("Cannot change PouchDB instance when an object graph exists.");}})}t.exports=c},{}],39:[function(e,t,r){(function(d){(function(d){function e(a){for(var b=0;1E3>b&&a.check_();)b++;x&&(d.dirtyCheckCycleCount=b);return 0<b}function l(a){for(var b in a)return!1;return!0}function q(a){return l(a.added)&&l(a.removed)&&l(a.changed)}function f(a,b){var c={},d={},e={},f;for(f in b){var g=a[f];if(void 0===
g||g!==b[f])f in a?g!==b[f]&&(e[f]=g):d[f]=void 0}for(f in a)f in b||(c[f]=a[f]);Array.isArray(a)&&a.length!==b.length&&(e.length=a.length);return{added:c,removed:d,changed:e}}function m(){if(!y.length)return!1;for(var a=0;a<y.length;a++)y[a]();y.length=0;return!0}function g(){function a(c){b&&b.state_===F&&!d&&b.check_(c)}var b,c,d=!1,e=!0;return{open:function(c){if(b)throw Error("ObservedObject in use");e||Object.deliverChangeRecords(a);b=c;e=!1},observe:function(b,d){c=b;d?Array.observe(c,a):Object.observe(c,
a)},deliver:function(b){d=b;Object.deliverChangeRecords(a);d=!1},close:function(){b=void 0;Object.unobserve(c,a);H.push(this)}}}function c(){this.state_=L;this.value_=this.directObserver_=this.target_=this.callback_=void 0;this.id_=M++}function b(a){c.call(this);this.value_=a;this.oldObject_=void 0}function a(a){if(!Array.isArray(a))throw Error("Provided object is not an Array");b.call(this,a)}function k(a,b,c){for(var d={},e={},f=0;f<b.length;f++){var g=b[f];O[g.type]?(g.name in c||(c[g.name]=g.oldValue),
"update"!=g.type&&("add"==g.type?g.name in e?delete e[g.name]:d[g.name]=!0:g.name in d?(delete d[g.name],delete c[g.name]):e[g.name]=!0)):(console.error("Unknown changeRecord type: "+g.type),console.error(g))}for(var h in d)d[h]=a[h];for(h in e)e[h]=void 0;b={};for(h in c)h in d||h in e||(f=a[h],c[h]!==f&&(b[h]=f));return{added:d,removed:e,changed:b}}function h(a,b,c){return{index:a,removed:b,addedCount:c}}function v(){}function z(a,b,c,d){b=h(b,c,d);d=!1;for(var e=0,f=0;f<a.length;f++){var g=a[f];
g.index+=e;if(!d){c=b.index;var k=b.index+b.removed.length,l=g.index,m=g.index+g.addedCount;c=k<l||m<c?-1:k==l||m==c?0:c<l?k<m?k-l:m-l:m<k?m-c:k-c;0<=c?(a.splice(f,1),f--,e-=g.addedCount-g.removed.length,b.addedCount+=g.addedCount-c,c=b.removed.length+g.removed.length-c,b.addedCount||c?(c=g.removed,b.index<g.index&&(k=b.removed.slice(0,g.index-b.index),Array.prototype.push.apply(k,c),c=k),b.index+b.removed.length>g.index+g.addedCount&&(k=b.removed.slice(g.index+g.addedCount-b.index),Array.prototype.push.apply(c,
k)),b.removed=c,g.index<b.index&&(b.index=g.index)):d=!0):b.index<g.index&&(d=!0,a.splice(f,0,b),f++,c=b.addedCount-b.removed.length,g.index+=c,e+=c)}}d||a.push(b)}function D(a,b){for(var c=[],d=0;d<b.length;d++){var e=b[d];switch(e.type){case "splice":z(c,e.index,e.removed.slice(),e.addedCount);break;case "add":case "update":case "delete":var f=e.name;if(+f!==f>>>0||""===f)continue;f=+e.name;if(0>f)continue;z(c,f,[e.oldValue],1);break;default:console.error("Unexpected record type: "+JSON.stringify(e))}}return c}
function B(a,b){var c=[];D(a,b).forEach(function(b){1==b.addedCount&&1==b.removed.length?b.removed[0]!==a[b.index]&&c.push(b):c=c.concat(K.calcSplices(a,b.index,b.index+b.addedCount,b.removed,0,b.removed.length))});return c}var x=d.testingExposeCycleCount,w=function(){function a(c){b=c}if("function"!==typeof Object.observe||"function"!==typeof Array.observe)return!1;var b=[],c={},d=[];Object.observe(c,a);Array.observe(d,a);c.id=1;c.id=2;delete c.id;d.push(1,2);d.length=0;Object.deliverChangeRecords(a);
if(5!==b.length||"add"!=b[0].type||"update"!=b[1].type||"delete"!=b[2].type||"splice"!=b[3].type||"splice"!=b[4].type)return!1;Object.unobserve(c,a);Array.unobserve(d,a);return!0}(),A=function(){if("undefined"!==typeof chrome&&chrome.app&&chrome.app.runtime||navigator.getDeviceStorage)return!1;try{return(new Function("","return true;"))()}catch(a){return!1}}(),C="__proto__"in{}?function(a){return a}:function(a){var b=a.__proto__;if(!b)return a;var c=Object.create(b);Object.getOwnPropertyNames(a).forEach(function(b){Object.defineProperty(c,
b,Object.getOwnPropertyDescriptor(a,b))});return c},y=[],E=w?function(){var a={pingPong:!0},b=!1;Object.observe(a,function(){m();b=!1});return function(c){y.push(c);b||(b=!0,a.pingPong=!a.pingPong)}}():function(){return function(a){y.push(a)}}(),H=[],L=0,F=1,M=1;c.prototype={open:function(a,b){if(this.state_!=L)throw Error("Observer has already been opened.");c._allObserversCount++;I&&G.push(this);this.callback_=a;this.target_=b;this.connect_();this.state_=F;return this.value_},close:function(){this.state_==
F&&(c._allObserversCount--,this.disconnect_(),this.target_=this.callback_=this.value_=void 0,this.state_=2)},deliver:function(){this.state_==F&&e(this)},report_:function(a){try{this.callback_.apply(this.target_,a)}catch(b){c._errorThrownDuringCallback=!0,console.error("Exception caught during observer callback: "+(b.stack||b))}},discardChanges:function(){this.check_(void 0,!0);return this.value_}};var I=!w,G;c._allObserversCount=0;I&&(G=[]);var J=!1,N=w&&A&&function(){try{return eval("%RunMicrotasks()"),
!0}catch(a){return!1}}();d.Platform=d.Platform||{};d.Platform.performMicrotaskCheckpoint=function(){if(!J)if(N)eval("%RunMicrotasks()");else if(I){J=!0;var a=0,b,c;do{a++;c=G;G=[];b=!1;for(var e=0;e<c.length;e++){var f=c[e];f.state_==F&&(f.check_()&&(b=!0),G.push(f))}m()&&(b=!0)}while(1E3>a&&b);x&&(d.dirtyCheckCycleCount=a);J=!1}};I&&(d.Platform.clearObservers=function(){G=[]});b.prototype=C({__proto__:c.prototype,arrayObserve:!1,connect_:function(a,b){if(w){var c=this.value_,d=this.arrayObserve,
e=H.pop()||g();e.open(this);e.observe(c,d);this.directObserver_=e}else this.oldObject_=this.copyObject(this.value_)},copyObject:function(a){var b=Array.isArray(a)?[]:{},c;for(c in a)b[c]=a[c];Array.isArray(a)&&(b.length=a.length);return b},check_:function(a,b){var c,d;if(w){if(!a)return!1;d={};c=k(this.value_,a,d)}else d=this.oldObject_,c=f(this.value_,this.oldObject_);if(q(c))return!1;w||(this.oldObject_=this.copyObject(this.value_));this.report_([c.added||{},c.removed||{},c.changed||{},function(a){return d[a]}]);
return!0},disconnect_:function(){w?(this.directObserver_.close(),this.directObserver_=void 0):this.oldObject_=void 0},deliver:function(){this.state_==F&&(w?this.directObserver_.deliver(!1):e(this))},discardChanges:function(){this.directObserver_?this.directObserver_.deliver(!0):this.oldObject_=this.copyObject(this.value_);return this.value_}});a.prototype=C({__proto__:b.prototype,arrayObserve:!0,copyObject:function(a){return a.slice()},check_:function(a){if(w){if(!a)return!1;a=B(this.value_,a)}else a=
K.calcSplices(this.value_,0,this.value_.length,this.oldObject_,0,this.oldObject_.length);if(!a||!a.length)return!1;w||(this.oldObject_=this.copyObject(this.value_));this.report_([a]);return!0}});a.applySplices=function(a,b,c){c.forEach(function(c){for(var d=[c.index,c.removed.length],e=c.index;e<c.index+c.addedCount;)d.push(b[e]),e++;Array.prototype.splice.apply(a,d)})};var O={add:!0,update:!0,"delete":!0};v.prototype={calcEditDistances:function(a,b,c,d,e,f){f=f-e+1;c=c-b+1;for(var g=Array(f),h=0;h<
f;h++)g[h]=Array(c),g[h][0]=h;for(var k=0;k<c;k++)g[0][k]=k;for(h=1;h<f;h++)for(k=1;k<c;k++)if(this.equals(a[b+k-1],d[e+h-1]))g[h][k]=g[h-1][k-1];else{var l=g[h-1][k]+1,m=g[h][k-1]+1;g[h][k]=l<m?l:m}return g},spliceOperationsFromEditDistances:function(a){for(var b=a.length-1,c=a[0].length-1,d=a[b][c],e=[];0<b||0<c;)if(0==b)e.push(2),c--;else if(0==c)e.push(3),b--;else{var f=a[b-1][c-1],g=a[b-1][c],h=a[b][c-1],k;k=g<h?g<f?g:f:h<f?h:f;k==f?(f==d?e.push(0):(e.push(1),d=f),b--,c--):k==g?(e.push(3),b--,
d=g):(e.push(2),c--,d=h)}e.reverse();return e},calcSplices:function(a,b,c,d,e,f){var g=0,k=0,l=Math.min(c-b,f-e);0==b&&0==e&&(g=this.sharedPrefix(a,d,l));c==a.length&&f==d.length&&(k=this.sharedSuffix(a,d,l-g));b+=g;e+=g;c-=k;f-=k;if(0==c-b&&0==f-e)return[];if(b==c){for(a=h(b,[],0);e<f;)a.removed.push(d[e++]);return[a]}if(e==f)return[h(b,[],c-b)];f=this.spliceOperationsFromEditDistances(this.calcEditDistances(a,b,c,d,e,f));a=void 0;c=[];for(g=0;g<f.length;g++)switch(f[g]){case 0:a&&(c.push(a),a=void 0);
b++;e++;break;case 1:a||(a=h(b,[],0));a.addedCount++;b++;a.removed.push(d[e]);e++;break;case 2:a||(a=h(b,[],0));a.addedCount++;b++;break;case 3:a||(a=h(b,[],0)),a.removed.push(d[e]),e++}a&&c.push(a);return c},sharedPrefix:function(a,b,c){for(var d=0;d<c;d++)if(!this.equals(a[d],b[d]))return d;return c},sharedSuffix:function(a,b,c){for(var d=a.length,e=b.length,f=0;f<c&&this.equals(a[--d],b[--e]);)f++;return f},calculateSplices:function(a,b){return this.calcSplices(a,0,a.length,b,0,b.length)},equals:function(a,
b){return a===b}};var K=new v,A=d;"undefined"!==typeof r&&("undefined"!==typeof t&&t.exports&&(A=r=t.exports),A=r);A.Observer=c;A.Observer.runEOM_=E;A.Observer.observerSentinel_={};A.Observer.hasObjectObserve=w;A.ArrayObserver=a;A.ArrayObserver.calculateSplices=function(a,b){return K.calculateSplices(a,b)};A.Platform=d.Platform;A.ArraySplice=v;A.ObjectObserver=b})("undefined"!==typeof d&&d&&"undefined"!==typeof t&&t?d:this||window)}).call(this,"undefined"!==typeof global?global:"undefined"!==typeof self?
self:"undefined"!==typeof window?window:{})},{}]},{},[16]);
