(function e$$0(t,q,d){function n(l,f){if(!q[l]){if(!t[l]){var m="function"==typeof require&&require;if(!f&&m)return m(l,!0);if(p)return p(l,!0);m=Error("Cannot find module '"+l+"'");throw m.code="MODULE_NOT_FOUND",m;}m=q[l]={exports:{}};t[l][0].call(m.exports,function(g){var b=t[l][1][g];return n(b?b:g)},m,m.exports,e$$0,t,q,d)}return q[l].exports}for(var p="function"==typeof require&&require,l=0;l<d.length;l++)n(d[l]);return n})({1:[function(e,t,q){function d(a){n.call(this,a);this.indexAttribute=
"index"}var n=e("./reactiveQuery");q=e("./log");var p=e("./util"),l=e("./error"),r=e("./modelEvents"),f=l.InternalSiestaError,m=e("./querySet"),g=l.errorFactory(l.Components.ArrangedReactiveQuery),b=p._;q.loggerWithName("Query");d.prototype=Object.create(n.prototype);b.extend(d.prototype,{_refreshIndexes:function(){var a=this.results,c=this.indexAttribute;if(!a)throw new f("ArrangedReactiveQuery must be initialised");for(var k=0;k<a.length;k++)a[k][c]=k},_mergeIndexes:function(){for(var a=this.results,
c=[],k=[],h=[],v=0;v<a.length;v++){var y=a[v],g=y[this.indexAttribute];void 0==g?h.push(y):g>a.length?k.push(y):c[g]?h.push(y):c[g]=y}k=b.sortBy(k,function(a){return a[this.indexAttribute]}.bind(this));for(v=0;v<k.length;v++)y=k[v],a=this.results.length-k.length+v,y[this.indexAttribute]=a,c[a]=y;h=this._query._sortResults(h);for(k=0;h.length;){for(y=h.shift();c[k];)k++;c[k]=y;y[this.indexAttribute]=k}this.results=m(c,this.model)},init:function(a){var c=p.defer(a);n.prototype.init.call(this,function(a){a||
(this.model.hasAttributeNamed(this.indexAttribute)?(this._mergeIndexes(),this._query.clearOrdering()):a=g('Model "'+this.model.name+'" does not have an attribute named "'+this.indexAttribute+'"'));c.finish(a,a?null:this.results)}.bind(this));return c.promise},_handleNotif:function(a){a.field!=this.indexAttribute&&(n.prototype._handleNotif.call(this,a),this._refreshIndexes())},validateIndex:function(a){var c=this.results.length-1;if(!(0<=a&&a<=c))throw Error("Index "+a.toString()+" is out of bounds");
},swapObjectsAtIndexes:function(a,c){this.validateIndex(a);this.validateIndex(c);var k=this.results[a],h=this.results[c];if(!k)throw Error('No model at index "'+a.toString()+'"');if(!h)throw Error('No model at index "'+c.toString()+'"');this.results[c]=k;this.results[a]=h;k[this.indexAttribute]=c;h[this.indexAttribute]=a},swapObjects:function(a,c){var k=this.results.indexOf(a),h=this.results.indexOf(c);this.swapObjectsAtIndexes(k,h)},move:function(a,c){this.validateIndex(a);this.validateIndex(c);
var k=this.results.mutableCopy();(function(a,c){if(c>=this.length)for(var k=c-this.length;k--+1;)this.push(void 0)}).call(k,a,c);var h=k.splice(a,1)[0];this.results=k.asModelQuerySet(this.model);this.emit("change",{index:a,removed:[h],type:r.ModelEventType.Splice,obj:this,field:"results"});k.splice(c,0,h);this.results=k.asModelQuerySet(this.model);this.emit("change",{index:c,added:[h],type:r.ModelEventType.Splice,obj:this,field:"results"});this._refreshIndexes()}});t.exports=d},{"./error":11,"./log":14,
"./modelEvents":18,"./querySet":23,"./reactiveQuery":24,"./util":28}],2:[function(e,t,q){function d(f){var g=this;this.model=f;n.subProperties(this,this.model,["collection","collectionName","_attributeNames",{name:"idField",property:"id"},{name:"modelName",property:"name"}]);r.ProxyEventEmitter.call(this);Object.defineProperties(this,{_relationshipNames:{get:function(){var b=p.map(Object.keys(g.__proxies||{}),function(a){return g.__proxies[a]});return p.map(b,function(a){return a.isForward?a.forwardName:
a.reverseName})},enumerable:!0,configurable:!0},dirty:{get:function(){if(siesta.ext.storageEnabled)return g._id in siesta.ext.storage._unsavedObjectsHash},enumerable:!0},event:{get:function(){return this._id}}});this.removed=!1}e("./log");var n=e("./util"),p=n._;e("./error");var l=e("./modelEvents"),r=e("./events"),f=e("./cache");d.prototype=Object.create(r.ProxyEventEmitter.prototype);p.extend(d.prototype,{get:function(f){var g=n.defer(f);f=g.finish.bind(g);f(null,this);return g.promise},emit:function(f,
g){"object"==typeof f?g=f:g.type=f;g=g||{};p.extend(g,{collection:this.collectionName,model:this.model.name,_id:this._id,obj:this});l.emit(g)},remove:function(d,g){g=null==g?!0:g;var b=n.defer(d);d=b.finish.bind(b);f.remove(this);this.removed=!0;g&&this.emit(l.ModelEventType.Remove,{old:this});var a=this.model.remove;if(a)if(n.paramNames(a).length){var c=this;a.call(this,function(a){d(a,c)})}else a.call(this),d(null,this);else d(null,this);return b.promise},restore:function(d){var g=n.defer(d);d=
g.finish.bind(g);var b=function(a){a||this.emit(l.ModelEventType.New,{"new":this});d(a,this)}.bind(this);if(this.removed){f.insert(this);this.removed=!1;var a=this.model.init;a?1<n.paramNames(a).length?a.call(this,!0,b):(a.call(this,!0),b()):b()}return g.promise}});p.extend(d.prototype,{getAttributes:function(){return p.extend({},this.__values)},isInstanceOf:function(f){return this.model==f},isA:function(f){return this.model==f||this.model.isDescendantOf(f)}});p.extend(d.prototype,{_dumpString:function(f){return JSON.stringify(this._dump(f,
null,4))},_dump:function(f){f=p.extend({},this.__values);f._rev=this._rev;f._id=this._id;return f}});t.exports=d},{"./cache":8,"./error":11,"./events":12,"./log":14,"./modelEvents":18,"./util":28}],3:[function(e,t,q){function d(b){n.call(this,b);this.isReverse&&(this.related=[])}var n=e("./RelationshipProxy");e("./store");var p=e("./util"),l=p._;e("./error");var r=e("./modelEvents");e("./modelInstance");var f=e("./events").wrapArray,m=e("../vendor/observe-js/src/observe").ArrayObserver,g=e("./modelEvents").ModelEventType;
d.prototype=Object.create(n.prototype);l.extend(d.prototype,{clearReverse:function(b){var a=this;l.each(b,function(c){a.reverseProxyForInstance(c).setIdAndRelated(null)})},setReverseOfAdded:function(b){var a=this;l.each(b,function(c){a.reverseProxyForInstance(c).setIdAndRelated(a.object)})},wrapArray:function(b){var a=this;f(b,this.reverseName,this.object);b.arrayObserver||(b.arrayObserver=new m(b),b.arrayObserver.open(function(c){c.forEach(function(c){var h=c.addedCount?b.slice(c.index,c.index+c.addedCount):
[],v=c.removed;a.clearReverse(v);a.setReverseOfAdded(h);var y=a.getForwardModel();r.emit({collection:y.collectionName,model:y.name,_id:a.object._id,field:a.getForwardName(),removed:v,added:h,type:g.Splice,index:c.index,obj:a.object})})}))},get:function(b){var a=p.defer(b);b=a.finish.bind(a);b(null,this.related);return a.promise},validate:function(b){b=Object.prototype.toString.call(b);if(this.isForward){if("[object Array]"==b)return"Cannot assign array forward oneToMany ("+b+"): "+this.forwardName}else if("[object Array]"!=
b)return"Cannot scalar to reverse oneToMany ("+b+"): "+this.reverseName;return null},set:function(b,a){this.checkInstalled();if(b){var c;if(c=this.validate(b))return c;this.clearReverseRelated(a);this.setIdAndRelated(b,a);this.isReverse&&this.wrapArray(this.related);this.setIdAndRelatedReverse(b,a)}else this.clearReverseRelated(a),this.setIdAndRelated(b,a)},install:function(b){n.prototype.install.call(this,b);this.isReverse&&(b["splice"+p.capitaliseFirstLetter(this.reverseName)]=l.bind(this.splice,
this),this.wrapArray(this.related))}});t.exports=d},{"../vendor/observe-js/src/observe":44,"./RelationshipProxy":6,"./error":11,"./events":12,"./modelEvents":18,"./modelInstance":19,"./store":26,"./util":28}],4:[function(e,t,q){function d(d){n.call(this,d)}var n=e("./RelationshipProxy");e("./store");var p=e("./util");q=p._;e("./error");e("./modelEvents");e("./modelInstance");d.prototype=Object.create(n.prototype);q.extend(d.prototype,{validate:function(d){return"[object Array]"==Object.prototype.toString.call(d)?
"Cannot assign array to one to one relationship":null},set:function(d,e){this.checkInstalled();if(d){var f;if(f=this.validate(d))return f;this.clearReverseRelated(e);this.setIdAndRelated(d,e);this.setIdAndRelatedReverse(d,e)}else this.clearReverseRelated(e),this.setIdAndRelated(d,e)},get:function(d){var e=p.defer(d);d=e.finish.bind(e);d(null,this.related);return e.promise}});t.exports=d},{"./RelationshipProxy":6,"./error":11,"./modelEvents":18,"./modelInstance":19,"./store":26,"./util":28}],5:[function(e,
t,q){function d(a,c){var k={},h;for(h in c)c.hasOwnProperty(h)&&"__"==h.slice(0,2)&&(k[h.slice(2)]=c[h],delete c[h]);g.extend(this,{model:a,query:c,opts:k});k.order=k.order||[];l.isArray(k.order)||(k.order=[k.order])}function n(a){var c=a.name;a=p._localCacheByType[a.collectionName];var k;a&&(k=a[c]||{});return k}q=e("./log");var p=e("./cache"),l=e("./util"),r=e("./error"),f=e("./querySet"),m=r.errorFactory(r.Components.Query),g=l._,b=q.loggerWithName("Query");g.extend(d,{comparators:{e:function(a){var c=
a.object[a.field];b.trace&&b.trace(a.field+": "+(null===c?"null":void 0===c?"undefined":c.toString())+" == "+a.value.toString());return c==a.value},lt:function(a){return a.invalid?!1:a.object[a.field]<a.value},gt:function(a){return a.invalid?!1:a.object[a.field]>a.value},lte:function(a){return a.invalid?!1:a.object[a.field]<=a.value},gte:function(a){return a.invalid?!1:a.object[a.field]>=a.value},contains:function(a){return a.invalid?!1:-1<a.object[a.field].indexOf(a.value)}},registerComparator:function(a,
c){this.comparators[a]||(this.comparators[a]=c)}});g.extend(d.prototype,{execute:function(a){var c=l.defer(a);a=c.finish.bind(c);this._executeInMemory(a);return c.promise},_dump:function(a){return a?"{}":{}},sortFunc:function(a){for(var c=function(a,c){return function(v,k){var h=v[c],b=k[c];"string"==typeof h||h instanceof String&&"string"==typeof b||b instanceof String?h=a?h.localeCompare(b):b.localeCompare(h):(h instanceof Date&&(h=h.getTime()),b instanceof Date&&(b=b.getTime()),h=a?h-b:b-h);return h}},
k=l,h=0;h<a.length;h++)var v=a[h],k=k.thenBy(c(v.ascending,v.field));return k==l?null:k},_sortResults:function(a){var c=this.opts.order;a&&c&&(c=g.map(c,function(a){a=a.split("-");var c=!0,v=null;1<a.length?(v=a[1],c=!1):v=a[0];return{field:v,ascending:c}}.bind(this)),c=this.sortFunc(c),a.immutable&&(a=a.mutableCopy()),c&&a.sort(c));return a},_getCacheByLocalId:function(){return g.reduce(this.model.descendants,function(a,c){return g.extend(a,n(c))},g.extend({},n(this.model)))},_executeInMemory:function(a){var c=
function(){for(var c=this._getCacheByLocalId(),h=Object.keys(c),v=[],b,g=0;g<h.length;g++){var d=c[h[g]],e=this.objectMatchesQuery(d);if("string"==typeof e){b=m(e);break}else e&&v.push(d)}v=this._sortResults(v);a(b,b?null:f(v,this.model))}.bind(this);this.opts.ignoreInstalled?c():siesta._afterInstall(c)},clearOrdering:function(){this.opts.order=null},objectMatchesOrQuery:function(a,c){for(var k in c)if(c.hasOwnProperty(k)&&this.objectMatchesBaseQuery(a,c[k]))return!0;return!1},objectMatchesAndQuery:function(a,
c){for(var k in c)if(c.hasOwnProperty(k)&&!this.objectMatchesBaseQuery(a,c[k]))return!1;return!0},splitMatches:function(a,c,k){var h="e",v=c.split("."),b=v[v.length-1].split("__");2==b.length?(c=b[0],h=b[1]):c=b[0];v[v.length-1]=c;g.each(v.slice(0,v.length-1),function(c){a=a[c]});v=a[c];return(b=d.comparators[h])?b({object:a,field:c,value:k,invalid:null===v||void 0===v}):'No comparator registered for query operation "'+h+'"'},objectMatches:function(a,c,k,h){if("$or"==c){if(!this.objectMatchesOrQuery(a,
h.$or))return!1}else if("$and"==c){if(!this.objectMatchesAndQuery(a,h.$and))return!1}else{a=this.splitMatches(a,c,k);if("boolean"!=typeof a)return a;if(!a)return!1}return!0},objectMatchesBaseQuery:function(a,c){for(var k=Object.keys(c),h=0;h<k.length;h++){var v=k[h],v=this.objectMatches(a,v,c[v],c);if("boolean"!=typeof v)return v;if(!v)return!1}return!0},objectMatchesQuery:function(a){return this.objectMatchesBaseQuery(a,this.query)}});t.exports=d},{"./cache":8,"./error":11,"./log":14,"./querySet":23,
"./util":28}],6:[function(e,t,q){function d(b){var a=this;b=b||{};l.extend(this,{object:null,related:null});Object.defineProperties(this,{isForward:{get:function(){return!a.isReverse},set:function(c){a.isReverse=!c},enumerable:!0}});p.extendFromOpts(this,b,{reverseModel:null,forwardModel:null,forwardName:null,reverseName:null,isReverse:null});this.cancelListens={}}var n=e("./error").InternalSiestaError;e("./store");var p=e("./util"),l=p._;e("./query");e("./log");e("./cache");var r=e("./events").wrapArray,
f=e("../vendor/observe-js/src/observe").ArrayObserver,m=e("./modelEvents"),g=m.ModelEventType;l.extend(d,{});l.extend(d.prototype,{install:function(b){if(b){if(this.object)throw new n("Already installed.");this.object=b;var a=this,c=this.getForwardName();Object.defineProperty(b,c,{get:function(){return a.related},set:function(c){a.set(c)},configurable:!0,enumerable:!0});b.__proxies||(b.__proxies={});b.__proxies[c]=this;b._proxies||(b._proxies=[]);b._proxies.push(this)}else throw new n("No object passed to relationship install");
}});l.extend(d.prototype,{set:function(b,a){throw new n("Must subclass RelationshipProxy");},get:function(b){throw new n("Must subclass RelationshipProxy");}});l.extend(d.prototype,{proxyForInstance:function(b,a){var c=a?this.getReverseName():this.getForwardName(),k=a?this.reverseModel:this.forwardModel;if(p.isArray(b))k=l.map(b,function(a){return a.__proxies[c]});else{var h=b.__proxies[c];if(!h)throw new n('No proxy with name "'+c+'" on mapping '+k.name);k=h}return k},reverseProxyForInstance:function(b){return this.proxyForInstance(b,
!0)},getReverseName:function(){return this.isForward?this.reverseName:this.forwardName},getForwardName:function(){return this.isForward?this.forwardName:this.reverseName},getForwardModel:function(){return this.isForward?this.forwardModel:this.reverseModel},clearRemovalListener:function(b){b=b._id;var a=this.cancelListens[b];a&&(a(),this.cancelListens[b]=null)},listenForRemoval:function(b){this.cancelListens[b._id]=b.listen(function(a){a.type==g.Remove&&(p.isArray(this.related)?(a=this.related.indexOf(b),
this.splice(a,1)):this.setIdAndRelated(null),this.clearRemovalListener(b))}.bind(this))},setIdAndRelated:function(b,a){a=a||{};a.disableevents||this.registerSetChange(b);var c=this.related;c&&this.clearRemovalListener(c);b?p.isArray(b)?(this.related=b,b.forEach(function(a){this.listenForRemoval(a)}.bind(this))):(this.related=b,this.listenForRemoval(b)):this.related=null},checkInstalled:function(){if(!this.object)throw new n("Proxy must be installed on an object before can use it.");},splicer:function(b){b=
b||{};return function(a,c){b=b||{};b.disableevents||this.registerSpliceChange.apply(this,arguments);var k=Array.prototype.slice.call(arguments,2);return l.partial(this.related.splice,a,c).apply(this.related,k)}.bind(this)},clearReverseRelated:function(b){b=b||{};var a=this;if(this.related){var c=this.reverseProxyForInstance(this.related),c=p.isArray(c)?c:[c];l.each(c,function(c){if(p.isArray(c.related)){var h=c.related.indexOf(a.object);c.makeChangesToRelatedWithoutObservations(function(){c.splicer(b)(h,
1)})}else c.setIdAndRelated(null,b)})}},setIdAndRelatedReverse:function(b,a){var c=this,k=this.reverseProxyForInstance(b),k=p.isArray(k)?k:[k];l.each(k,function(h){p.isArray(h.related)?h.makeChangesToRelatedWithoutObservations(function(){h.splicer(a)(h.related.length,0,c.object)}):(h.clearReverseRelated(a),h.setIdAndRelated(c.object,a))})},makeChangesToRelatedWithoutObservations:function(b){this.related?(this.related.arrayObserver.close(),this.related.arrayObserver=null,b(),this.wrapArray(this.related)):
b()},registerSetChange:function(b){var a=this.object;if(!a)throw new n("Proxy must have an object associated");var c=a.model.name,k=a.collectionName,h=this.related;p.isArray(h)&&!h.length&&(h=null);m.emit({collection:k,model:c,_id:a._id,field:this.getForwardName(),old:h,"new":b,type:g.Set,obj:a})},registerSpliceChange:function(b,a){var c=Array.prototype.slice.call(arguments,2);m.emit({collection:this.object.collectionName,model:this.object.model.name,_id:this.object._id,field:this.getForwardName(),
index:b,removed:this.related?this.related.slice(b,b+a):null,added:c.length?c:[],type:g.Splice,obj:this.object})},wrapArray:function(b){var a=this;r(b,this.reverseName,this.object);b.arrayObserver||(b.arrayObserver=new f(b),b.arrayObserver.open(function(c){c.forEach(function(c){var h=c.addedCount?b.slice(c.index,c.index+c.addedCount):[],v=a.getForwardModel();m.emit({collection:v.collectionName,model:v.name,_id:a.object._id,field:a.getForwardName(),removed:c.removed,added:h,type:g.Splice,obj:a.object})})}))},
splice:function(){this.splicer({}).apply(this,arguments)}});t.exports=d},{"../vendor/observe-js/src/observe":44,"./cache":8,"./error":11,"./events":12,"./log":14,"./modelEvents":18,"./query":22,"./store":26,"./util":28}],7:[function(e,t,q){t.exports={OneToMany:"OneToMany",OneToOne:"OneToOne",ManyToMany:"ManyToMany"}},{}],8:[function(e,t,q){function d(a){var c=a.name;if(a=k[a.collectionName])if(c=a[c]){a=[];for(var h in c)c.hasOwnProperty(h)&&a.push(c[h]);if(1<a.length)throw new g("A singleton model has more than 1 object in the cache! This is a serious error. Either a model has been modified after objects have already been created, or something has gonevery wrong. Please file a bug report if the latter.");
if(a.length)return a[0]}return null}function n(c,b){var k=b.model.name,g=b.model.collectionName;if(h[g]&&(k=h[g][k]))return(k=k[c])?a.debug&&a.debug("Remote cache hit: "+k._dump(!0)):a.debug&&a.debug("Remote cache miss: "+c),k;a.debug&&a.debug("Remote cache miss: "+c);return null}function p(c,b,k){if(c){var f=c.model.collectionName;if(f){h[f]||(h[f]={});var d=c.model.name;if(d)if(h[f][d]||(h[f][d]={}),k&&(h[f][d][k]=null),k=h[f][d][b]){if(c!=k)throw b="Object "+f.toString()+":"+d.toString()+"["+c.model.id+
'="'+b+'"] already exists in the cache. This is a serious error, please file a bug report if you are experiencing this out in the wild',a.error(b,{obj:c,cachedObject:k}),new g(b);a.debug.isEnabled&&a.debug("Object has already been inserted: "+c._dump(!0))}else h[f][d][b]=c,a.debug.isEnabled&&a.debug("Remote cache insert: "+c._dump(!0)),a.trace.isEnabled&&a.trace("Remote cache now looks like: "+l(!0));else throw new g("Model has no type",{model:c.model,obj:c});}else throw new g("Model has no collection",
{model:c.model,obj:c});}else throw a.error("Must pass an object when inserting to cache"),new g("Must pass an object when inserting to cache");}function l(a){var c={},k;for(k in h)if(h.hasOwnProperty(k)){var g={};c[k]=g;var f=h[k],d;for(d in f)if(f.hasOwnProperty(d)){var e={};g[d]=e;var l=f[d],m;for(m in l)l.hasOwnProperty(m)&&l[m]&&(e[m]=l[m]._dump())}}return a?b.prettyPrint((c,null,4)):c}function r(a){var h={},k;for(k in c)c.hasOwnProperty(k)&&(h[k]=c[k]._dump());return a?b.prettyPrint((h,null,
4)):h}function f(h){a.debug.isEnabled&&a.debug("get",h);var b,k;if(b=h._id){(k=c[b])?a.debug.isEnabled&&a.debug("Local cache hit: "+k._dump(!0)):a.debug.isEnabled&&a.debug("Local cache miss: "+b);if(k)return k;if(h.model)return b=h.model.id,k=h[b],a.debug.isEnabled&&a.debug(b+"="+k),n(k,h)}else if(h.model){b=h.model.id;if(k=h[b])return n(k,h);if(h.model.singleton)return d(h.model)}else a.warn("Invalid opts to cache",{opts:h});return null}function m(a){var c={_id:a._id},h=a.model;h.id&&a[h.id]&&(c.model=
h,c[h.id]=a[h.id]);return!!f(c)}t=e("./log");var g=e("./error").InternalSiestaError,b=e("./util"),a=t.loggerWithName("Cache"),c={},k={},h={};q._remoteCache=function(){return h};q._localCache=function(){return c};Object.defineProperty(q,"_localCacheByType",{get:function(){return k}});q.get=f;q.insert=function(h){var b=h._id;if(b){var f=h.model.collectionName,d=h.model.name;a.debug.isEnabled&&a.debug("Local cache insert: "+h._dumpString());if(!c[b])c[b]=h,a.trace.isEnabled&&a.trace("Local cache now looks like: "+
r(!0)),k[f]||(k[f]={}),k[f][d]||(k[f][d]={}),k[f][d][b]=h;else if(c[b]!=h)throw h='Object with _id="'+b.toString()+'" is already in the cache. This is a serious error. Please file a bug report if you are experiencing this out in the wild',a.error(h),new g(h);}b=h.idField;(f=h[b])?p(h,f):a.debug.isEnabled&&a.debug('No remote id ("'+b+'") so wont be placing in the remote cache',h)};q.remoteInsert=p;q.reset=function(){h={};c={};k={}};q._dump=function(a){var c={localCache:r(),remoteCache:l()};return a?
b.prettyPrint((c,null,4)):c};q.contains=m;q.remove=function(a){if(m(a)){var b=a.model.collectionName,f=a.model.name,d=a._id;if(!f)throw g("No mapping name");if(!b)throw g("No collection name");if(!d)throw g("No _id");delete k[b][f][d];delete c[d];a.model.id&&(a=a[a.model.id])&&delete h[b][f][a]}else throw new g("Object was not in cache.");};q.getSingleton=d},{"./error":11,"./log":14,"./util":28}],9:[function(e,t,q){function d(a,c){var b=this;if(!a)throw Error("Collection must have a name");c=c||{};
m.extendFromOpts(this,c,{baseURL:""});g.extend(this,{name:a,_rawModels:{},_models:{},_opts:c,installed:!1});Object.defineProperties(this,{dirty:{get:function(){if(siesta.ext.storageEnabled)return!!Object.keys(siesta.ext.storage._unsavedObjectsByCollection[b.name]||{}).length},enumerable:!0}});n.register(this);f.ProxyEventEmitter.call(this,this.name)}q=e("./log");var n=e("./collectionRegistry").CollectionRegistry,p=e("./error").InternalSiestaError,l=e("./model"),r=e("extend");e("../vendor/observe-js/src/observe");
var f=e("./events"),m=e("./util"),g=m._,b=e("./error"),a=b.errorFactory(b.Components.Collection);e("./cache");var c=["PUT","PATCH","POST","DELETE"],k=q.loggerWithName("Collection");d.prototype=Object.create(f.ProxyEventEmitter.prototype);g.extend(d.prototype,{install:function(a){var c=m.defer(a),b=this;if(this.installed)throw new p('Collection "'+this.name+'" has already been installed');var f=[],d;for(d in this._models)this._models.hasOwnProperty(d)&&f.push(this._models[d]);k.info.isEnabled&&k.info("There are "+
f.length.toString()+" mappings to install");f.length?(a=g.map(f,function(a){return g.bind(a.install,a)}),m.async.parallel(a,function(a){if(a)k.error("Failed to install collection",a);else{b.installed=!0;var h=[];g.each(f,function(a){k.info.isEnabled&&k.info('Installing relationships for mapping with name "'+a.name+'"');(a=a.installRelationships())&&h.push(a)});h.length||g.each(f,function(a){k.info.isEnabled&&k.info('Installing reverse relationships for mapping with name "'+a.name+'"');(a=a.installReverseRelationships())&&
h.push(a)});1==h.length?a=h[0]:h.length&&(a=h)}b._finaliseInstallation(a,c.finish.bind(c))})):b._finaliseInstallation(null,c.finish.bind(c));return c.promise},_finaliseInstallation:function(c,b){c&&(c=a("Errors were encountered whilst setting up the collection",{errors:c}));c||(this.installed=!0,e("./index")[this.name]=this);b(c)},_model:function(a,c){if(a){this._rawModels[a]=c;c=r(!0,{},c);c.name=a;c.collection=this;var b=new l(c);this._models[a]=b;return this[a]=b}throw Error("No name specified when creating mapping");
},model:function(a){if(this.installed)throw Error("Cannot create new models once the object graph is established!");var c=this;if(arguments.length){if(1==arguments.length){if(m.isArray(arguments[0]))return g.map(arguments[0],function(a){return c._model(a.name,a)});var b,k;m.isString(arguments[0])?(b=arguments[0],k={}):(k=arguments[0],b=k.name);return this._model(b,k)}return"string"==typeof arguments[0]?this._model(arguments[0],arguments[1]):g.map(arguments,function(a){return c._model(a.name,a)})}return null},
descriptor:function(a){var b=[];if(siesta.ext.httpEnabled){a.collection=this;for(var k=siesta.ext.http._resolveMethod(a.method),f=[],g=[],d=0;d<k.length;d++){var e=k[d];-1<c.indexOf(e)?f.push(e):g.push(e)}f.length&&(k=r({},a),k.method=f,k=new siesta.ext.http.RequestDescriptor(k),siesta.ext.http.DescriptorRegistry.registerRequestDescriptor(k),b.push(k));g.length&&(a=r({},a),a.method=g,a=new siesta.ext.http.ResponseDescriptor(a),siesta.ext.http.DescriptorRegistry.registerResponseDescriptor(a),b.push(a))}else throw Error("HTTP module not installed.");
return b},_dump:function(a){var c={};c.installed=this.installed;c.docId=this._docId;c.name=this.name;c.baseURL=this.baseURL;return a?m.prettyPrint(c):c},count:function(a){var c=m.defer(a);a=g.map(this._models,function(a){return g.bind(a.count,a)});m.async.parallel(a,function(a,b){var k;a||(k=g.reduce(b,function(a,c){return a+c},0));c.finish(a,k)});return c.promise}});t.exports=d},{"../vendor/observe-js/src/observe":44,"./cache":8,"./collectionRegistry":10,"./error":11,"./events":12,"./index":13,"./log":14,
"./model":17,"./util":28,extend:42}],10:[function(e,t,q){function d(){if(!this)return new d;this.collectionNames=[]}var n=e("./util")._;n.extend(d.prototype,{register:function(d){var e=d.name;this[e]=d;this.collectionNames.push(e)},reset:function(){var d=this;n.each(this.collectionNames,function(e){delete d[e]});this.collectionNames=[]}});q.CollectionRegistry=new d},{"./util":28}],11:[function(e,t,q){function d(d,e,f){this.message=d;this.context=e;(f=f||arguments.callee)&&Error.captureStackTrace&&
Error.captureStackTrace(this,f)}function n(d,e,f){f=f||{};this.component=d;this.message=e;for(var m in f)f.hasOwnProperty(m)&&(this[m]=f[m]);this.isUserError=!0}d.prototype=Object.create(Error.prototype);d.prototype.name="InternalSiestaError";d.prototype.constructor=d;e={Unknown:0,NoDescriptorMatched:1};var p={Mapping:"Mapping",HTTP:"HTTP",ReactiveQuery:"ReactiveQuery",ArrangedReactiveQuery:"ArrangedReactiveQuery",Collection:"Collection",Query:"Query"};q={};q[e.NoDescriptorMatched]="No descriptor matched the HTTP response/request.";
t.exports={InternalSiestaError:d,SiestaUserError:n,ErrorCode:e,ErrorField:{Message:"message",Code:"code"},Message:q,Components:p,errorFactory:function(d){if(d in p)return function(e,f){return new n(d,e,f)};throw new n('No such component "'+d+'"');}}},{}],12:[function(e,t,q){function d(f){p.extend(this,{event:f,listeners:{}})}q=e("events").EventEmitter;var n=e("../vendor/observe-js/src/observe").ArrayObserver,p=e("./util")._,l=e("./modelEvents"),r=new q;r.setMaxListeners(100);p.extend(d.prototype,
{listen:function(f,d){if("function"==typeof f)d=f,f=null;else{var g=d;d=function(a){a=a||{};f?a.type==f&&g(a):g(a)};var b=this.listeners;f&&(b[f]||(b[f]=[]),b[f].push(d))}r.on(this.event,d);return function(){this._removeListener(d,f)}.bind(this)},listenOnce:function(f,d){var g=this.event;if("function"==typeof f)d=f,f=null;else{var b=d;d=function(a){a=a||{};f?a.type==f&&(r.removeListener(g,d),b(a)):b(a)}}return f?r.on(g,d):r.once(g,d)},_removeListener:function(d,e){if(e){var g=this.listeners[e],b=
g.indexOf(d);g.splice(b,1)}return r.removeListener(this.event,d)},emit:function(d,e){"object"==typeof d?e=d:(e=e||{},e.type=d);r.emit.call(r,this.event,e)},_removeAllListeners:function(d){(this.listeners[d]||[]).forEach(function(d){r.removeListener(this.event,d)}.bind(this));this.listeners[d]=[]},removeAllListeners:function(d){if(d)this._removeAllListeners(d);else for(d in this.listeners)this.listeners.hasOwnProperty(d)&&this._removeAllListeners(d)}});p.extend(d.prototype,{on:d.prototype.listen});
p.extend(r,{ProxyEventEmitter:d,wrapArray:function(d,e,g){d.observer||(d.observer=new n(d),d.observer.open(function(b){-1<g._attributeNames.indexOf(e)&&b.forEach(function(a){l.emit({collection:g.collectionName,model:g.model.name,_id:g._id,index:a.index,removed:a.removed,added:a.addedCount?d.slice(a.index,a.index+a.addedCount):[],type:l.ModelEventType.Splice,field:e,obj:g})})}))}});t.exports=r},{"../vendor/observe-js/src/observe":44,"./modelEvents":18,"./util":28,events:38}],13:[function(e,t,q){var d=
e("./util"),n=e("./collectionRegistry").CollectionRegistry,p=e("./collection"),l=e("./cache");q=e("./model");var r=e("./error"),f=e("./events"),m=e("./RelationshipType"),g=e("./reactiveQuery"),b=e("./manyToManyProxy"),a=e("./oneToOneProxy"),c=e("./oneToManyProxy"),k=e("./relationshipProxy"),h=e("./modelEvents"),v=e("./Query"),y=e("./querySet"),C=e("./log"),A=d._,x=function(a){x.ext||(x.ext={});A.extend(x.ext,a||{});return x};Object.defineProperty(x,"q",{get:function(){return this._q||window.q||window.Q},
set:function(a){this._q=a}});A.extend(x,{on:f.on.bind(f),off:f.removeListener.bind(f),once:f.once.bind(f),removeAllListeners:f.removeAllListeners.bind(f)});A.extend(x,{removeListener:x.off,addListener:x.on});A.extend(x,{RelationshipType:m,ModelEventType:h.ModelEventType,log:C.Level,InsertionPolicy:g.InsertionPolicy,_internal:{log:C,Model:q,error:r,ModelEventType:h.ModelEventType,ModelInstance:e("./modelInstance"),extend:e("extend"),MappingOperation:e("./mappingOperation"),events:f,ProxyEventEmitter:f.ProxyEventEmitter,
cache:e("./cache"),modelEvents:h,CollectionRegistry:e("./collectionRegistry").CollectionRegistry,Collection:p,utils:d,util:d,_:d._,querySet:y,observe:e("../vendor/observe-js/src/observe"),Query:v,Store:e("./store"),ManyToManyProxy:b,OneToManyProxy:c,OneToOneProxy:a,RelationshipProxy:k},_:d._,async:d.async,isArray:d.isArray,isString:d.isString});x.ext={};var w=!1,B=!1;A.extend(x,{reset:function(a){B=w=!1;delete this.queuedTasks;l.reset();n.reset();f.removeAllListeners();x.ext.httpEnabled&&x.ext.http.DescriptorRegistry.reset();
x.ext.storageEnabled?x.ext.storage._reset(a):a()},resetData:function(a){var c=d.defer(a);a=c.finish.bind(c);x.ext.storage._reset(function(){var c=[],b=n.collectionNames.reduce(function(a,b){var k=n[b]._models;c.push(b);Object.keys(k).forEach(function(c){var b=k[c];a.push(function(a){b.all(function(c,b){c||b.remove();a(c)})})});return a},[]);d.async.series([A.partial(d.async.parallel,b)],a)});return c.promise},collection:function(a,c){return new p(a,c)},install:function(a){if(B||w)throw new r.InternalSiestaError("Already installing...");
B=!0;var c=d.defer(a);a=c.finish.bind(c);var b=A.map(n.collectionNames,function(a){return function(c){n[a].install(c)}}),k=this;x.async.series(b,function(c){if(c)a(c);else{if(x.ext.httpEnabled){c=function(a){Object.keys(a).forEach(function(c){a[c].forEach(function(a){a=a._resolveCollectionAndModel();console.log("error",a);a&&b.push(a)})})};var b=[],h=x.ext.http.DescriptorRegistry,d=h.responseDescriptors;c(h.requestDescriptors);c(d);console.log("errors",b);if(b.length){a(b);return}}x.ext.storageEnabled?
x.ext.storage._load(function(c){c||(w=!0,k.queuedTasks&&k.queuedTasks.execute());a(c)}):(w=!0,k.queuedTasks&&k.queuedTasks.execute(),a())}});return c.promise},_pushTask:function(a){this.queuedTasks||(this.queuedTasks=new function(){this.tasks=[];this.execute=function(){this.tasks.forEach(function(a){a()});this.tasks=[]}.bind(this)});this.queuedTasks.tasks.push(a)},_afterInstall:function(a){w?a():(B||this.install(function(a){a&&console.error("Error setting up siesta",a);delete this.queuedTasks}.bind(this)),
w?a():this._pushTask(a))},setLogLevel:function(a,c){C.loggerWithName(a).setLevel(c)},notify:d.next,registerComparator:v.bind(v)});Object.defineProperties(x,{_canChange:{get:function(){return!(B||w)}}});"undefined"!=typeof window&&(window.siesta=x);t.exports=x;var D=Function.prototype.apply.bind(Function.prototype.bind);Object.defineProperty(Function.prototype,"bind",{value:function(a){var c=D(this,arguments);Object.defineProperty(c,"__siesta_bound_object",{value:a,writable:!0,configurable:!0,enumerable:!1});
return c}});e("../http");e("../storage")},{"../http":33,"../storage":43,"../vendor/observe-js/src/observe":44,"./Query":5,"./RelationshipType":7,"./cache":8,"./collection":9,"./collectionRegistry":10,"./error":11,"./events":12,"./log":14,"./manyToManyProxy":15,"./mappingOperation":16,"./model":17,"./modelEvents":18,"./modelInstance":19,"./oneToManyProxy":20,"./oneToOneProxy":21,"./querySet":23,"./reactiveQuery":24,"./relationshipProxy":25,"./store":26,"./util":28,extend:42}],14:[function(e,t,q){function d(e){if(!this)return new d(e);
this.name=e;l[e]=d.Level.warn;this.trace=n(this,p.bind(console.debug?console.debug:console.log,console),d.Level.trace);this.debug=n(this,p.bind(console.debug?console.debug:console.log,console),d.Level.debug);this.info=n(this,p.bind(console.info?console.info:console.log,console),d.Level.info);this.log=n(this,p.bind(console.log,console),d.Level.info);this.warn=n(this,p.bind(console.warn?console.warn:console.log,console),d.Level.warning);this.error=n(this,p.bind(console.error?console.error:console.log,
console),d.Level.error);this.fatal=n(this,p.bind(console.error?console.error:console.log,console),d.Level.fatal)}function n(d,f,e){var g=function(b){d.performLog(f,e,b,arguments)};Object.defineProperty(g,"isEnabled",{get:function(){var b=d.currentLevel();return e>=b},enumerable:!0,configurable:!0});g.f=f;g.logger=d;g.level=e;return g}var p=e("./util")._,l={};d.Level={trace:0,debug:1,info:2,warning:3,warn:3,error:4,fatal:5};d.LevelText={};d.LevelText[d.Level.trace]="TRACE";d.LevelText[d.Level.debug]=
"DEBUG";d.LevelText[d.Level.info]="INFO ";d.LevelText[d.Level.warning]="WARN ";d.LevelText[d.Level.error]="ERROR";d.levelAsText=function(d){return this.LevelText[d]};d.loggerWithName=function(e){return new d(e)};d.prototype.currentLevel=function(){var e=l[this.name];return e?e:d.Level.trace};d.prototype.setLevel=function(d){l[this.name]=d};d.prototype.override=function(e,f,l){var g=this[d.levelAsText(e).trim().toLowerCase()].f,b=Array.prototype.slice.call(arguments,3,arguments.length);this.performLog(g,
e,l,b,f)};d.prototype.performLog=function(e,f,l,g,b){if((void 0!==b?b:this.currentLevel())<=f){e=p.partial(e,d.levelAsText(f)+" ["+this.name+"]: "+l);f=[];for(l=0;l<g.length;l++)f[l]=g[l];f.splice(0,1);e.apply(e,f)}};t.exports=d},{"./util":28}],15:[function(e,t,q){function d(b){n.call(this,b);this.related=[];this.relatedCancelListeners={}}var n=e("./RelationshipProxy");e("./store");var p=e("./util"),l=p._;e("./error");var r=e("./modelEvents"),f=e("./events").wrapArray;e("./modelInstance");var m=e("../vendor/observe-js/src/observe").ArrayObserver,
g=e("./modelEvents").ModelEventType;d.prototype=Object.create(n.prototype);l.extend(d.prototype,{clearReverse:function(b){var a=this;l.each(b,function(c){var b=a.reverseProxyForInstance(c),h=b.related.indexOf(a.object);b.makeChangesToRelatedWithoutObservations(function(){b.splice(h,1)})})},setReverseOfAdded:function(b){var a=this;l.each(b,function(c){var b=a.reverseProxyForInstance(c);b.makeChangesToRelatedWithoutObservations(function(){b.splice(0,0,a.object)})})},wrapArray:function(b){var a=this;
f(b,this.reverseName,this.object);b.arrayObserver||(b.arrayObserver=new m(b),b.arrayObserver.open(function(c){c.forEach(function(c){var h=c.addedCount?b.slice(c.index,c.index+c.addedCount):[],d=c.removed;a.clearReverse(d);a.setReverseOfAdded(h);var e=a.getForwardModel();r.emit({collection:e.collectionName,model:e.name,_id:a.object._id,field:a.getForwardName(),removed:d,added:h,type:g.Splice,index:c.index,obj:a.object})})}))},get:function(b){var a=p.defer(b);b=a.finish.bind(a);b(null,this.related);
return a.promise},validate:function(b){return"[object Array]"!=Object.prototype.toString.call(b)?"Cannot assign scalar to many to many":null},set:function(b,a){this.checkInstalled();if(b){var c;if(c=this.validate(b))return c;this.clearReverseRelated(a);this.setIdAndRelated(b,a);this.wrapArray(b);this.setIdAndRelatedReverse(b,a)}else this.clearReverseRelated(a),this.setIdAndRelated(b,a)},install:function(b){n.prototype.install.call(this,b);this.wrapArray(this.related);b["splice"+p.capitaliseFirstLetter(this.reverseName)]=
l.bind(this.splice,this)},registerRemovalListener:function(b){this.relatedCancelListeners[b._id]=b.listen(function(a){}.bind(this))}});t.exports=d},{"../vendor/observe-js/src/observe":44,"./RelationshipProxy":6,"./error":11,"./events":12,"./modelEvents":18,"./modelInstance":19,"./store":26,"./util":28}],16:[function(e,t,q){function d(b){this._opts=b;r.extendFromOpts(this,b,{model:null,data:null,objects:[],disableevents:!1,_ignoreInstalled:!1,fromStorage:!1});f.extend(this,{errors:[],subTaskResults:{},
_newObjects:[]})}var n=e("./store"),p=e("./modelInstance");q=e("./log");e("./error");var l=e("./cache"),r=e("./util"),f=r._,m=r.async;e("./modelEvents");var g=q.loggerWithName("Mapping");g.setLevel(q.Level.trace);f.extend(d.prototype,{mapAttributes:function(){for(var b=0;b<this.data.length;b++){var a=this.data[b],c=this.objects[b];a!=c&&c&&(f.each(this.model._attributeNames,function(b){void 0!==a[b]&&(this.disableevents?c.__values[b]=a[b]:c[b]=a[b])}.bind(this)),a._rev&&(c._rev=a._rev))}},_map:function(){var b=
this,a;this.mapAttributes();var c=f.keys(b.subTaskResults);f.each(c,function(c){for(var h=b.subTaskResults[c],d=h.indexes,h=h.objects,g=b.getRelatedData(c).relatedData,h=r.unflattenArray(h,g),g=0;g<h.length;g++){var e=d[g],f=b.errors[e];a=f?f[c]:null;if(!a){var f=h[g],l=b.objects[e];l&&(a=l.__proxies[c].set(f,{disableevents:b.disableevents}))&&(b.errors[e]||(b.errors[e]={}),b.errors[e][c]=a)}}})},_lookup:function(b){var a=r.defer(b);b=a.finish.bind(a);for(var c=this,k=[],h=[],d=0;d<this.data.length;d++)if(!this.objects[d]){var e,
m=this.data[d];e="string"==typeof m||"number"==typeof m||m instanceof String;m?e?(e={index:d,datum:{}},e.datum[c.model.id]=m,k.push(e)):m instanceof p?this.objects[d]=m:m._id?h.push({index:d,datum:m}):m[c.model.id]?k.push({index:d,datum:m}):this.objects[d]=c._new():this.objects[d]=null}r.async.parallel([function(a){var b=f.pluck(f.pluck(h,"datum"),"_id");b.length?n.getMultipleLocal(b,function(k,d){if(!k)for(var g=0;g<b.length;g++){var e=d[g],f=b[g],v=h[g];e||(e=l.get({_id:f}))||(e=c._new({_id:f},
!c.disableevents));c.objects[v.index]=e}a(k)}):a()},function(a){var b=f.pluck(f.pluck(k,"datum"),c.model.id);b.length?(g.trace.isEnabled&&g.trace("Looking up remoteIdentifiers: "+r.prettyPrint(b)),n.getMultipleRemote(b,c.model,function(h,e){if(!h){if(g.trace.isEnabled){var f={};for(d=0;d<e.length;d++)f[b[d]]=e[d]?e[d]._id:null;g.trace("Results for remoteIdentifiers: "+r.prettyPrint(f))}for(d=0;d<e.length;d++){var y=e[d],f=k[d];if(y)c.objects[f.index]=y;else{var y=b[d],m={model:c.model};m[c.model.id]=
y;(m=l.get(m))?c.objects[f.index]=m:(c.objects[f.index]=c._new(),c.objects[f.index][c.model.id]=y)}}}a(h)})):a()}],b);return a.promise},_lookupSingleton:function(b){var a=r.defer(b);b=a.finish.bind(a);for(var c=f.pluck(this.data,"_id"),k,h=0;h<c.length;h++)if(c[h]){k={_id:c[h]};break}for(var c=l.getSingleton(this.model)||this._new(k),h=0;h<this.data.length;h++)this.objects[h]=c;b();return a.promise},_new:function(){var b=this.model,b=b._new.apply(b,arguments);this._newObjects.push(b);return b},start:function(b){if(this.data.length){var a=
this,c=[];c.push(f.bind(this.model.singleton?this._lookupSingleton:this._lookup,this));c.push(f.bind(this._executeSubOperations,this));r.async.parallel(c,function(){try{a._map();var c=this.fromStorage,h=f.reduce(a._newObjects,function(a,h){var d=h.model.init;d&&(1<r.paramNames(d).length?a.push(f.bind(d,h,c,b)):d.call(h,c));return a},[]);m.parallel(h,function(){b(a.errors.length?a.errors:null,a.objects)})}catch(d){console.error("caught error",d),b(d)}}.bind(this))}else b(null,[])},getRelatedData:function(b){for(var a=
[],c=[],k=0;k<this.data.length;k++){var h=this.data[k];h&&h[b]&&(a.push(k),c.push(h[b]))}return{indexes:a,relatedData:c}},processErrorsFromTask:function(b,a,c){if(a.length){var k=this.getRelatedData(b).relatedData;a=r.unflattenArray(a,k);for(k=0;k<a.length;k++){var h=c[k],d=a[k],g=d;r.isArray(d)&&(g=f.reduce(d,function(a,c){return a||c},!1));g&&(this.errors[h]||(this.errors[h]={}),this.errors[h][b]=d)}}},_executeSubOperations:function(b){var a=this,c=f.keys(this.model.relationships);c.length?(c=f.reduce(c,
function(c,b){var g=a.model.relationships[b],e=g.forwardName==b?g.reverseModel:g.forwardModel;e.singleton&&!g.isReverse&&this.data.forEach(function(a){a[b]||(a[b]={})});var g=this.getRelatedData(b),f=g.indexes,g=g.relatedData;if(g.length)var g=r.flattenArray(g),l=new d({model:e,data:g,disableevents:a.disableevents,_ignoreInstalled:a._ignoreInstalled,fromStorage:this.fromStorage});l&&c.push(function(c){l.start(function(k,d){a.subTaskResults[b]={errors:k,objects:d,indexes:f};a.processErrorsFromTask(b,
l.errors,f);c()})});return c}.bind(this),[]),m.parallel(c,function(a){b(a)})):b()}});t.exports=d},{"./cache":8,"./error":11,"./log":14,"./modelEvents":18,"./modelInstance":19,"./store":26,"./util":28}],17:[function(e,t,q){function d(a){var c=this;this._opts=a?w.extend({},a):{};g.extendFromOpts(this,a,{methods:{},attributes:[],collection:function(a){g.isString(a)&&(a=n[a]);return a},id:"id",relationships:[],name:null,indexes:[],singleton:!1,statics:this.installStatics.bind(this),properties:{},init:null,
remove:null});this.attributes=d._processAttributes(this.attributes);w.extend(this,{_installed:!1,_relationshipsInstalled:!1,_reverseRelationshipsInstalled:!1,children:[]});Object.defineProperties(this,{_relationshipNames:{get:function(){return Object.keys(c.relationships)},enumerable:!0},_attributeNames:{get:function(){var a=[];c.id&&a.push(c.id);w.each(c.attributes,function(c){a.push(c.name)});return a},enumerable:!0,configurable:!0},installed:{get:function(){return c._installed&&c._relationshipsInstalled&&
c._reverseRelationshipsInstalled},enumerable:!0,configurable:!0},descendants:{get:function(){return w.reduce(c.children,function(a,c){return Array.prototype.concat.call(a,c.descendants)}.bind(c),w.extend([],c.children))},enumerable:!0},dirty:{get:function(){if(siesta.ext.storageEnabled)return!!Object.keys((siesta.ext.storage._unsavedObjectsByCollection[this.collectionName]||{})[this.name]||{}).length},enumerable:!0},collectionName:{get:function(){return this.collection.name},enumerable:!0}});k.ProxyEventEmitter.call(this,
this.collectionName+":"+this.name)}q=e("./log");var n=e("./collectionRegistry").CollectionRegistry,p=e("./error").InternalSiestaError,l=e("./RelationshipType"),r=e("./query"),f=e("./mappingOperation"),m=e("./modelInstance"),g=e("./util"),b=e("./cache");e("./store");var a=e("extend"),c=e("./modelEvents"),k=e("./events"),h=e("./events").wrapArray;e("./RelationshipProxy");var v=e("./OneToManyProxy"),y=e("./OneToOneProxy"),C=e("./manyToManyProxy"),A=e("./reactiveQuery"),x=e("./ArrangedReactiveQuery"),
w=g._,B=g.guid,D=c.ModelEventType,z=q.loggerWithName("Model");w.extend(d,{_processAttributes:function(a){return w.reduce(a,function(a,c){"string"==typeof c?a.push({name:c}):a.push(c);return a},[])}});d.prototype=Object.create(k.ProxyEventEmitter.prototype);w.extend(d.prototype,{installStatics:function(a){a&&w.each(Object.keys(a),function(c){this[c]?z.error('Static method with name "'+c+'" already exists. Ignoring it.'):this[c]=a[c].bind(this)}.bind(this));return a},installRelationships:function(){if(this._relationshipsInstalled)throw new p('Relationships for "'+
this.name+'" have already been installed');this._relationships=[];if(this._opts.relationships)for(var a in this._opts.relationships)if(this._opts.relationships.hasOwnProperty(a)){var c=this._opts.relationships[a];if(!c.isReverse){z.debug.isEnabled&&z.debug(this.name+": configuring relationship "+a,c);c.type||(c.type=this.singleton?l.OneToOne:l.OneToMany);if(this.singleton&&c.type==l.ManyToMany)return"Singleton model cannot use ManyToMany relationship.";if(c.type==l.OneToMany||c.type==l.OneToOne||
c.type==l.ManyToMany){var b=c.model;delete c.model;var h;if(b instanceof d)h=b;else{z.debug.isEnabled&&z.debug("reverseModelName",b);if(!this.collection)throw new p("Model must have collection");var k=this.collection;if(!k)throw new p("Collection "+this.collectionName+" not registered");h=k[b]}if(!h&&(k=b.split("."),2==k.length)){h=k[0];b=k[1];k=n[h];if(!k)return'Collection with name "'+h+'" does not exist.';h=k[b]}z.debug.isEnabled&&z.debug("reverseModel",h);if(h)c.reverseModel=h,c.forwardModel=
this,c.forwardName=a,c.reverseName=c.reverse||"reverse_"+a,delete c.reverse,c.isReverse=!1;else return'Model with name "'+b.toString()+'" does not exist'}else return"Relationship type "+c.type+" does not exist"}}this._relationshipsInstalled=!0;return null},installReverseRelationships:function(){if(this._reverseRelationshipsInstalled)throw new p('Reverse relationships for "'+this.name+'" have already been installed.');for(var c in this.relationships)if(this.relationships.hasOwnProperty(c)){var b=this.relationships[c],
b=a(!0,{},b);b.isReverse=!0;var h=b.reverseModel,k=b.reverseName;if(h.singleton){if(b.type==l.ManyToMany)return"Singleton model cannot be related via reverse ManyToMany";if(b.type==l.OneToMany)return"Singleton model cannot be related via reverse OneToMany"}z.debug.isEnabled&&z.debug(this.name+": configuring  reverse relationship "+k);h.relationships[k]=b}this._reverseRelationshipsInstalled=!0},_query:function(a){return a=new r(this,a||{})},query:function(a,c){if(this.singleton){var b=g.defer(c);c=
b.finish.bind(b);this._query({__ignoreInstalled:!0}).execute(function(b,h){b?c(b):(a=w.extend({},a),a.__ignoreInstalled=!0,h.length?this._query(a).execute(c):this.graph({},function(b){b?c(b):this._query(a).execute(c)}.bind(this)))}.bind(this));return b.promise}return this._query(a).execute(c)},reactiveQuery:function(a){return new A(new r(this,a||{}))},arrangedReactiveQuery:function(a){return new x(new r(this,a||{}))},one:function(a,c){"function"==typeof a&&(c=a,a={});var b=g.defer(c);c=b.finish.bind(b);
this.query(a,function(a,b){a?c(a):1<b.length?c("More than one instance returned when executing get query!"):(b=b.length?b[0]:null,c(null,b))});return b.promise},all:function(a,c){"function"==typeof a&&(c=a,a={});a=a||{};return this.query(a,c)},install:function(a){z.info.isEnabled&&z.info("Installing mapping "+this.name);var c=g.defer(a);a=c.finish.bind(c);if(this._installed)throw new p('Model "'+this.name+'" has already been installed');this._installed=!0;a();return c.promise},graph:function(a,c,
b){"function"==typeof c&&(b=c);c=c||{};var h=g.defer(b);b=function(){var b=c.override;b&&(g.isArray(b)?c.objects=b:c.objects=[b]);delete c.override;g.isArray(a)?this._mapBulk(a,c,h.finish.bind(h)):this._mapBulk([a],c,function(a,c){var b;c&&c.length&&(b=c[0]);h.finish(a?g.isArray(a)?a[0]:a:null,b)})}.bind(this);c._ignoreInstalled?b():siesta._afterInstall(b);return h.promise},_mapBulk:function(a,c,b){w.extend(c,{model:this,data:a});(new f(c)).start(function(a,c){a?b&&b(a):b(null,c||[])})},_countCache:function(){return w.reduce(Object.keys((b._localCacheByType[this.collectionName]||
{})[this.name]||{}),function(a,c){a[c]={};return a},{})},count:function(a){var c=g.defer(a);a=c.finish.bind(c);var b=this._countCache();a(null,Object.keys(b).length);return c.promise},_new:function(a,k){k=void 0===k?!0:k;if(this.installed){var d=this,e;e=a?a._id?a._id:B():B();var f=new m(this);z.info.isEnabled&&z.info('New object created _id="'+e.toString()+'", type='+this.name,a);f._id=e;e={};f.__values=e;var r=w.reduce(this.attributes,function(a,c){void 0!==c["default"]&&(a[c.name]=c["default"]);
return a},{});w.extend(e,r);a&&w.extend(e,a);e=this._attributeNames;r=e.indexOf(this.id);-1<r&&e.splice(r,1);w.each(e,function(a){Object.defineProperty(f,a,{get:function(){var c=f.__values[a];return void 0===c?null:c},set:function(b){var k=f.__values[a],e=this._propertyDependencies[a],e=w.map(e,function(a){return{prop:a,old:this[a]}}.bind(this));f.__values[a]=b;e.forEach(function(a){var b=a.prop;c.emit({collection:d.collectionName,model:d.name,_id:f._id,"new":this[b],old:a.old,type:D.Set,field:b,
obj:f})}.bind(this));k={collection:d.collectionName,model:d.name,_id:f._id,"new":b,old:k,type:D.Set,field:a,obj:f};window.lastEmission=k;c.emit(k);g.isArray(b)&&h(b,a,f)},enumerable:!0,configurable:!0})});w.each(Object.keys(this.methods),function(a){void 0===f[a]?f[a]=this.methods[a].bind(f):z.error('A method with name "'+a+'" already exists. Ignoring it.')}.bind(this));e=Object.keys(this.properties);var n={};w.each(e,function(a){var c=this.properties[a];(c.dependencies||[]).forEach(function(c){n[c]||
(n[c]=[]);n[c].push(a)});delete c.dependencies;void 0===f[a]?Object.defineProperty(f,a,c):z.error('A property/method with name "'+a+'" already exists. Ignoring it.')}.bind(this));f._propertyDependencies=n;Object.defineProperty(f,this.id,{get:function(){return f.__values[d.id]||null},set:function(a){var h=f[d.id];f.__values[d.id]=a;c.emit({collection:d.collectionName,model:d.name,_id:f._id,"new":a,old:h,type:D.Set,field:d.id,obj:f});b.remoteInsert(f,a,h)},enumerable:!0,configurable:!0});for(var x in this.relationships){var q;
if(this.relationships.hasOwnProperty(x))if(q=w.extend({},this.relationships[x]),e=q.type,delete q.type,e==l.OneToMany)q=new v(q);else if(e==l.OneToOne)q=new y(q);else if(e==l.ManyToMany)q=new C(q);else throw new p("No such relationship type: "+e);q.install(f)}b.insert(f);k&&c.emit({collection:this.collectionName,model:this.name,_id:f._id,"new":f,type:D.New,obj:f});return f}throw new p("Model must be fully installed before creating any models");},_dump:function(a){var c={};c.name=this.name;c.attributes=
this.attributes;c.id=this.id;c.collection=this.collectionName;c.relationships=w.map(this.relationships,function(a){return a.isForward?a.forwardName:a.reverseName});return a?g.prettyPrint(c):c},toString:function(){return"Model["+this.name+"]"}});w.extend(d.prototype,{child:function(a,c){"string"==typeof a?c.name=a:c=name;w.extend(c,{attributes:Array.prototype.concat.call(c.attributes||[],this._opts.attributes),relationships:w.extend(c.relationships||{},this._opts.relationships),methods:w.extend(w.extend({},
this._opts.methods)||{},c.methods),statics:w.extend(w.extend({},this._opts.statics)||{},c.statics),properties:w.extend(w.extend({},this._opts.properties)||{},c.properties),id:c.id||this._opts.id,init:c.init||this._opts.init,remove:c.remove||this._opts.remove});var b=this.collection.model(c.name,c);b.parent=this;this.children.push(b);return b},isChildOf:function(a){return this.parent==a},isParentOf:function(a){return-1<this.children.indexOf(a)},isDescendantOf:function(a){for(var c=this.parent;c;){if(c==
a)return!0;c=c.parent}return!1},isAncestorOf:function(a){return-1<this.descendants.indexOf(a)},hasAttributeNamed:function(a){return-1<this._attributeNames.indexOf(a)}});w.extend(d.prototype,{paginator:function(a){if(siesta.ext.httpEnabled){var c=siesta.ext.http.Paginator;a=a||{};a.model=this;return new c(a)}}});t.exports=d},{"./ArrangedReactiveQuery":1,"./OneToManyProxy":3,"./OneToOneProxy":4,"./RelationshipProxy":6,"./RelationshipType":7,"./cache":8,"./collectionRegistry":10,"./error":11,"./events":12,
"./log":14,"./manyToManyProxy":15,"./mappingOperation":16,"./modelEvents":18,"./modelInstance":19,"./query":22,"./reactiveQuery":24,"./store":26,"./util":28,extend:42}],18:[function(e,t,q){function d(d){this._opts=d||{};Object.keys(d).forEach(function(b){this[b]=d[b]}.bind(this))}function n(d){if(!d.model)throw new l("Must pass a model");if(!d.collection)throw new l("Must pass a collection");if(!d._id)throw new l("Must pass a local identifier");if(!d.obj)throw new l("Must pass the object");}var p=
e("./events"),l=e("./error").InternalSiestaError;t=e("./log");var r=e("./util")._.extend,f=e("./collectionRegistry").CollectionRegistry,m=t.loggerWithName("ModelEvents");d.prototype._dump=function(d){var b={};b.collection="string"==typeof this.collection?this.collection:this.collection._dump();b.model="string"==typeof this.model?this.model:this.model.name;b._id=this._id;b.field=this.field;b.type=this.type;this.index&&(b.index=this.index);this.added&&(b.added=_.map(this.added,function(a){return a._dump()}));
this.removed&&(b.removed=_.map(this.removed,function(a){return a._dump()}));this.old&&(b.old=this.old);this["new"]&&(b["new"]=this["new"]);return d?util.prettyPrint(b):b};r(q,{ModelEvent:d,emit:function(e){n(e);var b=e.collection,a=e.model;e=new d(e);m.trace.isEnabled&&m.trace('Sending notification "'+b+'" of type '+e.type);p.emit(b,e);var c=b+":"+a;m.trace.isEnabled&&m.trace('Sending notification "'+c+'" of type '+e.type);p.emit(c,e);m.trace.isEnabled&&m.trace('Sending notification "Siesta" of type '+
e.type);p.emit("Siesta",e);c=e._id;m.trace.isEnabled&&m.trace('Sending notification "'+c+'" of type '+e.type);p.emit(c,e);c=f[b];if(!c)throw b='No such collection "'+b+'"',m.error(b,f),new l(b);c=c[a];if(!c)throw b='No such model "'+a+'"',m.error(b,f),new l(b);c.id&&e.obj[c.id]&&(b=b+":"+a+":"+e.obj[c.id],m.trace.isEnabled&&m.trace('Sending notification "'+b+'" of type '+e.type),p.emit(b,e));return e},validateEventOpts:n,ModelEventType:{Set:"Set",Splice:"Splice",New:"New",Remove:"Remove"}})},{"./collectionRegistry":10,
"./error":11,"./events":12,"./log":14,"./util":28}],19:[function(e,t,q){t.exports=e(2)},{"./cache":8,"./error":11,"./events":12,"./log":14,"./modelEvents":18,"./util":28,"/Users/mtford/Playground/rest/core/ModelInstance.js":2}],20:[function(e,t,q){t.exports=e(3)},{"../vendor/observe-js/src/observe":44,"./RelationshipProxy":6,"./error":11,"./events":12,"./modelEvents":18,"./modelInstance":19,"./store":26,"./util":28,"/Users/mtford/Playground/rest/core/OneToManyProxy.js":3}],21:[function(e,t,q){t.exports=
e(4)},{"./RelationshipProxy":6,"./error":11,"./modelEvents":18,"./modelInstance":19,"./store":26,"./util":28,"/Users/mtford/Playground/rest/core/OneToOneProxy.js":4}],22:[function(e,t,q){t.exports=e(5)},{"./cache":8,"./error":11,"./log":14,"./querySet":23,"./util":28,"/Users/mtford/Playground/rest/core/Query.js":5}],23:[function(e,t,q){function d(a){return"string"==typeof a||a instanceof String?C.concat(A):"number"==typeof a||a instanceof Number?v.concat(y):a.getOwnPropertyNames()}function n(c,h){h in
c||Object.defineProperty(c,h,{get:function(){return f(k.pluck(c,h))},set:function(c){if(b.isArray(c)){if(this.length!=c.length)throw new a({message:"Must be same length"});for(var k=0;k<c.length;k++)this[k][h]=c[k]}else for(k=0;k<this.length;k++)this[k][h]=c}})}function p(a){return a.then&&a["catch"]}function l(a,c){c in a||(a[c]=function(){var a=arguments,b=this.map(function(b){return b[c].apply(b,a)}),h=!1;b.length&&(h=p(b[0]));return h?siesta.q.all(b):f(b)})}function r(a,b){a=k.extend([],a);b._attributeNames.concat(b._relationshipNames).concat(h).forEach(k.partial(n,
a));var h=Object.keys(c.prototype);h.forEach(k.partial(l,a));return g(a)}function f(a){if(a.length){var c=a[0];d(c).forEach(function(b){"function"==typeof c[b]?l(a,b,arguments):n(a,b)})}return g(a)}function m(){throw Error("Cannot modify a query set");}function g(a){h.forEach(function(c){a[c]=m});a.immutable=!0;a.mutableCopy=a.asArray=function(){var a=k.map(this,function(a){return a});a.asQuerySet=function(){return f(this)};a.asModelQuerySet=function(a){return r(this,a)};return a};return a}var b=
e("./util"),a=e("./error").SiestaUserError,c=e("./ModelInstance"),k=e("./util")._,h="push sort reverse splice shift unshift".split(" "),v=["toString","toExponential","toFixed","toPrecision","valueOf"],y=["MAX_VALUE","MIN_VALUE","NEGATIVE_INFINITY","NaN","POSITIVE_INFINITY"],C="charAt charCodeAt concat fromCharCode indexOf lastIndexOf localeCompare match replace search slice split substr substring toLocaleLowerCase toLocaleUpperCase toLowerCase toString toUpperCase trim valueOf".split(" "),A=["length"];
t.exports=r},{"./ModelInstance":2,"./error":11,"./util":28}],24:[function(e,t,q){function d(a){var c=this;n.call(this);g.extend(this,{_query:a,results:f([],a.model),insertionPolicy:d.InsertionPolicy.Back,initialised:!1});Object.defineProperties(this,{initialized:{get:function(){return this.initialised}},model:{get:function(){return c._query.model}},collection:{get:function(){return c.model.collectionName}}})}q=e("./log");e("./query");var n=e("events").EventEmitter,p=e("./events"),l=e("./modelEvents"),
r=e("./error").InternalSiestaError,f=e("./querySet"),m=e("./util"),g=m._,b=q.loggerWithName("Query");d.prototype=Object.create(n.prototype);g.extend(d,{InsertionPolicy:{Front:"Front",Back:"Back"}});g.extend(d.prototype,{init:function(a){b.trace&&b.trace("init");var c=m.defer(a);a=c.finish.bind(c);this.initialised?a(null,this.results):this._query.execute(function(c,h){if(c)a(c);else{this.results=h;if(!this.handler){var d=this._constructNotificationName(),e=function(a){this._handleNotif(a)}.bind(this);
this.handler=e;p.on(d,e)}b.trace&&b.trace("Listening to "+d);this.initialised=!0;a(null,this.results)}}.bind(this));return c.promise},insert:function(a){var c=this.results.mutableCopy();a=this.insertionPolicy==d.InsertionPolicy.Back?c.push(a):c.unshift(a);this.results=c.asModelQuerySet(this.model);return a},_handleNotif:function(a){b.trace&&b.trace("_handleNotif",a);if(a.type==l.ModelEventType.New){var c=a["new"];if(this._query.objectMatchesQuery(c)){b.trace&&b.trace("New object matches",c._dumpString());
var k=this.insert(c);this.emit("change",{index:k,added:[c],type:l.ModelEventType.Splice,obj:this})}else b.trace&&b.trace("New object does not match",c._dumpString())}else if(a.type==l.ModelEventType.Set){var c=a.obj,k=this.results.indexOf(c),h=-1<k,d=this._query.objectMatchesQuery(c);d&&!h?(b.trace&&b.trace("Updated object now matches!",c._dumpString()),k=this.insert(c),this.emit("change",{index:k,added:[c],type:l.ModelEventType.Splice,obj:this})):!d&&h?(b.trace&&b.trace("Updated object no longer matches!",
c._dumpString()),h=this.results.mutableCopy(),a=h.splice(k,1),this.results=h.asModelQuerySet(this.model),this.emit("change",{index:k,obj:this,"new":c,type:l.ModelEventType.Splice,removed:a})):d||h?d&&h&&(b.trace&&b.trace("Matches but already contains",c._dumpString()),this.emit("change",a)):b.trace&&b.trace("Does not contain, but doesnt match so not inserting",c._dumpString())}else if(a.type==l.ModelEventType.Remove)c=a.obj,h=this.results.mutableCopy(),k=h.indexOf(c),-1<k?(b.trace&&b.trace("Removing object",
c._dumpString()),a=h.splice(k,1),this.results=f(h,this.model),this.emit("change",{index:k,obj:this,type:l.ModelEventType.Splice,removed:a})):b.trace&&b.trace("No modelEvents neccessary.",c._dumpString());else throw new r('Unknown change type "'+a.type.toString()+'"');this.results=f(this._query._sortResults(this.results),this.model)},_constructNotificationName:function(){return this.model.collectionName+":"+this.model.name},terminate:function(){this.handler&&p.removeListener(this._constructNotificationName(),
this.handler);this.handler=this.results=null},listen:function(a){this.on("change",a);return function(){this.removeListener("change",a)}.bind(this)},listenOnce:function(a){this.once("change",a)}});t.exports=d},{"./error":11,"./events":12,"./log":14,"./modelEvents":18,"./query":22,"./querySet":23,"./util":28,events:38}],25:[function(e,t,q){t.exports=e(6)},{"../vendor/observe-js/src/observe":44,"./cache":8,"./error":11,"./events":12,"./log":14,"./modelEvents":18,"./query":22,"./store":26,"./util":28,
"/Users/mtford/Playground/rest/core/RelationshipProxy.js":6}],26:[function(e,t,q){function d(d,b){var a=l.defer(b);b=a.finish.bind(a);m.debug.isEnabled&&m.debug("get",d);var c;if(d._id)if(l.isArray(d._id))n(r.map(d._id,function(a){return{_id:a}}),b);else if(c=f.get(d))m.debug.isEnabled&&m.debug("Had cached object",{opts:d,obj:c}),b&&b(null,c);else if(l.isArray(d._id))n(r.map(d._id,function(a){return{_id:a}}),b);else{if(b)if(c=siesta.ext.storage)c.store.getFromPouch(d,b);else throw Error("Storage module not installed");
}else if(d.model)if(l.isArray(d[d.model.id]))n(r.map(d[d.model.id],function(a){var c={};c[d.model.id]=a;c.model=d.model;return c}),b);else if(c=f.get(d))m.debug.isEnabled&&m.debug("Had cached object",{opts:d,obj:c}),b&&b(null,c);else if(c=d.model,c.singleton)c.one(b);else{var k=c.id,h=d[k],e={};if(e[k]=h)c.one(e,function(a,c){a?b(a):c?b(null,c):b(null,null)});else throw new p('Invalid options given to store. Missing "'+k.toString()+'."');}else throw new p("Invalid options given to store",{opts:d});
return a.promise}function n(e,b){var a=l.defer(b);b=a.finish.bind(a);var c=[],k=[];r.each(e,function(a){d(a,function(a,h){a?k.push(a):c.push(h);c.length+k.length==e.length&&b&&(k.length?b(k):b(null,c))})});return a.promise}var p=e("./error").InternalSiestaError;q=e("./log");var l=e("./util"),r=l._,f=e("./cache"),m=q.loggerWithName("Store");t.exports={get:d,getMultiple:n,getMultipleLocal:function(d,b){var a=l.defer(b);b=a.finish.bind(a);var c=r.reduce(d,function(a,c){var b=f.get({_id:c});b?a.cached[c]=
b:a.notCached.push(c);return a},{cached:{},notCached:[]});(function(a){b&&(a?b(a):b(null,r.map(d,function(a){return c.cached[a]})))})();return a.promise},getMultipleRemote:function(d,b,a){var c=l.defer(a);a=c.finish.bind(c);var k=r.reduce(d,function(a,c){var d={model:b};d[b.id]=c;(d=f.get(d))?a.cached[c]=d:a.notCached.push(c);return a},{cached:{},notCached:[]});(function(c){a&&(c?a(c):a(null,r.map(d,function(a){return k.cached[a]})))})();return c.promise}}},{"./cache":8,"./error":11,"./log":14,"./util":28}],
27:[function(e,t,q){function d(a,c){if(a.map)return a.map(c);var b=[];r(a,function(a,d,h){b.push(c(a,d,h))});return b}function n(a,c,b,k){c=d(c,function(a,c){return{index:c,value:a}});if(k){var e=[];a(c,function(a,c){b(a.value,function(b,d){e[a.index]=d;c(b)})},function(a){k(a,e)})}else a(c,function(a,c){b(a.value,function(a){c(a)})})}function p(a,c,b){b=b||function(){};if(!a.length)return b();var d=0,k=function(){c(a[d],function(c){c?(b(c),b=function(){}):(d+=1,d>=a.length?b():k())})};k()}function l(a,
c){if(a.forEach)return a.forEach(c);for(var b=0;b<a.length;b+=1)c(a[b],b,a)}function r(a,c,b){function d(c){c?(b(c),b=function(){}):(k+=1,k>=a.length&&b())}b=b||function(){};if(!a.length)return b();var k=0;l(a,function(a){c(a,f(d))})}function f(c){var b=!1;return function(){if(b)throw Error("Callback was already called.");b=!0;c.apply(a,arguments)}}var m=e("./misc"),g=e("./underscore"),b=function(a){return function(){var c=Array.prototype.slice.call(arguments);return a.apply(null,[r].concat(c))}}(n),
a,c=function(a){return function(){var c=Array.prototype.slice.call(arguments);return a.apply(null,[p].concat(c))}}(n),k=function(a,c,b){b=b||function(){};if(m.isArray(c))a.map(c,function(a,c){a&&a(function(a){var b=Array.prototype.slice.call(arguments,1);1>=b.length&&(b=b[0]);c.call(null,a,b)})},b);else{var d={};a.each(Object.keys(c),function(a,b){c[a](function(c){var k=Array.prototype.slice.call(arguments,1);1>=k.length&&(k=k[0]);d[a]=k;b(c)})},function(a){b(a,d)})}};t.exports={series:function(a,
b){b=b||function(){};if(m.isArray(a))c(a,function(a,c){a&&a(function(a){var b=Array.prototype.slice.call(arguments,1);1>=b.length&&(b=b[0]);c.call(null,a,b)})},b);else{var d={};p(g.keys(a),function(c,b){a[c](function(a){var k=Array.prototype.slice.call(arguments,1);1>=k.length&&(k=k[0]);d[c]=k;b(a)})},function(a){b(a,d)})}},parallel:function(a,c){k({map:b,each:r},a,c)}}},{"./misc":29,"./underscore":30}],28:[function(e,t,q){q=e("./underscore");var d=e("./async");e=e("./misc");q.extend(t.exports,{_:q,
async:d});q.extend(t.exports,e)},{"./async":27,"./misc":29,"./underscore":30}],29:[function(e,t,q){var d=e("../../vendor/observe-js/src/observe").Platform,n=e("./underscore"),p=e("./../error").InternalSiestaError,l=/^function\s*[^\(]*\(\s*([^\)]*)\)/m,r=/,/,f=/^\s*(_?)(.+?)\1\s*$/,m=/((\/\/.*$)|(\/\*[\s\S]*?\*\/))/mg;e=function(a){return"[object Array]"===n.toString.call(a)};var g=Array.isArray||e,b=function(a){return"string"==typeof a||a instanceof String};n.extend(t.exports,{next:function(a){d.performMicrotaskCheckpoint();
setTimeout(a)},cb:function(a,c){return function(b){a&&a.apply(a,arguments);c&&(b?c.reject(b):c.resolve.apply(c,Array.prototype.slice.call(arguments,1)))}},guid:function(){function a(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return function(){return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()}}(),assert:function(a,c,b){if(!a)throw b=b||{},new p(c||"Assertion failed",b);},thenBy:function(){function a(a){a.thenBy=c;return a}function c(c){var b=this;return a(function(a,
d){return b(a,d)||c(a,d)})}return a}(),defer:function(a){var c;a=a||function(){};if(siesta.q){c=siesta.q.defer();var b=c.reject,d=c.resolve;n.extend(c,{reject:function(c){a(c);b.call(this,c)},resolve:function(c){var b=a.__siesta_bound_object||a,k=Array.prototype.slice.call(arguments,0);k.unshift(null);a.apply(b,k);d.apply(this,arguments)},finish:function(a,c){if(a)this.reject(a);else{var b=Array.prototype.slice.call(arguments,1);this.resolve.apply(this,b)}}})}else c={promise:void 0,reject:function(c){a.apply(a.__siesta_bound_object||
a,arguments)},resolve:function(c){var b=a.__siesta_bound_object||a,d=Array.prototype.slice.call(arguments,0);d.unshift(null);a.apply(b,d)},finish:function(c,b){a.apply(a.__siesta_bound_object||a,arguments)}};return c},defineSubProperty:function(a,c,b){return Object.defineProperty(this,a,{get:function(){return b?c[b]:c[a]},set:function(d){b?c[b]=d:c[a]=d},enumerable:!0,configurable:!0})},defineSubPropertyNoSet:function(a,c,b){return Object.defineProperty(this,a,{get:function(){return b?c[b]:c[a]},
enumerable:!0,configurable:!0})},subProperties:function(a,c,d){g(d)||(d=Array.prototype.slice.call(arguments,2));for(var h=0;h<d.length;h++)(function(d){var k={set:!1,name:d,property:d};b(d)||n.extend(k,d);d={get:function(){return c[k.property]},enumerable:!0,configurable:!0};k.set&&(d.set=function(a){c[k.property]=a});Object.defineProperty(a,k.name,d)})(d[h])},capitaliseFirstLetter:function(a){return a.charAt(0).toUpperCase()+a.slice(1)},extendFromOpts:function(a,c,b,d){if(void 0==d||d){var e=Object.keys(b);
d=Object.keys(c).filter(function(a){return-1==e.indexOf(a)});if(d.length)throw Error("Unknown options: "+d.toString());}n.each(Object.keys(b),function(a){var d=b[a];"function"==typeof d&&(b[a]=d(c[a]),delete c[a])});n.extend(b,c);n.extend(a,b)},isString:b,isArray:g,prettyPrint:function(a){return JSON.stringify(a,null,4)},flattenArray:function(a){return n.reduce(a,function(a,b){g(b)?a=a.concat(b):a.push(b);return a},[])},unflattenArray:function(a,c){for(var b=0,d=[],e=0;e<c.length;e++)if(g(c[e])){var f=
[];d[e]=f;for(var l=0;l<c[e].length;l++)f.push(a[b]),b++}else d[e]=a[b],b++;return d},paramNames:function(a){var c=[];a.toString().replace(m,"").match(l)[1].split(r).forEach(function(a){a.replace(f,function(a,b,d){c.push(d)})});return c}})},{"../../vendor/observe-js/src/observe":44,"./../error":11,"./underscore":30}],30:[function(e,t,q){var d={};e=Array.prototype;var n=e.forEach,p=e.map,l=e.reduce,r=Function.prototype.bind,f=e.slice,m={},g=function(){};d.keys=function(a){if(Object.keys)return Object.keys(a);
var b=[],d;for(d in a)a.hasOwnProperty(d)&&b.push(d);return b};d.each=d.forEach=function(a,b,h){if(null==a)return a;if(n&&a.forEach===n)a.forEach(b,h);else if(a.length===+a.length)for(var e=0,f=a.length;e<f;e++){if(b.call(h,a[e],e,a)===m)return}else for(var g=d.keys(a),e=0,f=g.length;e<f;e++)if(b.call(h,a[g[e]],g[e],a)===m)return;return a};d.map=d.collect=function(a,b,e){var f=[];if(null==a)return f;if(p&&a.map===p)return a.map(b,e);d.each(a,function(a,c,d){f.push(b.call(e,a,c,d))});return f};var b=
function(a,b,d){if(void 0===b)return a;switch(null==d?3:d){case 1:return function(d){return a.call(b,d)};case 2:return function(d,e){return a.call(b,d,e)};case 3:return function(d,e,h){return a.call(b,d,e,h)};case 4:return function(d,e,h,f){return a.call(b,d,e,h,f)}}return function(){return a.apply(b,arguments)}};d.times=function(a,d,e){var f=Array(Math.max(0,a));d=b(d,e,1);for(e=0;e<a;e++)f[e]=d(e);return f};d.partial=function(a){var b=f.call(arguments,1);return function(){for(var e=0,f=b.slice(),
g=0,l=f.length;g<l;g++)f[g]===d&&(f[g]=arguments[e++]);for(;e<arguments.length;)f.push(arguments[e++]);return a.apply(this,f)}};d.pluck=function(a,b){return d.map(a,d.property(b))};d.reduce=d.foldl=d.inject=function(a,b,e,f){var g=2<arguments.length;null==a&&(a=[]);if(l&&a.reduce===l)return f&&(b=d.bind(b,f)),g?a.reduce(b,e):a.reduce(b);d.each(a,function(a,c,d){g?e=b.call(f,e,a,c,d):(e=a,g=!0)});if(!g)throw new TypeError("Reduce of empty array with no initial value");return e};d.property=function(a){return function(b){return b[a]}};
"function"!==typeof/./&&(d.isFunction=function(a){return"function"===typeof a});d.isObject=function(a){var b=typeof a;return"function"===b||"object"===b&&!!a};var a=function(a){return null==a?d.identity:d.isFunction(a)?a:d.property(a)};d.sortBy=function(c,b,e){b=a(b);return d.pluck(d.map(c,function(a,c,d){return{value:a,index:c,criteria:b.call(e,a,c,d)}}).sort(function(a,c){var b=a.criteria,d=c.criteria;if(b!==d){if(b>d||void 0===b)return 1;if(b<d||void 0===d)return-1}return a.index-c.index}),"value")};
d.bind=function(a,b){var e,l;if(r&&a.bind===r)return r.apply(a,f.call(arguments,1));if(!d.isFunction(a))throw new TypeError;e=f.call(arguments,2);return l=function(){if(!(this instanceof l))return a.apply(b,e.concat(f.call(arguments)));g.prototype=a.prototype;var d=new g;g.prototype=null;u;var m=a.apply(d,e.concat(f.call(arguments)));return Object(m)===m?m:d}};d.identity=function(a){return a};d.zip=function(a){if(null==a)return[];for(var b=d.max(arguments,"length").length,e=Array(b),f=0;f<b;f++)e[f]=
d.pluck(arguments,f);return e};d.max=function(a,b,e){var f=-Infinity,g=-Infinity,l;if(null==b&&null!=a){a=a.length===+a.length?a:d.values(a);for(var m=0,r=a.length;m<r;m++)e=a[m],e>f&&(f=e)}else b=d.iteratee(b,e),d.each(a,function(a,c,d){l=b(a,c,d);if(l>g||-Infinity===l&&-Infinity===f)f=a,g=l});return f};d.iteratee=function(a,e,f){return null==a?d.identity:d.isFunction(a)?b(a,e,f):d.isObject(a)?d.matches(a):d.property(a)};d.pairs=function(a){for(var b=d.keys(a),e=b.length,f=Array(e),g=0;g<e;g++)f[g]=
[b[g],a[b[g]]];return f};d.matches=function(a){var b=d.pairs(a),e=b.length;return function(a){if(null==a)return!e;a=Object(a);for(var c=0;c<e;c++){var d=b[c],f=d[0];if(d[1]!==a[f]||!(f in a))return!1}return!0}};d.some=function(a,b,e){if(null==a)return!1;b=d.iteratee(b,e);e=a.length!==+a.length&&d.keys(a);var f=(e||a).length,g,l;for(g=0;g<f;g++)if(l=e?e[g]:g,b(a[l],l,a))return!0;return!1};d.extend=function(a){if(!d.isObject(a))return a;for(var b,e,f=1,g=arguments.length;f<g;f++)for(e in b=arguments[f],
b)hasOwnProperty.call(b,e)&&(a[e]=b[e]);return a};t.exports=d},{}],31:[function(e,t,q){function d(a){a?"*"==a||-1<a.indexOf("*")?a=c:l.isArray(a)||(a=[a]):a=["GET"];return b.map(a,function(a){return a.toUpperCase()})}function n(a){if(!this)return new n(a);this._rawOpts=g(!0,{},a);this._opts=a;var c=function(a){a instanceof RegExp||(a=new RegExp(a,"g"));return a}.bind(this);this._opts.path?(a=this._opts.path,l.isArray(a)||(a=[a]),this._opts.path=[],b.each(a,function(a){this._opts.path.push(c.call(this,
a))}.bind(this))):this._opts.path=[""];this._opts.method=d(this._opts.method);if((a=this._opts.data)&&a.length){var e=a.split(".");if(1==e.length)a=e[0];else{var m={};a=m;for(var r=e[0],p=1;p<e.length;p++){var q=e[p];if(p==e.length-1)m[r]=q;else var t={},m=m[r]=t,r=q}}this._opts.data=a}f.call(this,"path",this._opts);f.call(this,"method",this._opts);f.call(this,"data",this._opts);f.call(this,"transforms",this._opts)}e=siesta._internal;var p=e.error.InternalSiestaError,l=e.util,r=l.assert,f=l.defineSubProperty,
m=e.CollectionRegistry,g=e.extend,b=l._,a=e.log.loggerWithName("Descriptor"),c="POST PATCH PUT HEAD GET DELETE OPTIONS TRACE CONNECT".split(" ");b.extend(n.prototype,{httpMethods:c,_resolveCollectionAndModel:function(){var a;a=this._opts.collection;var b=this._opts.model;console.log("rawCollection",a);console.log("rawModel",b);if(a)a="string"==typeof a?m[a]:a;else if(b&&!l.isString(b))a=b.collection;else return"Must pass collection or a model object";var c;if(b)if(l.isString(b))if(c=a._models[b])this._opts.model=
c;else return"Model "+b+" does not exist in collection";else{if(b.collection!=a)return"Passed model is not part of the passed collection";c=b}else return"Descriptors must be initialised with a model";this.model=c;this.collection=a},_matchPath:function(b){var c;for(c=0;c<this._opts.path.length;c++){var d=this._opts.path[c];a.trace.isEnabled&&a.trace("Matching path",b,d.toString());var e=d.exec(b);a.trace.isEnabled&&(e?a.trace("Matched path successfully",b,d.toString()):a.trace("Failed to match path",
b,d.toString()));if(e)return!0}return!1},_matchMethod:function(a){for(var b=0;b<this.method.length;b++)if(a.toUpperCase()==this.method[b])return!0;return!1},bury:function(a,b){var c=Object.keys(b);r(1==c.length);for(var c=c[0],d=b;"string"!=typeof d[c];)d=d[c],c=Object.keys(d),r(1==c.length),c=c[0];var e=d[c],f={};d[c]=f;f[e]=a;return b},_embedData:function(a){if(this.data){var b;"string"==typeof this.data?(b={},b[this.data]=a):b=this.bury(a,g(!0,{},this.data));return b}return a},_extractData:function(b){a.debug.isEnabled&&
a.debug("_extractData",b);if(this.data){if("string"==typeof this.data)return b[this.data];var c=Object.keys(this.data);r(1==c.length);for(var d=this.data;"string"!=typeof d&&(c=Object.keys(d),r(1==c.length),c=c[0],d=d[c],b=b[c],b););return b?b[d]:null}return b},_matchConfig:function(a){var b=a.type?this._matchMethod(a.type):{};b&&(b=a.url?this._matchPath(a.url):{});return b},_matchData:function(a){var b=null;this.data?a&&(b=this._extractData(a)):b=a;return b},match:function(a,b){var c=!1;this._matchConfig(a)&&
(c=this._matchData(b));return c},_transformData:function(a){var b=this.transforms;if("function"==typeof b)a=b(a);else for(var c in b)if(b.hasOwnProperty(c)&&a[c]){var d=b[c],e=a[c];if("string"==typeof d)if(d=d.split("."),delete a[c],1==d.length)a[d[0]]=e;else{a[d[0]]={};for(var f=a[d[0]],g=1;g<d.length-1;g++){var m=d[g];f[m]={};f=f[m]}f[d[d.length-1]]=e}else if("function"==typeof d)e=d(e),l.isArray(e)?(delete a[c],a[e[0]]=e[1]):a[c]=e;else throw new p("Invalid transformer");}return a}});q.Descriptor=
n;q.resolveMethod=d},{}],32:[function(e,t,q){function d(){if(!this)return new d(opts);this.requestDescriptors={};this.responseDescriptors={}}function n(d,e){var b=e._opts.model,a=e._opts.collection,c;if(a)c=l.isString(a)?a:a.name;else if(b){if(l.isString(b))throw new r("Not enough information to register the descriptor");c=b.collection.name}d[c]||(d[c]=[]);d[c].push(e)}function p(d,e){var b;b="string"==typeof e?d[e]||[]:d[e.name]||[];f.trace.isEnabled&&f.trace("_descriptorsForCollection",{collection:e,
allDescriptors:d,descriptors:b});return b}e=siesta._internal;var l=e.util;t=l._;var r=e.error.InternalSiestaError,f=e.log.loggerWithName("Descriptor");t.extend(d.prototype,{registerRequestDescriptor:function(d){n(this.requestDescriptors,d)},registerResponseDescriptor:function(d){f.trace.isEnabled&&f.trace("registerResponseDescriptor");n(this.responseDescriptors,d)},requestDescriptorsForCollection:function(d){return p(this.requestDescriptors,d)},responseDescriptorsForCollection:function(d){var e=p(this.responseDescriptors,
d);e.length||f.debug.isEnabled&&f.debug("No response descriptors for collection ",{collection:d});return e},reset:function(){this.requestDescriptors={};this.responseDescriptors={}}});q.DescriptorRegistry=new d},{}],33:[function(e,t,q){function d(a,b,c){if(z.debug.isEnabled){var d=z.debug;a=a.type+" "+b.status+" "+a.url;z.trace.isEnabled&&c&&(d=z.trace,a+=": "+A.prettyPrint(c));d(a)}}function n(a){if(z.debug.isEnabled){var b=z.debug;a=a.type+" "+a.url;z.trace.isEnabled&&(b=z.trace);b(a)}}function p(a,
b,c,e){var f=this,g=Array.prototype.slice.call(arguments,2),h={},k=this.name;"function"==typeof g[0]?e=g[0]:"object"==typeof g[0]&&(h=g[0],e=g[1]);g=A.defer(e);e=g.finish.bind(g);siesta._afterInstall(function(){function c(a,b,g){d(h,g,a);if(h.parseResponse){b=D.responseDescriptorsForCollection(f);for(var l,m,r=0;r<b.length;r++){var p=b[r];if(m=p.match(h,a)){l=p;break}}if(l)z.trace.isEnabled&&z.trace("Model _constructSubOperation data: "+A.prettyPrint(m)),"object"==typeof m?l.model.graph(m,{override:h.obj},
function(b,c){e(b,c,a,g)}):e(null,null,null,g);else if(e)if(k)e(null,null,a,g);else throw new B("Unnamed collection");}else e(null,null,a,g)}function g(a,b,c){e&&e(c,null,null,a)}h.type=a;h.method=a;h.url||(h.url=this.baseURL+b);void 0===h.parseResponse&&(h.parseResponse=!0);n(h);var l=siesta.ext.http.ajax;l?(l=l(h),l.success?(l.success(c),l.error(g)):l.done?(l.done(c),l.fail(g)):e("Incompatible ajax function. Could not find success/fail methods on returned promise.")):e("No ajax function. Ensure that either $.ajax is available, or call siesta.setAjax(ajax) with a compatible ajax function e.g. zepto, jquery, $http")}.bind(this));
return g.promise}function l(a,b,c){this._serialise(b,function(b,d){var e=d;a.fields&&(e={},x.each(a.fields,function(a){e[a]=d[a]}));c(b,e)})}function r(a,b,c){var d=this,e=Array.prototype.slice.call(arguments,3),f,g={};"function"==typeof e[0]?f=e[0]:"object"==typeof e[0]&&(g=e[0],f=e[1]);var h=A.defer(f);f=h.finish.bind(h);var e=Array.prototype.slice.call(e,2),k=D.requestDescriptorsForCollection(this),m;g.type=a;g.url=this.baseURL+b;for(var r=0;r<k.length;r++){var n=k[r];if(n._matchConfig(g)){m=n;
break}}m?(z.trace.isEnabled&&z.trace("Matched descriptor: "+m._dump(!0)),l.call(m,c,g,function(h,k){z.trace.isEnabled&&z.trace("_serialise",{err:h,data:k});h?f&&f(h,null,null):(g.data=k,g.obj=c,x.partial(p,a,b,g,f).apply(d,e))})):f&&(z.trace.isEnabled&&z.trace("Did not match descriptor"),f("No descriptor matched",null,null));return h.promise}function f(a,b){var c=Array.prototype.slice.call(arguments,2),d={},e;"function"==typeof c[0]?e=c[0]:"object"==typeof c[0]&&(d=c[0],e=c[1]);var f=A.defer(e),g=
d.deletionMode||"restore";void 0===d.parseResponse&&(d.parseResponse=!1);p.call(this,"DELETE",a,d,function(a,c,d,h){a?"restore"==g&&b.restore():"success"==g&&b.remove();e(a,c,d,h);f.finish(a,{x:c,y:d,z:h})});"now"!=g&&"restore"!=g||b.remove();return f.promise}function m(a,b){var c=Array.prototype.slice.call(arguments,2);return x.partial(a?r:p,b).apply(this,c)}function g(){return x.partial(m,!1,"GET").apply(this,arguments)}function b(){return x.partial(m,!1,"OPTIONS").apply(this,arguments)}function a(){return x.partial(m,
!1,"TRACE").apply(this,arguments)}function c(){return x.partial(m,!1,"HEAD").apply(this,arguments)}function k(){return x.partial(m,!0,"POST").apply(this,arguments)}function h(){return x.partial(m,!0,"PUT").apply(this,arguments)}function v(){return x.partial(m,!0,"PATCH").apply(this,arguments)}if("undefined"==typeof siesta&&"undefined"==typeof t)throw Error("Could not find window.siesta. Make sure you include siesta.core.js first.");var y=siesta._internal;q=y.Collection;var C=y.log,A=y.util,x=A._,
w=e("./descriptor"),B=y.error.InternalSiestaError,D=e("./descriptorRegistry").DescriptorRegistry,z=C.loggerWithName("HTTP");e={RequestDescriptor:e("./requestDescriptor").RequestDescriptor,ResponseDescriptor:e("./responseDescriptor").ResponseDescriptor,Descriptor:w.Descriptor,_resolveMethod:w.resolveMethod,Serialiser:e("./serialiser"),DescriptorRegistry:e("./descriptorRegistry").DescriptorRegistry,_httpResponse:p,_httpRequest:r,DELETE:f,HTTP_METHOD:m,GET:g,TRACE:a,OPTIONS:b,HEAD:c,POST:k,PUT:h,PATCH:v,
_serialiseObject:l,Paginator:e("./paginator")};Object.defineProperty(e,"ajax",{get:function(){return E||($?$.ajax:null)||(jQuery?jQuery.ajax:null)},set:function(a){E=a}});x.extend(q.prototype,{DELETE:f,GET:g,TRACE:a,OPTIONS:b,HEAD:c,POST:k,PUT:h,PATCH:v});siesta.ext||(siesta.ext={});siesta.ext.http=e;Object.defineProperties(siesta.ext,{httpEnabled:{get:function(){return void 0!==siesta.ext._httpEnabled?siesta.ext._httpEnabled:!!siesta.ext.http},set:function(a){siesta.ext._httpEnabled=a},enumerable:!0}});
var E;q={};x.extend(siesta,{setAjax:function(a){E=a},getAjax:function(){return siesta.ext.http.ajax},serialisers:q,serializers:q});Object.defineProperty(siesta,"ajax",{get:function(){return E},set:function(a){E=a}});Object.defineProperties(q,{id:{get:function(){return siesta.ext.httpEnabled?siesta.ext.http.Serialiser.idSerialiser:null}},depth:{get:function(){return siesta.ext.httpEnabled?siesta.ext.http.Serialiser.depthSerializer:null}}});"undefined"!=typeof t&&(t.exports=e)},{"./descriptor":31,"./descriptorRegistry":32,
"./paginator":34,"./requestDescriptor":35,"./responseDescriptor":36,"./serialiser":37}],34:[function(e,t,q){function d(d){this.opts={};p.extendFromOpts(this.opts,d,{path:"/",model:null,page:"page",queryParams:!0,pageSize:"pageSize",numPages:"numPages",dataPath:"data",count:"count",type:"GET",dataType:"json"},!1);l.extend(this,{numPages:null,count:null});this.validate()}q=siesta._internal;var n=q.error.InternalSiestaError,p=q.util,l=p._,r=e("querystring");l.extend(d.prototype,{_extract:function(d,
e,g){if(d)if("function"==typeof d)e=d(e,g);else for(d=d.split("."),g=0;g<d.length;g++)e=e[d[g]];return e},_extractData:function(d,e){return this._extract(this.opts.dataPath,d,e)},_extractNumPages:function(d,e){return this._extract(this.opts.numPages,d,e)},_extractCount:function(d,e){return this._extract(this.opts.count,d,e)},_parseURL:function(d){var e=document.createElement("a");e.href=d;return e},page:function(d,e){var g=this,b={};"function"==typeof d?e=d:d&&(b=d);var a=p.defer(e),c=b.page,b=b.pageSize;
e=a.finish.bind(a);var k=siesta.ext.http.ajax,h=l.extend({},this.opts),n=this.opts.model.collection.baseURL+this.opts.path;if(this.opts.queryParams){var n=this._parseURL(n),q=n.search,t=q.split("?");1<t.length&&(q=t[1]);q=r.parse(q);c&&(q[this.opts.page]=c);b&&(q[this.opts.pageSize]=b);Object.keys(q).length&&(n.search="?"+r.stringify(q));n=n.href}else q={},c&&(q[this.opts.page]=c),b&&(q[this.opts.pageSize]=b),h.data=q;l.extend(h,{url:n,success:function(a,b,c){var d=g._extractData(a,c),f=g._extractCount(a,
c),h=g._extractNumPages(a,c);g.opts.model.graph(d,function(d,k){d?e(d):(g.count=f,g.numPages=h,e(null,k,{data:a,textStatus:b,jqXHR:c}))})},fail:e});k(h);return a.promise},validate:function(){if(!this.opts.model)throw new n("Paginator must have a model");}});t.exports=d},{querystring:41}],35:[function(e,t,q){function d(e){if(!this)return new d(e);n.call(this,e);this._opts.serializer&&(this._opts.serialiser=this._opts.serializer);this._opts.serialiser||(this._opts.serialiser=p.depthSerializer(0));r.call(this,
"serialiser",this._opts);r.call(this,"serializer",this._opts,"serialiser")}var n=e("./descriptor").Descriptor,p=e("./serialiser");e=siesta._internal;var l=e.util;t=l._;var r=l.defineSubProperty,f=e.log.loggerWithName("Descriptor");d.prototype=Object.create(n.prototype);t.extend(d.prototype,{_serialise:function(d,e){var b=l.defer(e);e=b.finish.bind(b);var a=this;f.trace.isEnabled&&f.trace("_serialise");var c,k=this.serialiser(d,function(b,d){c||(d=a._transformData(d),e&&e(b,a._embedData(d)))});void 0!==
k?(f.trace.isEnabled&&f.trace("serialiser doesnt use a callback"),c=!0,k=a._transformData(k),e&&e(null,a._embedData(k))):f.trace.isEnabled&&f.trace("serialiser uses a callback",this.serialiser);return b.promise},_dump:function(d){var e={};e.methods=this.method;e.model=this.model.name;e.path=this._rawOpts.path;e.serialiser="function"==typeof this._rawOpts.serialiser?"function () { ... }":this._rawOpts.serialiser;var b={},a;for(a in this.transforms)this.transforms.hasOwnProperty(a)&&(b[a]="function"==
typeof this.transforms[a]?"function () { ... }":this.transforms[a]);e.transforms=b;return d?l.prettyPrint(e):e}});q.RequestDescriptor=d},{"./descriptor":31,"./serialiser":37}],36:[function(e,t,q){function d(e){if(!this)return new d(e);n.call(this,e)}var n=e("./descriptor").Descriptor;e=siesta._internal.util._;d.prototype=Object.create(n.prototype);e.extend(d.prototype,{_extractData:function(d){(d=n.prototype._extractData.call(this,d))&&(d=this._transformData(d));return d},_matchData:function(d){(d=
n.prototype._matchData.call(this,d))&&(d=this._transformData(d));return d},_dump:function(d){var e={};e.methods=this.method;e.model=this.model.name;e.path=this._rawOpts.path;var r={},f;for(f in this.transforms)this.transforms.hasOwnProperty(f)&&(r[f]="function"==typeof this.transforms[f]?"function () { ... }":this.transforms[f]);e.transforms=r;return d?util.prettyPrint(e):e}});q.ResponseDescriptor=d},{"./descriptor":31}],37:[function(e,t,q){function d(d){var e=d.model.id;if(e)return d[e]?d[e]:null;
p.debug.isEnabled&&p.debug("No idfield")}function n(d,e,m){m=m||function(){};p.trace.isEnabled&&p.trace("depthSerialiser");var g={};l.each(e._attributeNames,function(a){p.trace.isEnabled&&p.trace("field",a);e[a]&&(g[a]=e[a])});var b=[],a=[],c={},k=[];l.each(e._relationshipNames,function(h){p.trace.isEnabled&&p.trace("relationshipField",h);var l=e.__proxies[h];l.isForward&&(p.debug.isEnabled&&p.debug(h),b.push(h),l.get(function(l,q){p.trace.isEnabled&&p.trace("proxy.get",h);p.debug.isEnabled&&p.debug(h,
q);l?(a.push(l),k.push(h),c[h]={err:l,v:q}):q?d?n(d-1,q,function(d,e,f){d?a.push(d):g[h]=e;k.push(h);c[h]={err:d,v:q,resp:f};b.length==k.length&&m&&m(a.length?a:null,g,c)}):(k.push(h),g[h]=q[e.__proxies[h].forwardModel.id],c[h]={err:l,v:q},b.length==k.length&&m&&m(a.length?a:null,g,c)):(p.debug.isEnabled&&p.debug("no value for "+h),k.push(h),c[h]={err:l,v:q},b.length==k.length&&m&&m(a.length?a:null,g,c))}))});b.length||m(null,g,{})}e=siesta._internal;t=e.util;var p=e.log.loggerWithName("Serialisation"),
l=t._;q.depthSerialiser=function(d){return l.partial(n,d)};q.depthSerializer=function(d){return l.partial(n,d)};q.idSerializer=d;q.idSerialiser=d},{}],38:[function(e,t,q){function d(){this._events=this._events||{};this._maxListeners=this._maxListeners||void 0}function n(d){return"function"===typeof d}function p(d){return"object"===typeof d&&null!==d}t.exports=d;d.EventEmitter=d;d.prototype._events=void 0;d.prototype._maxListeners=void 0;d.defaultMaxListeners=10;d.prototype.setMaxListeners=function(d){if("number"!==
typeof d||0>d||isNaN(d))throw TypeError("n must be a positive number");this._maxListeners=d;return this};d.prototype.emit=function(d){var e,f,m,g;this._events||(this._events={});if("error"===d&&(!this._events.error||p(this._events.error)&&!this._events.error.length)){e=arguments[1];if(e instanceof Error)throw e;throw TypeError('Uncaught, unspecified "error" event.');}f=this._events[d];if(void 0===f)return!1;if(n(f))switch(arguments.length){case 1:f.call(this);break;case 2:f.call(this,arguments[1]);
break;case 3:f.call(this,arguments[1],arguments[2]);break;default:e=arguments.length;m=Array(e-1);for(g=1;g<e;g++)m[g-1]=arguments[g];f.apply(this,m)}else if(p(f)){e=arguments.length;m=Array(e-1);for(g=1;g<e;g++)m[g-1]=arguments[g];f=f.slice();e=f.length;for(g=0;g<e;g++)f[g].apply(this,m)}return!0};d.prototype.addListener=function(e,r){var f;if(!n(r))throw TypeError("listener must be a function");this._events||(this._events={});this._events.newListener&&this.emit("newListener",e,n(r.listener)?r.listener:
r);this._events[e]?p(this._events[e])?this._events[e].push(r):this._events[e]=[this._events[e],r]:this._events[e]=r;p(this._events[e])&&!this._events[e].warned&&(f=void 0!==this._maxListeners?this._maxListeners:d.defaultMaxListeners)&&0<f&&this._events[e].length>f&&(this._events[e].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[e].length),"function"===typeof console.trace&&console.trace());
return this};d.prototype.on=d.prototype.addListener;d.prototype.once=function(d,e){function f(){this.removeListener(d,f);m||(m=!0,e.apply(this,arguments))}if(!n(e))throw TypeError("listener must be a function");var m=!1;f.listener=e;this.on(d,f);return this};d.prototype.removeListener=function(d,e){var f,m,g;if(!n(e))throw TypeError("listener must be a function");if(!this._events||!this._events[d])return this;f=this._events[d];g=f.length;m=-1;if(f===e||n(f.listener)&&f.listener===e)delete this._events[d],
this._events.removeListener&&this.emit("removeListener",d,e);else if(p(f)){for(;0<g--;)if(f[g]===e||f[g].listener&&f[g].listener===e){m=g;break}if(0>m)return this;1===f.length?(f.length=0,delete this._events[d]):f.splice(m,1);this._events.removeListener&&this.emit("removeListener",d,e)}return this};d.prototype.removeAllListeners=function(d){var e;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[d]&&delete this._events[d],this;if(0===
arguments.length){for(e in this._events)"removeListener"!==e&&this.removeAllListeners(e);this.removeAllListeners("removeListener");this._events={};return this}e=this._events[d];if(n(e))this.removeListener(d,e);else for(;e.length;)this.removeListener(d,e[e.length-1]);delete this._events[d];return this};d.prototype.listeners=function(d){return this._events&&this._events[d]?n(this._events[d])?[this._events[d]]:this._events[d].slice():[]};d.listenerCount=function(d,e){return d._events&&d._events[e]?n(d._events[e])?
1:d._events[e].length:0}},{}],39:[function(e,t,q){t.exports=function(e,p,l,r){l=l||"=";var f={};if("string"!==typeof e||0===e.length)return f;var m=/\+/g;e=e.split(p||"&");p=1E3;r&&"number"===typeof r.maxKeys&&(p=r.maxKeys);r=e.length;0<p&&r>p&&(r=p);for(p=0;p<r;++p){var g=e[p].replace(m,"%20"),b=g.indexOf(l),a;0<=b?(a=g.substr(0,b),g=g.substr(b+1)):(a=g,g="");a=decodeURIComponent(a);g=decodeURIComponent(g);Object.prototype.hasOwnProperty.call(f,a)?d(f[a])?f[a].push(g):f[a]=[f[a],g]:f[a]=g}return f};
var d=Array.isArray||function(d){return"[object Array]"===Object.prototype.toString.call(d)}},{}],40:[function(e,t,q){function d(d,e){if(d.map)return d.map(e);for(var l=[],g=0;g<d.length;g++)l.push(e(d[g],g));return l}var n=function(d){switch(typeof d){case "string":return d;case "boolean":return d?"true":"false";case "number":return isFinite(d)?d:"";default:return""}};t.exports=function(e,f,m,g){f=f||"&";m=m||"=";null===e&&(e=void 0);return"object"===typeof e?d(l(e),function(b){var a=encodeURIComponent(n(b))+
m;return p(e[b])?d(e[b],function(b){return a+encodeURIComponent(n(b))}).join(f):a+encodeURIComponent(n(e[b]))}).join(f):g?encodeURIComponent(n(g))+m+encodeURIComponent(n(e)):""};var p=Array.isArray||function(d){return"[object Array]"===Object.prototype.toString.call(d)},l=Object.keys||function(d){var e=[],l;for(l in d)Object.prototype.hasOwnProperty.call(d,l)&&e.push(l);return e}},{}],41:[function(e,t,q){q.decode=q.parse=e("./decode");q.encode=q.stringify=e("./encode")},{"./decode":39,"./encode":40}],
42:[function(e,t,q){var d=Object.prototype.hasOwnProperty,n=Object.prototype.toString,p=function(e){if(!e||"[object Object]"!==n.call(e)||e.nodeType||e.setInterval)return!1;var p=d.call(e,"constructor"),f=e.constructor&&e.constructor.prototype&&d.call(e.constructor.prototype,"isPrototypeOf");if(e.constructor&&!p&&!f)return!1;for(var m in e);return void 0===m||d.call(e,m)};t.exports=function r(){var d,e,g,b,a,c=arguments[0],k=1,h=arguments.length,n=!1;if("boolean"===typeof c)n=c,c=arguments[1]||{},
k=2;else if("object"!==typeof c&&"function"!==typeof c||void 0==c)c={};for(;k<h;++k)if(null!=(d=arguments[k]))for(e in d)g=c[e],b=d[e],c!==b&&(n&&b&&(p(b)||(a=Array.isArray(b)))?(a?(a=!1,g=g&&Array.isArray(g)?g:[]):g=g&&p(g)?g:{},c[e]=r(n,g,b)):void 0!==b&&(c[e]=b));return c}},{}],43:[function(e,t,q){if("undefined"==typeof siesta&&"undefined"==typeof t)throw Error("Could not find window.siesta. Make sure you include siesta.core.js first.");var d=siesta._internal,n=d.CollectionRegistry,p=d.util,l=
p._,r=d.events,f=[],m={},g={};e={};var b=d.log.loggerWithName("Storage");if("undefined"==typeof PouchDB)siesta.ext.storageEnabled=!1,console.log("PouchDB is not present therefore storage is disabled.");else{q=function(c){var d=p.defer(c);siesta._afterInstall(function(){c=c||function(){};var e=f;f=[];m={};g={};b.trace&&b.trace("Saving objects",l.map(e,function(a){return a._dump()}));a(e,c,d)});return d.promise};var a=function(a,d,e){var f=[];y.bulkDocs(l.map(a,v)).then(function(g){for(var h=0;h<g.length;h++){var k=
g[h],l=a[h];k.ok?l._rev=k.rev:409==k.status?f.push(l):b.error('Error saving object with _id="'+l._id+'"',k)}f.length?c(f,d,e):(d(),e&&e.resolve())},function(a){d(a);e&&e.reject(a)})},c=function(b,c,d){y.allDocs({keys:l.pluck(b,"_id")}).then(function(e){for(var f=0;f<e.rows.length;f++)b[f]._rev=e.rows[f].value.rev;a(b,c,d)})["catch"](function(a){d.reject(a)})},k=function(a,c){var d=a.collectionName,e=a.modelName;if(b.trace){var f=d+"."+e;b.trace("Loading instances for "+f)}var g=n[d][e],d=function(a){"$1"==
a.model&&"$2"==a.collection&&emit(a._id,a)}.toString().replace("$1",e).replace("$2",d);b.trace.isEnabled&&b.trace("Querying pouch");y.query({map:d}).then(function(a){b.trace.isEnabled&&b.trace("Queried pouch succesffully");a=siesta._.map(siesta._.pluck(a.rows,"value"),function(a){return h(a,g)});b.trace.isEnabled&&b.trace("Mapping data",a);g.graph(a,{disableevents:!0,_ignoreInstalled:!0,fromStorage:!0},function(a,d){a?b.error("Error loading models",a):b.trace.isEnabled&&b.trace("Loaded "+d?d.length.toString():
"0 instances for "+f);c(a,d)})})["catch"](function(a){c(a)})},h=function(a,b){delete a.collection;delete a.model;l.each(b._relationshipNames,function(b){var c=a[b];siesta.isArray(c)?a[b]=l.map(c,function(a){return{_id:a}}):a[b]={_id:c}});return a},v=function(a){var b=siesta._.extend({},a.__values);b.collection=a.collectionName;b.model=a.modelName;b._id=a._id;a.removed&&(b._deleted=!0);var c=a._rev;c&&(b._rev=c);return b=l.reduce(a._relationshipNames,function(b,c){var d=a[c];siesta.isArray(d)?b[c]=
l.pluck(d,"_id"):d&&(b[c]=d._id);return b},b)},y=new PouchDB("siesta"),C=function(a){a=a.obj;var b=a._id;if(!a)throw new d.error.InternalSiestaError("No obj field in notification received by storage extension");if(!(b in m)){m[b]=a;f.push(a);var c=a.collectionName;g[c]||(g[c]={});var e=a.model.name;g[c][e]||(g[c][e]={});g[c][e][b]=a}};siesta.on("Siesta",C);l.extend(e,{_load:function(a){if(x)throw Error("not loaded yet how can i save");var c=p.defer(a);if(siesta.ext.storageEnabled){var d=[];l.each(n.collectionNames,
function(a){var b=Object.keys(n[a]._models);l.each(b,function(b){d.push(function(c){k({collectionName:a,modelName:b},c)})})});siesta.async.parallel(d,function(a,d){if(!a){var e=[];siesta._.each(d,function(a){e.concat(a)});b.trace&&b.trace("Loaded "+e.length.toString()+" instances")}c.finish(a)})}else c.finish();return c.promise},save:q,_serialise:v,_reset:function(a){siesta.removeListener("Siesta",C);f=[];m={};y.destroy(function(c){c||(y=new PouchDB("siesta"));siesta.on("Siesta",C);b.warn("Reset complete");
a(c)})}});Object.defineProperties(e,{_unsavedObjects:{get:function(){return f}},_unsavedObjectsHash:{get:function(){return m}},_unsavedObjectsByCollection:{get:function(){return g}},_pouch:{get:function(){return y}}});siesta.ext||(siesta.ext={});siesta.ext.storage=e;Object.defineProperties(siesta.ext,{storageEnabled:{get:function(){return void 0!==siesta.ext._storageEnabled?siesta.ext._storageEnabled:!!siesta.ext.storage},set:function(a){siesta.ext._storageEnabled=a},enumerable:!0}});var A,x,w=1E3;
Object.defineProperties(siesta,{autosave:{get:function(){return!!A},set:function(a){a?A||(A=setInterval(function(){x||(x=!0,siesta.save(function(a){a||r.emit("saved");x=!1}))},siesta.autosaveInterval)):A&&(clearInterval(A),A=null)}},autosaveInterval:{get:function(){return w},set:function(a){w=a;A&&(siesta.autosave=!1,siesta.autosave=!0)}},dirty:{get:function(){return!!Object.keys(siesta.ext.storage._unsavedObjectsByCollection).length},enumerable:!0}});l.extend(siesta,{save:q,setPouch:function(a){if(siesta._canChange)y=
a;else throw Error("Cannot change PouchDB instance when an object graph exists.");}})}t.exports=e},{}],44:[function(e,t,q){(function(d){(function(d){function e(a){for(var b=0;1E3>b&&a.check_();)b++;x&&(d.dirtyCheckCycleCount=b);return 0<b}function l(a){for(var b in a)return!1;return!0}function r(a){return l(a.added)&&l(a.removed)&&l(a.changed)}function f(a,b){var c={},d={},e={},f;for(f in b){var g=a[f];if(void 0===g||g!==b[f])f in a?g!==b[f]&&(e[f]=g):d[f]=void 0}for(f in a)f in b||(c[f]=a[f]);Array.isArray(a)&&
a.length!==b.length&&(e.length=a.length);return{added:c,removed:d,changed:e}}function m(){if(!z.length)return!1;for(var a=0;a<z.length;a++)z[a]();z.length=0;return!0}function g(){function a(c){b&&b.state_===F&&!d&&b.check_(c)}var b,c,d=!1,e=!0;return{open:function(c){if(b)throw Error("ObservedObject in use");e||Object.deliverChangeRecords(a);b=c;e=!1},observe:function(b,d){c=b;d?Array.observe(c,a):Object.observe(c,a)},deliver:function(b){d=b;Object.deliverChangeRecords(a);d=!1},close:function(){b=
void 0;Object.unobserve(c,a);K.push(this)}}}function b(){this.state_=L;this.value_=this.directObserver_=this.target_=this.callback_=void 0;this.id_=M++}function a(a){b.call(this);this.value_=a;this.oldObject_=void 0}function c(b){if(!Array.isArray(b))throw Error("Provided object is not an Array");a.call(this,b)}function k(a,b,c){for(var d={},e={},f=0;f<b.length;f++){var g=b[f];O[g.type]?(g.name in c||(c[g.name]=g.oldValue),"update"!=g.type&&("add"==g.type?g.name in e?delete e[g.name]:d[g.name]=!0:
g.name in d?(delete d[g.name],delete c[g.name]):e[g.name]=!0)):(console.error("Unknown changeRecord type: "+g.type),console.error(g))}for(var h in d)d[h]=a[h];for(h in e)e[h]=void 0;b={};for(h in c)h in d||h in e||(f=a[h],c[h]!==f&&(b[h]=f));return{added:d,removed:e,changed:b}}function h(a,b,c){return{index:a,removed:b,addedCount:c}}function v(){}function y(a,b,c,d){b=h(b,c,d);d=!1;for(var e=0,f=0;f<a.length;f++){var g=a[f];g.index+=e;if(!d){c=b.index;var k=b.index+b.removed.length,l=g.index,m=g.index+
g.addedCount;c=k<l||m<c?-1:k==l||m==c?0:c<l?k<m?k-l:m-l:m<k?m-c:k-c;0<=c?(a.splice(f,1),f--,e-=g.addedCount-g.removed.length,b.addedCount+=g.addedCount-c,c=b.removed.length+g.removed.length-c,b.addedCount||c?(c=g.removed,b.index<g.index&&(k=b.removed.slice(0,g.index-b.index),Array.prototype.push.apply(k,c),c=k),b.index+b.removed.length>g.index+g.addedCount&&(k=b.removed.slice(g.index+g.addedCount-b.index),Array.prototype.push.apply(c,k)),b.removed=c,g.index<b.index&&(b.index=g.index)):d=!0):b.index<
g.index&&(d=!0,a.splice(f,0,b),f++,c=b.addedCount-b.removed.length,g.index+=c,e+=c)}}d||a.push(b)}function C(a,b){for(var c=[],d=0;d<b.length;d++){var e=b[d];switch(e.type){case "splice":y(c,e.index,e.removed.slice(),e.addedCount);break;case "add":case "update":case "delete":var f=e.name;if(+f!==f>>>0||""===f)continue;f=+e.name;if(0>f)continue;y(c,f,[e.oldValue],1);break;default:console.error("Unexpected record type: "+JSON.stringify(e))}}return c}function A(a,b){var c=[];C(a,b).forEach(function(b){1==
b.addedCount&&1==b.removed.length?b.removed[0]!==a[b.index]&&c.push(b):c=c.concat(J.calcSplices(a,b.index,b.index+b.addedCount,b.removed,0,b.removed.length))});return c}var x=d.testingExposeCycleCount,w=function(){function a(c){b=c}if("function"!==typeof Object.observe||"function"!==typeof Array.observe)return!1;var b=[],c={},d=[];Object.observe(c,a);Array.observe(d,a);c.id=1;c.id=2;delete c.id;d.push(1,2);d.length=0;Object.deliverChangeRecords(a);if(5!==b.length||"add"!=b[0].type||"update"!=b[1].type||
"delete"!=b[2].type||"splice"!=b[3].type||"splice"!=b[4].type)return!1;Object.unobserve(c,a);Array.unobserve(d,a);return!0}(),B=function(){if("undefined"!==typeof chrome&&chrome.app&&chrome.app.runtime||navigator.getDeviceStorage)return!1;try{return(new Function("","return true;"))()}catch(a){return!1}}(),D="__proto__"in{}?function(a){return a}:function(a){var b=a.__proto__;if(!b)return a;var c=Object.create(b);Object.getOwnPropertyNames(a).forEach(function(b){Object.defineProperty(c,b,Object.getOwnPropertyDescriptor(a,
b))});return c},z=[],E=w?function(){var a={pingPong:!0},b=!1;Object.observe(a,function(){m();b=!1});return function(c){z.push(c);b||(b=!0,a.pingPong=!a.pingPong)}}():function(){return function(a){z.push(a)}}(),K=[],L=0,F=1,M=1;b.prototype={open:function(a,c){if(this.state_!=L)throw Error("Observer has already been opened.");b._allObserversCount++;H&&G.push(this);this.callback_=a;this.target_=c;this.connect_();this.state_=F;return this.value_},close:function(){this.state_==F&&(b._allObserversCount--,
this.disconnect_(),this.target_=this.callback_=this.value_=void 0,this.state_=2)},deliver:function(){this.state_==F&&e(this)},report_:function(a){try{this.callback_.apply(this.target_,a)}catch(c){b._errorThrownDuringCallback=!0,console.error("Exception caught during observer callback: "+(c.stack||c))}},discardChanges:function(){this.check_(void 0,!0);return this.value_}};var H=!w,G;b._allObserversCount=0;H&&(G=[]);var I=!1,N=w&&B&&function(){try{return eval("%RunMicrotasks()"),!0}catch(a){return!1}}();
d.Platform=d.Platform||{};d.Platform.performMicrotaskCheckpoint=function(){if(!I)if(N)eval("%RunMicrotasks()");else if(H){I=!0;var a=0,b,c;do{a++;c=G;G=[];b=!1;for(var e=0;e<c.length;e++){var f=c[e];f.state_==F&&(f.check_()&&(b=!0),G.push(f))}m()&&(b=!0)}while(1E3>a&&b);x&&(d.dirtyCheckCycleCount=a);I=!1}};H&&(d.Platform.clearObservers=function(){G=[]});a.prototype=D({__proto__:b.prototype,arrayObserve:!1,connect_:function(a,b){if(w){var c=this.value_,d=this.arrayObserve,e=K.pop()||g();e.open(this);
e.observe(c,d);this.directObserver_=e}else this.oldObject_=this.copyObject(this.value_)},copyObject:function(a){var b=Array.isArray(a)?[]:{},c;for(c in a)b[c]=a[c];Array.isArray(a)&&(b.length=a.length);return b},check_:function(a,b){var c,d;if(w){if(!a)return!1;d={};c=k(this.value_,a,d)}else d=this.oldObject_,c=f(this.value_,this.oldObject_);if(r(c))return!1;w||(this.oldObject_=this.copyObject(this.value_));this.report_([c.added||{},c.removed||{},c.changed||{},function(a){return d[a]}]);return!0},
disconnect_:function(){w?(this.directObserver_.close(),this.directObserver_=void 0):this.oldObject_=void 0},deliver:function(){this.state_==F&&(w?this.directObserver_.deliver(!1):e(this))},discardChanges:function(){this.directObserver_?this.directObserver_.deliver(!0):this.oldObject_=this.copyObject(this.value_);return this.value_}});c.prototype=D({__proto__:a.prototype,arrayObserve:!0,copyObject:function(a){return a.slice()},check_:function(a){if(w){if(!a)return!1;a=A(this.value_,a)}else a=J.calcSplices(this.value_,
0,this.value_.length,this.oldObject_,0,this.oldObject_.length);if(!a||!a.length)return!1;w||(this.oldObject_=this.copyObject(this.value_));this.report_([a]);return!0}});c.applySplices=function(a,b,c){c.forEach(function(c){for(var d=[c.index,c.removed.length],e=c.index;e<c.index+c.addedCount;)d.push(b[e]),e++;Array.prototype.splice.apply(a,d)})};var O={add:!0,update:!0,"delete":!0};v.prototype={calcEditDistances:function(a,b,c,d,e,f){f=f-e+1;c=c-b+1;for(var g=Array(f),h=0;h<f;h++)g[h]=Array(c),g[h][0]=
h;for(var k=0;k<c;k++)g[0][k]=k;for(h=1;h<f;h++)for(k=1;k<c;k++)if(this.equals(a[b+k-1],d[e+h-1]))g[h][k]=g[h-1][k-1];else{var l=g[h-1][k]+1,m=g[h][k-1]+1;g[h][k]=l<m?l:m}return g},spliceOperationsFromEditDistances:function(a){for(var b=a.length-1,c=a[0].length-1,d=a[b][c],e=[];0<b||0<c;)if(0==b)e.push(2),c--;else if(0==c)e.push(3),b--;else{var f=a[b-1][c-1],g=a[b-1][c],h=a[b][c-1],k;k=g<h?g<f?g:f:h<f?h:f;k==f?(f==d?e.push(0):(e.push(1),d=f),b--,c--):k==g?(e.push(3),b--,d=g):(e.push(2),c--,d=h)}e.reverse();
return e},calcSplices:function(a,b,c,d,e,f){var g=0,k=0,l=Math.min(c-b,f-e);0==b&&0==e&&(g=this.sharedPrefix(a,d,l));c==a.length&&f==d.length&&(k=this.sharedSuffix(a,d,l-g));b+=g;e+=g;c-=k;f-=k;if(0==c-b&&0==f-e)return[];if(b==c){for(a=h(b,[],0);e<f;)a.removed.push(d[e++]);return[a]}if(e==f)return[h(b,[],c-b)];f=this.spliceOperationsFromEditDistances(this.calcEditDistances(a,b,c,d,e,f));a=void 0;c=[];for(g=0;g<f.length;g++)switch(f[g]){case 0:a&&(c.push(a),a=void 0);b++;e++;break;case 1:a||(a=h(b,
[],0));a.addedCount++;b++;a.removed.push(d[e]);e++;break;case 2:a||(a=h(b,[],0));a.addedCount++;b++;break;case 3:a||(a=h(b,[],0)),a.removed.push(d[e]),e++}a&&c.push(a);return c},sharedPrefix:function(a,b,c){for(var d=0;d<c;d++)if(!this.equals(a[d],b[d]))return d;return c},sharedSuffix:function(a,b,c){for(var d=a.length,e=b.length,f=0;f<c&&this.equals(a[--d],b[--e]);)f++;return f},calculateSplices:function(a,b){return this.calcSplices(a,0,a.length,b,0,b.length)},equals:function(a,b){return a===b}};
var J=new v,B=d;"undefined"!==typeof q&&("undefined"!==typeof t&&t.exports&&(B=q=t.exports),B=q);B.Observer=b;B.Observer.runEOM_=E;B.Observer.observerSentinel_={};B.Observer.hasObjectObserve=w;B.ArrayObserver=c;B.ArrayObserver.calculateSplices=function(a,b){return J.calculateSplices(a,b)};B.Platform=d.Platform;B.ArraySplice=v;B.ObjectObserver=a})("undefined"!==typeof d&&d&&"undefined"!==typeof t&&t?d:this||window)}).call(this,"undefined"!==typeof global?global:"undefined"!==typeof self?self:"undefined"!==
typeof window?window:{})},{}]},{},[13]);
