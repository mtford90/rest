(function e$$0(t,q,d){function n(l,f){if(!q[l]){if(!t[l]){var m="function"==typeof require&&require;if(!f&&m)return m(l,!0);if(p)return p(l,!0);m=Error("Cannot find module '"+l+"'");throw m.code="MODULE_NOT_FOUND",m;}m=q[l]={exports:{}};t[l][0].call(m.exports,function(g){var c=t[l][1][g];return n(c?c:g)},m,m.exports,e$$0,t,q,d)}return q[l].exports}for(var p="function"==typeof require&&require,l=0;l<d.length;l++)n(d[l]);return n})({1:[function(e,t,q){function d(a){n.call(this,a);this.indexAttribute=
"index"}var n=e("./reactiveQuery");q=e("./log");var p=e("./util"),l=e("./error"),r=e("./modelEvents"),f=l.InternalSiestaError,m=e("./querySet"),g=l.errorFactory(l.Components.ArrangedReactiveQuery),c=p._;q.loggerWithName("Query");d.prototype=Object.create(n.prototype);c.extend(d.prototype,{_refreshIndexes:function(){var a=this.results,b=this.indexAttribute;if(!a)throw new f("ArrangedReactiveQuery must be initialised");for(var k=0;k<a.length;k++)a[k][b]=k},_mergeIndexes:function(){for(var a=this.results,
b=[],k=[],h=[],v=0;v<a.length;v++){var y=a[v],g=y[this.indexAttribute];void 0==g?h.push(y):g>a.length?k.push(y):b[g]?h.push(y):b[g]=y}k=c.sortBy(k,function(a){return a[this.indexAttribute]}.bind(this));for(v=0;v<k.length;v++)y=k[v],a=this.results.length-k.length+v,y[this.indexAttribute]=a,b[a]=y;h=this._query._sortResults(h);for(k=0;h.length;){for(y=h.shift();b[k];)k++;b[k]=y;y[this.indexAttribute]=k}this.results=m(b,this.model)},init:function(a){var b=p.defer(a);n.prototype.init.call(this,function(a){a||
(this.model.hasAttributeNamed(this.indexAttribute)?(this._mergeIndexes(),this._query.clearOrdering()):a=g('Model "'+this.model.name+'" does not have an attribute named "'+this.indexAttribute+'"'));b.finish(a,a?null:this.results)}.bind(this));return b.promise},_handleNotif:function(a){a.field!=this.indexAttribute&&(n.prototype._handleNotif.call(this,a),this._refreshIndexes())},validateIndex:function(a){var b=this.results.length-1;if(!(0<=a&&a<=b))throw Error("Index "+a.toString()+" is out of bounds");
},swapObjectsAtIndexes:function(a,b){this.validateIndex(a);this.validateIndex(b);var k=this.results[a],h=this.results[b];if(!k)throw Error('No model at index "'+a.toString()+'"');if(!h)throw Error('No model at index "'+b.toString()+'"');this.results[b]=k;this.results[a]=h;k[this.indexAttribute]=b;h[this.indexAttribute]=a},swapObjects:function(a,b){var k=this.results.indexOf(a),h=this.results.indexOf(b);this.swapObjectsAtIndexes(k,h)},move:function(a,b){this.validateIndex(a);this.validateIndex(b);
var k=this.results.mutableCopy();(function(a,b){if(b>=this.length)for(var k=b-this.length;k--+1;)this.push(void 0)}).call(k,a,b);var h=k.splice(a,1)[0];this.emit("change",this.results=k.asModelQuerySet(this.model),{index:a,removed:[h],type:r.ModelEventType.Splice,obj:this,field:"results"});k.splice(b,0,h);this.emit("change",this.results=k.asModelQuerySet(this.model),{index:b,added:[h],type:r.ModelEventType.Splice,obj:this,field:"results"});this._refreshIndexes()}});t.exports=d},{"./error":11,"./log":14,
"./modelEvents":18,"./querySet":23,"./reactiveQuery":24,"./util":28}],2:[function(e,t,q){function d(f){var g=this;this.model=f;n.subProperties(this,this.model,["collection","collectionName","_attributeNames",{name:"idField",property:"id"},{name:"modelName",property:"name"}]);r.ProxyEventEmitter.call(this);Object.defineProperties(this,{_relationshipNames:{get:function(){var c=p.map(Object.keys(g.__proxies||{}),function(a){return g.__proxies[a]});return p.map(c,function(a){return a.isForward?a.forwardName:
a.reverseName})},enumerable:!0,configurable:!0},dirty:{get:function(){if(siesta.ext.storageEnabled)return g._id in siesta.ext.storage._unsavedObjectsHash},enumerable:!0},event:{get:function(){return this._id}}});this.removed=!1}e("./log");var n=e("./util"),p=n._;e("./error");var l=e("./modelEvents"),r=e("./events"),f=e("./cache");d.prototype=Object.create(r.ProxyEventEmitter.prototype);p.extend(d.prototype,{get:function(f){var g=n.defer(f);f=g.finish.bind(g);f(null,this);return g.promise},emit:function(f,
g){"object"==typeof f?g=f:g.type=f;g=g||{};p.extend(g,{collection:this.collectionName,model:this.model.name,_id:this._id,obj:this});l.emit(g)},remove:function(d,g){g=null==g?!0:g;var c=n.defer(d);d=c.finish.bind(c);f.remove(this);this.removed=!0;g&&this.emit(l.ModelEventType.Remove,{old:this});var a=this.model.remove;if(a)if(n.paramNames(a).length){var b=this;a.call(this,function(a){d(a,b)})}else a.call(this),d(null,this);else d(null,this);return c.promise},restore:function(d){var g=n.defer(d);d=
g.finish.bind(g);var c=function(a){a||this.emit(l.ModelEventType.New,{"new":this});d(a,this)}.bind(this);if(this.removed){f.insert(this);this.removed=!1;var a=this.model.init;a?n.paramNames(a).length?a.call(this,c):(a.call(this),c()):c()}return g.promise}});p.extend(d.prototype,{getAttributes:function(){return p.extend({},this.__values)},isInstanceOf:function(f){return this.model==f},isA:function(f){return this.model==f||this.model.isDescendantOf(f)}});p.extend(d.prototype,{_dumpString:function(f){return JSON.stringify(this._dump(f,
null,4))},_dump:function(f){f=p.extend({},this.__values);f._rev=this._rev;f._id=this._id;return f}});t.exports=d},{"./cache":8,"./error":11,"./events":12,"./log":14,"./modelEvents":18,"./util":28}],3:[function(e,t,q){function d(c){n.call(this,c);this.isReverse&&(this.related=[])}var n=e("./RelationshipProxy");e("./store");var p=e("./util"),l=p._;e("./error");var r=e("./modelEvents");e("./modelInstance");var f=e("./events").wrapArray,m=e("../vendor/observe-js/src/observe").ArrayObserver,g=e("./modelEvents").ModelEventType;
d.prototype=Object.create(n.prototype);l.extend(d.prototype,{clearReverse:function(c){var a=this;l.each(c,function(b){a.reverseProxyForInstance(b).setIdAndRelated(null)})},setReverseOfAdded:function(c){var a=this;l.each(c,function(b){a.reverseProxyForInstance(b).setIdAndRelated(a.object)})},wrapArray:function(c){var a=this;f(c,this.reverseName,this.object);c.arrayObserver||(c.arrayObserver=new m(c),c.arrayObserver.open(function(b){b.forEach(function(b){var h=b.addedCount?c.slice(b.index,b.index+b.addedCount):
[],v=b.removed;a.clearReverse(v);a.setReverseOfAdded(h);var y=a.getForwardModel();r.emit({collection:y.collectionName,model:y.name,_id:a.object._id,field:a.getForwardName(),removed:v,added:h,type:g.Splice,index:b.index,obj:a.object})})}))},get:function(c){var a=p.defer(c);c=a.finish.bind(a);c(null,this.related);return a.promise},validate:function(c){c=Object.prototype.toString.call(c);if(this.isForward){if("[object Array]"==c)return"Cannot assign array forward oneToMany ("+c+"): "+this.forwardName}else if("[object Array]"!=
c)return"Cannot scalar to reverse oneToMany ("+c+"): "+this.reverseName;return null},set:function(c,a){this.checkInstalled();if(c){var b;if(b=this.validate(c))return b;this.clearReverseRelated(a);this.setIdAndRelated(c,a);this.isReverse&&this.wrapArray(this.related);this.setIdAndRelatedReverse(c,a)}else this.clearReverseRelated(a),this.setIdAndRelated(c,a)},install:function(c){n.prototype.install.call(this,c);this.isReverse&&(c["splice"+p.capitaliseFirstLetter(this.reverseName)]=l.bind(this.splice,
this),this.wrapArray(this.related))}});t.exports=d},{"../vendor/observe-js/src/observe":44,"./RelationshipProxy":6,"./error":11,"./events":12,"./modelEvents":18,"./modelInstance":19,"./store":26,"./util":28}],4:[function(e,t,q){function d(d){n.call(this,d)}var n=e("./RelationshipProxy");e("./store");var p=e("./util");q=p._;e("./error");e("./modelEvents");e("./modelInstance");d.prototype=Object.create(n.prototype);q.extend(d.prototype,{validate:function(d){return"[object Array]"==Object.prototype.toString.call(d)?
"Cannot assign array to one to one relationship":null},set:function(d,e){this.checkInstalled();if(d){var f;if(f=this.validate(d))return f;this.clearReverseRelated(e);this.setIdAndRelated(d,e);this.setIdAndRelatedReverse(d,e)}else this.clearReverseRelated(e),this.setIdAndRelated(d,e)},get:function(d){var e=p.defer(d);d=e.finish.bind(e);d(null,this.related);return e.promise}});t.exports=d},{"./RelationshipProxy":6,"./error":11,"./modelEvents":18,"./modelInstance":19,"./store":26,"./util":28}],5:[function(e,
t,q){function d(a,b){var k={},h;for(h in b)b.hasOwnProperty(h)&&"__"==h.slice(0,2)&&(k[h.slice(2)]=b[h],delete b[h]);g.extend(this,{model:a,query:b,opts:k});k.order=k.order||[];l.isArray(k.order)||(k.order=[k.order])}function n(a){var b=a.name;a=p._localCacheByType[a.collectionName];var k;a&&(k=a[b]||{});return k}q=e("./log");var p=e("./cache"),l=e("./util"),r=e("./error"),f=e("./querySet"),m=r.errorFactory(r.Components.Query),g=l._,c=q.loggerWithName("Query");g.extend(d,{comparators:{e:function(a){var b=
a.object[a.field];c.trace&&c.trace(a.field+": "+(null===b?"null":void 0===b?"undefined":b.toString())+" == "+a.value.toString());return b==a.value},lt:function(a){return a.invalid?!1:a.object[a.field]<a.value},gt:function(a){return a.invalid?!1:a.object[a.field]>a.value},lte:function(a){return a.invalid?!1:a.object[a.field]<=a.value},gte:function(a){return a.invalid?!1:a.object[a.field]>=a.value},contains:function(a){return a.invalid?!1:-1<a.object[a.field].indexOf(a.value)}},registerComparator:function(a,
b){this.comparators[a]||(this.comparators[a]=b)}});g.extend(d.prototype,{execute:function(a){var b=l.defer(a);a=b.finish.bind(b);this._executeInMemory(a);return b.promise},_dump:function(a){return a?"{}":{}},sortFunc:function(a){for(var b=function(a,b){return function(v,k){var h=v[b],c=k[b];"string"==typeof h||h instanceof String&&"string"==typeof c||c instanceof String?h=a?h.localeCompare(c):c.localeCompare(h):(h instanceof Date&&(h=h.getTime()),c instanceof Date&&(c=c.getTime()),h=a?h-c:c-h);return h}},
k=l,h=0;h<a.length;h++)var v=a[h],k=k.thenBy(b(v.ascending,v.field));return k==l?null:k},_sortResults:function(a){var b=this.opts.order;a&&b&&(b=g.map(b,function(a){a=a.split("-");var b=!0,v=null;1<a.length?(v=a[1],b=!1):v=a[0];return{field:v,ascending:b}}.bind(this)),b=this.sortFunc(b),a.immutable&&(a=a.mutableCopy()),b&&a.sort(b));return a},_getCacheByLocalId:function(){return g.reduce(this.model.descendants,function(a,b){return g.extend(a,n(b))},g.extend({},n(this.model)))},_executeInMemory:function(a){var b=
function(){for(var b=this._getCacheByLocalId(),h=Object.keys(b),v=[],c,g=0;g<h.length;g++){var d=b[h[g]],e=this.objectMatchesQuery(d);if("string"==typeof e){c=m(e);break}else e&&v.push(d)}v=this._sortResults(v);a(c,c?null:f(v,this.model))}.bind(this);this.opts.ignoreInstalled?b():siesta._afterInstall(b)},clearOrdering:function(){this.opts.order=null},objectMatchesOrQuery:function(a,b){for(var k in b)if(b.hasOwnProperty(k)&&this.objectMatchesBaseQuery(a,b[k]))return!0;return!1},objectMatchesAndQuery:function(a,
b){for(var k in b)if(b.hasOwnProperty(k)&&!this.objectMatchesBaseQuery(a,b[k]))return!1;return!0},splitMatches:function(a,b,k){var h="e",v=b.split("."),c=v[v.length-1].split("__");2==c.length?(b=c[0],h=c[1]):b=c[0];v[v.length-1]=b;g.each(v.slice(0,v.length-1),function(b){a=a[b]});v=a[b];return(c=d.comparators[h])?c({object:a,field:b,value:k,invalid:null===v||void 0===v}):'No comparator registered for query operation "'+h+'"'},objectMatches:function(a,b,k,h){if("$or"==b){if(!this.objectMatchesOrQuery(a,
h.$or))return!1}else if("$and"==b){if(!this.objectMatchesAndQuery(a,h.$and))return!1}else{a=this.splitMatches(a,b,k);if("boolean"!=typeof a)return a;if(!a)return!1}return!0},objectMatchesBaseQuery:function(a,b){for(var k=Object.keys(b),h=0;h<k.length;h++){var v=k[h],v=this.objectMatches(a,v,b[v],b);if("boolean"!=typeof v)return v;if(!v)return!1}return!0},objectMatchesQuery:function(a){return this.objectMatchesBaseQuery(a,this.query)}});t.exports=d},{"./cache":8,"./error":11,"./log":14,"./querySet":23,
"./util":28}],6:[function(e,t,q){function d(c){var a=this;c=c||{};l.extend(this,{object:null,related:null});Object.defineProperties(this,{isForward:{get:function(){return!a.isReverse},set:function(b){a.isReverse=!b},enumerable:!0}});p.extendFromOpts(this,c,{reverseModel:null,forwardModel:null,forwardName:null,reverseName:null,isReverse:null});this.cancelListens={}}var n=e("./error").InternalSiestaError;e("./store");var p=e("./util"),l=p._;e("./query");e("./log");e("./cache");var r=e("./events").wrapArray,
f=e("../vendor/observe-js/src/observe").ArrayObserver,m=e("./modelEvents"),g=m.ModelEventType;l.extend(d,{});l.extend(d.prototype,{install:function(c){if(c){if(this.object)throw new n("Already installed.");this.object=c;var a=this,b=this.getForwardName();Object.defineProperty(c,b,{get:function(){return a.related},set:function(b){a.set(b)},configurable:!0,enumerable:!0});c.__proxies||(c.__proxies={});c.__proxies[b]=this;c._proxies||(c._proxies=[]);c._proxies.push(this)}else throw new n("No object passed to relationship install");
}});l.extend(d.prototype,{set:function(c,a){throw new n("Must subclass RelationshipProxy");},get:function(c){throw new n("Must subclass RelationshipProxy");}});l.extend(d.prototype,{proxyForInstance:function(c,a){var b=a?this.getReverseName():this.getForwardName(),k=a?this.reverseModel:this.forwardModel;if(p.isArray(c))k=l.map(c,function(a){return a.__proxies[b]});else{var h=c.__proxies[b];if(!h)throw new n('No proxy with name "'+b+'" on mapping '+k.name);k=h}return k},reverseProxyForInstance:function(c){return this.proxyForInstance(c,
!0)},getReverseName:function(){return this.isForward?this.reverseName:this.forwardName},getForwardName:function(){return this.isForward?this.forwardName:this.reverseName},getForwardModel:function(){return this.isForward?this.forwardModel:this.reverseModel},clearRemovalListener:function(c){c=c._id;var a=this.cancelListens[c];a&&(a(),this.cancelListens[c]=null)},listenForRemoval:function(c){this.cancelListens[c._id]=c.listen(function(a){a.type==g.Remove&&(p.isArray(this.related)?(a=this.related.indexOf(c),
this.splice(a,1)):this.setIdAndRelated(null),this.clearRemovalListener(c))}.bind(this))},setIdAndRelated:function(c,a){a=a||{};a.disableevents||this.registerSetChange(c);var b=this.related;b&&this.clearRemovalListener(b);c?p.isArray(c)?(this.related=c,c.forEach(function(a){this.listenForRemoval(a)}.bind(this))):(this.related=c,this.listenForRemoval(c)):this.related=null},checkInstalled:function(){if(!this.object)throw new n("Proxy must be installed on an object before can use it.");},splicer:function(c){c=
c||{};return function(a,b){c=c||{};c.disableevents||this.registerSpliceChange.apply(this,arguments);var k=Array.prototype.slice.call(arguments,2);return l.partial(this.related.splice,a,b).apply(this.related,k)}.bind(this)},clearReverseRelated:function(c){c=c||{};var a=this;if(this.related){var b=this.reverseProxyForInstance(this.related),b=p.isArray(b)?b:[b];l.each(b,function(b){if(p.isArray(b.related)){var h=b.related.indexOf(a.object);b.makeChangesToRelatedWithoutObservations(function(){b.splicer(c)(h,
1)})}else b.setIdAndRelated(null,c)})}},setIdAndRelatedReverse:function(c,a){var b=this,k=this.reverseProxyForInstance(c),k=p.isArray(k)?k:[k];l.each(k,function(h){p.isArray(h.related)?h.makeChangesToRelatedWithoutObservations(function(){h.splicer(a)(h.related.length,0,b.object)}):(h.clearReverseRelated(a),h.setIdAndRelated(b.object,a))})},makeChangesToRelatedWithoutObservations:function(c){this.related?(this.related.arrayObserver.close(),this.related.arrayObserver=null,c(),this.wrapArray(this.related)):
c()},registerSetChange:function(c){var a=this.object;if(!a)throw new n("Proxy must have an object associated");var b=a.model.name,k=a.collectionName,h=this.related;p.isArray(h)&&!h.length&&(h=null);m.emit({collection:k,model:b,_id:a._id,field:this.getForwardName(),old:h,"new":c,type:g.Set,obj:a})},registerSpliceChange:function(c,a){var b=Array.prototype.slice.call(arguments,2);m.emit({collection:this.object.collectionName,model:this.object.model.name,_id:this.object._id,field:this.getForwardName(),
index:c,removed:this.related?this.related.slice(c,c+a):null,added:b.length?b:[],type:g.Splice,obj:this.object})},wrapArray:function(c){var a=this;r(c,this.reverseName,this.object);c.arrayObserver||(c.arrayObserver=new f(c),c.arrayObserver.open(function(b){b.forEach(function(b){var h=b.addedCount?c.slice(b.index,b.index+b.addedCount):[],v=a.getForwardModel();m.emit({collection:v.collectionName,model:v.name,_id:a.object._id,field:a.getForwardName(),removed:b.removed,added:h,type:g.Splice,obj:a.object})})}))},
splice:function(){this.splicer({}).apply(this,arguments)}});t.exports=d},{"../vendor/observe-js/src/observe":44,"./cache":8,"./error":11,"./events":12,"./log":14,"./modelEvents":18,"./query":22,"./store":26,"./util":28}],7:[function(e,t,q){t.exports={OneToMany:"OneToMany",OneToOne:"OneToOne",ManyToMany:"ManyToMany"}},{}],8:[function(e,t,q){function d(a){var b=a.name;if(a=k[a.collectionName])if(b=a[b]){a=[];for(var h in b)b.hasOwnProperty(h)&&a.push(b[h]);if(1<a.length)throw new g("A singleton model has more than 1 object in the cache! This is a serious error. Either a model has been modified after objects have already been created, or something has gonevery wrong. Please file a bug report if the latter.");
if(a.length)return a[0]}return null}function n(b,c){var k=c.model.name,g=c.model.collectionName;if(h[g]&&(k=h[g][k]))return(k=k[b])?a.debug&&a.debug("Remote cache hit: "+k._dump(!0)):a.debug&&a.debug("Remote cache miss: "+b),k;a.debug&&a.debug("Remote cache miss: "+b);return null}function p(b,c,k){if(b){var f=b.model.collectionName;if(f){h[f]||(h[f]={});var d=b.model.name;if(d)if(h[f][d]||(h[f][d]={}),k&&(h[f][d][k]=null),k=h[f][d][c]){if(b!=k)throw c="Object "+f.toString()+":"+d.toString()+"["+b.model.id+
'="'+c+'"] already exists in the cache. This is a serious error, please file a bug report if you are experiencing this out in the wild',a.error(c,{obj:b,cachedObject:k}),new g(c);a.debug.isEnabled&&a.debug("Object has already been inserted: "+b._dump(!0))}else h[f][d][c]=b,a.debug.isEnabled&&a.debug("Remote cache insert: "+b._dump(!0)),a.trace.isEnabled&&a.trace("Remote cache now looks like: "+l(!0));else throw new g("Model has no type",{model:b.model,obj:b});}else throw new g("Model has no collection",
{model:b.model,obj:b});}else throw a.error("Must pass an object when inserting to cache"),new g("Must pass an object when inserting to cache");}function l(a){var b={},k;for(k in h)if(h.hasOwnProperty(k)){var g={};b[k]=g;var f=h[k],d;for(d in f)if(f.hasOwnProperty(d)){var e={};g[d]=e;var l=f[d],m;for(m in l)l.hasOwnProperty(m)&&l[m]&&(e[m]=l[m]._dump())}}return a?c.prettyPrint((b,null,4)):b}function r(a){var h={},k;for(k in b)b.hasOwnProperty(k)&&(h[k]=b[k]._dump());return a?c.prettyPrint((h,null,
4)):h}function f(h){a.debug.isEnabled&&a.debug("get",h);var k,c;if(k=h._id){(c=b[k])?a.debug.isEnabled&&a.debug("Local cache hit: "+c._dump(!0)):a.debug.isEnabled&&a.debug("Local cache miss: "+k);if(c)return c;if(h.model)return k=h.model.id,c=h[k],a.debug.isEnabled&&a.debug(k+"="+c),n(c,h)}else if(h.model){k=h.model.id;if(c=h[k])return n(c,h);if(h.model.singleton)return d(h.model)}else a.warn("Invalid opts to cache",{opts:h});return null}function m(a){var b={_id:a._id},h=a.model;h.id&&a[h.id]&&(b.model=
h,b[h.id]=a[h.id]);return!!f(b)}t=e("./log");var g=e("./error").InternalSiestaError,c=e("./util"),a=t.loggerWithName("Cache"),b={},k={},h={};q._remoteCache=function(){return h};q._localCache=function(){return b};Object.defineProperty(q,"_localCacheByType",{get:function(){return k}});q.get=f;q.insert=function(h){var c=h._id;if(c){var f=h.model.collectionName,d=h.model.name;a.debug.isEnabled&&a.debug("Local cache insert: "+h._dumpString());if(!b[c])b[c]=h,a.trace.isEnabled&&a.trace("Local cache now looks like: "+
r(!0)),k[f]||(k[f]={}),k[f][d]||(k[f][d]={}),k[f][d][c]=h;else if(b[c]!=h)throw h='Object with _id="'+c.toString()+'" is already in the cache. This is a serious error. Please file a bug report if you are experiencing this out in the wild',a.error(h),new g(h);}c=h.idField;(f=h[c])?p(h,f):a.debug.isEnabled&&a.debug('No remote id ("'+c+'") so wont be placing in the remote cache',h)};q.remoteInsert=p;q.reset=function(){h={};b={};k={}};q._dump=function(a){var b={localCache:r(),remoteCache:l()};return a?
c.prettyPrint((b,null,4)):b};q.contains=m;q.remove=function(a){if(m(a)){var c=a.model.collectionName,f=a.model.name,d=a._id;if(!f)throw g("No mapping name");if(!c)throw g("No collection name");if(!d)throw g("No _id");delete k[c][f][d];delete b[d];a.model.id&&(a=a[a.model.id])&&delete h[c][f][a]}else throw new g("Object was not in cache.");};q.getSingleton=d},{"./error":11,"./log":14,"./util":28}],9:[function(e,t,q){function d(a,b){var c=this;if(!a)throw Error("Collection must have a name");b=b||{};
m.extendFromOpts(this,b,{baseURL:""});g.extend(this,{name:a,_rawModels:{},_models:{},_opts:b,installed:!1});Object.defineProperties(this,{dirty:{get:function(){if(siesta.ext.storageEnabled)return!!Object.keys(siesta.ext.storage._unsavedObjectsByCollection[c.name]||{}).length},enumerable:!0}});n.register(this);f.ProxyEventEmitter.call(this,this.name)}q=e("./log");var n=e("./collectionRegistry").CollectionRegistry,p=e("./error").InternalSiestaError,l=e("./model"),r=e("extend");e("../vendor/observe-js/src/observe");
var f=e("./events"),m=e("./util"),g=m._,c=e("./error"),a=c.errorFactory(c.Components.Collection);e("./cache");var b=["PUT","PATCH","POST","DELETE"],k=q.loggerWithName("Collection");d.prototype=Object.create(f.ProxyEventEmitter.prototype);g.extend(d.prototype,{install:function(a){var b=m.defer(a),c=this;if(this.installed)throw new p('Collection "'+this.name+'" has already been installed');var f=[],d;for(d in this._models)this._models.hasOwnProperty(d)&&f.push(this._models[d]);k.info.isEnabled&&k.info("There are "+
f.length.toString()+" mappings to install");f.length?(a=g.map(f,function(a){return g.bind(a.install,a)}),m.async.parallel(a,function(a){if(a)k.error("Failed to install collection",a);else{c.installed=!0;var h=[];g.each(f,function(a){k.info.isEnabled&&k.info('Installing relationships for mapping with name "'+a.name+'"');(a=a.installRelationships())&&h.push(a)});h.length||g.each(f,function(a){k.info.isEnabled&&k.info('Installing reverse relationships for mapping with name "'+a.name+'"');(a=a.installReverseRelationships())&&
h.push(a)});1==h.length?a=h[0]:h.length&&(a=h)}c._finaliseInstallation(a,b.finish.bind(b))})):c._finaliseInstallation(null,b.finish.bind(b));return b.promise},_finaliseInstallation:function(b,c){b&&(b=a("Errors were encountered whilst setting up the collection",{errors:b}));b||(this.installed=!0,e("./index")[this.name]=this);c(b)},_model:function(a,b){if(a){this._rawModels[a]=b;b=r(!0,{},b);b.name=a;b.collection=this;var c=new l(b);this._models[a]=c;return this[a]=c}throw Error("No name specified when creating mapping");
},model:function(){if(this.installed)throw Error("Cannot create new models once the object graph is established!");var a=this;return arguments.length?1==arguments.length?m.isArray(arguments[0])?g.map(arguments[0],function(b){return a._model(b.name,b)}):this._model(arguments[0].name,arguments[0]):"string"==typeof arguments[0]?this._model(arguments[0],arguments[1]):g.map(arguments,function(b){return a._model(b.name,b)}):null},descriptor:function(a){var c=[];if(siesta.ext.httpEnabled){a.collection=this;
for(var k=siesta.ext.http._resolveMethod(a.method),f=[],g=[],d=0;d<k.length;d++){var e=k[d];-1<b.indexOf(e)?f.push(e):g.push(e)}f.length&&(k=r({},a),k.method=f,k=new siesta.ext.http.RequestDescriptor(k),siesta.ext.http.DescriptorRegistry.registerRequestDescriptor(k),c.push(k));g.length&&(a=r({},a),a.method=g,a=new siesta.ext.http.ResponseDescriptor(a),siesta.ext.http.DescriptorRegistry.registerResponseDescriptor(a),c.push(a))}else throw Error("HTTP module not installed.");return c},_dump:function(a){var b=
{};b.installed=this.installed;b.docId=this._docId;b.name=this.name;b.baseURL=this.baseURL;return a?m.prettyPrint(b):b},count:function(a){var b=m.defer(a);a=g.map(this._models,function(a){return g.bind(a.count,a)});m.async.parallel(a,function(a,c){var k;a||(k=g.reduce(c,function(a,b){return a+b},0));b.finish(a,k)});return b.promise}});t.exports=d},{"../vendor/observe-js/src/observe":44,"./cache":8,"./collectionRegistry":10,"./error":11,"./events":12,"./index":13,"./log":14,"./model":17,"./util":28,
extend:42}],10:[function(e,t,q){function d(){if(!this)return new d;this.collectionNames=[]}var n=e("./util")._;n.extend(d.prototype,{register:function(d){var e=d.name;this[e]=d;this.collectionNames.push(e)},reset:function(){var d=this;n.each(this.collectionNames,function(e){delete d[e]});this.collectionNames=[]}});q.CollectionRegistry=new d},{"./util":28}],11:[function(e,t,q){function d(d,e,f){this.message=d;this.context=e;(f=f||arguments.callee)&&Error.captureStackTrace&&Error.captureStackTrace(this,
f)}function n(d,e,f){f=f||{};this.component=d;this.message=e;for(var m in f)f.hasOwnProperty(m)&&(this[m]=f[m]);this.isUserError=!0}d.prototype=Object.create(Error.prototype);d.prototype.name="InternalSiestaError";d.prototype.constructor=d;e={Unknown:0,NoDescriptorMatched:1};var p={Mapping:"Mapping",HTTP:"HTTP",ReactiveQuery:"ReactiveQuery",ArrangedReactiveQuery:"ArrangedReactiveQuery",Collection:"Collection",Query:"Query"};q={};q[e.NoDescriptorMatched]="No descriptor matched the HTTP response/request.";
t.exports={InternalSiestaError:d,SiestaUserError:n,ErrorCode:e,ErrorField:{Message:"message",Code:"code"},Message:q,Components:p,errorFactory:function(d){if(d in p)return function(e,f){return new n(d,e,f)};throw new n('No such component "'+d+'"');}}},{}],12:[function(e,t,q){function d(f){p.extend(this,{event:f,listeners:{}})}q=e("events").EventEmitter;var n=e("../vendor/observe-js/src/observe").ArrayObserver,p=e("./util")._,l=e("./modelEvents"),r=new q;r.setMaxListeners(100);p.extend(d.prototype,
{listen:function(f,d){if("function"==typeof f)d=f,f=null;else{var g=d;d=function(a){a=a||{};f?a.type==f&&g(a):g(a)};var c=this.listeners;f&&(c[f]||(c[f]=[]),c[f].push(d))}r.on(this.event,d);return function(){this._removeListener(d,f)}.bind(this)},listenOnce:function(f,d){var g=this.event;if("function"==typeof f)d=f,f=null;else{var c=d;d=function(a){a=a||{};f?a.type==f&&(r.removeListener(g,d),c(a)):c(a)}}return f?r.on(g,d):r.once(g,d)},_removeListener:function(d,e){if(e){var g=this.listeners[e],c=
g.indexOf(d);g.splice(c,1)}return r.removeListener(this.event,d)},emit:function(d,e){"object"==typeof d?e=d:(e=e||{},e.type=d);r.emit.call(r,this.event,e)},_removeAllListeners:function(d){(this.listeners[d]||[]).forEach(function(d){r.removeListener(this.event,d)}.bind(this));this.listeners[d]=[]},removeAllListeners:function(d){if(d)this._removeAllListeners(d);else for(d in this.listeners)this.listeners.hasOwnProperty(d)&&this._removeAllListeners(d)}});p.extend(d.prototype,{on:d.prototype.listen});
p.extend(r,{ProxyEventEmitter:d,wrapArray:function(d,e,g){d.observer||(d.observer=new n(d),d.observer.open(function(c){-1<g._attributeNames.indexOf(e)&&c.forEach(function(a){l.emit({collection:g.collectionName,model:g.model.name,_id:g._id,index:a.index,removed:a.removed,added:a.addedCount?d.slice(a.index,a.index+a.addedCount):[],type:l.ModelEventType.Splice,field:e,obj:g})})}))}});t.exports=r},{"../vendor/observe-js/src/observe":44,"./modelEvents":18,"./util":28,events:38}],13:[function(e,t,q){var d=
e("./util"),n=e("./collectionRegistry").CollectionRegistry,p=e("./collection"),l=e("./cache");q=e("./model");var r=e("./error"),f=e("./events"),m=e("./RelationshipType"),g=e("./reactiveQuery"),c=e("./manyToManyProxy"),a=e("./oneToOneProxy"),b=e("./oneToManyProxy"),k=e("./relationshipProxy"),h=e("./modelEvents"),v=e("./Query"),y=e("./querySet"),C=e("./log"),A=d._,x=function(a){x.ext||(x.ext={});A.extend(x.ext,a||{});return x};Object.defineProperty(x,"q",{get:function(){return this._q||window.q||window.Q},
set:function(a){this._q=a}});A.extend(x,{on:f.on.bind(f),off:f.removeListener.bind(f),once:f.once.bind(f),removeAllListeners:f.removeAllListeners.bind(f)});A.extend(x,{removeListener:x.off,addListener:x.on});A.extend(x,{RelationshipType:m,ModelEventType:h.ModelEventType,log:C.Level,InsertionPolicy:g.InsertionPolicy,_internal:{log:C,Model:q,error:r,ModelEventType:h.ModelEventType,ModelInstance:e("./modelInstance"),extend:e("extend"),MappingOperation:e("./mappingOperation"),events:f,ProxyEventEmitter:f.ProxyEventEmitter,
cache:e("./cache"),modelEvents:h,CollectionRegistry:e("./collectionRegistry").CollectionRegistry,Collection:p,utils:d,util:d,_:d._,querySet:y,observe:e("../vendor/observe-js/src/observe"),Query:v,Store:e("./store"),ManyToManyProxy:c,OneToManyProxy:b,OneToOneProxy:a,RelationshipProxy:k},_:d._,async:d.async,isArray:d.isArray,isString:d.isString});x.ext={};var w=!1,B=!1;A.extend(x,{reset:function(a){B=w=!1;delete this.queuedTasks;l.reset();n.reset();f.removeAllListeners();x.ext.httpEnabled&&x.ext.http.DescriptorRegistry.reset();
x.ext.storageEnabled?x.ext.storage._reset(a):a()},resetData:function(a){var b=d.defer(a);a=b.finish.bind(b);x.ext.storage._reset(function(){var b=[],c=n.collectionNames.reduce(function(a,c){var k=n[c]._models;b.push(c);Object.keys(k).forEach(function(b){var c=k[b];a.push(function(a){c.all(function(b,c){b||c.remove();a(b)})})});return a},[]);d.async.series([A.partial(d.async.parallel,c)],a)});return b.promise},collection:function(a,b){return new p(a,b)},install:function(a){if(B||w)throw new r.InternalSiestaError("Already installing...");
B=!0;var b=d.defer(a);a=b.finish.bind(b);var c=A.map(n.collectionNames,function(a){return function(b){n[a].install(b)}}),k=this;x.async.series(c,function(b){if(b)a(b);else{if(x.ext.httpEnabled){b=function(a){Object.keys(a).forEach(function(b){a[b].forEach(function(a){a=a._resolveCollectionAndModel();console.log("error",a);a&&c.push(a)})})};var c=[],h=x.ext.http.DescriptorRegistry,d=h.responseDescriptors;b(h.requestDescriptors);b(d);console.log("errors",c);if(c.length){a(c);return}}x.ext.storageEnabled?
x.ext.storage._load(function(b){b||(w=!0,k.queuedTasks&&k.queuedTasks.execute());a(b)}):(w=!0,k.queuedTasks&&k.queuedTasks.execute(),a())}});return b.promise},_pushTask:function(a){this.queuedTasks||(this.queuedTasks=new function(){this.tasks=[];this.execute=function(){this.tasks.forEach(function(a){a()});this.tasks=[]}.bind(this)});this.queuedTasks.tasks.push(a)},_afterInstall:function(a){w?a():(B||this.install(function(a){a&&console.error("Error setting up siesta",a);delete this.queuedTasks}.bind(this)),
w?a():this._pushTask(a))},setLogLevel:function(a,b){C.loggerWithName(a).setLevel(b)},notify:d.next,registerComparator:v.bind(v)});Object.defineProperties(x,{_canChange:{get:function(){return!(B||w)}}});"undefined"!=typeof window&&(window.siesta=x);t.exports=x;e("../http");e("../storage")},{"../http":33,"../storage":43,"../vendor/observe-js/src/observe":44,"./Query":5,"./RelationshipType":7,"./cache":8,"./collection":9,"./collectionRegistry":10,"./error":11,"./events":12,"./log":14,"./manyToManyProxy":15,
"./mappingOperation":16,"./model":17,"./modelEvents":18,"./modelInstance":19,"./oneToManyProxy":20,"./oneToOneProxy":21,"./querySet":23,"./reactiveQuery":24,"./relationshipProxy":25,"./store":26,"./util":28,extend:42}],14:[function(e,t,q){function d(e){if(!this)return new d(e);this.name=e;l[e]=d.Level.warn;this.trace=n(this,p.bind(console.debug?console.debug:console.log,console),d.Level.trace);this.debug=n(this,p.bind(console.debug?console.debug:console.log,console),d.Level.debug);this.info=n(this,
p.bind(console.info?console.info:console.log,console),d.Level.info);this.log=n(this,p.bind(console.log,console),d.Level.info);this.warn=n(this,p.bind(console.warn?console.warn:console.log,console),d.Level.warning);this.error=n(this,p.bind(console.error?console.error:console.log,console),d.Level.error);this.fatal=n(this,p.bind(console.error?console.error:console.log,console),d.Level.fatal)}function n(d,f,e){var g=function(c){d.performLog(f,e,c,arguments)};Object.defineProperty(g,"isEnabled",{get:function(){var c=
d.currentLevel();return e>=c},enumerable:!0,configurable:!0});g.f=f;g.logger=d;g.level=e;return g}var p=e("./util")._,l={};d.Level={trace:0,debug:1,info:2,warning:3,warn:3,error:4,fatal:5};d.LevelText={};d.LevelText[d.Level.trace]="TRACE";d.LevelText[d.Level.debug]="DEBUG";d.LevelText[d.Level.info]="INFO ";d.LevelText[d.Level.warning]="WARN ";d.LevelText[d.Level.error]="ERROR";d.levelAsText=function(d){return this.LevelText[d]};d.loggerWithName=function(e){return new d(e)};d.prototype.currentLevel=
function(){var e=l[this.name];return e?e:d.Level.trace};d.prototype.setLevel=function(d){l[this.name]=d};d.prototype.override=function(e,f,l){var g=this[d.levelAsText(e).trim().toLowerCase()].f,c=Array.prototype.slice.call(arguments,3,arguments.length);this.performLog(g,e,l,c,f)};d.prototype.performLog=function(e,f,l,g,c){if((void 0!==c?c:this.currentLevel())<=f){e=p.partial(e,d.levelAsText(f)+" ["+this.name+"]: "+l);f=[];for(l=0;l<g.length;l++)f[l]=g[l];f.splice(0,1);e.apply(e,f)}};t.exports=d},
{"./util":28}],15:[function(e,t,q){function d(c){n.call(this,c);this.related=[];this.relatedCancelListeners={}}var n=e("./RelationshipProxy");e("./store");var p=e("./util"),l=p._;e("./error");var r=e("./modelEvents"),f=e("./events").wrapArray;e("./modelInstance");var m=e("../vendor/observe-js/src/observe").ArrayObserver,g=e("./modelEvents").ModelEventType;d.prototype=Object.create(n.prototype);l.extend(d.prototype,{clearReverse:function(c){var a=this;l.each(c,function(b){var c=a.reverseProxyForInstance(b),
h=c.related.indexOf(a.object);c.makeChangesToRelatedWithoutObservations(function(){c.splice(h,1)})})},setReverseOfAdded:function(c){var a=this;l.each(c,function(b){var c=a.reverseProxyForInstance(b);c.makeChangesToRelatedWithoutObservations(function(){c.splice(0,0,a.object)})})},wrapArray:function(c){var a=this;f(c,this.reverseName,this.object);c.arrayObserver||(c.arrayObserver=new m(c),c.arrayObserver.open(function(b){b.forEach(function(b){var h=b.addedCount?c.slice(b.index,b.index+b.addedCount):
[],d=b.removed;a.clearReverse(d);a.setReverseOfAdded(h);var e=a.getForwardModel();r.emit({collection:e.collectionName,model:e.name,_id:a.object._id,field:a.getForwardName(),removed:d,added:h,type:g.Splice,index:b.index,obj:a.object})})}))},get:function(c){var a=p.defer(c);c=a.finish.bind(a);c(null,this.related);return a.promise},validate:function(c){return"[object Array]"!=Object.prototype.toString.call(c)?"Cannot assign scalar to many to many":null},set:function(c,a){this.checkInstalled();if(c){var b;
if(b=this.validate(c))return b;this.clearReverseRelated(a);this.setIdAndRelated(c,a);this.wrapArray(c);this.setIdAndRelatedReverse(c,a)}else this.clearReverseRelated(a),this.setIdAndRelated(c,a)},install:function(c){n.prototype.install.call(this,c);this.wrapArray(this.related);c["splice"+p.capitaliseFirstLetter(this.reverseName)]=l.bind(this.splice,this)},registerRemovalListener:function(c){this.relatedCancelListeners[c._id]=c.listen(function(a){}.bind(this))}});t.exports=d},{"../vendor/observe-js/src/observe":44,
"./RelationshipProxy":6,"./error":11,"./events":12,"./modelEvents":18,"./modelInstance":19,"./store":26,"./util":28}],16:[function(e,t,q){function d(c){this._opts=c;r.extendFromOpts(this,c,{model:null,data:null,objects:[],disableevents:!1,_ignoreInstalled:!1,callInit:!0});f.extend(this,{errors:[],subTaskResults:{},_newObjects:[]})}var n=e("./store"),p=e("./modelInstance");q=e("./log");e("./error");var l=e("./cache"),r=e("./util"),f=r._,m=r.async;e("./modelEvents");var g=q.loggerWithName("Mapping");
g.setLevel(q.Level.trace);f.extend(d.prototype,{mapAttributes:function(){for(var c=0;c<this.data.length;c++){var a=this.data[c],b=this.objects[c];a!=b&&b&&(f.each(this.model._attributeNames,function(c){void 0!==a[c]&&(this.disableevents?b.__values[c]=a[c]:b[c]=a[c])}.bind(this)),a._rev&&(b._rev=a._rev))}},_map:function(){var c=this,a;this.mapAttributes();var b=f.keys(c.subTaskResults);f.each(b,function(b){for(var h=c.subTaskResults[b],d=h.indexes,h=h.objects,g=c.getRelatedData(b).relatedData,h=r.unflattenArray(h,
g),g=0;g<h.length;g++){var e=d[g],f=c.errors[e];a=f?f[b]:null;if(!a){var f=h[g],l=c.objects[e];l&&(a=l.__proxies[b].set(f,{disableevents:c.disableevents}))&&(c.errors[e]||(c.errors[e]={}),c.errors[e][b]=a)}}})},_lookup:function(c){var a=r.defer(c);c=a.finish.bind(a);for(var b=this,k=[],h=[],d=0;d<this.data.length;d++)if(!this.objects[d]){var e,m=this.data[d];e="string"==typeof m||"number"==typeof m||m instanceof String;m?e?(e={index:d,datum:{}},e.datum[b.model.id]=m,k.push(e)):m instanceof p?this.objects[d]=
m:m._id?h.push({index:d,datum:m}):m[b.model.id]?k.push({index:d,datum:m}):this.objects[d]=b._new():this.objects[d]=null}r.async.parallel([function(a){var c=f.pluck(f.pluck(h,"datum"),"_id");c.length?n.getMultipleLocal(c,function(k,d){if(!k)for(var g=0;g<c.length;g++){var e=d[g],f=c[g],v=h[g];e||(e=l.get({_id:f}))||(e=b._new({_id:f},!b.disableevents));b.objects[v.index]=e}a(k)}):a()},function(a){var c=f.pluck(f.pluck(k,"datum"),b.model.id);c.length?(g.trace.isEnabled&&g.trace("Looking up remoteIdentifiers: "+
r.prettyPrint(c)),n.getMultipleRemote(c,b.model,function(h,e){if(!h){if(g.trace.isEnabled){var f={};for(d=0;d<e.length;d++)f[c[d]]=e[d]?e[d]._id:null;g.trace("Results for remoteIdentifiers: "+r.prettyPrint(f))}for(d=0;d<e.length;d++){var y=e[d],f=k[d];if(y)b.objects[f.index]=y;else{var y=c[d],m={model:b.model};m[b.model.id]=y;(m=l.get(m))?b.objects[f.index]=m:(b.objects[f.index]=b._new(),b.objects[f.index][b.model.id]=y)}}}a(h)})):a()}],c);return a.promise},_lookupSingleton:function(c){var a=r.defer(c);
c=a.finish.bind(a);for(var b=f.pluck(this.data,"_id"),k,h=0;h<b.length;h++)if(b[h]){k={_id:b[h]};break}for(var b=l.getSingleton(this.model)||this._new(k),h=0;h<this.data.length;h++)this.objects[h]=b;c();return a.promise},_new:function(){var c=this.model,c=c._new.apply(c,arguments);this._newObjects.push(c);return c},start:function(c){if(this.data.length){var a=this,b=[];b.push(f.bind(this.model.singleton?this._lookupSingleton:this._lookup,this));b.push(f.bind(this._executeSubOperations,this));r.async.parallel(b,
function(){try{a._map();var b;b=a.callInit?f.reduce(a._newObjects,function(a,b){var h=b.model.init;h&&(r.paramNames(h).length?a.push(f.bind(h,b,c)):h.call(b));return a},[]):[];m.parallel(b,function(){c(a.errors.length?a.errors:null,a.objects)})}catch(h){console.error("caught error",h),c(h)}})}else c(null,[])},getRelatedData:function(c){for(var a=[],b=[],k=0;k<this.data.length;k++){var h=this.data[k];h&&h[c]&&(a.push(k),b.push(h[c]))}return{indexes:a,relatedData:b}},processErrorsFromTask:function(c,
a,b){if(a.length){var k=this.getRelatedData(c).relatedData;a=r.unflattenArray(a,k);for(k=0;k<a.length;k++){var h=b[k],d=a[k],g=d;r.isArray(d)&&(g=f.reduce(d,function(a,b){return a||b},!1));g&&(this.errors[h]||(this.errors[h]={}),this.errors[h][c]=d)}}},_executeSubOperations:function(c){var a=this,b=f.keys(this.model.relationships);b.length?(b=f.reduce(b,function(b,c){var g=a.model.relationships[c],e=g.forwardName==c?g.reverseModel:g.forwardModel;e.singleton&&!g.isReverse&&this.data.forEach(function(a){a[c]||
(a[c]={})});var g=this.getRelatedData(c),f=g.indexes,g=g.relatedData;if(g.length)var g=r.flattenArray(g),l=new d({model:e,data:g,disableevents:a.disableevents,_ignoreInstalled:a._ignoreInstalled,callInit:this.callInit});l&&b.push(function(b){l.start(function(k,d){a.subTaskResults[c]={errors:k,objects:d,indexes:f};a.processErrorsFromTask(c,l.errors,f);b()})});return b}.bind(this),[]),m.parallel(b,function(a){c(a)})):c()}});t.exports=d},{"./cache":8,"./error":11,"./log":14,"./modelEvents":18,"./modelInstance":19,
"./store":26,"./util":28}],17:[function(e,t,q){function d(a){var b=this;this._opts=a?w.extend({},a):{};g.extendFromOpts(this,a,{methods:{},attributes:[],collection:function(a){g.isString(a)&&(a=n[a]);return a},id:"id",relationships:[],name:null,indexes:[],singleton:!1,statics:this.installStatics.bind(this),properties:{},init:null,remove:null});this.attributes=d._processAttributes(this.attributes);w.extend(this,{_installed:!1,_relationshipsInstalled:!1,_reverseRelationshipsInstalled:!1,children:[]});
Object.defineProperties(this,{_relationshipNames:{get:function(){return Object.keys(b.relationships)},enumerable:!0},_attributeNames:{get:function(){var a=[];b.id&&a.push(b.id);w.each(b.attributes,function(b){a.push(b.name)});return a},enumerable:!0,configurable:!0},installed:{get:function(){return b._installed&&b._relationshipsInstalled&&b._reverseRelationshipsInstalled},enumerable:!0,configurable:!0},descendants:{get:function(){return w.reduce(b.children,function(a,b){return Array.prototype.concat.call(a,
b.descendants)}.bind(b),w.extend([],b.children))},enumerable:!0},dirty:{get:function(){if(siesta.ext.storageEnabled)return!!Object.keys((siesta.ext.storage._unsavedObjectsByCollection[this.collectionName]||{})[this.name]||{}).length},enumerable:!0},collectionName:{get:function(){return this.collection.name},enumerable:!0}});k.ProxyEventEmitter.call(this,this.collectionName+":"+this.name)}q=e("./log");var n=e("./collectionRegistry").CollectionRegistry,p=e("./error").InternalSiestaError,l=e("./RelationshipType"),
r=e("./query"),f=e("./mappingOperation"),m=e("./modelInstance"),g=e("./util"),c=e("./cache");e("./store");var a=e("extend"),b=e("./modelEvents"),k=e("./events"),h=e("./events").wrapArray;e("./RelationshipProxy");var v=e("./OneToManyProxy"),y=e("./OneToOneProxy"),C=e("./manyToManyProxy"),A=e("./reactiveQuery"),x=e("./ArrangedReactiveQuery"),w=g._,B=g.guid,D=b.ModelEventType,z=q.loggerWithName("Model");w.extend(d,{_processAttributes:function(a){return w.reduce(a,function(a,b){"string"==typeof b?a.push({name:b}):
a.push(b);return a},[])}});d.prototype=Object.create(k.ProxyEventEmitter.prototype);w.extend(d.prototype,{installStatics:function(a){a&&w.each(Object.keys(a),function(b){this[b]?z.error('Static method with name "'+b+'" already exists. Ignoring it.'):this[b]=a[b].bind(this)}.bind(this));return a},installRelationships:function(){if(this._relationshipsInstalled)throw new p('Relationships for "'+this.name+'" have already been installed');this._relationships=[];if(this._opts.relationships)for(var a in this._opts.relationships)if(this._opts.relationships.hasOwnProperty(a)){var b=
this._opts.relationships[a];if(!b.isReverse){z.debug.isEnabled&&z.debug(this.name+": configuring relationship "+a,b);b.type||(b.type=this.singleton?l.OneToOne:l.OneToMany);if(this.singleton&&b.type==l.ManyToMany)return"Singleton model cannot use ManyToMany relationship.";if(b.type==l.OneToMany||b.type==l.OneToOne||b.type==l.ManyToMany){var c=b.model;delete b.model;var h;if(c instanceof d)h=c;else{z.debug.isEnabled&&z.debug("reverseModelName",c);if(!this.collection)throw new p("Model must have collection");
var k=this.collection;if(!k)throw new p("Collection "+this.collectionName+" not registered");h=k[c]}if(!h&&(k=c.split("."),2==k.length)){h=k[0];c=k[1];k=n[h];if(!k)return'Collection with name "'+h+'" does not exist.';h=k[c]}z.debug.isEnabled&&z.debug("reverseModel",h);if(h)b.reverseModel=h,b.forwardModel=this,b.forwardName=a,b.reverseName=b.reverse||"reverse_"+a,delete b.reverse,b.isReverse=!1;else return'Model with name "'+c.toString()+'" does not exist'}else return"Relationship type "+b.type+" does not exist"}}this._relationshipsInstalled=
!0;return null},installReverseRelationships:function(){if(this._reverseRelationshipsInstalled)throw new p('Reverse relationships for "'+this.name+'" have already been installed.');for(var b in this.relationships)if(this.relationships.hasOwnProperty(b)){var c=this.relationships[b],c=a(!0,{},c);c.isReverse=!0;var h=c.reverseModel,k=c.reverseName;if(h.singleton){if(c.type==l.ManyToMany)return"Singleton model cannot be related via reverse ManyToMany";if(c.type==l.OneToMany)return"Singleton model cannot be related via reverse OneToMany"}z.debug.isEnabled&&
z.debug(this.name+": configuring  reverse relationship "+k);h.relationships[k]=c}this._reverseRelationshipsInstalled=!0},_query:function(a){return a=new r(this,a||{})},query:function(a,b){if(this.singleton){var c=g.defer(b);b=c.finish.bind(c);this._query({__ignoreInstalled:!0}).execute(function(c,h){c?b(c):(a=w.extend({},a),a.__ignoreInstalled=!0,h.length?this._query(a).execute(b):this.map({},function(c){c?b(c):this._query(a).execute(b)}.bind(this)))}.bind(this));return c.promise}return this._query(a).execute(b)},
reactiveQuery:function(a){return new A(new r(this,a||{}))},arrangedReactiveQuery:function(a){return new x(new r(this,a||{}))},one:function(a,b){"function"==typeof a&&(b=a,a={});var c=g.defer(b);b=c.finish.bind(c);this.query(a,function(a,c){a?b(a):1<c.length?b("More than one instance returned when executing get query!"):(c=c.length?c[0]:null,b(null,c))});return c.promise},all:function(a,b){"function"==typeof a&&(b=a,a={});a=a||{};return this.query(a,b)},install:function(a){z.info.isEnabled&&z.info("Installing mapping "+
this.name);var b=g.defer(a);a=b.finish.bind(b);if(this._installed)throw new p('Model "'+this.name+'" has already been installed');this._installed=!0;a();return b.promise},map:function(a,b,c){"function"==typeof b&&(c=b);b=b||{};var h=g.defer(c);c=function(){var c=b.override;c&&(g.isArray(c)?b.objects=c:b.objects=[c]);delete b.override;g.isArray(a)?this._mapBulk(a,b,h.finish.bind(h)):this._mapBulk([a],b,function(a,b){var c;b&&b.length&&(c=b[0]);h.finish(a?g.isArray(a)?a[0]:a:null,c)})}.bind(this);b._ignoreInstalled?
c():siesta._afterInstall(c);return h.promise},_mapBulk:function(a,b,c){w.extend(b,{model:this,data:a});(new f(b)).start(function(a,b){a?c&&c(a):c(null,b||[])})},_countCache:function(){return w.reduce(Object.keys((c._localCacheByType[this.collectionName]||{})[this.name]||{}),function(a,b){a[b]={};return a},{})},count:function(a){var b=g.defer(a);a=b.finish.bind(b);var c=this._countCache();a(null,Object.keys(c).length);return b.promise},_new:function(a,k){k=void 0===k?!0:k;if(this.installed){var d=
this,e;e=a?a._id?a._id:B():B();var f=new m(this);z.info.isEnabled&&z.info('New object created _id="'+e.toString()+'", type='+this.name,a);f._id=e;e={};f.__values=e;var r=w.reduce(this.attributes,function(a,b){void 0!==b["default"]&&(a[b.name]=b["default"]);return a},{});w.extend(e,r);a&&w.extend(e,a);e=this._attributeNames;r=e.indexOf(this.id);-1<r&&e.splice(r,1);w.each(e,function(a){Object.defineProperty(f,a,{get:function(){var b=f.__values[a];return void 0===b?null:b},set:function(c){var k=f.__values[a],
e=this._propertyDependencies[a],e=w.map(e,function(a){return{prop:a,old:this[a]}}.bind(this));f.__values[a]=c;e.forEach(function(a){var c=a.prop;b.emit({collection:d.collectionName,model:d.name,_id:f._id,"new":this[c],old:a.old,type:D.Set,field:c,obj:f})}.bind(this));k={collection:d.collectionName,model:d.name,_id:f._id,"new":c,old:k,type:D.Set,field:a,obj:f};window.lastEmission=k;b.emit(k);g.isArray(c)&&h(c,a,f)},enumerable:!0,configurable:!0})});w.each(Object.keys(this.methods),function(a){void 0===
f[a]?f[a]=this.methods[a].bind(f):z.error('A method with name "'+a+'" already exists. Ignoring it.')}.bind(this));e=Object.keys(this.properties);var n={};w.each(e,function(a){var b=this.properties[a];(b.dependencies||[]).forEach(function(b){n[b]||(n[b]=[]);n[b].push(a)});delete b.dependencies;void 0===f[a]?Object.defineProperty(f,a,b):z.error('A property/method with name "'+a+'" already exists. Ignoring it.')}.bind(this));f._propertyDependencies=n;Object.defineProperty(f,this.id,{get:function(){return f.__values[d.id]||
null},set:function(a){var h=f[d.id];f.__values[d.id]=a;b.emit({collection:d.collectionName,model:d.name,_id:f._id,"new":a,old:h,type:D.Set,field:d.id,obj:f});c.remoteInsert(f,a,h)},enumerable:!0,configurable:!0});for(var x in this.relationships){var q;if(this.relationships.hasOwnProperty(x))if(q=w.extend({},this.relationships[x]),e=q.type,delete q.type,e==l.OneToMany)q=new v(q);else if(e==l.OneToOne)q=new y(q);else if(e==l.ManyToMany)q=new C(q);else throw new p("No such relationship type: "+e);q.install(f)}c.insert(f);
k&&b.emit({collection:this.collectionName,model:this.name,_id:f._id,"new":f,type:D.New,obj:f});return f}throw new p("Model must be fully installed before creating any models");},_dump:function(a){var b={};b.name=this.name;b.attributes=this.attributes;b.id=this.id;b.collection=this.collectionName;b.relationships=w.map(this.relationships,function(a){return a.isForward?a.forwardName:a.reverseName});return a?g.prettyPrint(b):b},toString:function(){return"Model["+this.name+"]"}});w.extend(d.prototype,
{child:function(a,b){"string"==typeof a?b.name=a:b=name;w.extend(b,{attributes:Array.prototype.concat.call(b.attributes||[],this._opts.attributes),relationships:w.extend(b.relationships||{},this._opts.relationships),methods:w.extend(w.extend({},this._opts.methods)||{},b.methods),statics:w.extend(w.extend({},this._opts.statics)||{},b.statics),properties:w.extend(w.extend({},this._opts.properties)||{},b.properties),id:b.id||this._opts.id,init:b.init||this._opts.init,remove:b.remove||this._opts.remove});
var c=this.collection.model(b.name,b);c.parent=this;this.children.push(c);return c},isChildOf:function(a){return this.parent==a},isParentOf:function(a){return-1<this.children.indexOf(a)},isDescendantOf:function(a){for(var b=this.parent;b;){if(b==a)return!0;b=b.parent}return!1},isAncestorOf:function(a){return-1<this.descendants.indexOf(a)},hasAttributeNamed:function(a){return-1<this._attributeNames.indexOf(a)}});w.extend(d.prototype,{paginator:function(a){if(siesta.ext.httpEnabled){var b=siesta.ext.http.Paginator;
a=a||{};a.model=this;return new b(a)}}});t.exports=d},{"./ArrangedReactiveQuery":1,"./OneToManyProxy":3,"./OneToOneProxy":4,"./RelationshipProxy":6,"./RelationshipType":7,"./cache":8,"./collectionRegistry":10,"./error":11,"./events":12,"./log":14,"./manyToManyProxy":15,"./mappingOperation":16,"./modelEvents":18,"./modelInstance":19,"./query":22,"./reactiveQuery":24,"./store":26,"./util":28,extend:42}],18:[function(e,t,q){function d(d){this._opts=d||{};Object.keys(d).forEach(function(c){this[c]=d[c]}.bind(this))}
function n(d){if(!d.model)throw new l("Must pass a model");if(!d.collection)throw new l("Must pass a collection");if(!d._id)throw new l("Must pass a local identifier");if(!d.obj)throw new l("Must pass the object");}var p=e("./events"),l=e("./error").InternalSiestaError;t=e("./log");var r=e("./util")._.extend,f=e("./collectionRegistry").CollectionRegistry,m=t.loggerWithName("ModelEvents");d.prototype._dump=function(d){var c={};c.collection="string"==typeof this.collection?this.collection:this.collection._dump();
c.model="string"==typeof this.model?this.model:this.model.name;c._id=this._id;c.field=this.field;c.type=this.type;this.index&&(c.index=this.index);this.added&&(c.added=_.map(this.added,function(a){return a._dump()}));this.removed&&(c.removed=_.map(this.removed,function(a){return a._dump()}));this.old&&(c.old=this.old);this["new"]&&(c["new"]=this["new"]);return d?util.prettyPrint(c):c};r(q,{ModelEvent:d,emit:function(e){n(e);var c=e.collection,a=e.model;e=new d(e);m.trace.isEnabled&&m.trace('Sending notification "'+
c+'" of type '+e.type);p.emit(c,e);var b=c+":"+a;m.trace.isEnabled&&m.trace('Sending notification "'+b+'" of type '+e.type);p.emit(b,e);m.trace.isEnabled&&m.trace('Sending notification "Siesta" of type '+e.type);p.emit("Siesta",e);b=e._id;m.trace.isEnabled&&m.trace('Sending notification "'+b+'" of type '+e.type);p.emit(b,e);b=f[c];if(!b)throw c='No such collection "'+c+'"',m.error(c,f),new l(c);b=b[a];if(!b)throw c='No such model "'+a+'"',m.error(c,f),new l(c);b.id&&e.obj[b.id]&&(c=c+":"+a+":"+e.obj[b.id],
m.trace.isEnabled&&m.trace('Sending notification "'+c+'" of type '+e.type),p.emit(c,e));return e},validateEventOpts:n,ModelEventType:{Set:"Set",Splice:"Splice",New:"New",Remove:"Remove"}})},{"./collectionRegistry":10,"./error":11,"./events":12,"./log":14,"./util":28}],19:[function(e,t,q){t.exports=e(2)},{"./cache":8,"./error":11,"./events":12,"./log":14,"./modelEvents":18,"./util":28,"/Users/mtford/Playground/rest/core/ModelInstance.js":2}],20:[function(e,t,q){t.exports=e(3)},{"../vendor/observe-js/src/observe":44,
"./RelationshipProxy":6,"./error":11,"./events":12,"./modelEvents":18,"./modelInstance":19,"./store":26,"./util":28,"/Users/mtford/Playground/rest/core/OneToManyProxy.js":3}],21:[function(e,t,q){t.exports=e(4)},{"./RelationshipProxy":6,"./error":11,"./modelEvents":18,"./modelInstance":19,"./store":26,"./util":28,"/Users/mtford/Playground/rest/core/OneToOneProxy.js":4}],22:[function(e,t,q){t.exports=e(5)},{"./cache":8,"./error":11,"./log":14,"./querySet":23,"./util":28,"/Users/mtford/Playground/rest/core/Query.js":5}],
23:[function(e,t,q){function d(a){return"string"==typeof a||a instanceof String?C.concat(A):"number"==typeof a||a instanceof Number?v.concat(y):a.getOwnPropertyNames()}function n(b,h){h in b||Object.defineProperty(b,h,{get:function(){return f(k.pluck(b,h))},set:function(b){if(c.isArray(b)){if(this.length!=b.length)throw new a({message:"Must be same length"});for(var k=0;k<b.length;k++)this[k][h]=b[k]}else for(k=0;k<this.length;k++)this[k][h]=b}})}function p(a){return a.then&&a["catch"]}function l(a,
b){b in a||(a[b]=function(){var a=arguments,c=this.map(function(c){return c[b].apply(c,a)}),h=!1;c.length&&(h=p(c[0]));return h?siesta.q.all(c):f(c)})}function r(a,c){a=k.extend([],a);c._attributeNames.concat(c._relationshipNames).concat(h).forEach(k.partial(n,a));var h=Object.keys(b.prototype);h.forEach(k.partial(l,a));return g(a)}function f(a){if(a.length){var b=a[0];d(b).forEach(function(c){"function"==typeof b[c]?l(a,c,arguments):n(a,c)})}return g(a)}function m(){throw Error("Cannot modify a query set");
}function g(a){h.forEach(function(b){a[b]=m});a.immutable=!0;a.mutableCopy=a.asArray=function(){var a=k.map(this,function(a){return a});a.asQuerySet=function(){return f(this)};a.asModelQuerySet=function(a){return r(this,a)};return a};return a}var c=e("./util"),a=e("./error").SiestaUserError,b=e("./ModelInstance"),k=e("./util")._,h="push sort reverse splice shift unshift".split(" "),v=["toString","toExponential","toFixed","toPrecision","valueOf"],y=["MAX_VALUE","MIN_VALUE","NEGATIVE_INFINITY","NaN",
"POSITIVE_INFINITY"],C="charAt charCodeAt concat fromCharCode indexOf lastIndexOf localeCompare match replace search slice split substr substring toLocaleLowerCase toLocaleUpperCase toLowerCase toString toUpperCase trim valueOf".split(" "),A=["length"];t.exports=r},{"./ModelInstance":2,"./error":11,"./util":28}],24:[function(e,t,q){function d(a){var b=this;n.call(this);g.extend(this,{_query:a,results:f([],a.model),insertionPolicy:d.InsertionPolicy.Back,initialised:!1});Object.defineProperties(this,
{initialized:{get:function(){return this.initialised}},model:{get:function(){return b._query.model}},collection:{get:function(){return b.model.collectionName}}})}q=e("./log");e("./query");var n=e("events").EventEmitter,p=e("./events"),l=e("./modelEvents"),r=e("./error").InternalSiestaError,f=e("./querySet"),m=e("./util"),g=m._,c=q.loggerWithName("Query");d.prototype=Object.create(n.prototype);g.extend(d,{InsertionPolicy:{Front:"Front",Back:"Back"}});g.extend(d.prototype,{init:function(a){c.trace&&
c.trace("init");var b=m.defer(a);a=b.finish.bind(b);this.initialised?a(null,this.results):this._query.execute(function(b,h){if(b)a(b);else{this.results=h;if(!this.handler){var d=this._constructNotificationName(),e=function(a){this._handleNotif(a)}.bind(this);this.handler=e;p.on(d,e)}c.trace&&c.trace("Listening to "+d);this.initialised=!0;a(null,this.results)}}.bind(this));return b.promise},insert:function(a){var b=this.results.mutableCopy();a=this.insertionPolicy==d.InsertionPolicy.Back?b.push(a):
b.unshift(a);this.results=b.asModelQuerySet(this.model);return a},_handleNotif:function(a){c.trace&&c.trace("_handleNotif",a);if(a.type==l.ModelEventType.New){var b=a["new"];if(this._query.objectMatchesQuery(b)){c.trace&&c.trace("New object matches",b._dumpString());var k=this.insert(b);this.emit("change",this.results,{index:k,added:[b],type:l.ModelEventType.Splice,obj:this})}else c.trace&&c.trace("New object does not match",b._dumpString())}else if(a.type==l.ModelEventType.Set){var b=a.obj,k=this.results.indexOf(b),
h=-1<k,d=this._query.objectMatchesQuery(b);d&&!h?(c.trace&&c.trace("Updated object now matches!",b._dumpString()),k=this.insert(b),this.emit("change",this.results,{index:k,added:[b],type:l.ModelEventType.Splice,obj:this})):!d&&h?(c.trace&&c.trace("Updated object no longer matches!",b._dumpString()),h=this.results.mutableCopy(),a=h.splice(k,1),this.results=h.asModelQuerySet(this.model),this.emit("change",this.results,{index:k,obj:this,"new":b,type:l.ModelEventType.Splice,removed:a})):d||h?d&&h&&(c.trace&&
c.trace("Matches but already contains",b._dumpString()),this.emit("change",this.results,a)):c.trace&&c.trace("Does not contain, but doesnt match so not inserting",b._dumpString())}else if(a.type==l.ModelEventType.Remove)b=a.obj,h=this.results.mutableCopy(),k=h.indexOf(b),-1<k?(c.trace&&c.trace("Removing object",b._dumpString()),a=h.splice(k,1),this.results=f(h,this.model),this.emit("change",this.results,{index:k,obj:this,type:l.ModelEventType.Splice,removed:a})):c.trace&&c.trace("No modelEvents neccessary.",
b._dumpString());else throw new r('Unknown change type "'+a.type.toString()+'"');this.results=f(this._query._sortResults(this.results),this.model)},_constructNotificationName:function(){return this.model.collectionName+":"+this.model.name},terminate:function(){this.handler&&p.removeListener(this._constructNotificationName(),this.handler);this.handler=this.results=null},listen:function(a){this.on("change",a);return function(){this.removeListener("change",a)}.bind(this)},listenOnce:function(a){this.once("change",
a)}});t.exports=d},{"./error":11,"./events":12,"./log":14,"./modelEvents":18,"./query":22,"./querySet":23,"./util":28,events:38}],25:[function(e,t,q){t.exports=e(6)},{"../vendor/observe-js/src/observe":44,"./cache":8,"./error":11,"./events":12,"./log":14,"./modelEvents":18,"./query":22,"./store":26,"./util":28,"/Users/mtford/Playground/rest/core/RelationshipProxy.js":6}],26:[function(e,t,q){function d(d,c){var a=l.defer(c);c=a.finish.bind(a);m.debug.isEnabled&&m.debug("get",d);var b;if(d._id)if(l.isArray(d._id))n(r.map(d._id,
function(a){return{_id:a}}),c);else if(b=f.get(d))m.debug.isEnabled&&m.debug("Had cached object",{opts:d,obj:b}),c&&c(null,b);else if(l.isArray(d._id))n(r.map(d._id,function(a){return{_id:a}}),c);else{if(c)if(b=siesta.ext.storage)b.store.getFromPouch(d,c);else throw Error("Storage module not installed");}else if(d.model)if(l.isArray(d[d.model.id]))n(r.map(d[d.model.id],function(a){var b={};b[d.model.id]=a;b.model=d.model;return b}),c);else if(b=f.get(d))m.debug.isEnabled&&m.debug("Had cached object",
{opts:d,obj:b}),c&&c(null,b);else if(b=d.model,b.singleton)b.one(c);else{var k=b.id,h=d[k],e={};if(e[k]=h)b.one(e,function(a,b){a?c(a):b?c(null,b):c(null,null)});else throw new p('Invalid options given to store. Missing "'+k.toString()+'."');}else throw new p("Invalid options given to store",{opts:d});return a.promise}function n(e,c){var a=l.defer(c);c=a.finish.bind(a);var b=[],k=[];r.each(e,function(a){d(a,function(a,h){a?k.push(a):b.push(h);b.length+k.length==e.length&&c&&(k.length?c(k):c(null,
b))})});return a.promise}var p=e("./error").InternalSiestaError;q=e("./log");var l=e("./util"),r=l._,f=e("./cache"),m=q.loggerWithName("Store");t.exports={get:d,getMultiple:n,getMultipleLocal:function(d,c){var a=l.defer(c);c=a.finish.bind(a);var b=r.reduce(d,function(a,b){var c=f.get({_id:b});c?a.cached[b]=c:a.notCached.push(b);return a},{cached:{},notCached:[]});(function(a){c&&(a?c(a):c(null,r.map(d,function(a){return b.cached[a]})))})();return a.promise},getMultipleRemote:function(d,c,a){var b=
l.defer(a);a=b.finish.bind(b);var k=r.reduce(d,function(a,b){var d={model:c};d[c.id]=b;(d=f.get(d))?a.cached[b]=d:a.notCached.push(b);return a},{cached:{},notCached:[]});(function(b){a&&(b?a(b):a(null,r.map(d,function(a){return k.cached[a]})))})();return b.promise}}},{"./cache":8,"./error":11,"./log":14,"./util":28}],27:[function(e,t,q){function d(a,b){if(a.map)return a.map(b);var c=[];r(a,function(a,d,h){c.push(b(a,d,h))});return c}function n(a,b,c,k){b=d(b,function(a,b){return{index:b,value:a}});
if(k){var e=[];a(b,function(a,b){c(a.value,function(c,d){e[a.index]=d;b(c)})},function(a){k(a,e)})}else a(b,function(a,b){c(a.value,function(a){b(a)})})}function p(a,b,c){c=c||function(){};if(!a.length)return c();var d=0,k=function(){b(a[d],function(b){b?(c(b),c=function(){}):(d+=1,d>=a.length?c():k())})};k()}function l(a,b){if(a.forEach)return a.forEach(b);for(var c=0;c<a.length;c+=1)b(a[c],c,a)}function r(a,b,c){function d(b){b?(c(b),c=function(){}):(k+=1,k>=a.length&&c())}c=c||function(){};if(!a.length)return c();
var k=0;l(a,function(a){b(a,f(d))})}function f(b){var c=!1;return function(){if(c)throw Error("Callback was already called.");c=!0;b.apply(a,arguments)}}var m=e("./misc"),g=e("./underscore"),c=function(a){return function(){var b=Array.prototype.slice.call(arguments);return a.apply(null,[r].concat(b))}}(n),a,b=function(a){return function(){var b=Array.prototype.slice.call(arguments);return a.apply(null,[p].concat(b))}}(n),k=function(a,b,c){c=c||function(){};if(m.isArray(b))a.map(b,function(a,b){a&&
a(function(a){var c=Array.prototype.slice.call(arguments,1);1>=c.length&&(c=c[0]);b.call(null,a,c)})},c);else{var d={};a.each(Object.keys(b),function(a,c){b[a](function(b){var k=Array.prototype.slice.call(arguments,1);1>=k.length&&(k=k[0]);d[a]=k;c(b)})},function(a){c(a,d)})}};t.exports={series:function(a,c){c=c||function(){};if(m.isArray(a))b(a,function(a,b){a&&a(function(a){var c=Array.prototype.slice.call(arguments,1);1>=c.length&&(c=c[0]);b.call(null,a,c)})},c);else{var d={};p(g.keys(a),function(b,
c){a[b](function(a){var k=Array.prototype.slice.call(arguments,1);1>=k.length&&(k=k[0]);d[b]=k;c(a)})},function(a){c(a,d)})}},parallel:function(a,b){k({map:c,each:r},a,b)}}},{"./misc":29,"./underscore":30}],28:[function(e,t,q){q=e("./underscore");var d=e("./async");e=e("./misc");q.extend(t.exports,{_:q,async:d});q.extend(t.exports,e)},{"./async":27,"./misc":29,"./underscore":30}],29:[function(e,t,q){var d=e("../../vendor/observe-js/src/observe").Platform,n=e("./underscore"),p=e("./../error").InternalSiestaError,
l=/^function\s*[^\(]*\(\s*([^\)]*)\)/m,r=/,/,f=/^\s*(_?)(.+?)\1\s*$/,m=/((\/\/.*$)|(\/\*[\s\S]*?\*\/))/mg;e=function(a){return"[object Array]"===n.toString.call(a)};var g=Array.isArray||e,c=function(a){return"string"==typeof a||a instanceof String};n.extend(t.exports,{next:function(a){d.performMicrotaskCheckpoint();setTimeout(a)},cb:function(a,b){return function(c){a&&a.apply(a,arguments);b&&(c?b.reject(c):b.resolve.apply(b,Array.prototype.slice.call(arguments,1)))}},guid:function(){function a(){return Math.floor(65536*
(1+Math.random())).toString(16).substring(1)}return function(){return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()}}(),assert:function(a,b,c){if(!a)throw c=c||{},new p(b||"Assertion failed",c);},thenBy:function(){function a(a){a.thenBy=b;return a}function b(b){var c=this;return a(function(a,d){return c(a,d)||b(a,d)})}return a}(),defer:function(a){var b;a=a||function(){};if(siesta.q){b=siesta.q.defer();var c=b.reject,d=b.resolve;n.extend(b,{reject:function(b){a(b);c.call(this,b)},resolve:function(b){a(null,
b);d.call(this,b)},finish:function(b,e){a(b,e);b?c.call(this,b):d.call(this,e)}})}else b={promise:void 0,reject:function(b){a(b)},resolve:function(b){a(null,b)},finish:function(b,c){a(b,c)}};return b},defineSubProperty:function(a,b,c){return Object.defineProperty(this,a,{get:function(){return c?b[c]:b[a]},set:function(d){c?b[c]=d:b[a]=d},enumerable:!0,configurable:!0})},defineSubPropertyNoSet:function(a,b,c){return Object.defineProperty(this,a,{get:function(){return c?b[c]:b[a]},enumerable:!0,configurable:!0})},
subProperties:function(a,b,d){g(d)||(d=Array.prototype.slice.call(arguments,2));for(var h=0;h<d.length;h++)(function(d){var k={set:!1,name:d,property:d};c(d)||n.extend(k,d);d={get:function(){return b[k.property]},enumerable:!0,configurable:!0};k.set&&(d.set=function(a){b[k.property]=a});Object.defineProperty(a,k.name,d)})(d[h])},capitaliseFirstLetter:function(a){return a.charAt(0).toUpperCase()+a.slice(1)},extendFromOpts:function(a,b,c,d){if(void 0==d||d){var e=Object.keys(c);d=Object.keys(b).filter(function(a){return-1==
e.indexOf(a)});if(d.length)throw Error("Unknown options: "+d.toString());}n.each(Object.keys(c),function(a){var d=c[a];"function"==typeof d&&(c[a]=d(b[a]),delete b[a])});n.extend(c,b);n.extend(a,c)},isString:c,isArray:g,prettyPrint:function(a){return JSON.stringify(a,null,4)},flattenArray:function(a){return n.reduce(a,function(a,c){g(c)?a=a.concat(c):a.push(c);return a},[])},unflattenArray:function(a,b){for(var c=0,d=[],e=0;e<b.length;e++)if(g(b[e])){var f=[];d[e]=f;for(var l=0;l<b[e].length;l++)f.push(a[c]),
c++}else d[e]=a[c],c++;return d},paramNames:function(a){var b=[];a.toString().replace(m,"").match(l)[1].split(r).forEach(function(a){a.replace(f,function(a,c,d){b.push(d)})});return b}})},{"../../vendor/observe-js/src/observe":44,"./../error":11,"./underscore":30}],30:[function(e,t,q){var d={};e=Array.prototype;var n=e.forEach,p=e.map,l=e.reduce,r=Function.prototype.bind,f=e.slice,m={},g=function(){};d.keys=function(a){if(Object.keys)return Object.keys(a);var c=[],d;for(d in a)a.hasOwnProperty(d)&&
c.push(d);return c};d.each=d.forEach=function(a,c,h){if(null==a)return a;if(n&&a.forEach===n)a.forEach(c,h);else if(a.length===+a.length)for(var e=0,f=a.length;e<f;e++){if(c.call(h,a[e],e,a)===m)return}else for(var g=d.keys(a),e=0,f=g.length;e<f;e++)if(c.call(h,a[g[e]],g[e],a)===m)return;return a};d.map=d.collect=function(a,c,e){var f=[];if(null==a)return f;if(p&&a.map===p)return a.map(c,e);d.each(a,function(a,b,d){f.push(c.call(e,a,b,d))});return f};var c=function(a,c,d){if(void 0===c)return a;switch(null==
d?3:d){case 1:return function(d){return a.call(c,d)};case 2:return function(d,e){return a.call(c,d,e)};case 3:return function(d,e,h){return a.call(c,d,e,h)};case 4:return function(d,e,h,f){return a.call(c,d,e,h,f)}}return function(){return a.apply(c,arguments)}};d.times=function(a,d,e){var f=Array(Math.max(0,a));d=c(d,e,1);for(e=0;e<a;e++)f[e]=d(e);return f};d.partial=function(a){var c=f.call(arguments,1);return function(){for(var e=0,f=c.slice(),g=0,l=f.length;g<l;g++)f[g]===d&&(f[g]=arguments[e++]);
for(;e<arguments.length;)f.push(arguments[e++]);return a.apply(this,f)}};d.pluck=function(a,c){return d.map(a,d.property(c))};d.reduce=d.foldl=d.inject=function(a,c,e,f){var g=2<arguments.length;null==a&&(a=[]);if(l&&a.reduce===l)return f&&(c=d.bind(c,f)),g?a.reduce(c,e):a.reduce(c);d.each(a,function(a,b,d){g?e=c.call(f,e,a,b,d):(e=a,g=!0)});if(!g)throw new TypeError("Reduce of empty array with no initial value");return e};d.property=function(a){return function(c){return c[a]}};"function"!==typeof/./&&
(d.isFunction=function(a){return"function"===typeof a});d.isObject=function(a){var c=typeof a;return"function"===c||"object"===c&&!!a};var a=function(a){return null==a?d.identity:d.isFunction(a)?a:d.property(a)};d.sortBy=function(b,c,e){c=a(c);return d.pluck(d.map(b,function(a,b,d){return{value:a,index:b,criteria:c.call(e,a,b,d)}}).sort(function(a,b){var c=a.criteria,d=b.criteria;if(c!==d){if(c>d||void 0===c)return 1;if(c<d||void 0===d)return-1}return a.index-b.index}),"value")};d.bind=function(a,
c){var e,l;if(r&&a.bind===r)return r.apply(a,f.call(arguments,1));if(!d.isFunction(a))throw new TypeError;e=f.call(arguments,2);return l=function(){if(!(this instanceof l))return a.apply(c,e.concat(f.call(arguments)));g.prototype=a.prototype;var d=new g;g.prototype=null;u;var m=a.apply(d,e.concat(f.call(arguments)));return Object(m)===m?m:d}};d.identity=function(a){return a};d.zip=function(a){if(null==a)return[];for(var c=d.max(arguments,"length").length,e=Array(c),f=0;f<c;f++)e[f]=d.pluck(arguments,
f);return e};d.max=function(a,c,e){var f=-Infinity,g=-Infinity,l;if(null==c&&null!=a){a=a.length===+a.length?a:d.values(a);for(var m=0,r=a.length;m<r;m++)e=a[m],e>f&&(f=e)}else c=d.iteratee(c,e),d.each(a,function(a,b,d){l=c(a,b,d);if(l>g||-Infinity===l&&-Infinity===f)f=a,g=l});return f};d.iteratee=function(a,e,f){return null==a?d.identity:d.isFunction(a)?c(a,e,f):d.isObject(a)?d.matches(a):d.property(a)};d.pairs=function(a){for(var c=d.keys(a),e=c.length,f=Array(e),g=0;g<e;g++)f[g]=[c[g],a[c[g]]];
return f};d.matches=function(a){var c=d.pairs(a),e=c.length;return function(a){if(null==a)return!e;a=Object(a);for(var b=0;b<e;b++){var d=c[b],f=d[0];if(d[1]!==a[f]||!(f in a))return!1}return!0}};d.some=function(a,c,e){if(null==a)return!1;c=d.iteratee(c,e);e=a.length!==+a.length&&d.keys(a);var f=(e||a).length,g,l;for(g=0;g<f;g++)if(l=e?e[g]:g,c(a[l],l,a))return!0;return!1};d.extend=function(a){if(!d.isObject(a))return a;for(var c,e,f=1,g=arguments.length;f<g;f++)for(e in c=arguments[f],c)hasOwnProperty.call(c,
e)&&(a[e]=c[e]);return a};t.exports=d},{}],31:[function(e,t,q){function d(a){a?"*"==a||-1<a.indexOf("*")?a=b:l.isArray(a)||(a=[a]):a=["GET"];return c.map(a,function(a){return a.toUpperCase()})}function n(a){if(!this)return new n(a);this._rawOpts=g(!0,{},a);this._opts=a;var b=function(a){a instanceof RegExp||(a=new RegExp(a,"g"));return a}.bind(this);this._opts.path?(a=this._opts.path,l.isArray(a)||(a=[a]),this._opts.path=[],c.each(a,function(a){this._opts.path.push(b.call(this,a))}.bind(this))):this._opts.path=
[""];this._opts.method=d(this._opts.method);if((a=this._opts.data)&&a.length){var e=a.split(".");if(1==e.length)a=e[0];else{var m={};a=m;for(var r=e[0],p=1;p<e.length;p++){var q=e[p];if(p==e.length-1)m[r]=q;else var t={},m=m[r]=t,r=q}}this._opts.data=a}f.call(this,"path",this._opts);f.call(this,"method",this._opts);f.call(this,"data",this._opts);f.call(this,"transforms",this._opts)}e=siesta._internal;var p=e.error.InternalSiestaError,l=e.util,r=l.assert,f=l.defineSubProperty,m=e.CollectionRegistry,
g=e.extend,c=l._,a=e.log.loggerWithName("Descriptor"),b="POST PATCH PUT HEAD GET DELETE OPTIONS TRACE CONNECT".split(" ");c.extend(n.prototype,{httpMethods:b,_resolveCollectionAndModel:function(){var a;a=this._opts.collection;var b=this._opts.model;console.log("rawCollection",a);console.log("rawModel",b);if(a)a="string"==typeof a?m[a]:a;else if(b&&!l.isString(b))a=b.collection;else return"Must pass collection or a model object";var c;if(b)if(l.isString(b))if(c=a._models[b])this._opts.model=c;else return"Model "+
b+" does not exist in collection";else{if(b.collection!=a)return"Passed model is not part of the passed collection";c=b}else return"Descriptors must be initialised with a model";this.model=c;this.collection=a},_matchPath:function(b){var c;for(c=0;c<this._opts.path.length;c++){var d=this._opts.path[c];a.trace.isEnabled&&a.trace("Matching path",b,d.toString());var e=d.exec(b);a.trace.isEnabled&&(e?a.trace("Matched path successfully",b,d.toString()):a.trace("Failed to match path",b,d.toString()));if(e)return!0}return!1},
_matchMethod:function(a){for(var b=0;b<this.method.length;b++)if(a.toUpperCase()==this.method[b])return!0;return!1},bury:function(a,b){var c=Object.keys(b);r(1==c.length);for(var c=c[0],d=b;"string"!=typeof d[c];)d=d[c],c=Object.keys(d),r(1==c.length),c=c[0];var e=d[c],f={};d[c]=f;f[e]=a;return b},_embedData:function(a){if(this.data){var b;"string"==typeof this.data?(b={},b[this.data]=a):b=this.bury(a,g(!0,{},this.data));return b}return a},_extractData:function(b){a.debug.isEnabled&&a.debug("_extractData",
b);if(this.data){if("string"==typeof this.data)return b[this.data];var c=Object.keys(this.data);r(1==c.length);for(var d=this.data;"string"!=typeof d&&(c=Object.keys(d),r(1==c.length),c=c[0],d=d[c],b=b[c],b););return b?b[d]:null}return b},_matchConfig:function(a){var b=a.type?this._matchMethod(a.type):{};b&&(b=a.url?this._matchPath(a.url):{});return b},_matchData:function(a){var b=null;this.data?a&&(b=this._extractData(a)):b=a;return b},match:function(a,b){var c=!1;this._matchConfig(a)&&(c=this._matchData(b));
return c},_transformData:function(a){var b=this.transforms;if("function"==typeof b)a=b(a);else for(var c in b)if(b.hasOwnProperty(c)&&a[c]){var d=b[c],e=a[c];if("string"==typeof d)if(d=d.split("."),delete a[c],1==d.length)a[d[0]]=e;else{a[d[0]]={};for(var f=a[d[0]],g=1;g<d.length-1;g++){var m=d[g];f[m]={};f=f[m]}f[d[d.length-1]]=e}else if("function"==typeof d)e=d(e),l.isArray(e)?(delete a[c],a[e[0]]=e[1]):a[c]=e;else throw new p("Invalid transformer");}return a}});q.Descriptor=n;q.resolveMethod=d},
{}],32:[function(e,t,q){function d(){if(!this)return new d(opts);this.requestDescriptors={};this.responseDescriptors={}}function n(d,e){var c=e._opts.model,a=e._opts.collection,b;if(a)b=l.isString(a)?a:a.name;else if(c){if(l.isString(c))throw new r("Not enough information to register the descriptor");b=c.collection.name}d[b]||(d[b]=[]);d[b].push(e)}function p(d,e){var c;c="string"==typeof e?d[e]||[]:d[e.name]||[];f.trace.isEnabled&&f.trace("_descriptorsForCollection",{collection:e,allDescriptors:d,
descriptors:c});return c}e=siesta._internal;var l=e.util;t=l._;var r=e.error.InternalSiestaError,f=e.log.loggerWithName("Descriptor");t.extend(d.prototype,{registerRequestDescriptor:function(d){n(this.requestDescriptors,d)},registerResponseDescriptor:function(d){f.trace.isEnabled&&f.trace("registerResponseDescriptor");n(this.responseDescriptors,d)},requestDescriptorsForCollection:function(d){return p(this.requestDescriptors,d)},responseDescriptorsForCollection:function(d){var e=p(this.responseDescriptors,
d);e.length||f.debug.isEnabled&&f.debug("No response descriptors for collection ",{collection:d});return e},reset:function(){this.requestDescriptors={};this.responseDescriptors={}}});q.DescriptorRegistry=new d},{}],33:[function(e,t,q){function d(a,b,c){if(z.debug.isEnabled){var d=z.debug;a=a.type+" "+b.status+" "+a.url;z.trace.isEnabled&&c&&(d=z.trace,a+=": "+A.prettyPrint(c));d(a)}}function n(a){if(z.debug.isEnabled){var b=z.debug;a=a.type+" "+a.url;z.trace.isEnabled&&(b=z.trace);b(a)}}function p(a,
b,c,e){var f=this,g=Array.prototype.slice.call(arguments,2),h={},k=this.name;"function"==typeof g[0]?e=g[0]:"object"==typeof g[0]&&(h=g[0],e=g[1]);g=A.defer(e);e=g.finish.bind(g);siesta._afterInstall(function(){function c(a,b,g){d(h,g,a);var l={data:a,status:b,xhr:g};if(h.parseResponse){b=D.responseDescriptorsForCollection(f);var m,r;for(g=0;g<b.length;g++){var p=b[g];if(r=p.match(h,a)){m=p;break}}if(m)z.trace.isEnabled&&z.trace("Model _constructSubOperation data: "+A.prettyPrint(r)),"object"==typeof r?
m.model.map(r,{override:h.obj},function(a,b){e&&e(a,b,l)}):e(null,!0,l);else if(e)if(k)e("No descriptors matched",null,l);else throw new B("Unnamed collection");}else e(null,null,l)}function g(a,b,c){a={xhr:a,status:b,error:c};e&&e(a,null,a)}h.type=a;h.method=a;h.url||(h.url=this.baseURL+b);void 0===h.parseResponse&&(h.parseResponse=!0);console.log("opts",h);console.log("this",this);n(h);var l=siesta.ext.http.ajax(h);l.success?(l.success(c),l.error(g)):l.done?(l.done(c),l.fail(g)):e("Incompatible ajax function. Could not find success/fail methods on returned promise.")}.bind(this));
return g.promise}function l(a,b,c){this._serialise(b,function(b,d){var e=d;a.fields&&(e={},x.each(a.fields,function(a){e[a]=d[a]}));c(b,e)})}function r(a,b,c){var d=this,e=Array.prototype.slice.call(arguments,3),f,g={};"function"==typeof e[0]?f=e[0]:"object"==typeof e[0]&&(g=e[0],f=e[1]);var h=A.defer(f);f=h.finish.bind(h);var e=Array.prototype.slice.call(e,2),k=D.requestDescriptorsForCollection(this),m;g.type=a;g.url=this.baseURL+b;for(var r=0;r<k.length;r++){var n=k[r];if(n._matchConfig(g)){m=n;
break}}m?(z.trace.isEnabled&&z.trace("Matched descriptor: "+m._dump(!0)),l.call(m,c,g,function(h,k){z.trace.isEnabled&&z.trace("_serialise",{err:h,data:k});h?f&&f(h,null,null):(g.data=k,g.obj=c,x.partial(p,a,b,g,f).apply(d,e))})):f&&(z.trace.isEnabled&&z.trace("Did not match descriptor"),f("No descriptor matched",null,null));return h.promise}function f(a,b){var c=Array.prototype.slice.call(arguments,2),d={},e;"function"==typeof c[0]?e=c[0]:"object"==typeof c[0]&&(d=c[0],e=c[1]);var f=A.defer(e),g=
d.deletionMode||"restore";void 0===d.parseResponse&&(d.parseResponse=!1);p.call(this,"DELETE",a,d,function(a,c,d,h){a?"restore"==g&&b.restore():"success"==g&&b.remove();e(a,c,d,h);f.finish(a,{x:c,y:d,z:h})});"now"!=g&&"restore"!=g||b.remove();return f.promise}function m(a,b){var c=Array.prototype.slice.call(arguments,2);return x.partial(a?r:p,b).apply(this,c)}function g(){return x.partial(m,!1,"GET").apply(this,arguments)}function c(){return x.partial(m,!1,"OPTIONS").apply(this,arguments)}function a(){return x.partial(m,
!1,"TRACE").apply(this,arguments)}function b(){return x.partial(m,!1,"HEAD").apply(this,arguments)}function k(){return x.partial(m,!0,"POST").apply(this,arguments)}function h(){return x.partial(m,!0,"PUT").apply(this,arguments)}function v(){return x.partial(m,!0,"PATCH").apply(this,arguments)}if("undefined"==typeof siesta&&"undefined"==typeof t)throw Error("Could not find window.siesta. Make sure you include siesta.core.js first.");var y=siesta._internal;q=y.Collection;var C=y.log,A=y.util,x=A._,
w=e("./descriptor"),B=y.error.InternalSiestaError,D=e("./descriptorRegistry").DescriptorRegistry,z=C.loggerWithName("HTTP");e={RequestDescriptor:e("./requestDescriptor").RequestDescriptor,ResponseDescriptor:e("./responseDescriptor").ResponseDescriptor,Descriptor:w.Descriptor,_resolveMethod:w.resolveMethod,Serialiser:e("./serialiser"),DescriptorRegistry:e("./descriptorRegistry").DescriptorRegistry,_httpResponse:p,_httpRequest:r,DELETE:f,HTTP_METHOD:m,GET:g,TRACE:a,OPTIONS:c,HEAD:b,POST:k,PUT:h,PATCH:v,
_serialiseObject:l,Paginator:e("./paginator")};Object.defineProperty(e,"ajax",{get:function(){var a=E||($?$.ajax:null)||(jQuery?jQuery.ajax:null);if(!a)throw new B("ajax has not been defined and could not find $.ajax or jQuery.ajax");return a},set:function(a){E=a}});x.extend(q.prototype,{DELETE:f,GET:g,TRACE:a,OPTIONS:c,HEAD:b,POST:k,PUT:h,PATCH:v});siesta.ext||(siesta.ext={});siesta.ext.http=e;Object.defineProperties(siesta.ext,{httpEnabled:{get:function(){return void 0!==siesta.ext._httpEnabled?
siesta.ext._httpEnabled:!!siesta.ext.http},set:function(a){siesta.ext._httpEnabled=a},enumerable:!0}});var E;q={};x.extend(siesta,{setAjax:function(a){E=a},getAjax:function(){return siesta.ext.http.ajax},serialisers:q,serializers:q});Object.defineProperty(siesta,"ajax",{get:function(){return E},set:function(a){E=a}});Object.defineProperties(q,{id:{get:function(){return siesta.ext.httpEnabled?siesta.ext.http.Serialiser.idSerialiser:null}},depth:{get:function(){return siesta.ext.httpEnabled?siesta.ext.http.Serialiser.depthSerializer:
null}}});"undefined"!=typeof t&&(t.exports=e)},{"./descriptor":31,"./descriptorRegistry":32,"./paginator":34,"./requestDescriptor":35,"./responseDescriptor":36,"./serialiser":37}],34:[function(e,t,q){function d(d){this.opts={};p.extendFromOpts(this.opts,d,{path:"/",model:null,page:"page",queryParams:!0,pageSize:"pageSize",numPages:"numPages",dataPath:"data",count:"count",type:"GET",dataType:"json"},!1);l.extend(this,{numPages:null,count:null});this.validate()}q=siesta._internal;var n=q.error.InternalSiestaError,
p=q.util,l=p._,r=e("querystring");l.extend(d.prototype,{_extract:function(d,e,g){if(d)if("function"==typeof d)e=d(e,g);else for(d=d.split("."),g=0;g<d.length;g++)e=e[d[g]];return e},_extractData:function(d,e){return this._extract(this.opts.dataPath,d,e)},_extractNumPages:function(d,e){return this._extract(this.opts.numPages,d,e)},_extractCount:function(d,e){return this._extract(this.opts.count,d,e)},_parseURL:function(d){var e=document.createElement("a");e.href=d;return e},page:function(d,e){var g=
this,c={};"function"==typeof d?e=d:d&&(c=d);var a=p.defer(e),b=c.page,c=c.pageSize;e=a.finish.bind(a);var k=siesta.ext.http.ajax,h=l.extend({},this.opts),n=this.opts.model.collection.baseURL+this.opts.path;if(this.opts.queryParams){var n=this._parseURL(n),q=n.search,t=q.split("?");1<t.length&&(q=t[1]);q=r.parse(q);b&&(q[this.opts.page]=b);c&&(q[this.opts.pageSize]=c);Object.keys(q).length&&(n.search="?"+r.stringify(q));n=n.href}else q={},b&&(q[this.opts.page]=b),c&&(q[this.opts.pageSize]=c),h.data=
q;l.extend(h,{url:n,success:function(a,b,c){var d=g._extractData(a,c),f=g._extractCount(a,c),h=g._extractNumPages(a,c);g.opts.model.map(d,function(d,k){d?e(d):(g.count=f,g.numPages=h,e(null,k,{data:a,textStatus:b,jqXHR:c}))})},fail:e});k(h);return a.promise},validate:function(){if(!this.opts.model)throw new n("Paginator must have a model");}});t.exports=d},{querystring:41}],35:[function(e,t,q){function d(e){if(!this)return new d(e);n.call(this,e);this._opts.serializer&&(this._opts.serialiser=this._opts.serializer);
this._opts.serialiser||(this._opts.serialiser=p.depthSerializer(0));r.call(this,"serialiser",this._opts);r.call(this,"serializer",this._opts,"serialiser")}var n=e("./descriptor").Descriptor,p=e("./serialiser");e=siesta._internal;var l=e.util;t=l._;var r=l.defineSubProperty,f=e.log.loggerWithName("Descriptor");d.prototype=Object.create(n.prototype);t.extend(d.prototype,{_serialise:function(d,e){var c=l.defer(e);e=c.finish.bind(c);var a=this;f.trace.isEnabled&&f.trace("_serialise");var b,k=this.serialiser(d,
function(c,d){b||(d=a._transformData(d),e&&e(c,a._embedData(d)))});void 0!==k?(f.trace.isEnabled&&f.trace("serialiser doesnt use a callback"),b=!0,k=a._transformData(k),e&&e(null,a._embedData(k))):f.trace.isEnabled&&f.trace("serialiser uses a callback",this.serialiser);return c.promise},_dump:function(d){var e={};e.methods=this.method;e.model=this.model.name;e.path=this._rawOpts.path;e.serialiser="function"==typeof this._rawOpts.serialiser?"function () { ... }":this._rawOpts.serialiser;var c={},a;
for(a in this.transforms)this.transforms.hasOwnProperty(a)&&(c[a]="function"==typeof this.transforms[a]?"function () { ... }":this.transforms[a]);e.transforms=c;return d?l.prettyPrint(e):e}});q.RequestDescriptor=d},{"./descriptor":31,"./serialiser":37}],36:[function(e,t,q){function d(e){if(!this)return new d(e);n.call(this,e)}var n=e("./descriptor").Descriptor;e=siesta._internal.util._;d.prototype=Object.create(n.prototype);e.extend(d.prototype,{_extractData:function(d){(d=n.prototype._extractData.call(this,
d))&&(d=this._transformData(d));return d},_matchData:function(d){(d=n.prototype._matchData.call(this,d))&&(d=this._transformData(d));return d},_dump:function(d){var e={};e.methods=this.method;e.model=this.model.name;e.path=this._rawOpts.path;var r={},f;for(f in this.transforms)this.transforms.hasOwnProperty(f)&&(r[f]="function"==typeof this.transforms[f]?"function () { ... }":this.transforms[f]);e.transforms=r;return d?util.prettyPrint(e):e}});q.ResponseDescriptor=d},{"./descriptor":31}],37:[function(e,
t,q){function d(d){var e=d.model.id;if(e)return d[e]?d[e]:null;p.debug.isEnabled&&p.debug("No idfield")}function n(d,e,m){m=m||function(){};p.trace.isEnabled&&p.trace("depthSerialiser");var g={};l.each(e._attributeNames,function(a){p.trace.isEnabled&&p.trace("field",a);e[a]&&(g[a]=e[a])});var c=[],a=[],b={},k=[];l.each(e._relationshipNames,function(h){p.trace.isEnabled&&p.trace("relationshipField",h);var l=e.__proxies[h];l.isForward&&(p.debug.isEnabled&&p.debug(h),c.push(h),l.get(function(l,q){p.trace.isEnabled&&
p.trace("proxy.get",h);p.debug.isEnabled&&p.debug(h,q);l?(a.push(l),k.push(h),b[h]={err:l,v:q}):q?d?n(d-1,q,function(d,e,f){d?a.push(d):g[h]=e;k.push(h);b[h]={err:d,v:q,resp:f};c.length==k.length&&m&&m(a.length?a:null,g,b)}):(k.push(h),g[h]=q[e.__proxies[h].forwardModel.id],b[h]={err:l,v:q},c.length==k.length&&m&&m(a.length?a:null,g,b)):(p.debug.isEnabled&&p.debug("no value for "+h),k.push(h),b[h]={err:l,v:q},c.length==k.length&&m&&m(a.length?a:null,g,b))}))});c.length||m(null,g,{})}e=siesta._internal;
t=e.util;var p=e.log.loggerWithName("Serialisation"),l=t._;q.depthSerialiser=function(d){return l.partial(n,d)};q.depthSerializer=function(d){return l.partial(n,d)};q.idSerializer=d;q.idSerialiser=d},{}],38:[function(e,t,q){function d(){this._events=this._events||{};this._maxListeners=this._maxListeners||void 0}function n(d){return"function"===typeof d}function p(d){return"object"===typeof d&&null!==d}t.exports=d;d.EventEmitter=d;d.prototype._events=void 0;d.prototype._maxListeners=void 0;d.defaultMaxListeners=
10;d.prototype.setMaxListeners=function(d){if("number"!==typeof d||0>d||isNaN(d))throw TypeError("n must be a positive number");this._maxListeners=d;return this};d.prototype.emit=function(d){var e,f,m,g;this._events||(this._events={});if("error"===d&&(!this._events.error||p(this._events.error)&&!this._events.error.length)){e=arguments[1];if(e instanceof Error)throw e;throw TypeError('Uncaught, unspecified "error" event.');}f=this._events[d];if(void 0===f)return!1;if(n(f))switch(arguments.length){case 1:f.call(this);
break;case 2:f.call(this,arguments[1]);break;case 3:f.call(this,arguments[1],arguments[2]);break;default:e=arguments.length;m=Array(e-1);for(g=1;g<e;g++)m[g-1]=arguments[g];f.apply(this,m)}else if(p(f)){e=arguments.length;m=Array(e-1);for(g=1;g<e;g++)m[g-1]=arguments[g];f=f.slice();e=f.length;for(g=0;g<e;g++)f[g].apply(this,m)}return!0};d.prototype.addListener=function(e,r){var f;if(!n(r))throw TypeError("listener must be a function");this._events||(this._events={});this._events.newListener&&this.emit("newListener",
e,n(r.listener)?r.listener:r);this._events[e]?p(this._events[e])?this._events[e].push(r):this._events[e]=[this._events[e],r]:this._events[e]=r;p(this._events[e])&&!this._events[e].warned&&(f=void 0!==this._maxListeners?this._maxListeners:d.defaultMaxListeners)&&0<f&&this._events[e].length>f&&(this._events[e].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[e].length),"function"===
typeof console.trace&&console.trace());return this};d.prototype.on=d.prototype.addListener;d.prototype.once=function(d,e){function f(){this.removeListener(d,f);m||(m=!0,e.apply(this,arguments))}if(!n(e))throw TypeError("listener must be a function");var m=!1;f.listener=e;this.on(d,f);return this};d.prototype.removeListener=function(d,e){var f,m,g;if(!n(e))throw TypeError("listener must be a function");if(!this._events||!this._events[d])return this;f=this._events[d];g=f.length;m=-1;if(f===e||n(f.listener)&&
f.listener===e)delete this._events[d],this._events.removeListener&&this.emit("removeListener",d,e);else if(p(f)){for(;0<g--;)if(f[g]===e||f[g].listener&&f[g].listener===e){m=g;break}if(0>m)return this;1===f.length?(f.length=0,delete this._events[d]):f.splice(m,1);this._events.removeListener&&this.emit("removeListener",d,e)}return this};d.prototype.removeAllListeners=function(d){var e;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[d]&&
delete this._events[d],this;if(0===arguments.length){for(e in this._events)"removeListener"!==e&&this.removeAllListeners(e);this.removeAllListeners("removeListener");this._events={};return this}e=this._events[d];if(n(e))this.removeListener(d,e);else for(;e.length;)this.removeListener(d,e[e.length-1]);delete this._events[d];return this};d.prototype.listeners=function(d){return this._events&&this._events[d]?n(this._events[d])?[this._events[d]]:this._events[d].slice():[]};d.listenerCount=function(d,
e){return d._events&&d._events[e]?n(d._events[e])?1:d._events[e].length:0}},{}],39:[function(e,t,q){t.exports=function(e,p,l,r){l=l||"=";var f={};if("string"!==typeof e||0===e.length)return f;var m=/\+/g;e=e.split(p||"&");p=1E3;r&&"number"===typeof r.maxKeys&&(p=r.maxKeys);r=e.length;0<p&&r>p&&(r=p);for(p=0;p<r;++p){var g=e[p].replace(m,"%20"),c=g.indexOf(l),a;0<=c?(a=g.substr(0,c),g=g.substr(c+1)):(a=g,g="");a=decodeURIComponent(a);g=decodeURIComponent(g);Object.prototype.hasOwnProperty.call(f,a)?
d(f[a])?f[a].push(g):f[a]=[f[a],g]:f[a]=g}return f};var d=Array.isArray||function(d){return"[object Array]"===Object.prototype.toString.call(d)}},{}],40:[function(e,t,q){function d(d,e){if(d.map)return d.map(e);for(var l=[],g=0;g<d.length;g++)l.push(e(d[g],g));return l}var n=function(d){switch(typeof d){case "string":return d;case "boolean":return d?"true":"false";case "number":return isFinite(d)?d:"";default:return""}};t.exports=function(e,f,m,g){f=f||"&";m=m||"=";null===e&&(e=void 0);return"object"===
typeof e?d(l(e),function(c){var a=encodeURIComponent(n(c))+m;return p(e[c])?d(e[c],function(b){return a+encodeURIComponent(n(b))}).join(f):a+encodeURIComponent(n(e[c]))}).join(f):g?encodeURIComponent(n(g))+m+encodeURIComponent(n(e)):""};var p=Array.isArray||function(d){return"[object Array]"===Object.prototype.toString.call(d)},l=Object.keys||function(d){var e=[],l;for(l in d)Object.prototype.hasOwnProperty.call(d,l)&&e.push(l);return e}},{}],41:[function(e,t,q){q.decode=q.parse=e("./decode");q.encode=
q.stringify=e("./encode")},{"./decode":39,"./encode":40}],42:[function(e,t,q){var d=Object.prototype.hasOwnProperty,n=Object.prototype.toString,p=function(e){if(!e||"[object Object]"!==n.call(e)||e.nodeType||e.setInterval)return!1;var p=d.call(e,"constructor"),f=e.constructor&&e.constructor.prototype&&d.call(e.constructor.prototype,"isPrototypeOf");if(e.constructor&&!p&&!f)return!1;for(var m in e);return void 0===m||d.call(e,m)};t.exports=function r(){var d,e,g,c,a,b=arguments[0],k=1,h=arguments.length,
n=!1;if("boolean"===typeof b)n=b,b=arguments[1]||{},k=2;else if("object"!==typeof b&&"function"!==typeof b||void 0==b)b={};for(;k<h;++k)if(null!=(d=arguments[k]))for(e in d)g=b[e],c=d[e],b!==c&&(n&&c&&(p(c)||(a=Array.isArray(c)))?(a?(a=!1,g=g&&Array.isArray(g)?g:[]):g=g&&p(g)?g:{},b[e]=r(n,g,c)):void 0!==c&&(b[e]=c));return b}},{}],43:[function(e,t,q){if("undefined"==typeof siesta&&"undefined"==typeof t)throw Error("Could not find window.siesta. Make sure you include siesta.core.js first.");var d=
siesta._internal,n=d.CollectionRegistry,p=d.util,l=p._,r=d.events,f=[],m={},g={};e={};var c=d.log.loggerWithName("Storage");if("undefined"==typeof PouchDB)siesta.ext.storageEnabled=!1,console.log("PouchDB is not present therefore storage is disabled.");else{q=function(b){var d=p.defer(b);siesta._afterInstall(function(){b=b||function(){};var e=f;f=[];m={};g={};c.trace&&c.trace("Saving objects",l.map(e,function(a){return a._dump()}));a(e,b,d)});return d.promise};var a=function(a,d,e){var f=[];y.bulkDocs(l.map(a,
v)).then(function(g){for(var h=0;h<g.length;h++){var k=g[h],l=a[h];k.ok?l._rev=k.rev:409==k.status?f.push(l):c.error('Error saving object with _id="'+l._id+'"',k)}f.length?b(f,d,e):(d(),e&&e.resolve())},function(a){d(a);e&&e.reject(a)})},b=function(b,c,d){y.allDocs({keys:l.pluck(b,"_id")}).then(function(e){for(var f=0;f<e.rows.length;f++)b[f]._rev=e.rows[f].value.rev;a(b,c,d)})["catch"](function(a){d.reject(a)})},k=function(a,b){var d=a.collectionName,e=a.modelName;if(c.trace){var f=d+"."+e;c.trace("Loading instances for "+
f)}var g=n[d][e],d=function(a){"$1"==a.model&&"$2"==a.collection&&emit(a._id,a)}.toString().replace("$1",e).replace("$2",d);c.trace.isEnabled&&c.trace("Querying pouch");y.query({map:d}).then(function(a){c.trace.isEnabled&&c.trace("Queried pouch succesffully");a=siesta._.map(siesta._.pluck(a.rows,"value"),function(a){return h(a,g)});c.trace.isEnabled&&c.trace("Mapping data",a);g.map(a,{disableevents:!0,_ignoreInstalled:!0,callInit:!1},function(a,d){a?c.error("Error loading models",a):c.trace.isEnabled&&
c.trace("Loaded "+d?d.length.toString():"0 instances for "+f);b(a,d)})})["catch"](function(a){b(a)})},h=function(a,b){delete a.collection;delete a.model;l.each(b._relationshipNames,function(b){var c=a[b];siesta.isArray(c)?a[b]=l.map(c,function(a){return{_id:a}}):a[b]={_id:c}});return a},v=function(a){var b=siesta._.extend({},a.__values);b.collection=a.collectionName;b.model=a.modelName;b._id=a._id;a.removed&&(b._deleted=!0);var c=a._rev;c&&(b._rev=c);return b=l.reduce(a._relationshipNames,function(b,
c){var d=a[c];siesta.isArray(d)?b[c]=l.pluck(d,"_id"):d&&(b[c]=d._id);return b},b)},y=new PouchDB("siesta"),C=function(a){a=a.obj;var b=a._id;if(!a)throw new d.error.InternalSiestaError("No obj field in notification received by storage extension");if(!(b in m)){m[b]=a;f.push(a);var c=a.collectionName;g[c]||(g[c]={});var e=a.model.name;g[c][e]||(g[c][e]={});g[c][e][b]=a}};siesta.on("Siesta",C);l.extend(e,{_load:function(a){if(x)throw Error("not loaded yet how can i save");var b=p.defer(a);if(siesta.ext.storageEnabled){var d=
[];l.each(n.collectionNames,function(a){var b=Object.keys(n[a]._models);l.each(b,function(b){d.push(function(c){k({collectionName:a,modelName:b},c)})})});siesta.async.parallel(d,function(a,d){if(!a){var e=[];siesta._.each(d,function(a){e.concat(a)});c.trace&&c.trace("Loaded "+e.length.toString()+" instances")}b.finish(a)})}else b.finish();return b.promise},save:q,_serialise:v,_reset:function(a){siesta.removeListener("Siesta",C);f=[];m={};y.destroy(function(b){b||(y=new PouchDB("siesta"));siesta.on("Siesta",
C);c.warn("Reset complete");a(b)})}});Object.defineProperties(e,{_unsavedObjects:{get:function(){return f}},_unsavedObjectsHash:{get:function(){return m}},_unsavedObjectsByCollection:{get:function(){return g}},_pouch:{get:function(){return y}}});siesta.ext||(siesta.ext={});siesta.ext.storage=e;Object.defineProperties(siesta.ext,{storageEnabled:{get:function(){return void 0!==siesta.ext._storageEnabled?siesta.ext._storageEnabled:!!siesta.ext.storage},set:function(a){siesta.ext._storageEnabled=a},enumerable:!0}});
var A,x,w=1E3;Object.defineProperties(siesta,{autosave:{get:function(){return!!A},set:function(a){a?A||(A=setInterval(function(){x||(x=!0,siesta.save(function(a){a||r.emit("saved");x=!1}))},siesta.autosaveInterval)):A&&(clearInterval(A),A=null)}},autosaveInterval:{get:function(){return w},set:function(a){w=a;A&&(siesta.autosave=!1,siesta.autosave=!0)}},dirty:{get:function(){return!!Object.keys(siesta.ext.storage._unsavedObjectsByCollection).length},enumerable:!0}});l.extend(siesta,{save:q,setPouch:function(a){if(siesta._canChange)y=
a;else throw Error("Cannot change PouchDB instance when an object graph exists.");}})}t.exports=e},{}],44:[function(e,t,q){(function(d){(function(d){function e(a){for(var b=0;1E3>b&&a.check_();)b++;x&&(d.dirtyCheckCycleCount=b);return 0<b}function l(a){for(var b in a)return!1;return!0}function r(a){return l(a.added)&&l(a.removed)&&l(a.changed)}function f(a,b){var c={},d={},e={},f;for(f in b){var g=a[f];if(void 0===g||g!==b[f])f in a?g!==b[f]&&(e[f]=g):d[f]=void 0}for(f in a)f in b||(c[f]=a[f]);Array.isArray(a)&&
a.length!==b.length&&(e.length=a.length);return{added:c,removed:d,changed:e}}function m(){if(!z.length)return!1;for(var a=0;a<z.length;a++)z[a]();z.length=0;return!0}function g(){function a(c){b&&b.state_===F&&!d&&b.check_(c)}var b,c,d=!1,e=!0;return{open:function(c){if(b)throw Error("ObservedObject in use");e||Object.deliverChangeRecords(a);b=c;e=!1},observe:function(b,d){c=b;d?Array.observe(c,a):Object.observe(c,a)},deliver:function(b){d=b;Object.deliverChangeRecords(a);d=!1},close:function(){b=
void 0;Object.unobserve(c,a);L.push(this)}}}function c(){this.state_=K;this.value_=this.directObserver_=this.target_=this.callback_=void 0;this.id_=M++}function a(a){c.call(this);this.value_=a;this.oldObject_=void 0}function b(b){if(!Array.isArray(b))throw Error("Provided object is not an Array");a.call(this,b)}function k(a,b,c){for(var d={},e={},f=0;f<b.length;f++){var g=b[f];O[g.type]?(g.name in c||(c[g.name]=g.oldValue),"update"!=g.type&&("add"==g.type?g.name in e?delete e[g.name]:d[g.name]=!0:
g.name in d?(delete d[g.name],delete c[g.name]):e[g.name]=!0)):(console.error("Unknown changeRecord type: "+g.type),console.error(g))}for(var h in d)d[h]=a[h];for(h in e)e[h]=void 0;b={};for(h in c)h in d||h in e||(f=a[h],c[h]!==f&&(b[h]=f));return{added:d,removed:e,changed:b}}function h(a,b,c){return{index:a,removed:b,addedCount:c}}function v(){}function y(a,b,c,d){b=h(b,c,d);d=!1;for(var e=0,f=0;f<a.length;f++){var g=a[f];g.index+=e;if(!d){c=b.index;var k=b.index+b.removed.length,l=g.index,m=g.index+
g.addedCount;c=k<l||m<c?-1:k==l||m==c?0:c<l?k<m?k-l:m-l:m<k?m-c:k-c;0<=c?(a.splice(f,1),f--,e-=g.addedCount-g.removed.length,b.addedCount+=g.addedCount-c,c=b.removed.length+g.removed.length-c,b.addedCount||c?(c=g.removed,b.index<g.index&&(k=b.removed.slice(0,g.index-b.index),Array.prototype.push.apply(k,c),c=k),b.index+b.removed.length>g.index+g.addedCount&&(k=b.removed.slice(g.index+g.addedCount-b.index),Array.prototype.push.apply(c,k)),b.removed=c,g.index<b.index&&(b.index=g.index)):d=!0):b.index<
g.index&&(d=!0,a.splice(f,0,b),f++,c=b.addedCount-b.removed.length,g.index+=c,e+=c)}}d||a.push(b)}function C(a,b){for(var c=[],d=0;d<b.length;d++){var e=b[d];switch(e.type){case "splice":y(c,e.index,e.removed.slice(),e.addedCount);break;case "add":case "update":case "delete":var f=e.name;if(+f!==f>>>0||""===f)continue;f=+e.name;if(0>f)continue;y(c,f,[e.oldValue],1);break;default:console.error("Unexpected record type: "+JSON.stringify(e))}}return c}function A(a,b){var c=[];C(a,b).forEach(function(b){1==
b.addedCount&&1==b.removed.length?b.removed[0]!==a[b.index]&&c.push(b):c=c.concat(J.calcSplices(a,b.index,b.index+b.addedCount,b.removed,0,b.removed.length))});return c}var x=d.testingExposeCycleCount,w=function(){function a(c){b=c}if("function"!==typeof Object.observe||"function"!==typeof Array.observe)return!1;var b=[],c={},d=[];Object.observe(c,a);Array.observe(d,a);c.id=1;c.id=2;delete c.id;d.push(1,2);d.length=0;Object.deliverChangeRecords(a);if(5!==b.length||"add"!=b[0].type||"update"!=b[1].type||
"delete"!=b[2].type||"splice"!=b[3].type||"splice"!=b[4].type)return!1;Object.unobserve(c,a);Array.unobserve(d,a);return!0}(),B=function(){if("undefined"!==typeof chrome&&chrome.app&&chrome.app.runtime||navigator.getDeviceStorage)return!1;try{return(new Function("","return true;"))()}catch(a){return!1}}(),D="__proto__"in{}?function(a){return a}:function(a){var b=a.__proto__;if(!b)return a;var c=Object.create(b);Object.getOwnPropertyNames(a).forEach(function(b){Object.defineProperty(c,b,Object.getOwnPropertyDescriptor(a,
b))});return c},z=[],E=w?function(){var a={pingPong:!0},b=!1;Object.observe(a,function(){m();b=!1});return function(c){z.push(c);b||(b=!0,a.pingPong=!a.pingPong)}}():function(){return function(a){z.push(a)}}(),L=[],K=0,F=1,M=1;c.prototype={open:function(a,b){if(this.state_!=K)throw Error("Observer has already been opened.");c._allObserversCount++;H&&G.push(this);this.callback_=a;this.target_=b;this.connect_();this.state_=F;return this.value_},close:function(){this.state_==F&&(c._allObserversCount--,
this.disconnect_(),this.target_=this.callback_=this.value_=void 0,this.state_=2)},deliver:function(){this.state_==F&&e(this)},report_:function(a){try{this.callback_.apply(this.target_,a)}catch(b){c._errorThrownDuringCallback=!0,console.error("Exception caught during observer callback: "+(b.stack||b))}},discardChanges:function(){this.check_(void 0,!0);return this.value_}};var H=!w,G;c._allObserversCount=0;H&&(G=[]);var I=!1,N=w&&B&&function(){try{return eval("%RunMicrotasks()"),!0}catch(a){return!1}}();
d.Platform=d.Platform||{};d.Platform.performMicrotaskCheckpoint=function(){if(!I)if(N)eval("%RunMicrotasks()");else if(H){I=!0;var a=0,b,c;do{a++;c=G;G=[];b=!1;for(var e=0;e<c.length;e++){var f=c[e];f.state_==F&&(f.check_()&&(b=!0),G.push(f))}m()&&(b=!0)}while(1E3>a&&b);x&&(d.dirtyCheckCycleCount=a);I=!1}};H&&(d.Platform.clearObservers=function(){G=[]});a.prototype=D({__proto__:c.prototype,arrayObserve:!1,connect_:function(a,b){if(w){var c=this.value_,d=this.arrayObserve,e=L.pop()||g();e.open(this);
e.observe(c,d);this.directObserver_=e}else this.oldObject_=this.copyObject(this.value_)},copyObject:function(a){var b=Array.isArray(a)?[]:{},c;for(c in a)b[c]=a[c];Array.isArray(a)&&(b.length=a.length);return b},check_:function(a,b){var c,d;if(w){if(!a)return!1;d={};c=k(this.value_,a,d)}else d=this.oldObject_,c=f(this.value_,this.oldObject_);if(r(c))return!1;w||(this.oldObject_=this.copyObject(this.value_));this.report_([c.added||{},c.removed||{},c.changed||{},function(a){return d[a]}]);return!0},
disconnect_:function(){w?(this.directObserver_.close(),this.directObserver_=void 0):this.oldObject_=void 0},deliver:function(){this.state_==F&&(w?this.directObserver_.deliver(!1):e(this))},discardChanges:function(){this.directObserver_?this.directObserver_.deliver(!0):this.oldObject_=this.copyObject(this.value_);return this.value_}});b.prototype=D({__proto__:a.prototype,arrayObserve:!0,copyObject:function(a){return a.slice()},check_:function(a){if(w){if(!a)return!1;a=A(this.value_,a)}else a=J.calcSplices(this.value_,
0,this.value_.length,this.oldObject_,0,this.oldObject_.length);if(!a||!a.length)return!1;w||(this.oldObject_=this.copyObject(this.value_));this.report_([a]);return!0}});b.applySplices=function(a,b,c){c.forEach(function(c){for(var d=[c.index,c.removed.length],e=c.index;e<c.index+c.addedCount;)d.push(b[e]),e++;Array.prototype.splice.apply(a,d)})};var O={add:!0,update:!0,"delete":!0};v.prototype={calcEditDistances:function(a,b,c,d,e,f){f=f-e+1;c=c-b+1;for(var g=Array(f),h=0;h<f;h++)g[h]=Array(c),g[h][0]=
h;for(var k=0;k<c;k++)g[0][k]=k;for(h=1;h<f;h++)for(k=1;k<c;k++)if(this.equals(a[b+k-1],d[e+h-1]))g[h][k]=g[h-1][k-1];else{var l=g[h-1][k]+1,m=g[h][k-1]+1;g[h][k]=l<m?l:m}return g},spliceOperationsFromEditDistances:function(a){for(var b=a.length-1,c=a[0].length-1,d=a[b][c],e=[];0<b||0<c;)if(0==b)e.push(2),c--;else if(0==c)e.push(3),b--;else{var f=a[b-1][c-1],g=a[b-1][c],h=a[b][c-1],k;k=g<h?g<f?g:f:h<f?h:f;k==f?(f==d?e.push(0):(e.push(1),d=f),b--,c--):k==g?(e.push(3),b--,d=g):(e.push(2),c--,d=h)}e.reverse();
return e},calcSplices:function(a,b,c,d,e,f){var g=0,k=0,l=Math.min(c-b,f-e);0==b&&0==e&&(g=this.sharedPrefix(a,d,l));c==a.length&&f==d.length&&(k=this.sharedSuffix(a,d,l-g));b+=g;e+=g;c-=k;f-=k;if(0==c-b&&0==f-e)return[];if(b==c){for(a=h(b,[],0);e<f;)a.removed.push(d[e++]);return[a]}if(e==f)return[h(b,[],c-b)];f=this.spliceOperationsFromEditDistances(this.calcEditDistances(a,b,c,d,e,f));a=void 0;c=[];for(g=0;g<f.length;g++)switch(f[g]){case 0:a&&(c.push(a),a=void 0);b++;e++;break;case 1:a||(a=h(b,
[],0));a.addedCount++;b++;a.removed.push(d[e]);e++;break;case 2:a||(a=h(b,[],0));a.addedCount++;b++;break;case 3:a||(a=h(b,[],0)),a.removed.push(d[e]),e++}a&&c.push(a);return c},sharedPrefix:function(a,b,c){for(var d=0;d<c;d++)if(!this.equals(a[d],b[d]))return d;return c},sharedSuffix:function(a,b,c){for(var d=a.length,e=b.length,f=0;f<c&&this.equals(a[--d],b[--e]);)f++;return f},calculateSplices:function(a,b){return this.calcSplices(a,0,a.length,b,0,b.length)},equals:function(a,b){return a===b}};
var J=new v,B=d;"undefined"!==typeof q&&("undefined"!==typeof t&&t.exports&&(B=q=t.exports),B=q);B.Observer=c;B.Observer.runEOM_=E;B.Observer.observerSentinel_={};B.Observer.hasObjectObserve=w;B.ArrayObserver=b;B.ArrayObserver.calculateSplices=function(a,b){return J.calculateSplices(a,b)};B.Platform=d.Platform;B.ArraySplice=v;B.ObjectObserver=a})("undefined"!==typeof d&&d&&"undefined"!==typeof t&&t?d:this||window)}).call(this,"undefined"!==typeof global?global:"undefined"!==typeof self?self:"undefined"!==
typeof window?window:{})},{}]},{},[13]);
